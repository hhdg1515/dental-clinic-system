function escapeHtml(e){if(null==e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}let currentFirebaseUser=null,userRole=null,userClinics=[],userClaimsCache=null;async function getCurrentUser(){try{const e=["currentUser","user","userData","authUser"];for(const t of e){const e=localStorage.getItem(t);if(e){const t=JSON.parse(e);if(t&&(t.role||t.email))return currentFirebaseUser=t,t}}return null}catch(e){return console.error("Ëß£ÊûêÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:",e),null}}async function getUserRole(){const e=await getCurrentUser();if(!e)return null;try{return e.role?(userRole=e.role,userClinics=e.clinics||e.accessibleLocations||[],userRole):e.email&&(e.email.includes("admin")||e.email.includes("boss")||e.email.includes("owner"))?(userRole="admin",userRole):null}catch(e){return console.error("Error getting user role:",e),null}}async function redirectIfNotAdmin(){const e=await getCurrentUser(),t=await getUserRole();return e?!t||"admin"!==t&&"boss"!==t&&"owner"!==t?(console.log("User does not have admin privileges"),showAuthError("Access denied. Admin privileges required for internal dashboard."),!1):(console.log(`‚úÖ User authenticated as ${t}`),!0):(console.log("No user logged in, showing login message..."),showAuthError("Please login first through the external website to access the internal dashboard."),!1)}async function initializeUserPermissions(){try{console.log("üîí Initializing secure user permissions...");const e=await window.AuthUtils.getCurrentUserClaims();if(!e)return console.warn("‚ö†Ô∏è No user claims available"),userRole=null,void(userClinics=[]);userClaimsCache=e,userRole=e.claims.role||null,userClinics="owner"===userRole||"boss"===userRole?["arcadia","irvine","south-pasadena","rowland-heights","eastvale"]:"admin"===userRole&&e.claims.clinics?e.claims.clinics:[],console.log("‚úÖ User permissions initialized:"),console.log("   Role:",userRole),console.log("   Clinics:",userClinics),!userRole&&e.user.email&&e.user.email.endsWith("@firstavedental.com")&&(console.warn("‚ö†Ô∏è Custom claims not set, using email domain fallback"),userRole="owner",userClinics=["arcadia","irvine","south-pasadena","rowland-heights","eastvale"])}catch(e){console.error("‚ùå Failed to initialize user permissions:",e),userRole=null,userClinics=[]}}function isOwner(){if("boss"===userRole||"owner"===userRole)return!0;if(userClaimsCache&&userClaimsCache.claims){const e=userClaimsCache.claims.role;return"boss"===e||"owner"===e}return!1}function getAccessibleClinics(){if(userClinics&&userClinics.length>0)return userClinics;if(userClaimsCache&&userClaimsCache.claims){const e=userClaimsCache.claims.role;if("owner"===e||"boss"===e)return["arcadia","irvine","south-pasadena","rowland-heights","eastvale"];if("admin"===e&&userClaimsCache.claims.clinics)return userClaimsCache.claims.clinics}return[]}function hasClinicAccess(e){return getAccessibleClinics().includes(e)}function filterDataByRole(e,t="appointments"){if(!e||!Array.isArray(e))return e;if(isOwner())return e;const n=getAccessibleClinics();return e.filter(e=>{if(!e.location)return!1;const t=e.location.toLowerCase().replace(/\s+/g,"-");return n.includes(t)})}function setupAuthStateListener(){console.log("‚úÖ Auth state listener setup (using localStorage auth)")}async function updateUIBasedOnRole(){updateLocationSelectorPermissions(),updateUserDisplay(),updateDashboardStats(),await refreshDashboardData()}function updateLocationSelectorPermissions(){const e=document.querySelector(".location-selector-container"),t=document.getElementById("locationSelector");if(console.log("üîß updateLocationSelectorPermissions called"),console.log("üìç Current userRole:",userRole),console.log("üëë isOwner():",isOwner()),console.log("üì¶ locationSelectorContainer found:",!!e),console.log("üéõÔ∏è locationSelector found:",!!t),t)if(isOwner()){console.log("‚úÖ User is owner - showing location selector"),e&&(e.style.display="flex",console.log("‚úÖ Set locationSelectorContainer display to flex"));const n=[{value:"arcadia",name:"Arcadia"},{value:"irvine",name:"Irvine"},{value:"south-pasadena",name:"South Pasadena"},{value:"rowland-heights",name:"Rowland Heights"},{value:"eastvale",name:"Eastvale"}];t.innerHTML="",n.forEach(e=>{const n=document.createElement("option");n.value=e.value,n.textContent=e.name,t.appendChild(n)}),console.log("‚úÖ Populated location selector with all locations")}else console.log("üö´ User is admin - hiding location selector"),e&&(e.style.display="none",console.log("‚úÖ Set locationSelectorContainer display to none"));else console.log("‚ùå locationSelector not found, exiting")}function updateUserDisplay(){const e=document.querySelector(".user-name"),t=document.querySelector(".user-role");if(currentFirebaseUser&&(e&&(e.textContent=currentFirebaseUser.displayName||currentFirebaseUser.email.split("@")[0]),t)){const e="boss"===userRole||"owner"===userRole?"Owner":"Admin";t.textContent=e}}function testFirebaseConnection(){console.log("üî• Testing Firebase connection...");const e=()=>!!(window.firebase&&window.firebase.app&&window.firebase.auth&&window.firebase.db)&&(console.log("‚úÖ Firebase services initialized successfully!"),console.log("Firebase Auth:",window.firebase.auth),console.log("Firebase Firestore:",window.firebase.db),console.log("Firebase App:",window.firebase.app),console.log("Google Provider:",window.firebase.googleProvider),console.log("‚úÖ Firebase connection test completed successfully!"),!0);if(e())return;let t=0;const n=setInterval(()=>{t++,e()?clearInterval(n):t>=50&&(clearInterval(n),console.error("‚ùå Firebase connection test failed: Services not available after timeout"))},100)}function getLocalDateString(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function getStartOfWeek(e){const t=new Date(e),n=t.getDay(),o=t.getDate()-n+(0===n?-6:1);return t.setDate(o),t}function safeGetCurrentUser(){try{const e=["currentUser","user","userData","authUser"];for(const t of e){const e=localStorage.getItem(t);if(e){const t=JSON.parse(e);if(t&&(t.role||t.email))return t}}if(window.dataManager&&dataManager.getCurrentUser)return dataManager.getCurrentUser()}catch(e){console.warn("DataManager access failed:",e)}return{name:"Sunny",role:"boss",currentViewLocation:"arcadia",assignedLocation:"arcadia"}}function safeGetCurrentLocation(){if(currentFirebaseUser&&userRole){if(isOwner()){const e=document.getElementById("locationSelector");return e&&e.value?e.value:"arcadia"}{const e=getAccessibleClinics();return e.length>0?e[0]:"arcadia"}}const e=safeGetCurrentUser();return"boss"===e.role?e.currentViewLocation||"arcadia":e.assignedLocation||"arcadia"}async function safeGetAppointmentsForDate(e){try{if(window.dataManager&&dataManager.getAppointmentsForDate){console.log("üî• Dashboard: Getting appointments from Firebase for date:",e);let t=await dataManager.getAppointmentsForDate(e)||[];return console.log("üî• Dashboard: Firebase returned",t.length,"appointments:",t.map(e=>e.patientName)),t=filterDataByRole(t,"appointments"),console.log("üî• Dashboard: After filtering",t.length,"appointments"),t}}catch(e){console.error("‚ùå Dashboard: Failed to get appointments from Firebase:",e),console.warn("üö® Dashboard: Not falling back to localStorage - returning empty array")}return[]}function safeGetAppointmentsForDateSync(e){console.warn("üö® safeGetAppointmentsForDateSync is deprecated - use safeGetAppointmentsForDate instead");try{if(window.dataManager&&dataManager.getAppointmentsForDateLocal){let t=dataManager.getAppointmentsForDateLocal(e)||[];return t=filterDataByRole(t,"appointments"),t}}catch(e){console.warn("Failed to get appointments for date:",e)}return[]}async function safeGetPendingConfirmations(){try{if(window.dataManager&&dataManager.getPendingConfirmations){let e=await dataManager.getPendingConfirmations()||[];return e=filterDataByRole(e,"confirmations"),e}}catch(e){console.warn("Failed to get pending confirmations:",e)}return[]}function safeGetPendingConfirmationsSync(){try{if(window.dataManager&&window.dataManager.data){let e=dataManager.data.pendingConfirmations||[];return e=filterDataByRole(e,"confirmations"),e}}catch(e){console.warn("Failed to get pending confirmations:",e)}return[]}async function initializeAuthSystem(){console.log("üîê Initializing authentication system..."),console.log("‚úÖ Firebase auth service ready"),setupAuthStateListener(),await performInitialAuthCheck()}function waitForDataManager(){return new Promise(e=>{const t=()=>{window.dataManager&&window.dataManager.firebaseService?(console.log("‚úÖ DataManager is ready with Firebase connection"),e()):(console.log("‚è≥ Waiting for DataManager to connect to Firebase..."),setTimeout(t,100))};t()})}async function performInitialAuthCheck(){try{console.log("üîç Performing initial authentication check...");await redirectIfNotAdmin()?(console.log("‚úÖ Authentication successful, initializing dashboard..."),await initializeUserPermissions(),await waitForDataManager(),initializeDashboard(),initializeModal(),initializeLocationSelector(),await updateUIBasedOnRole(),await refreshDashboardData(),renderDashboardCalendar()):console.log("‚ö†Ô∏è Authentication failed, user will be redirected")}catch(e){console.error("‚ùå Authentication check failed:",e),showAuthError("Authentication check failed")}}function showAuthError(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #fee2e2;\n        color: #991b1b;\n        padding: 20px;\n        border-radius: 8px;\n        border: 1px solid #fecaca;\n        z-index: 9999;\n        font-family: Inter, sans-serif;\n        max-width: 400px;\n        text-align: center;\n    ";const n=e.includes("login");t.innerHTML=`\n        <h3 style="margin: 0 0 10px 0;">Authentication ${n?"Required":"Error"}</h3>\n        <p style="margin: 0;">${e}</p>\n        <button onclick="this.parentElement.remove()" style="\n            background: #6b7280;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 4px;\n            margin: 10px 5px 0 5px;\n            cursor: pointer;\n        ">Close</button>\n    `,document.body.appendChild(t)}function initializeDashboard(){updateTodayDate(),renderDashboardCalendar(),initializeServiceChartSelector();const e=document.getElementById("service");e&&window.ServiceMapping&&window.ServiceMapping.populateInternalServiceDropdown(e),"function"==typeof setMinDateToToday&&setMinDateToToday("appointmentDate"),"function"==typeof initializePhoneFormatting&&initializePhoneFormatting("phoneNumber"),"function"==typeof initializePatientNameValidation&&initializePatientNameValidation("patientName")}function initializeUserSwitcher(){const e=document.getElementById("userSwitcher"),t=document.getElementById("userSwitchSelect");DEV_MODE?t?(t.value=currentDevUser.id,t.addEventListener("change",function(){handleUserSwitch(this.value)})):console.error("User switcher select not found"):e&&(e.style.display="none")}async function handleUserSwitch(e){DEV_MODE&&DEV_USERS[e]?(currentDevUser=DEV_USERS[e],await refreshDashboardData()):console.error("Invalid user switch attempt:",e)}function initializeServiceChartSelector(){const e=document.getElementById("chartPeriodSelector");e&&(e.addEventListener("change",function(){renderServiceChart()}),e.value="weekly")}function initializeLocationSelector(){const e=document.getElementById("locationSelector"),t=safeGetCurrentUser();if(!e||"boss"!==t.role)return;const n=[{value:"arcadia",name:"Arcadia"},{value:"irvine",name:"Irvine"},{value:"south-pasadena",name:"South Pasadena"},{value:"rowland-heights",name:"Rowland Heights"},{value:"eastvale",name:"Eastvale"}];e.innerHTML="",n.forEach(t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.name,e.appendChild(n)}),t.currentViewLocation&&(e.value=t.currentViewLocation),e.addEventListener("change",async function(){const e=this.value;try{if(window.dataManager&&dataManager.switchLocation){if(dataManager.switchLocation(e),"function"==typeof showSuccessMessage){const t=n.find(t=>t.value===e)?.name||e;showSuccessMessage(`Switched to ${t} location`)}await refreshDashboardData()}}catch(e){console.error("Failed to switch location:",e),"function"==typeof showErrorMessage&&showErrorMessage("Failed to switch location")}})}function updateTodayDate(){const e=document.getElementById("todayDate");if(e){const t=(new Date).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"});e.textContent=t}}async function refreshDashboardData(){await renderStatusCards(),await renderAnalysisCards(),await renderTodaysAppointments(),await renderServiceChart(),await renderTrendChart(),await renderPendingConfirmations();try{const e=(await safeGetPendingConfirmations()).length;"function"==typeof updateNotificationBadge&&updateNotificationBadge(e>0)}catch(e){console.warn("Failed to update notification badge:",e)}}async function renderStatusCards(){const e=getCurrentDate(),t=safeGetCurrentLocation(),n=(await safeGetAppointmentsForDate(e)).filter(e=>"all"===t||e.location.toLowerCase().replace(/\s+/g,"-")===t),o={completed:0,inProgress:0,scheduled:0,noShow:0};n.forEach(e=>{switch(e.status){case"completed":o.completed++;break;case"arrived":o.inProgress++;break;case"scheduled":o.scheduled++;break;case"no-show":o.noShow++}});const a={completedCount:document.getElementById("completedCount"),inProgressCount:document.getElementById("inProgressCount"),scheduledCount:document.getElementById("scheduledCount"),noShowCount:document.getElementById("noShowCount")};a.completedCount&&(a.completedCount.textContent=o.completed),a.inProgressCount&&(a.inProgressCount.textContent=o.inProgress),a.scheduledCount&&(a.scheduledCount.textContent=o.scheduled),a.noShowCount&&(a.noShowCount.textContent=o.noShow)}async function renderAnalysisCards(){const e={allAppointmentsCount:document.getElementById("allAppointmentsCount"),allAppointmentsChange:document.getElementById("allAppointmentsChange"),newPatientsCount:document.getElementById("newPatientsCount"),newPatientsChange:document.getElementById("newPatientsChange"),attendanceRate:document.getElementById("attendanceRate"),attendanceProgress:document.getElementById("attendanceProgress"),attendanceLabel:document.getElementById("attendanceLabel"),premiumMembersCount:document.getElementById("premiumMembersCount"),premiumMembersChange:document.getElementById("premiumMembersChange")},t=safeGetCurrentLocation();let n=[];try{n=await dataManager.getAllAppointments()||[],n=filterDataByRole(n,"appointments")}catch(e){console.warn("Failed to get all appointments:",e),n=[]}const o=n.filter(e=>"all"===t||e.location.toLowerCase().replace(/\s+/g,"-")===t),a=(getCurrentDate(),new Date),i=a.getMonth(),r=a.getFullYear(),s=0===i?11:i-1,l=0===i?r-1:r,c=o.filter(e=>{const t=new Date(e.dateKey);return t.getMonth()===i&&t.getFullYear()===r}),d=o.filter(e=>{const t=new Date(e.dateKey);return t.getMonth()===s&&t.getFullYear()===l}),u=c.length,g=c.length,m=d.length,p=g-m;console.log("üìä Dashboard: All Appointments calculation:"),console.log(`   - Total appointments (all time): ${o.length}`),console.log(`   - Current month (${r}-${String(i+1).padStart(2,"0")}): ${g}`),console.log(`   - Previous month: ${m}`),console.log(`   - Change: ${p>=0?"+":""}${p}`);const h=new Set,f=new Set,w=new Set;o.forEach(e=>{e.phone&&h.add(e.phone)}),c.forEach(e=>{e.phone&&f.add(e.phone)}),d.forEach(e=>{e.phone&&w.add(e.phone)});h.size;const C=f.size,y=C-w.size,v=getStartOfWeek(a),b=new Date(v);b.setDate(v.getDate()+6);const A=[];for(let e=new Date(v);e<=b;e.setDate(e.getDate()+1)){const t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,n=await safeGetAppointmentsForDate(t);A.push(...n)}console.log(`üìä Dashboard: This week appointments (raw): ${A.length}`);const D=A.filter(e=>"all"===t||e.location.toLowerCase().replace(/\s+/g,"-")===t);console.log(`üìä Dashboard: This week appointments (after location filter): ${D.length}`);const S=D.filter(e=>"completed"===e.status||"arrived"===e.status).length,E=D.length,M=E>0?Math.round(S/E*100):0;if(console.log(`üìä Dashboard: Attendance this week: ${S}/${E} (${M}%)`),console.log(`   - Completed: ${D.filter(e=>"completed"===e.status).length}`),console.log(`   - Arrived: ${D.filter(e=>"arrived"===e.status).length}`),e.allAppointmentsCount&&(e.allAppointmentsCount.textContent=u),e.allAppointmentsChange){const t=p>=0?`+${p}`:p;e.allAppointmentsChange.textContent=`${t} in this month`,e.allAppointmentsChange.className="change-indicator "+(p>=0?"positive":"negative")}if(e.newPatientsCount&&(e.newPatientsCount.textContent=C),e.newPatientsChange){const t=y>=0?`+${y}`:y;e.newPatientsChange.textContent=`${t} in this month`,e.newPatientsChange.className="change-indicator "+(y>=0?"positive":"negative")}e.attendanceRate&&(e.attendanceRate.textContent=`${M}%`),e.attendanceProgress&&(e.attendanceProgress.style.width=`${M}%`),e.attendanceLabel&&(e.attendanceLabel.textContent=`This Week ${S}/${E}`),e.premiumMembersCount&&(e.premiumMembersCount.textContent="0"),e.premiumMembersChange&&(e.premiumMembersChange.textContent="0 in this month",e.premiumMembersChange.className="change-indicator neutral")}async function renderTodaysAppointments(){const e=document.getElementById("todaysAppointmentsList");if(!e)return void console.error("todaysAppointmentsList not found");const t=getCurrentDate(),n=safeGetCurrentLocation(),o=(await safeGetAppointmentsForDate(t)).filter(e=>"all"===n||e.location.toLowerCase().replace(/\s+/g,"-")===n).sort((e,t)=>e.time.localeCompare(t.time));e.innerHTML="";const a=o.slice(0,6);for(let t=0;t<6;t++){const n=document.createElement("tr");if(t<a.length){const e=a[t],o=formatTime(e.time),i=getStatusDisplayName(e.status);n.innerHTML=`\n            <td>${escapeHtml(e.patientName)}</td>\n            <td>${escapeHtml(o)}</td>\n            <td>${escapeHtml(e.service)}</td>\n            <td><span class="status-badge ${e.status}">${escapeHtml(i)}</span></td>\n        `}else n.innerHTML='\n            <td style="color: #d1d5db;">--</td>\n            <td style="color: #d1d5db;">--</td>\n            <td style="color: #d1d5db;">--</td>\n            <td style="color: #d1d5db;">--</td>\n        ';e.appendChild(n)}}async function renderPendingConfirmations(){const e=document.getElementById("pendingConfirmationsList"),t=document.getElementById("pendingConfirmationCount");if(e&&t){e.innerHTML='<div style="padding: 20px; text-align: center; color: #6b7280;">Loading pending confirmations...</div>',t.textContent="...";try{const n=await safeGetPendingConfirmations();if(t.textContent=n.length,e.innerHTML="",0===n.length)return void(e.innerHTML='<div style="padding: 20px; text-align: center; color: #6b7280; font-style: italic;">No pending confirmations</div>');n.slice(0,3).forEach(t=>{const n=document.createElement("div");n.className="pending-item",n.innerHTML=`\n                <div class="pending-info">\n                    <div class="pending-patient-name">${escapeHtml(t.patientName)}</div>\n                    <div class="pending-details">\n                        ${escapeHtml(t.dateTime)}<br>\n                        ${escapeHtml(t.service)} ‚Ä¢ ${escapeHtml(t.location)}\n                    </div>\n                </div>\n                <div class="pending-actions">\n                    <button class="btn-icon" data-confirmation-id="${escapeHtml(t.id)}" data-action="confirm" title="Confirm">‚úì</button>\n                    <button class="btn-icon" data-confirmation-id="${escapeHtml(t.id)}" data-action="decline" title="Decline">‚úó</button>\n                </div>\n            `;n.querySelectorAll(".btn-icon").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-action"),t=this.getAttribute("data-confirmation-id");"confirm"===e?handleConfirmAction(t):"decline"===e&&handleDeclineAction(t)})}),e.appendChild(n)})}catch(n){console.error("Error loading pending confirmations:",n),e.innerHTML='<div style="padding: 20px; text-align: center; color: #dc3545;">Error loading pending confirmations</div>',t.textContent="0"}}else console.error("Pending confirmations elements not found")}async function renderServiceChart(){console.log("üé® renderServiceChart called");const e=document.getElementById("serviceChart"),t=document.getElementById("chartLegend");if(!e||!t)return void console.error("Service chart elements not found");const n=e.getContext("2d"),o=await getServiceTypeData();if(console.log("üé® Service data received:",o.length,"items",o),n.clearRect(0,0,e.width,e.height),updateChartLegend(t,o),0===o.length){const t=e.width/2,o=e.height/2,a=80;return n.strokeStyle="#e5e7eb",n.lineWidth=2,n.beginPath(),n.arc(t,o,a,0,2*Math.PI),n.stroke(),n.setLineDash([5,5]),n.strokeStyle="#d1d5db",n.beginPath(),n.arc(t,o,a-20,0,2*Math.PI),n.stroke(),n.setLineDash([]),n.fillStyle="#9ca3af",n.font="14px Inter",n.textAlign="center",void n.fillText("No appointments",t,o)}drawPieChart(n,o,e.width/2,e.height/2,80)}async function getServiceTypeData(){const e=safeGetCurrentLocation(),t=document.getElementById("chartPeriodSelector"),n=t?t.value:"weekly";console.log("üìä getServiceTypeData called - Period:",n,"Location:",e);let o=[];if("weekly"===n){const e=getStartOfWeek(new Date),t=new Date(e);t.setDate(e.getDate()+6),console.log("üìÖ Weekly range:",e.toISOString().split("T")[0],"to",t.toISOString().split("T")[0]);for(let n=new Date(e);n<=t;n.setDate(n.getDate()+1)){const e=n.toISOString().split("T")[0];console.log("üîç Fetching appointments for:",e);const t=await safeGetAppointmentsForDate(e);console.log("üìä Found",t.length,"appointments for",e),o.push(...t)}console.log("‚úÖ Total weekly appointments:",o.length)}else if("monthly"===n){const e=new Date,t=e.getMonth(),n=e.getFullYear();console.log("üìÖ Monthly filter: Month",t,"Year",n);let a=[];try{a=await dataManager.getAllAppointments()||[],console.log("üî• getAllAppointments returned:",typeof a,"isArray:",Array.isArray(a),"length:",a.length),Array.isArray(a)||(console.warn("‚ö†Ô∏è getAllAppointments did not return array, converting to empty array"),a=[]),console.log("üìä Total appointments before filtering:",a.length),a=filterDataByRole(a,"appointments"),console.log("üìä Appointments after role filtering:",a.length),Array.isArray(a)||(console.warn("‚ö†Ô∏è filterDataByRole did not return array"),a=[])}catch(e){console.warn("Failed to get appointments for service chart:",e),a=[]}o=a.filter(e=>{const o=new Date(e.dateKey),i=o.getMonth()===t&&o.getFullYear()===n;return!i&&a.length<10&&console.log("üìÖ Excluding:",e.dateKey,"(month:",o.getMonth(),"year:",o.getFullYear(),")"),i}),console.log("‚úÖ Total monthly appointments after date filter:",o.length)}const a=o.filter(t=>"all"===e||t.location.toLowerCase().replace(/\s+/g,"-")===e);console.log("üîé Location filtered appointments:",a.length);const i={};a.forEach(e=>{const t=mapServiceName(e.service);i[t]=(i[t]||0)+1}),console.log("üìà Service counts:",i);const r=["#5B7FD8","#52C4A0","#8B9DC3","#DBA362","#A78BCA","#7ECBC9","#B8C5A6","#E8A87C","#C4A5C7"],s=Object.values(i).reduce((e,t)=>e+t,0);console.log("üìä Total services:",s);const l={General:"#5B7FD8",Implant:"#52C4A0",Extraction:"#8B9DC3",Preventive:"#DBA362",Cosmetic:"#A78BCA",Orthodontics:"#7ECBC9","Root Canals":"#B8C5A6",Restorations:"#E8A87C",Periodontics:"#C4A5C7"},c=Object.entries(i).map(([e,t],n)=>{const o=l[e]||r[n%r.length];return console.log("üé® Mapping service:",e,"-> color:",o,"count:",t),{label:e,value:t,color:o,percentage:s>0?Math.round(t/s*100):0}});return console.log("‚úÖ Final chart data:",c),c}function drawPieChart(e,t,n,o,a){const i=t.reduce((e,t)=>e+t.value,0);let r=-Math.PI/2;t.forEach(t=>{const s=t.value/i*2*Math.PI;if(e.fillStyle=t.color,e.beginPath(),e.moveTo(n,o),e.arc(n,o,a,r,r+s),e.closePath(),e.fill(),t.percentage>0){const i=r+s/2;let l,c;if(100===t.percentage)l=n,c=o;else{const e=.65*a;l=n+Math.cos(i)*e,c=o+Math.sin(i)*e}e.save(),e.fillStyle="white",e.font="bold 14px Inter",e.textAlign="center",e.textBaseline="middle",e.fillText(`${t.percentage}%`,l,c),e.restore()}r+=s})}function updateChartLegend(e,t){e.innerHTML="";[{label:"General",color:"#5B7FD8"},{label:"Implant",color:"#52C4A0"},{label:"Extraction",color:"#8B9DC3"},{label:"Preventive",color:"#DBA362"},{label:"Cosmetic",color:"#A78BCA"},{label:"Orthodontics",color:"#7ECBC9"},{label:"Root Canals",color:"#B8C5A6"},{label:"Restorations",color:"#E8A87C"},{label:"Periodontics",color:"#C4A5C7"}].forEach(t=>{const n=document.createElement("div");n.className="legend-item",n.innerHTML=`\n            <div class="legend-color" style="background-color: ${escapeHtml(t.color)}"></div>\n            <span>${escapeHtml(t.label)}</span>\n        `,e.appendChild(n)})}function initializeModal(){const e=document.getElementById("quickAddBtn"),t=document.getElementById("quickAddModal");if(!e||!t)return void console.error("Modal elements not found");const n=e.cloneNode(!0);e.parentNode.replaceChild(n,e),n.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),applyQuickAddLocationPermissions(),t.classList.add("show"),document.body.style.overflow="hidden"});const o=document.getElementById("modalClose"),a=document.getElementById("modalCancel");function i(){t.classList.remove("show"),document.body.style.overflow="auto";const e=document.getElementById("quickAddForm");e&&e.reset()}o&&o.addEventListener("click",i),a&&a.addEventListener("click",i),t.addEventListener("click",function(e){e.target===t&&i()});const r=document.getElementById("quickAddForm");r?(console.log("üü° [Quick Add Modal] Form event listener attached to:",r),r.addEventListener("submit",function(e){console.log("üü° [Quick Add Modal] Form submit event fired!",e),e.preventDefault(),handleQuickAddAppointment(),i()})):console.error("‚ùå [Quick Add Modal] Form #quickAddForm not found!")}function applyQuickAddLocationPermissions(){const e=dataManager.getCurrentUser(),t=document.getElementById("location");if(!t)return void console.error("Dashboard Quick Add: Location select element not found");const n=dataManager.getUserClinics(e);t.innerHTML='<option value="">Select Location</option>';const o={arcadia:"Arcadia",irvine:"Irvine","south-pasadena":"South Pasadena","rowland-heights":"Rowland Heights",eastvale:"Eastvale"};n.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=o[e]||e,t.appendChild(n)}),"admin"===e.role?(t.value=e.assignedLocation,t.disabled=!0,t.style.backgroundColor="#f3f4f6",t.style.cursor="not-allowed"):(t.disabled=!1,t.style.backgroundColor="white",t.style.cursor="pointer")}async function handleQuickAddAppointment(){console.log("üü¢ [handleQuickAddAppointment] Function called!");try{const e={patientName:document.getElementById("patientName")?.value,date:document.getElementById("appointmentDate")?.value,time:document.getElementById("appointmentTime")?.value?.split("-")[0],service:document.getElementById("service")?.value,location:document.getElementById("location")?.value,phone:document.getElementById("phoneNumber")?.value};if(console.log("üü¢ [handleQuickAddAppointment] Form data collected:",e),!(e.patientName&&e.date&&e.time&&e.service&&e.location))return console.log("‚ùå [handleQuickAddAppointment] Validation failed - missing fields"),void("function"==typeof showErrorMessage?showErrorMessage("Please fill in all required fields"):alert("Please fill in all required fields"));if(console.log("‚úÖ [handleQuickAddAppointment] Validation passed"),console.log("üü¢ [handleQuickAddAppointment] Checking dataManager:",{exists:!!window.dataManager,hasAddMethod:!!dataManager?.addAppointment}),window.dataManager&&dataManager.addAppointment)try{console.log("üü¢ [handleQuickAddAppointment] Calling dataManager.addAppointment..."),await dataManager.addAppointment(e),console.log("‚úÖ [handleQuickAddAppointment] dataManager.addAppointment completed successfully"),"function"==typeof showSuccessMessage?showSuccessMessage("Appointment added successfully!"):alert("Appointment added successfully!"),console.log("üü¢ [handleQuickAddAppointment] Refreshing dashboard..."),await refreshDashboardData(),console.log("‚úÖ [handleQuickAddAppointment] Dashboard refreshed")}catch(e){console.error("‚ùå [handleQuickAddAppointment] Error in dataManager.addAppointment:",e),"function"==typeof showErrorMessage?showErrorMessage("Failed to add appointment"):alert("Failed to add appointment")}else console.error("‚ùå [handleQuickAddAppointment] dataManager not available!",{windowDataManager:window.dataManager,dataManagerGlobal:"undefined"!=typeof dataManager?dataManager:"undefined"})}catch(e){console.error("‚ùå [handleQuickAddAppointment] Top-level error:",e),"function"==typeof showErrorMessage?showErrorMessage("Failed to add appointment. Please try again."):alert("Failed to add appointment. Please try again.")}}function getStatusDisplayName(e){return{scheduled:"Scheduled",arrived:"Arrived",completed:"Completed","no-show":"No Show",cancelled:"Cancelled",held:"Held"}[e]||e}async function getLast30DaysCompletedData(){const e=safeGetCurrentLocation(),t=[];for(let n=29;n>=0;n--){const o=new Date;o.setDate(o.getDate()-n);const a=o.toISOString().split("T")[0],i=(await safeGetAppointmentsForDate(a)).filter(t=>"all"===e||t.location.toLowerCase().replace(/\s+/g,"-")===e).filter(e=>"completed"===e.status).length;t.push({date:a,dateLabel:o.getMonth()+1+"/"+o.getDate(),completed:i})}return t}async function renderTrendChart(){const e=document.getElementById("trendChart");if(!e)return void console.error("Trend chart canvas not found");const t=document.querySelector(".trend-chart-container");e.style.width="100%",e.style.height="auto";const n=window.getComputedStyle(t),o=parseFloat(n.paddingLeft)+parseFloat(n.paddingRight),a=t.clientWidth-o,i=Math.min(a,800);e.width=i,e.height=296;const r=e.getContext("2d"),s=await getLast30DaysCompletedData();if(r.clearRect(0,0,e.width,e.height),0===s.length)return r.fillStyle="#6b7280",r.font="14px Inter",r.textAlign="center",void r.fillText("No data available for the last 30 days.",e.width/2,e.height/2);const l=50,c=e.width-100,d=e.height-100,u=Math.max(...s.map(e=>e.completed),1);r.strokeStyle="#e5e7eb",r.lineWidth=1,r.beginPath(),r.moveTo(l,l),r.lineTo(l,e.height-l),r.lineTo(e.width-l,e.height-l),r.stroke(),r.font="12px Inter",r.fillStyle="#6b7280",r.textAlign="right";for(let t=0;t<=4;t++){const n=Math.round(u/4*t),o=e.height-l-t/4*d;r.fillText(n.toString(),40,o+3)}r.font="12px Inter",r.fillStyle="#6b7280",r.textAlign="center";const g=Math.ceil(s.length/5);s.forEach((t,n)=>{if(n%g===0||n===s.length-1){const o=l+n/(s.length-1)*c;r.beginPath(),r.moveTo(o,e.height-l),r.lineTo(o,e.height-l+5),r.stroke(),r.fillText(t.dateLabel,o,e.height-l+25)}}),r.strokeStyle="#3b82f6",r.lineWidth=2,r.beginPath();const m=s.map((t,n)=>({x:l+n/(s.length-1)*c,y:e.height-l-t.completed/u*d}));if(m.length>1){r.moveTo(m[0].x,m[0].y);for(let e=0;e<m.length-1;e++){const t=m[e],n=m[e+1],o=(t.x+n.x)/2,a=t.y,i=(t.x+n.x)/2,s=n.y;r.bezierCurveTo(o,a,i,s,n.x,n.y)}}r.stroke()}function renderDashboardCalendar(){const e=document.getElementById("calendarDates"),t=document.getElementById("calendarMonthYear");if(!e||!t)return;const n=new Date,o=n.getMonth(),a=n.getFullYear();t.textContent=`${["January","February","March","April","May","June","July","August","September","October","November","December"][o]} ${a}`;const i=new Date(a,o,1),r=(new Date(a,o+1,0),new Date(i));r.setDate(r.getDate()-i.getDay()),e.innerHTML="";for(let t=0;t<42;t++){const a=new Date(r);a.setDate(r.getDate()+t);const i=document.createElement("div");i.className="calendar-date",i.textContent=a.getDate(),a.getMonth()!==o&&i.classList.add("other-month"),a.toDateString()===n.toDateString()&&i.classList.add("today");const s=new Date(a);i.addEventListener("click",function(e){console.log("Single click on date:",s.toLocaleDateString())}),i.addEventListener("dblclick",function(e){e.preventDefault(),console.log("Double click on date:",s.toLocaleDateString());const t=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`;window.location.href=`appointments.html?date=${t}&view=day`}),e.appendChild(i)}}function mapServiceName(e){return{Cleaning:"Preventive",Examination:"Preventive","Root Canal":"Root Canals",Filling:"Restorations",Orthodontics:"Orthodontics","Teeth Whitening":"Cosmetic",Periodontal:"Periodontics",Restorative:"Restorations",Extraction:"Extraction",Implant:"Implant"}[e]||e}document.addEventListener("DOMContentLoaded",function(){testFirebaseConnection(),initializeAuthSystem()}),window.handleConfirmAction=async function(e){if(confirm("Please confirm if you want to CONFIRM this appointment?"))try{window.dataManager&&dataManager.removePendingConfirmation&&(await dataManager.removePendingConfirmation(e),"function"==typeof showSuccessMessage&&showSuccessMessage("Appointment confirmed!"),await refreshDashboardData())}catch(e){console.error("Error confirming appointment:",e)}},window.handleDeclineAction=async function(e){if(confirm("Please confirm if you want to DECLINE this appointment?"))try{window.dataManager&&dataManager.removePendingConfirmation&&(dataManager.removePendingConfirmation(e),"function"==typeof showSuccessMessage&&showSuccessMessage("Appointment declined!"),await refreshDashboardData())}catch(e){console.error("Error declining appointment:",e)}};let pollingInterval=null,lastPendingCount=0;async function pollPendingAppointments(){try{if(!window.firebaseDataService)return;const e=await getUserRole(),t=getAccessibleClinics();if(!e||0===t.length)return;const n=await window.firebaseDataService.getPendingAppointmentsCount(e,t);console.log(`üì¨ Pending appointments check: ${n}`),updateNotificationBell(n>0);const o=document.getElementById("pendingConfirmationCount");o&&(o.textContent=n),n>lastPendingCount&&console.log(`üîî New pending appointments detected: ${n-lastPendingCount} new`),lastPendingCount=n}catch(e){console.error("Error polling pending appointments:",e)}}async function initializePollingSystem(){try{if(!window.firebaseDataService)return console.log("Waiting for Firebase Data Service..."),void setTimeout(initializePollingSystem,500);console.log("üîÑ Initializing polling-based notification system (30 min interval)"),await pollPendingAppointments(),pollingInterval=setInterval(pollPendingAppointments,18e5),console.log("‚úÖ Polling system initialized")}catch(e){console.error("Error initializing polling system:",e)}}function updateNotificationBell(e){const t=document.getElementById("notificationBell");t&&(e?t.classList.add("has-notifications"):t.classList.remove("has-notifications"))}function handleNotificationBellClick(){window.location.href="patients.html"}function cleanupPollingSystem(){pollingInterval&&(clearInterval(pollingInterval),pollingInterval=null,console.log("üßπ Polling system cleaned up"))}async function updateDashboardStats(){try{if(!window.firebaseDataService)return void console.log("Firebase Data Service not ready for stats update");const e=await getUserRole(),t=getAccessibleClinics();if(!e||0===t.length)return void console.log("No role or clinics found, keeping stats at 0");console.log("Updating dashboard stats for role:",e,"clinics:",t);const n=await window.dataManager.getAllAppointments();if(!Array.isArray(n))return void console.warn("No appointments data available");const o=calculateAppointmentStatsWithComparison(n);updateStatsDisplayWithComparison(o),console.log("Dashboard stats updated:",o)}catch(e){console.error("Error updating dashboard stats:",e)}}function calculateAppointmentStatsWithComparison(e){const t=new Date,n=t.getMonth(),o=t.getFullYear(),a=0===n?11:n-1,i=0===n?o-1:o,r=e.filter(e=>{if(!e.dateKey)return!1;const t=new Date(e.dateKey);return t.getMonth()===n&&t.getFullYear()===o}),s=e.filter(e=>{if(!e.dateKey)return!1;const t=new Date(e.dateKey);return t.getMonth()===a&&t.getFullYear()===i}),l=r.length,c={completed:0,inProgress:0,scheduled:0,noShow:0,total:l,appointmentChange:l-s.length,newPatients:0,newPatientsChange:0,vips:0,pending:0};r.forEach(e=>{const t=e.status?.toLowerCase();switch(t){case"completed":c.completed++;break;case"in-progress":case"arrived":c.inProgress++;break;case"scheduled":case"confirmed":c.scheduled++;break;case"no-show":c.noShow++;break;case"pending":c.pending++}});const d=new Set,u=new Set;r.forEach(e=>{e.phone&&d.add(e.phone)}),s.forEach(e=>{e.phone&&u.add(e.phone)}),c.newPatients=d.size;const g=u.size;return c.newPatientsChange=c.newPatients-g,c.vips=Math.floor(.1*c.newPatients),c}function calculateAppointmentStats(e){return calculateAppointmentStatsWithComparison(e)}function updateStatsDisplayWithComparison(e){const t=document.getElementById("completedCount"),n=document.getElementById("inProgressCount"),o=document.getElementById("scheduledCount"),a=document.getElementById("noShowCount");t&&(t.textContent=e.completed),n&&(n.textContent=e.inProgress),o&&(o.textContent=e.scheduled),a&&(a.textContent=e.noShow);const i=document.getElementById("allAppointmentsCount"),r=document.getElementById("allAppointmentsChange");if(i&&(i.textContent=e.total),r){const t=e.appointmentChange>=0?`+${e.appointmentChange}`:e.appointmentChange;r.textContent=`${t} vs last month`,r.className="change-indicator "+(e.appointmentChange>=0?"positive":"negative")}const s=document.getElementById("newPatientsCount"),l=document.getElementById("newPatientsChange");if(s&&(s.textContent=e.newPatients),l){const t=e.newPatientsChange>=0?`+${e.newPatientsChange}`:e.newPatientsChange;l.textContent=`${t} vs last month`,l.className="change-indicator "+(e.newPatientsChange>=0?"positive":"negative")}const c=document.getElementById("premiumMembersCount");c&&(c.textContent=e.vips);const d=document.getElementById("pendingConfirmationCount");d&&e.pending>0&&(d.textContent=e.pending)}function updateStatsDisplay(e){updateStatsDisplayWithComparison(e)}document.addEventListener("DOMContentLoaded",function(){setTimeout(initializePollingSystem,1e3);const e=document.getElementById("notificationBell");e&&e.addEventListener("click",handleNotificationBellClick)}),window.addEventListener("beforeunload",cleanupPollingSystem);