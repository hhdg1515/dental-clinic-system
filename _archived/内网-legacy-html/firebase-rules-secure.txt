rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user data from database
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is owner (has access to all clinics)
    function isOwner() {
      return isAuthenticated() && getUserData().role == 'owner';
    }

    // Check if user is admin (has access to specific clinics)
    function isAdmin() {
      return isAuthenticated() && getUserData().role in ['owner', 'admin'];
    }

    // Check if admin has access to specific clinic
    function hasClinicAccess(clinicId) {
      let userData = getUserData();
      return userData.role == 'owner' || clinicId in userData.clinics;
    }

    // Check if user owns the resource (based on userId field)
    function isOwnerOf(resource) {
      return isAuthenticated() && request.auth.uid == resource.data.userId;
    }

    // Check if user owns the resource being created
    function isCreatingOwnResource() {
      return isAuthenticated() && request.auth.uid == request.resource.data.userId;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can only read their own profile
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||  // Own profile
        isAdmin()                       // Admin can read user profiles
      );

      // Users can only write their own profile (excluding role/clinics fields)
      // Admins cannot write to prevent client-side privilege escalation
      allow create: if isAuthenticated() && request.auth.uid == userId &&
        request.resource.data.uid == userId &&
        request.resource.data.email == request.auth.token.email;

      allow update: if isAuthenticated() && request.auth.uid == userId &&
        // Prevent modification of security-critical fields
        request.resource.data.role == resource.data.role &&
        request.resource.data.clinics == resource.data.clinics &&
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.email == resource.data.email &&
        // Allow modification of non-critical fields (lastLogin, displayName, photoURL, etc.)
        // The above checks ensure security-critical fields remain unchanged
        true;

      // Only owner can delete users
      allow delete: if isOwner();
    }

    // ============================================
    // APPOINTMENTS COLLECTION (Flat Structure)
    // ============================================
    match /appointments/{appointmentId} {
      // Read: Owner can read all, customer can read their own, admin can read their clinic's
      allow read: if isAuthenticated() && (
        isOwnerOf(resource) ||                    // User owns the appointment
        isOwner() ||                              // Owner role has full access
        (isAdmin() && hasClinicAccess(resource.data.clinicLocation))  // Admin has clinic access
      );

      // Create: Users can create appointments for themselves or admins can create for any
      allow create: if isAuthenticated() && (
        isCreatingOwnResource() ||                // Creating own appointment
        isAdmin()                                 // Admin can create appointments
      ) &&
        // Validate required fields exist
        request.resource.data.keys().hasAll(['userId', 'clinicLocation', 'patientName', 'patientPhone']) &&
        // Validate clinic location is valid
        request.resource.data.clinicLocation in ['arcadia', 'irvine', 'south-pasadena', 'rowland-heights', 'eastvale'] &&
        // If admin is creating, they must have access to the clinic
        (!isAdmin() || hasClinicAccess(request.resource.data.clinicLocation));

      // Update: Owner of appointment or admin with clinic access
      allow update: if isAuthenticated() && (
        isOwnerOf(resource) ||                    // User owns the appointment
        isOwner() ||                              // Owner role has full access
        (isAdmin() && hasClinicAccess(resource.data.clinicLocation))  // Admin has clinic access
      ) &&
        // Prevent changing the userId (owner)
        request.resource.data.userId == resource.data.userId;

      // Delete: Only owner or admin with clinic access
      allow delete: if isAuthenticated() && (
        isOwner() ||                              // Owner role has full access
        (isAdmin() && hasClinicAccess(resource.data.clinicLocation))  // Admin has clinic access
      );
    }

    // ============================================
    // APPOINTMENTS COLLECTION (Nested by Clinic)
    // ============================================
    match /appointments/{clinicId}/dates/{dateKey}/appointments/{appointmentId} {
      allow read: if isAuthenticated() && (
        isOwnerOf(resource) ||
        isOwner() ||
        (isAdmin() && hasClinicAccess(clinicId))
      );

      allow write: if isAuthenticated() && (
        isOwner() ||
        (isAdmin() && hasClinicAccess(clinicId))
      );
    }

    match /appointments/{clinicId}/appointments/{appointmentId} {
      allow read: if isAuthenticated() && (
        isOwnerOf(resource) ||
        isOwner() ||
        (isAdmin() && hasClinicAccess(clinicId))
      );

      allow write: if isAuthenticated() && (
        isOwner() ||
        (isAdmin() && hasClinicAccess(clinicId))
      );
    }

    // ============================================
    // CANCELLED APPOINTMENTS
    // ============================================
    match /cancelledAppointments/{clinicId}/appointments/{appointmentId} {
      allow read: if isAuthenticated() && (
        isOwner() ||
        (isAdmin() && hasClinicAccess(clinicId))
      );

      allow write: if isAuthenticated() && (
        isOwner() ||
        (isAdmin() && hasClinicAccess(clinicId))
      );
    }

    // ============================================
    // PENDING CONFIRMATIONS
    // ============================================
    match /pendingConfirmations/{confirmationId} {
      // Read: Owner and admin can read, customer can read their own
      allow read: if isAuthenticated() && (
        isOwnerOf(resource) ||
        isAdmin()
      );

      // Write: Only admin and owner can write confirmations
      allow write: if isAdmin();
    }

    // ============================================
    // PATIENT PROFILES (Sensitive PHI/PII Data)
    // ============================================
    match /patientProfiles/{patientId} {
      // Read: Patient owns profile OR admin with clinic access
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||  // Patient owns profile
        isOwner() ||                                  // Owner has full access
        (isAdmin() && resource.data.clinicLocation != null && hasClinicAccess(resource.data.clinicLocation))
      );

      // Create: User creating own profile or admin creating
      allow create: if isAuthenticated() && (
        request.auth.uid == request.resource.data.userId ||  // Creating own profile
        isAdmin()
      );

      // Update: Only admin can update patient profiles (not patients themselves for data integrity)
      allow update: if isAdmin();

      // Delete: Only owner can delete patient profiles
      allow delete: if isOwner();
    }

    // ============================================
    // MEDICAL RECORDS (HIPAA Sensitive Data)
    // ============================================
    match /medicalRecords/{recordId} {
      // Only admin can access medical records
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ============================================
    // AUDIT LOGS (Write-only for security)
    // ============================================
    match /auditLogs/{logId} {
      // Only authenticated users can create logs
      allow create: if isAuthenticated();

      // Only owner can read audit logs
      allow read: if isOwner();

      // No one can update or delete logs (immutable)
      allow update: if false;
      allow delete: if false;
    }

    // ============================================
    // DEFAULT DENY ALL
    // ============================================
    // All other collections are denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
