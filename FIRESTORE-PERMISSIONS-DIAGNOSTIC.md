# Firestore æƒé™é—®é¢˜è¯Šæ–­æŒ‡å—

## é”™è¯¯ç—‡çŠ¶

```
Error getting appointments for date: FirebaseError: Missing or insufficient permissions.
```

æ•°æ®å®Œå…¨æ— æ³•è¯»å–ï¼š
- ğŸ“­ é¢„çº¦ä¸ºç©º
- ğŸ“­ æ‚£è€…å†å²ä¸ºç©º
- ğŸ“­ åŒ»ç–—è®°å½•ä¸ºç©º

ç™»å½•æˆåŠŸ âœ…ï¼Œä½† Firestore æŸ¥è¯¢å¤±è´¥ âŒ

---

## æ ¹æœ¬åŸå› åˆ†æ

### å¯èƒ½åŸå›  1: Firebase Console è§„åˆ™è¿‡äºä¸¥æ ¼ (æœ€å¯èƒ½ - 80%)

**ç—‡çŠ¶**:
- ä»£ç æ²¡æœ‰é”™è¯¯
- è®¤è¯å·¥ä½œæ­£å¸¸
- åªæœ‰ Firestore è¯»å†™å¤±è´¥
- é”™è¯¯ä¿¡æ¯ï¼š"Missing or insufficient permissions"

**è§£å†³æ–¹æ¡ˆ**: è§ä¸‹æ–‡ "å¿«é€Ÿä¿®å¤æ­¥éª¤"

### å¯èƒ½åŸå›  2: ç”¨æˆ·ç¼ºå°‘ role/clinics å­—æ®µ

**ç—‡çŠ¶**:
- ç”¨æˆ·åœ¨ Firebase Console â†’ Authentication ä¸­å­˜åœ¨
- ä½†ç”¨æˆ·æ–‡æ¡£åœ¨ `/users/{uid}` ä¸­ç¼ºå°‘ `role` å’Œ `clinics` å­—æ®µ
- RBAC è§„åˆ™æ— æ³•éªŒè¯ç”¨æˆ·æƒé™

**æ£€æŸ¥æ–¹æ³•**:
```
Firebase Console:
1. Firestore Database â†’ Collections
2. ç‚¹å‡» "users" collection
3. æ‰¾åˆ°ä½ çš„ç”¨æˆ· (uid å¯¹åº” auth uid)
4. æ£€æŸ¥æ˜¯å¦æœ‰è¿™äº›å­—æ®µ:
   âœ“ role: "admin" æˆ– "owner"
   âœ“ clinics: ["arcadia", "irvine", ...]
   âœ“ email: "admin@..."
```

### å¯èƒ½åŸå›  3: åº”ç”¨è¿æ¥åˆ°é”™è¯¯çš„ Firebase é¡¹ç›®

**ç—‡çŠ¶**:
- å¤šä¸ª Firebase é¡¹ç›®
- åº”ç”¨è¿æ¥åˆ°ä¸åŒçš„é¡¹ç›®
- æ•°æ®åœ¨å¦ä¸€ä¸ªé¡¹ç›®ä¸­

**æ£€æŸ¥æ–¹æ³•**:
```
F12 â†’ Console è¾“å…¥:
console.log(firebase.app().options.projectId)

åº”è¯¥è¾“å‡º: dental-clinic-demo-ce94b
```

---

## å¿«é€Ÿè¯Šæ–­æ¸…å•

### â–¡ Step 1: ç¡®è®¤å½“å‰è§„åˆ™

```
Firebase Console:
1. Firestore Database â†’ Rules æ ‡ç­¾é¡µ
2. è®°ä¸‹å½“å‰æ˜¾ç¤ºçš„è§„åˆ™ (æ˜¯å“ªä¸ªæ–‡ä»¶?)
3. æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥æ ¼çš„æƒé™æ£€æŸ¥
```

**ä½ ä¼šçœ‹åˆ°ä»¥ä¸‹ä¹‹ä¸€**:
- âœ… å¼€å‘è§„åˆ™ (allow read, write: if request.auth != null)
- âš ï¸ ç”Ÿäº§è§„åˆ™ (isAdmin() æ£€æŸ¥ï¼Œå¯èƒ½å¤ªä¸¥æ ¼)
- âš ï¸ å®‰å…¨è§„åˆ™ (RBACï¼Œéœ€è¦ç”¨æˆ·æ•°æ®)

### â–¡ Step 2: æ£€æŸ¥ç”¨æˆ·æ•°æ®

```
Firebase Console:
1. Firestore â†’ Collections â†’ users
2. æ‰¾åˆ°ä½ ç™»å½•çš„ç”¨æˆ· (uid åº”è¯¥åŒ¹é…)
3. æ£€æŸ¥å­—æ®µ:
   - role: _______ (åº”è¯¥æ˜¯ "owner" æˆ– "admin")
   - clinics: _______ (åº”è¯¥æœ‰è¯Šæ‰€åˆ—è¡¨)
   - email: _______ (åº”è¯¥åŒ¹é…ç™»å½•é‚®ç®±)
```

### â–¡ Step 3: æµ‹è¯•è§„åˆ™

æ‰“å¼€ Firebase Console:
```
1. Firestore â†’ Rules æ ‡ç­¾é¡µ
2. ç‚¹å‡» "Rules playground" (å¦‚æœå¯ç”¨)
3. é€‰æ‹©ä¸€ä¸ªç”¨æˆ· uid
4. å°è¯•æŸ¥è¯¢ /appointments
5. æŸ¥çœ‹æ˜¯å¦å…è®¸è®¿é—®
```

### â–¡ Step 4: æ£€æŸ¥ Network è¯·æ±‚

```
F12 â†’ Network æ ‡ç­¾:
1. åˆ·æ–°åº”ç”¨
2. æ‰¾åˆ°å¯¹ firestore.googleapis.com çš„è¯·æ±‚
3. æŸ¥çœ‹å“åº”:
   - çŠ¶æ€ 200 = æˆåŠŸ
   - çŠ¶æ€ 403 = æƒé™è¢«æ‹’ç»
   - çœ‹å“åº”ä½“ä¸­çš„é”™è¯¯ä¿¡æ¯
```

---

## å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä½¿ç”¨å¼€å‘è§„åˆ™ (å¿«é€Ÿ)

**é€‚ç”¨äº**: å¼€å‘/æµ‹è¯•ç¯å¢ƒ

1. æ‰“å¼€ FIRESTORE-RULES-QUICK-FIX.md
2. å¤åˆ¶"ä¸´æ—¶è§„åˆ™"ä»£ç 
3. ç²˜è´´åˆ° Firebase Console Rules ç¼–è¾‘å™¨
4. ç‚¹å‡» Publish
5. åˆ·æ–°åº”ç”¨æµ‹è¯•

### æ–¹æ¡ˆ B: ä¿®å¤ç”¨æˆ·æ•°æ®

å¦‚æœä½¿ç”¨ RBAC è§„åˆ™ï¼Œç¡®ä¿ç”¨æˆ·æœ‰æ­£ç¡®çš„å­—æ®µï¼š

```
Firebase Console:
1. Firestore â†’ Collections â†’ users â†’ ä½ çš„ uid
2. ç¼–è¾‘æ–‡æ¡£ï¼Œæ·»åŠ å­—æ®µ:

{
  "uid": "user-uid-here",
  "email": "admin@firstavedental.com",
  "role": "owner",              // é‡è¦!
  "clinics": {                  // é‡è¦!
    "arcadia": true,
    "irvine": true,
    "pasadena": true,
    "rowland-heights": true,
    "eastvale": true
  },
  "displayName": "Admin Name",
  "photoURL": "",
  "createdAt": <timestamp>,
  "lastLogin": <timestamp>
}
```

### æ–¹æ¡ˆ C: åˆ‡æ¢åˆ°æ­£ç¡®çš„è§„åˆ™

å¦‚æœåº”è¯¥ç”¨ RBAC è§„åˆ™ä½† Firebase ä¸­è¿˜æ˜¯å¼€å‘è§„åˆ™ï¼š

1. æ‰“å¼€ firebase-rules-secure.txt (æœ€å®‰å…¨)
2. æˆ– firebase-rules-production.txt (æ ‡å‡†)
3. å¤åˆ¶å®Œæ•´ä»£ç 
4. ç²˜è´´åˆ° Firebase Console
5. ç¡®ä¿æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ­£ç¡®çš„ role/clinics
6. å‘å¸ƒè§„åˆ™

---

## å½“å‰æ–‡ä»¶å¯¹åº”å…³ç³»

| æ–‡ä»¶ | ç±»å‹ | ç”¨é€” | æ˜¯å¦å®‰å…¨ |
|------|------|------|--------|
| firebase-rules-temp.txt | å¼€å‘ | æµ‹è¯• | âŒ å¦ |
| firebase-rules-production.txt | æ ‡å‡† | åŸºç¡€æƒé™ | âš ï¸ ä¸­ç­‰ |
| firebase-rules-secure.txt | RBAC | ç”Ÿäº§çº§ | âœ… æ˜¯ |

**æ¨è**:
- å¼€å‘: ä½¿ç”¨ `temp.txt`
- ç”Ÿäº§: ä½¿ç”¨ `secure.txt` + æ­£ç¡®çš„ç”¨æˆ·æ•°æ®

---

## ä¿®å¤åçš„éªŒè¯

ä¿®å¤ååº”è¯¥çœ‹åˆ°:

```
âœ… é¢„çº¦æ•°æ®åŠ è½½æˆåŠŸ
âœ… æ—¥æœŸèŒƒå›´æŸ¥è¯¢æœ‰æ•°æ®
âœ… æ‚£è€…å†å²æ˜¾ç¤º
âœ… F12 Console æ— æƒé™é”™è¯¯
âœ… Network è¯·æ±‚è¿”å› 200 çŠ¶æ€

ç¤ºä¾‹æ—¥å¿—:
firebase-data-service.js:238  ğŸ” Querying appointments for date: 2025-11-14
firebase-data-service.js:241  âœ… Found 3 appointments for 2025-11-14
```

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¹‹å‰æœ‰æ•°æ®ç°åœ¨æ²¡æœ‰äº†?
**A**: å¯èƒ½åŸå› ï¼š
1. è§„åˆ™è¢«æ„å¤–æ›´æ–°ä¸ºé™åˆ¶æ€§è§„åˆ™
2. ç”¨æˆ·è¢«åˆ é™¤æˆ–ç¦ç”¨
3. æ•°æ®è¢«æ„å¤–åˆ é™¤
4. è¿æ¥åˆ°äº†ä¸åŒçš„ Firebase é¡¹ç›®

### Q: æˆ‘æ˜¯å¦åº”è¯¥ç”¨ `allow read, write: if true`?
**A**:
- âŒ **ä¸** ç”¨äºç”Ÿäº§ç¯å¢ƒ (ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®)
- âœ… **å¯ä»¥** ç”¨äºå¼€å‘/æµ‹è¯•ä¸´æ—¶è¯Šæ–­
- âœ… è¯Šæ–­åç«‹å³åˆ‡æ¢åˆ°å®‰å…¨è§„åˆ™

### Q: å¦‚ä½•çŸ¥é“ä½¿ç”¨å“ªä¸ªè§„åˆ™æ–‡ä»¶?
**A**:
- å¼€å‘: temp.txt
- ç”Ÿäº§: secure.txt (éœ€è¦ç”¨æˆ· role/clinics)

---

## åç»­è¡ŒåŠ¨

1. âœ… éµå¾ªä¸Šé¢çš„è¯Šæ–­æ­¥éª¤
2. âœ… ç¡®å®šçœŸæ­£çš„é—®é¢˜åŸå› 
3. âœ… åº”ç”¨ç›¸åº”çš„è§£å†³æ–¹æ¡ˆ
4. âœ… æµ‹è¯•æ•°æ®æ˜¯å¦åŠ è½½
5. âœ… å¦‚æœæˆåŠŸï¼Œæäº¤æ­£ç¡®çš„è§„åˆ™åˆ° Firebase

---

**çŠ¶æ€**: ğŸ”§ è¯Šæ–­æŒ‡å—
**æœ€åæ›´æ–°**: 2025-11-14
**é¢„è®¡è§£å†³æ—¶é—´**: 5-10 åˆ†é’Ÿ
