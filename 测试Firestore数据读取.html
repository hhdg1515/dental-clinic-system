<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore æ•°æ®è¯»å–æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-item {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
            max-height: 400px;
        }
        #loginSection { margin-bottom: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ğŸ” Firestore æ•°æ®è¯»å–æµ‹è¯•</h1>

    <div id="loginSection" class="test-item info">
        <h3>æ­¥éª¤1: ç™»å½•</h3>
        <input type="email" id="email" placeholder="é‚®ç®±" value="manager1@firstavedental.com">
        <input type="password" id="password" placeholder="å¯†ç " value="">
        <button onclick="login()">ç™»å½•</button>
        <div id="loginStatus"></div>
    </div>

    <div id="testSection" class="hidden">
        <div class="test-item info">
            <h3>æ­¥éª¤2: æµ‹è¯•æ•°æ®è¯»å–</h3>
            <button onclick="testAppointments()">æµ‹è¯•è¯»å– appointments</button>
            <button onclick="testUsers()">æµ‹è¯•è¯»å– users</button>
            <button onclick="testPatientProfiles()">æµ‹è¯•è¯»å– patientProfiles</button>
            <button onclick="testMedicalRecords()">æµ‹è¯•è¯»å– medicalRecords</button>
            <button onclick="testAll()">æµ‹è¯•æ‰€æœ‰é›†åˆ</button>
        </div>
    </div>

    <div id="results"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCCJbTwnqQo4CcUM-jDSaTC-hdpMcBTX4c",
            authDomain: "dental-clinic-demo-ce94b.firebaseapp.com",
            projectId: "dental-clinic-demo-ce94b",
            storageBucket: "dental-clinic-demo-ce94b.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;

        const results = document.getElementById('results');
        const loginStatus = document.getElementById('loginStatus');
        const loginSection = document.getElementById('loginSection');
        const testSection = document.getElementById('testSection');

        function addResult(title, message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-item ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${message}</pre>`;
            results.appendChild(div);
            // æ»šåŠ¨åˆ°åº•éƒ¨
            div.scrollIntoView({ behavior: 'smooth' });
        }

        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // è·å–ID Tokenå’ŒClaims
                const idTokenResult = await user.getIdTokenResult();

                loginStatus.innerHTML = `
                    <div style="color: green; margin-top: 10px;">
                        âœ… ç™»å½•æˆåŠŸï¼<br>
                        ç”¨æˆ·: ${user.email}<br>
                        UID: ${user.uid}<br>
                        Role (ä»claims): ${idTokenResult.claims.role || 'æœªè®¾ç½®'}<br>
                        Clinics (ä»claims): ${JSON.stringify(idTokenResult.claims.clinics) || 'æœªè®¾ç½®'}
                    </div>
                `;

                testSection.classList.remove('hidden');

                addResult('âœ… ç™»å½•æˆåŠŸ',
                    `é‚®ç®±: ${user.email}\n` +
                    `UID: ${user.uid}\n` +
                    `Role: ${idTokenResult.claims.role || 'æœªè®¾ç½®'}\n` +
                    `Clinics: ${JSON.stringify(idTokenResult.claims.clinics) || 'æœªè®¾ç½®'}`,
                    'success');

            } catch (error) {
                loginStatus.innerHTML = `<div style="color: red; margin-top: 10px;">âŒ ${error.message}</div>`;
                addResult('âŒ ç™»å½•å¤±è´¥',
                    `é”™è¯¯ä»£ç : ${error.code}\né”™è¯¯æ¶ˆæ¯: ${error.message}`,
                    'error');
            }
        };

        async function testCollection(collectionName, limitCount = 10) {
            addResult(`ğŸ” æµ‹è¯•é›†åˆ: ${collectionName}`, 'å¼€å§‹è¯»å–...', 'info');

            try {
                const q = query(collection(db, collectionName), limit(limitCount));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    addResult(`âš ï¸ ${collectionName} - é›†åˆä¸ºç©º`,
                        `é›†åˆå­˜åœ¨ä½†æ²¡æœ‰æ•°æ®`,
                        'info');
                } else {
                    const docs = [];
                    querySnapshot.forEach((doc) => {
                        docs.push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });

                    addResult(`âœ… ${collectionName} - è¯»å–æˆåŠŸ`,
                        `æ‰¾åˆ° ${docs.length} æ¡è®°å½•\n\n` +
                        `å‰3æ¡æ•°æ®:\n${JSON.stringify(docs.slice(0, 3), null, 2)}`,
                        'success');
                }

            } catch (error) {
                let errorType = 'error';
                let diagnosis = '';

                if (error.code === 'permission-denied') {
                    diagnosis = `\n\nğŸ”’ æƒé™è¢«æ‹’ç»ï¼\n` +
                        `è¿™è¯´æ˜Firestoreå®‰å…¨è§„åˆ™é˜»æ­¢äº†ä½ è®¿é—®è¿™ä¸ªé›†åˆã€‚\n\n` +
                        `å¯èƒ½çš„åŸå› :\n` +
                        `1. å½“å‰ç”¨æˆ· (${auth.currentUser?.email}) æ²¡æœ‰è®¿é—®æƒé™\n` +
                        `2. Firestoreè§„åˆ™è¦æ±‚ç‰¹å®šçš„roleæˆ–claims\n` +
                        `3. è§„åˆ™é…ç½®é”™è¯¯\n\n` +
                        `è§£å†³æ–¹æ¡ˆ:\n` +
                        `- æ£€æŸ¥ Firebase Console â†’ Firestore â†’ Rules\n` +
                        `- ç¡®ä¿è§„åˆ™å…è®¸å½“å‰ç”¨æˆ·è®¿é—®\n` +
                        `- æ£€æŸ¥ç”¨æˆ·çš„Custom Claimsæ˜¯å¦æ­£ç¡®è®¾ç½®`;
                } else if (error.code === 'unavailable') {
                    diagnosis = `\n\nğŸŒ æœåŠ¡ä¸å¯ç”¨\n` +
                        `FirestoreæœåŠ¡æš‚æ—¶æ— æ³•è®¿é—®ã€‚\n` +
                        `è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚`;
                }

                addResult(`âŒ ${collectionName} - è¯»å–å¤±è´¥`,
                    `é”™è¯¯ä»£ç : ${error.code}\n` +
                    `é”™è¯¯æ¶ˆæ¯: ${error.message}\n` +
                    `${diagnosis}`,
                    'error');
            }
        }

        window.testAppointments = () => testCollection('appointments');
        window.testUsers = () => testCollection('users');
        window.testPatientProfiles = () => testCollection('patientProfiles');
        window.testMedicalRecords = () => testCollection('medicalRecords');

        window.testAll = async function() {
            const collections = [
                'appointments',
                'users',
                'patientProfiles',
                'medicalRecords',
                'auditLogs',
                'dentalCharts',
                'pendingConfirmations'
            ];

            addResult('ğŸš€ å¼€å§‹æµ‹è¯•æ‰€æœ‰é›†åˆ', `å°†æµ‹è¯• ${collections.length} ä¸ªé›†åˆ`, 'info');

            for (const coll of collections) {
                await testCollection(coll, 5);
                // ç¨å¾®å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            addResult('âœ… æµ‹è¯•å®Œæˆ', `å·²æµ‹è¯•æ‰€æœ‰ ${collections.length} ä¸ªé›†åˆ`, 'success');
        };
    </script>
</body>
</html>
