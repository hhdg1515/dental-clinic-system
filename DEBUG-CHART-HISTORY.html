<!DOCTYPE html>
<html>
<head>
    <title>Debug Chart History Permissions</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #0e4429; border: 1px solid #2ea043; }
        .error { background: #5a1e1e; border: 1px solid #f85149; }
        .info { background: #1f3a5f; border: 1px solid #58a6ff; }
        button { background: #238636; color: white; border: none; padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        button:hover { background: #2ea043; }
        pre { background: #0d1117; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Chart History æƒé™è°ƒè¯•å·¥å…·</h1>

    <div id="status"></div>

    <button onclick="checkAuth()">1. æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
    <button onclick="checkFirebaseConfig()">2. æ£€æŸ¥ Firebase é…ç½®</button>
    <button onclick="testSnapshotPermission()">3. æµ‹è¯•å¿«ç…§æƒé™</button>
    <button onclick="viewFirebaseRules()">4. æŸ¥çœ‹å½“å‰è§„åˆ™ï¼ˆéœ€æ‰‹åŠ¨ï¼‰</button>

    <div id="output"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

        // ä»ä½ çš„ firebase-config.js è·å–é…ç½®
        const firebaseConfig = {
            // ä½ éœ€è¦å¡«å…¥ä½ çš„å®é™…é…ç½®
            // å¯ä»¥ä» firebase-config.js å¤åˆ¶
        };

        let app, auth, db;

        window.initFirebase = async function() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                window.firebaseApp = app;
                window.firebaseAuth = auth;
                window.firebaseDb = db;

                return { app, auth, db };
            } catch (error) {
                console.error('Firebase init error:', error);
                throw error;
            }
        };

        // è‡ªåŠ¨åˆå§‹åŒ–
        window.initFirebase();
    </script>

    <script>
        const output = document.getElementById('output');
        const status = document.getElementById('status');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            output.appendChild(div);
            console.log(message);
        }

        // 1. æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            output.innerHTML = '';
            log('ğŸ” æ£€æŸ¥è®¤è¯çŠ¶æ€...', 'info');

            try {
                const auth = window.firebaseAuth;
                const user = auth.currentUser;

                if (user) {
                    log(`âœ… ç”¨æˆ·å·²ç™»å½•<br>
                         UID: ${user.uid}<br>
                         Email: ${user.email || 'N/A'}<br>
                         Provider: ${user.providerData[0]?.providerId || 'N/A'}`, 'success');
                } else {
                    log('âŒ ç”¨æˆ·æœªç™»å½•ï¼<br>è¯·å…ˆç™»å½•ä½ çš„åº”ç”¨', 'error');
                    log('ğŸ’¡ æç¤ºï¼šåœ¨ä½ çš„ä¸»åº”ç”¨ä¸­ç™»å½•åå†è¿è¡Œæ­¤æµ‹è¯•', 'info');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 2. æ£€æŸ¥ Firebase é…ç½®
        async function checkFirebaseConfig() {
            output.innerHTML = '';
            log('ğŸ” æ£€æŸ¥ Firebase é…ç½®...', 'info');

            try {
                const app = window.firebaseApp;
                const config = app.options;

                log(`<pre>Firebase é¡¹ç›®é…ç½®:
Project ID: ${config.projectId}
Auth Domain: ${config.authDomain}
Database URL: ${config.databaseURL || 'N/A'}
Storage Bucket: ${config.storageBucket}</pre>`, 'success');
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. æµ‹è¯•å¿«ç…§æƒé™
        async function testSnapshotPermission() {
            output.innerHTML = '';
            log('ğŸ” æµ‹è¯• dentalChartSnapshots é›†åˆæƒé™...', 'info');

            try {
                const db = window.firebaseDb;
                const auth = window.firebaseAuth;
                const user = auth.currentUser;

                if (!user) {
                    log('âŒ è¯·å…ˆç™»å½•ï¼', 'error');
                    return;
                }

                log(`ğŸ“ å½“å‰ç”¨æˆ·: ${user.uid}`, 'info');

                // å°è¯•åˆ›å»ºæµ‹è¯•å¿«ç…§
                log('ğŸ“¤ å°è¯•åˆ›å»ºæµ‹è¯•å¿«ç…§...', 'info');
                const testSnapshot = {
                    userId: 'test_user_' + Date.now(),
                    chartData: { '1': { status: 'healthy' } },
                    description: 'Debug test snapshot',
                    createdAt: new Date().toISOString()
                };

                const docRef = await addDoc(collection(db, 'dentalChartSnapshots'), testSnapshot);
                log(`âœ… åˆ›å»ºæˆåŠŸï¼å¿«ç…§ ID: ${docRef.id}`, 'success');
                log(`âœ… æƒé™é…ç½®æ­£ç¡®ï¼Chart History åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œ`, 'success');

                // å°è¯•è¯»å–
                log('ğŸ“¥ å°è¯•è¯»å–å¿«ç…§...', 'info');
                const q = query(collection(db, 'dentalChartSnapshots'), where('userId', '==', testSnapshot.userId));
                const querySnapshot = await getDocs(q);

                log(`âœ… è¯»å–æˆåŠŸï¼æ‰¾åˆ° ${querySnapshot.size} ä¸ªå¿«ç…§`, 'success');

            } catch (error) {
                log(`âŒ æƒé™æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');

                if (error.code === 'permission-denied') {
                    log(`<br>ğŸ“‹ <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br><br>
                        1. æ‰“å¼€ Firebase Console: <a href="https://console.firebase.google.com/" target="_blank">https://console.firebase.google.com/</a><br>
                        2. é€‰æ‹©ä½ çš„é¡¹ç›®<br>
                        3. è¿›å…¥ Firestore Database â†’ Rules<br>
                        4. æ·»åŠ ä»¥ä¸‹è§„åˆ™ï¼š<br>
                        <pre>match /dentalChartSnapshots/{snapshotId} {
  allow read, write: if request.auth != null;
}</pre>
                        5. ç‚¹å‡» Publish<br>
                        6. ç­‰å¾… 30 ç§’åé‡è¯•`, 'info');
                }

                log(`<br>ğŸ” <strong>è¯¦ç»†é”™è¯¯ï¼š</strong><br><pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
            }
        }

        // 4. æŸ¥çœ‹å½“å‰è§„åˆ™æç¤º
        function viewFirebaseRules() {
            output.innerHTML = '';
            log('ğŸ“‹ è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æŸ¥çœ‹å½“å‰è§„åˆ™ï¼š', 'info');
            log(`
                1. æ‰“å¼€ <a href="https://console.firebase.google.com/" target="_blank" style="color: #58a6ff;">Firebase Console</a><br>
                2. é€‰æ‹©ä½ çš„é¡¹ç›®<br>
                3. å·¦ä¾§èœå• â†’ <strong>Firestore Database</strong><br>
                4. é¡¶éƒ¨ â†’ <strong>Rules</strong> æ ‡ç­¾<br>
                5. æŸ¥çœ‹æ˜¯å¦åŒ…å«ä»¥ä¸‹è§„åˆ™ï¼š<br>
                <pre>match /dentalChartSnapshots/{snapshotId} {
  allow read, write: if request.auth != null;
}</pre>
                6. å¦‚æœæ²¡æœ‰ï¼Œè¯·æ·»åŠ å¹¶ç‚¹å‡» Publish
            `, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.addEventListener('load', () => {
            status.innerHTML = `
                <div class="status info">
                    <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
                    <ol>
                        <li>ç¡®ä¿ä½ å·²åœ¨ä¸»åº”ç”¨ä¸­ç™»å½•</li>
                        <li>æŒ‰é¡ºåºç‚¹å‡»æŒ‰é’® 1 â†’ 2 â†’ 3 è¿›è¡Œæµ‹è¯•</li>
                        <li>å¦‚æœæµ‹è¯• 3 å¤±è´¥ï¼ŒæŒ‰ç…§æç¤ºä¿®å¤ Firebase è§„åˆ™</li>
                        <li>ä¿®å¤åç­‰å¾… 30 ç§’ï¼Œå†æ¬¡è¿è¡Œæµ‹è¯• 3</li>
                    </ol>
                </div>
            `;
        });
    </script>
</body>
</html>
