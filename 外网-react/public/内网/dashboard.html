<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - First Ave Dental</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/glass-effects.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/liquid-glass-modal.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- 认证检查已集成到 dashboard.js 中 -->

    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js';

        // Make Firebase functions available globally
        window.firebaseSDK = {
            initializeApp,
            getAuth,
            GoogleAuthProvider,
            getFirestore,
            getStorage
        };
    </script>
</head>
<body>
    <div class="admin-container">
        <!-- Left Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <i class="fas fa-tooth"></i>
                    <div class="logo-text">
                        <div class="company-name">FIRST AVE DENTAL</div>
                        <div class="company-subtitle">&ORTHODONTICS</div>
                    </div>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item active">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-indent"></i>
                </div>
                <a href="patients.html" class="nav-item">
                    <i class="fas fa-tasks"></i>
                    <span>Appointments</span>
                </a>
                <a href="appointments.html" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
                <a href="#logout" class="nav-item logout" onclick="handleLogout(event); return false;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-actions">
                    <div class="page-title">
                        <h1>Dashboard</h1>
                    </div>
                    <div class="global-search-container">
                        <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Search...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="history-icon" id="historyIcon">
                        <i class="fas fa-users"></i>
                        <div class="tooltip">Accounts</div>
                    </div>
                    <div class="notification-bell" id="notificationBell">
                        <i class="far fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge"></span>
                        <div class="tooltip">Notifications</div>
                    </div>
                    <div class="user-profile">
                        <img class="profile-img" src="./author_lily.jpg" alt="Profile">
                        <div class="user-info">
                            <div class="user-name">Sunny</div>
                            <div class="user-role">Admin</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Location Selector and New Appointment Button -->
                <div class="dashboard-header">
                    <div class="location-selector-container">
                        <select id="locationSelector" class="location-selector" aria-label="Select location">
                            <option value="arcadia">Arcadia</option>
                        </select>
                        <i class="fas fa-chevron-down location-selector-icon"></i>
                    </div>
                    <button class="btn-primary" id="quickAddBtn">
                        <i class="fas fa-plus"></i>
                        New Appointment
                    </button>
                </div>

                <!-- Main Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Left Side: Status Cards -->
                    <div class="dashboard-left">
                        <!-- First Row: Compact Status Cards -->
                        <div class="status-cards-row">
                            <div class="status-card completed">
                                <div class="status-info">
                                    <div class="status-number" id="completedCount">0</div>
                                    <div class="status-label">completed</div>
                                </div>   
                                <div class="status-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            
                            <div class="status-card in-progress">
                                <div class="status-info">
                                    <div class="status-number" id="inProgressCount">0</div>
                                    <div class="status-label">In progress</div>
                                </div>
                                <div class="status-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            
                            <div class="status-card scheduled">
                                <div class="status-info">
                                    <div class="status-number" id="scheduledCount">0</div>
                                    <div class="status-label">scheduled</div>
                                </div>
                                <div class="status-icon">
                                    <i class="fas fa-calendar"></i>
                                </div>
                            </div>
                            
                            <div class="status-card no-show">
                                <div class="status-info">
                                    <div class="status-number" id="noShowCount">0</div>
                                    <div class="status-label">No show</div>
                                </div>
                                <div class="status-icon">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Second Row: Analysis Cards -->
                        <div class="analysis-cards-row">
                            <div class="analysis-card">
                                <div class="analysis-header">
                                    <h3>All Appointments</h3>
                                </div>
                                <div class="analysis-content">
                                    <div class="main-number" id="allAppointmentsCount">0</div>
                                    <div class="change-indicator positive" id="allAppointmentsChange">
                                        <span class="change-text">+16 in this month</span>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-card">
                                <div class="analysis-header">
                                    <h3>New Patients</h3>
                                </div>
                                <div class="analysis-content">
                                    <div class="main-number" id="newPatientsCount">0</div>
                                    <div class="change-indicator positive" id="newPatientsChange">
                                        <span class="change-text">+11 in this month</span>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-card">
                                <div class="analysis-header">
                                    <h3>New Vips</h3>
                                </div>
                                <div class="analysis-content">
                                    <div class="main-number" id="premiumMembersCount">0</div>
                                    <div class="change-indicator positive" id="premiumMembersChange">
                                        <span class="change-text">+3 in this month</span>
                                    </div>
                                </div>
                            </div>

                            <div class="analysis-card">
                                <div class="analysis-header">
                                    <h3>Attendance Rate</h3>
                                </div>
                                <div class="analysis-content">
                                    <div class="main-number" id="attendanceRate">0%</div>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="attendanceProgress"></div>
                                        </div>
                                        <div class="progress-label" id="attendanceLabel">This Week 0/1</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Today's Appointments Table -->
                        <div class="todays-appointments">
                            <div class="section-header">
                                <h2>
                                    <i class="fas fa-calendar-check"></i>
                                    Today's Appointments
                                </h2>
                                <div class="date-display" id="todayDate">09/09/2025</div>
                            </div>
                            <div class="appointments-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Patient Name</th>
                                            <th>Time</th>
                                            <th>Service</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="todaysAppointmentsList">
                                        <!-- Appointments will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Trend chart area -->
                        <div class="trend-chart-section">
                            <div class="section-header">
                                <h2>
                                    <i class="fas fa-chart-line"></i>
                                    Completed (Last 30 Days)
                                </h2>
                            </div>
                            <div class="trend-chart-container">
                                <canvas id="trendChart" width="600" ></canvas>
                            </div>
                        </div>

                        <!-- Service Success Rate Analysis -->
                        <div class="service-success-section">
                            <div class="section-header">
                                <h2>
                                    <i class="fas fa-check-double"></i>
                                    Service Success Rate (This Month)
                                </h2>
                            </div>
                            <div class="service-success-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Total</th>
                                            <th>Completed</th>
                                            <th>Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceSuccessRateList">
                                        <!-- Service success rates will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Pending Confirmations and Service Chart -->
                    <div class="dashboard-right">
                        <!-- Pending Confirmations -->
                        <div class="pending-section">
                            <div class="pending-header">
                                <h3>Pending Confirmation:</h3>
                                <div class="pending-count" id="pendingConfirmationCount">0</div>
                            </div>
                            <div class="pending-list" id="pendingConfirmationsList">
                                <!-- Pending confirmations will be populated here -->
                            </div>
                            <div class="view-all-link">
                                <a href="patients.html#pending">View All</a>
                            </div>
                        </div>

                        <!-- Calendar component -->
                        <div class="dashboard-calendar">
                            <div class="calendar-header">
                                <h3 id="calendarMonthYear">September 2025</h3>
                            </div>
                            <div class="calendar-grid">
                                <div class="calendar-weekdays">
                                    <div class="weekday">S</div>
                                    <div class="weekday">M</div>
                                    <div class="weekday">T</div>
                                    <div class="weekday">W</div>
                                    <div class="weekday">T</div>
                                    <div class="weekday">F</div>
                                    <div class="weekday">S</div>
                                </div>
                                <div class="calendar-dates" id="calendarDates">
                                    <!-- Dates will be generated by JavaScript -->
                                </div>
                            </div>
                        </div>


                        <!-- Service Types Chart -->
                        <div class="service-chart-section">
                            <div class="chart-header">
                                <h3>Service Types</h3>
                                <select class="chart-period-selector" id="chartPeriodSelector" aria-label="Select chart period">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <!-- <option value="yearly">Yearly</option> Future feature -->
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="serviceChart" width="220" height="240"></canvas>
                            </div>
                            <div class="chart-legend" id="chartLegend">
                                <!-- Legend will be populated here -->
                            </div>
                        </div>

                        <!-- Service Upgrade Rate -->
                        <div class="service-upgrade-section">
                            <div class="section-header">
                                <h3>Service Upgrade Rate (All Time)</h3>
                            </div>
                            <div class="service-upgrade-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Initial</th>
                                            <th>Total</th>
                                            <th>Up</th>
                                            <th>Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceUpgradeRateList">
                                        <!-- Service upgrade rates will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="service-upgrade-legend">
                                <div class="legend-column">
                                    <div class="legend-title">Initial Services</div>
                                    <ul class="legend-list">
                                        <li>General</li>
                                        <li>Preventive</li>
                                    </ul>
                                </div>
                                <div class="legend-column">
                                    <div class="legend-title">Upgrade Targets</div>
                                    <ul class="legend-list">
                                        <li>Root Canal</li>
                                        <li>Periodontics</li>
                                        <li>Extraction</li>
                                        <li>Implant</li>
                                        <li>Orthodontics</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div class="modal-overlay liquid-glass" id="quickAddModal">
        <div class="modal-content liquid-glass">
            <div class="modal-header">
                <h3>Quick Add Appointment</h3>
                <button class="modal-close" id="modalClose" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="quickAddForm">
                    <div class="form-group">
                        <label for="patientName">Patient Name</label>
                        <input type="text" id="patientName" pattern="[A-Za-z\s]+" title="Please enter only English letters and spaces" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appointmentDate">Date</label>
                            <input type="date" id="appointmentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentTime">Time</label>
                            <select id="appointmentTime" required>
                                <option value="">Select Time Slot</option>
                                <option value="09:00-10:00">09:00 AM - 10:00 AM</option>
                                <option value="10:00-11:00">10:00 AM - 11:00 AM</option>
                                <option value="11:00-12:00">11:00 AM - 12:00 PM</option>
                                <option value="12:00-13:00">12:00 PM - 01:00 PM</option>
                                <option value="13:00-14:00">01:00 PM - 02:00 PM</option>
                                <option value="14:00-15:00">02:00 PM - 03:00 PM</option>
                                <option value="15:00-16:00">03:00 PM - 04:00 PM</option>
                                <option value="16:00-17:00">04:00 PM - 05:00 PM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="service">Service</label>
                            <select id="service" required>
                                <option value="">Select Service</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <select id="location" required>
                                <option value="">Select Location</option>
                                <option value="arcadia">Arcadia</option>
                                <option value="irvine">Irvine</option>
                                <option value="south-pasadena">South Pasadena</option>
                                <option value="rowland-heights">Rowland Heights</option>
                                <option value="eastvale">Eastvale</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number</label>
                        <input type="tel" id="phoneNumber" placeholder="(XXX) XXX-XXXX" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="modalCancel">Cancel</button>
                <button type="submit" class="btn-primary" form="quickAddForm">Add Appointment</button>
            </div>
        </div>
    </div>

    <!-- 新的认证守卫模块 - 必须最先加载 -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="js/intranet-auth-guard.js"></script>

    <!-- 其他业务逻辑脚本 -->
    <script src="js/service-mapping.js"></script>
    <script src="js/cache-manager.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/shared.js"></script>
    <script src="js/firebase-data-service.js"></script>
    <script src="js/dashboard.js"></script>
</body>
</html>