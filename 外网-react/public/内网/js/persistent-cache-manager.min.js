class PersistentCacheManager extends GlobalCacheManager{constructor(){super(),this.persistent=null,this.isReady=!1,this.SENSITIVE_KEYS=["user-role","user-clinics","auth-token","currentuser","firebase-token","uid","role","clinics","permissions"],this.init()}async init(){try{if(!window.indexedDB)return;"undefined"!=typeof localforage&&(this.persistent=localforage.createInstance({name:"dental-clinic-cache",storeName:"appointments-data",description:"Persistent cache for appointment data"}),this.isReady=!0,await this.cleanupExpiredPersistent())}catch(t){this.isReady=!1}}isSafeKey(t){const e=t.toLowerCase();return!this.SENSITIVE_KEYS.some(t=>e.includes(t))}async getDateCache(t){const e=super.getDateCache(t);if(e)return e;if(!this.isReady||!this.persistent)return null;try{const e=`date:${t}`,s=await this.persistent.getItem(e);if(!s)return null;return Date.now()-s.timestamp>=this.CACHE_DURATION?(await this.persistent.removeItem(e),null):(super.setDateCache(t,s.data),this.stats.hits++,this.stats.savedReads++,s.data)}catch(t){return null}}async setDateCache(t,e){if(this.isSafeKey(t)&&(super.setDateCache(t,e),this.isReady&&this.persistent))try{const s=`date:${t}`,a={data:e,timestamp:Date.now(),version:"1.0"};await this.persistent.setItem(s,a)}catch(t){}}async getAllCache(){const t=super.getAllCache();if(t)return t;if(!this.isReady||!this.persistent)return null;try{const t="all-appointments",e=await this.persistent.getItem(t);if(!e)return null;return Date.now()-e.timestamp>=this.CACHE_DURATION?(await this.persistent.removeItem(t),null):(super.setAllCache(e.data),e.data)}catch(t){return null}}async setAllCache(t){if(super.setAllCache(t),this.isReady&&this.persistent)try{const e="all-appointments",s={data:t,timestamp:Date.now(),version:"1.0"};await this.persistent.setItem(e,s)}catch(t){}}async clearAll(){if(super.clearAll(),this.isReady&&this.persistent)try{await this.persistent.clear()}catch(t){}}async cleanupExpiredPersistent(){if(this.isReady&&this.persistent)try{const t=await this.persistent.keys();let e=0;for(const s of t){const t=await this.persistent.getItem(s);if(t&&t.timestamp){Date.now()-t.timestamp>=this.CACHE_DURATION&&(await this.persistent.removeItem(s),e++)}}}catch(t){}}async onAppointmentCreated(t){if(super.onAppointmentCreated(t),this.isReady&&this.persistent)try{await this.persistent.removeItem(`date:${t}`),await this.persistent.removeItem("all-appointments")}catch(t){}}async onAppointmentUpdated(t,e){if(super.onAppointmentUpdated(t,e),this.isReady&&this.persistent)try{await this.persistent.removeItem(`date:${t}`),"cancelled"===e&&(await this.persistent.removeItem("all-appointments"),await this.persistent.removeItem("cancelled-appointments"))}catch(t){}}async getStats(){const t=super.getStats();if(!this.isReady||!this.persistent)return{...t,indexedDBStatus:"unavailable"};try{const e=(await this.persistent.keys()).length;return{...t,indexedDBStatus:"available",indexedDBEntries:e,persistenceEnabled:!0}}catch(e){return{...t,indexedDBStatus:"error",persistenceEnabled:!1}}}}"undefined"!=typeof window&&(window.PersistentCacheManager=PersistentCacheManager,window.cacheManager&&(window.cacheManager=new PersistentCacheManager));