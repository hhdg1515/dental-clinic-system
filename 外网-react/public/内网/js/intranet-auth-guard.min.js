class IntranetAuthGuard{constructor(){this.currentUserProfile=null,this.isAuthReady=!1,this.authCallbacks=[],this.allowedRoles=["owner","admin"],this.loginPageUrl="/app/login"}async initialize(){try{this.showLoadingOverlay(),await this.waitForFirebase(),await this.setupAuthStateListener()}catch(e){this.handleAuthFailure("Authentication system initialization failed")}}waitForFirebase(){return new Promise((e,t)=>{let i=0;const n=setInterval(()=>{i++,window.firebase&&window.firebase.auth&&window.firebase.db?(clearInterval(n),e()):i>=50&&(clearInterval(n),t(new Error("Firebase initialization timeout")))},100)})}async setupAuthStateListener(){const{onAuthStateChanged:e}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js");return new Promise(t=>{e(window.firebase.auth,async e=>{e?await this.loadUserProfile(e.uid):this.handleAuthFailure("Please login first through the external website"),t()})})}async loadUserProfile(e){try{const{doc:t,getDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=t(window.firebase.db,"users",e),a=await i(n);if(!a.exists())throw new Error("User profile not found in database");const r=a.data();if(!this.allowedRoles.includes(r.role))throw new Error(`Access denied. Role "${r.role}" is not allowed to access the internal dashboard`);this.currentUserProfile={uid:e,email:r.email||"",displayName:r.displayName||r.email?.split("@")[0]||"Admin",role:r.role,clinics:r.clinics||[],assignedLocation:r.assignedLocation||null,photoURL:r.photoURL||null},this.hideLoadingOverlay(),this.isAuthReady=!0,this.authCallbacks.forEach(e=>e(this.currentUserProfile)),this.authCallbacks=[],this.updatePageUI()}catch(e){this.handleAuthFailure(e.message||"Failed to load user account information")}}handleAuthFailure(e){this.showErrorMessage(e),setTimeout(()=>{const e=window.location.pathname,t=`${this.loginPageUrl}?redirect=${encodeURIComponent(e)}`;window.location.href=t},2e3)}showLoadingOverlay(){const e=document.createElement("div");e.id="auth-loading-overlay",e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(255, 255, 255, 0.98);\n            z-index: 99999;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            font-family: Arial, sans-serif;\n        ",e.innerHTML='\n            <div style="text-align: center;">\n                <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>\n                <div style="font-size: 16px; color: #333;">Verifying authentication...</div>\n            </div>\n            <style>\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n            </style>\n        ',document.body.appendChild(e)}hideLoadingOverlay(){const e=document.getElementById("auth-loading-overlay");e&&(e.style.opacity="0",e.style.transition="opacity 0.3s ease",setTimeout(()=>e.remove(),300))}showErrorMessage(e){const t=document.getElementById("auth-loading-overlay");t&&(t.innerHTML=`\n                <div style="text-align: center; max-width: 400px; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">\n                    <div style="font-size: 48px; margin-bottom: 20px;">ðŸ”’</div>\n                    <div style="font-size: 18px; font-weight: bold; color: #e74c3c; margin-bottom: 10px;">Access Denied</div>\n                    <div style="font-size: 14px; color: #666; margin-bottom: 20px;">${e}</div>\n                    <div style="font-size: 12px; color: #999;">Redirecting to login page...</div>\n                </div>\n            `)}updatePageUI(){if(!this.currentUserProfile)return;const e=document.querySelector(".user-name");e&&(e.textContent=this.currentUserProfile.displayName);const t=document.querySelector(".user-role");if(t){const e="owner"===this.currentUserProfile.role?"Owner":"Admin";t.textContent=e}const i=document.querySelector(".profile-img");i&&this.currentUserProfile.photoURL&&(i.src=this.currentUserProfile.photoURL),this.updateClinicSelector()}updateClinicSelector(){const e=document.getElementById("locationSelector");if(!e)return;const t=this.currentUserProfile,i=[{value:"arcadia",label:"Arcadia"},{value:"irvine",label:"Irvine"},{value:"south-pasadena",label:"South Pasadena"},{value:"rowland-heights",label:"Rowland Heights"},{value:"eastvale",label:"Eastvale"}],n="owner"===t.role?i:i.filter(e=>t.clinics.includes(e.value));e.innerHTML="",n.forEach(t=>{const i=document.createElement("option");i.value=t.value,i.textContent=t.label,e.appendChild(i)}),"owner"!==t.role&&(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.7");const a=localStorage.getItem("intranet:view-location");a&&n.some(e=>e.value===a)?e.value=a:(e.value=n[0]?.value||"arcadia",localStorage.setItem("intranet:view-location",e.value)),e.addEventListener("change",e=>{localStorage.setItem("intranet:view-location",e.target.value),window.dispatchEvent(new CustomEvent("clinic-changed",{detail:{clinicId:e.target.value}}))})}getUserProfile(){return this.currentUserProfile}getAllowedClinics(){return this.currentUserProfile?"owner"===this.currentUserProfile.role?["arcadia","irvine","south-pasadena","rowland-heights","eastvale"]:this.currentUserProfile.clinics||[]:[]}getCurrentViewLocation(){return localStorage.getItem("intranet:view-location")||"arcadia"}isOwner(){return"owner"===this.currentUserProfile?.role}isAdmin(){const e=this.currentUserProfile?.role;return"owner"===e||"admin"===e}waitForAuth(){return new Promise(e=>{this.isAuthReady?e(this.currentUserProfile):this.authCallbacks.push(e)})}async logout(){try{const{signOut:e}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js");localStorage.removeItem("intranet:view-location"),await e(window.firebase.auth),window.location.href=this.loginPageUrl}catch(e){}}}window.intranetAuthGuard=new IntranetAuthGuard,window.getAuthGuard=()=>window.intranetAuthGuard,window.getUserProfile=()=>window.intranetAuthGuard.getUserProfile(),window.getAllowedClinics=()=>window.intranetAuthGuard.getAllowedClinics(),window.getCurrentViewLocation=()=>window.intranetAuthGuard.getCurrentViewLocation(),window.isOwner=()=>window.intranetAuthGuard.isOwner(),window.isAdmin=()=>window.intranetAuthGuard.isAdmin(),window.waitForAuth=()=>window.intranetAuthGuard.waitForAuth(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.intranetAuthGuard.initialize()}):window.intranetAuthGuard.initialize(),window.handleLogout=async function(e){e&&e.preventDefault(),await window.intranetAuthGuard.logout()};