class FirebaseDataService{constructor(){this.db=null,this.auth=null,this.storage=null,this.isInitialized=!1,this.clinicLocations=["arcadia","irvine","south-pasadena","rowland-heights","eastvale"],this.init()}async init(){try{await this.waitForFirebase(),this.db=window.firebase.db,this.auth=window.firebase.auth,this.storage=window.firebase.storage,this.isInitialized=!0}catch(t){this.isInitialized=!1}}waitForFirebase(){return new Promise((t,e)=>{let a=0;const i=()=>{window.firebase&&window.firebase.db&&window.firebase.auth&&window.firebase.storage?t():a>=100?e(new Error("Firebase services not available")):(a++,setTimeout(i,100))};i()})}async ensureReady(){this.isInitialized||await this.init();let t=0;for(;(!this.isInitialized||!window.firebase?.db)&&t<10;)await new Promise(t=>setTimeout(t,300)),this.isInitialized||await this.init(),t++;if(!this.isInitialized||!window.firebase?.db)throw new Error("Firebase services not available after multiple retry attempts")}validateDatabase(){const t=window.firebase?.db;if(!t)throw new Error("Firebase database not available - window.firebase.db is null or undefined");if("object"!=typeof t||!t.app)throw new Error("Firebase database object is invalid - missing app property");return t}getAccessibleClinics(t,e){return"boss"===t||"owner"===t?this.clinicLocations:e||[]}normalizeStatus(t){if(!t)return"scheduled";return{confirmed:"scheduled",scheduled:"scheduled",completed:"completed",cancelled:"cancelled",pending:"pending",declined:"declined",arrived:"arrived","no-show":"no-show"}[t.toLowerCase()]||"scheduled"}async getAppointmentsForDate(t,e=null,a=[],i=!1){try{let s;await this.ensureReady();try{s=this.validateDatabase()}catch(t){return[]}const{collection:n,getDocs:r,query:o,where:c,orderBy:d,Timestamp:l}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),p=this.getAccessibleClinics(e,a),w=o(n(s,"appointments"),c("appointmentDate","==",t)),m=await r(w),h=[];let u=0,f=0,g=0;const b=new Set(p.map(t=>t.toLowerCase()));return m.forEach(e=>{u++;const a=e.data();if(!b.has((a.clinicLocation||"").toLowerCase()))return void f++;if(!i&&("cancelled"===a.status||"declined"===a.status))return void g++;let s="",n=t;if(a.appointmentTime)s=a.appointmentTime;else if(a.appointmentDateTime){const t=a.appointmentDateTime.toDate();s=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}if(a.appointmentDate)n=a.appointmentDate;else if(a.appointmentDateTime){const t=a.appointmentDateTime.toDate();n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}if(n===t){const t=this.normalizeStatus(a.status),i=a.service||a.serviceType||a.serviceName||"General Consultation";h.push({id:e.id,...a,time:s,dateKey:n,date:n,location:a.clinicLocation,status:t,service:i})}}),h}catch(t){return[]}}async getAppointmentsForDateRange(t,e,a=null,i=[]){try{let s;await this.ensureReady();try{s=this.validateDatabase()}catch(t){return{}}const{collection:n,getDocs:r,query:o,where:c}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),d=this.getAccessibleClinics(a,i),l=o(n(s,"appointments"),c("appointmentDate",">=",t),c("appointmentDate","<=",e)),p=await r(l),w={},m=new Set(d.map(t=>t.toLowerCase()));return p.forEach(a=>{const i=a.data();if(!m.has((i.clinicLocation||"").toLowerCase()))return;if("pending"===i.status||"cancelled"===i.status||"declined"===i.status)return;let s="",n="";if(i.appointmentTime)s=i.appointmentTime;else if(i.appointmentDateTime){const t=i.appointmentDateTime.toDate();s=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}if(i.appointmentDate)n=i.appointmentDate;else if(i.appointmentDateTime){const t=i.appointmentDateTime.toDate();n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}if(n>=t&&n<=e){w[n]||(w[n]=[]);const t=this.normalizeStatus(i.status),e=i.service||i.serviceType||i.serviceName||"General Consultation";w[n].push({id:a.id,...i,time:s,dateKey:n,date:n,location:i.clinicLocation,status:t,service:e})}}),w}catch(t){return{}}}async getAllAppointments(t=null,e=[],a=!0){try{let i;await this.ensureReady();try{i=this.validateDatabase()}catch(t){return[]}const{collection:s,getDocs:n,query:r,where:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=this.getAccessibleClinics(t,e),d=new Date,l=new Date(d.getFullYear(),d.getMonth()-3,d.getDate()),p=new Date(d.getFullYear()+1,d.getMonth(),d.getDate()),w=l.toISOString().split("T")[0],m=p.toISOString().split("T")[0],h=r(s(i,"appointments"),o("appointmentDate",">=",w),o("appointmentDate","<=",m)),u=await n(h),f=[],g=new Set(c.map(t=>t.toLowerCase()));return u.forEach(t=>{const e=t.data();if(!g.has((e.clinicLocation||"").toLowerCase()))return;if(!a&&("cancelled"===e.status||"declined"===e.status))return;let i="",s="";if(e.appointmentTime)i=e.appointmentTime;else if(e.appointmentDateTime){const t=e.appointmentDateTime.toDate();i=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}if(e.appointmentDate)s=e.appointmentDate;else if(e.appointmentDateTime){const t=e.appointmentDateTime.toDate();s=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const n=this.normalizeStatus(e.status),r=e.service||e.serviceType||e.serviceName||"General Consultation";f.push({id:t.id,...e,time:i,dateKey:s,location:e.clinicLocation,status:n,service:r})}),f}catch(t){return[]}}async createAppointmentTimestamp(t,e){try{const{Timestamp:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),[i,s,n]=t.split("-").map(Number),[r,o]=e.split(":").map(Number),c=new Date(i,s-1,n,r,o,0,0);return a.fromDate(c)}catch(t){const{Timestamp:e}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");return e.fromDate(new Date)}}async addAppointment(t,e=null,a=[]){try{await this.ensureReady();const{collection:i,addDoc:s,doc:n,setDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=this.getClinicIdFromLocation(t.location);if(!this.getAccessibleClinics(e,a).includes(o))throw new Error(`Access denied: You don't have permission to create appointments for ${o}`);const c=await this.createAppointmentTimestamp(t.date,t.time),d={patientName:t.patientName,service:t.service,appointmentTime:t.time,appointmentDate:t.date,appointmentDateTime:c,status:"scheduled",clinicLocation:o,phone:t.phone||"",email:t.email||`${t.patientName.toLowerCase().replace(/\s+/g,".")}@email.com`,notes:t.notes||"",dateKey:t.date,createdAt:(new Date).toISOString(),clinicId:o},l=i(this.validateDatabase(),"appointments");return{id:(await s(l,d)).id,...d}}catch(t){throw t}}async updateAppointmentStatus(t,e,a={},i=null,s=[]){try{await this.ensureReady();const{doc:n,updateDoc:r,deleteDoc:o,collection:c,addDoc:d}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),l=await this.findAppointmentById(t,i,s);if(l&&l.appointmentDateTime){l.appointmentDateTime.toDate().toISOString().split("T")[0]}if(!l)throw new Error("Appointment not found");const p=l.clinicLocation,w=(l.dateKey||(l.appointmentDateTime?l.appointmentDateTime.toDate().toISOString().split("T")[0]:(new Date).toISOString().split("T")[0]),this.getAccessibleClinics(i,s)),m=(p||"").toLowerCase().replace(/\s+/g,"-");if(!w.includes(m))throw new Error(`Access denied to clinic: ${m}`);if("cancelled"===e){const e={...l,status:"cancelled",cancelledAt:(new Date).toISOString(),cancelReason:a.reason||"Unknown",cancelNotes:a.notes||""},i=this.validateDatabase(),s=c(i,"cancelledAppointments");await d(s,e),await o(n(i,"appointments",t))}else{const i={status:e,...a,lastUpdated:(new Date).toISOString()},s=this.validateDatabase();await r(n(s,"appointments",t),i)}return!0}catch(t){throw t}}async updateAppointment(t,e,a=null,i=[]){try{await this.ensureReady();const{doc:s,updateDoc:n,getDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=await this.findAppointmentById(t,a,i);if(!o)throw new Error("Appointment not found");const c=this.getAccessibleClinics(a,i),d=(o.clinicLocation||"").toLowerCase().replace(/\s+/g,"-");if(!c.includes(d))throw new Error(`No permission to update appointments for ${d}`);const l=this.validateDatabase(),p={...e,lastUpdated:(new Date).toISOString()};return e.name&&(p.patientName=e.name,delete p.name),await n(s(l,"appointments",t),p),!0}catch(t){throw t}}async deleteAppointment(t,e=null,a=[]){try{await this.ensureReady();const{doc:i,deleteDoc:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=await this.findAppointmentById(t,e,a);if(!n)throw new Error("Appointment not found");const r=n.clinicLocation,o=this.getAccessibleClinics(e,a),c=(r||"").toLowerCase().replace(/\s+/g,"-");if(!o.includes(c))throw new Error(`Access denied to delete appointments for ${c}`);const d=this.validateDatabase();return await s(i(d,"appointments",t)),!0}catch(t){throw t}}async findAppointmentById(t,e=null,a=[]){try{await this.ensureReady();const{doc:i,getDoc:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=this.getAccessibleClinics(e,a),r=i(this.validateDatabase(),"appointments",t),o=await s(r);if(o.exists()){const t=o.data(),e=(t.clinicLocation||"").toLowerCase().replace(/\s+/g,"-");if(n.includes(e))return{id:o.id,...t};throw new Error("No permission to access this appointment")}return null}catch(t){return null}}async getPendingConfirmations(t=null,e=[]){try{await this.ensureReady();const{collection:a,getDocs:i,query:s,orderBy:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=this.validateDatabase(),o=s(a(r,"pendingConfirmations"),n("createdAt","desc")),c=await i(o),d=[];return c.forEach(a=>{const i=a.data(),s=this.getClinicIdFromLocation(i.location);this.getAccessibleClinics(t,e).includes(s)&&d.push({id:a.id,...i})}),d}catch(t){return[]}}async addPendingConfirmation(t){try{await this.ensureReady();const{collection:e,addDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i={...t,createdAt:(new Date).toISOString()},s=e(this.validateDatabase(),"pendingConfirmations");return{id:(await a(s,i)).id,...i}}catch(t){throw t}}async removePendingConfirmation(t){try{await this.ensureReady();const{doc:e,deleteDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=this.validateDatabase();return await a(e(i,"pendingConfirmations",t)),!0}catch(t){throw t}}async getCancelledAppointments(t=null,e=[]){try{let a;await this.ensureReady();try{a=this.validateDatabase()}catch(t){return[]}const{collection:i,getDocs:s,query:n,orderBy:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=[],c=this.getAccessibleClinics(t,e);for(const t of c){const e=n(i(a,"cancelledAppointments",t,"appointments"),r("cancelledAt","desc"));(await s(e)).forEach(t=>{o.push({id:t.id,...t.data()})})}return o}catch(t){return[]}}async getPatientProfile(t){try{await this.ensureReady();const{doc:e,getDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=t.toLowerCase().replace(/\s+/g,"_"),s=e(this.validateDatabase(),"patientProfiles",i),n=await a(s);return n.exists()?n.data():null}catch(t){return null}}async setPatientProfile(t,e){try{await this.ensureReady();const{doc:a,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=t.toLowerCase().replace(/\s+/g,"_"),n=a(this.validateDatabase(),"patientProfiles",s),r={patientName:t,detailedInfo:e,lastUpdated:(new Date).toISOString()};return await i(n,r,{merge:!0}),r}catch(t){throw t}}getClinicIdFromLocation(t){return t?t.toLowerCase().replace(/\s+/g,"-"):"arcadia"}getLocationFromClinicId(t){return t.split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}generateAppointmentId(){return"app_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}async subscribeToNewAppointments(t,e,a){try{await this.ensureReady();const{collection:i,query:s,where:n,orderBy:r,onSnapshot:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=this.getAccessibleClinics(t,e),d=this.validateDatabase(),l=s(i(d,"appointments"),n("clinicLocation","in",c),n("status","==","pending"),r("appointmentDateTime","asc"));return o(l,t=>{const e=[];t.forEach(t=>{const a=t.data(),i=a.appointmentDateTime?a.appointmentDateTime.toDate():new Date;e.push({id:t.id,...a,time:i.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),dateKey:i.toISOString().split("T")[0],location:a.clinicLocation,appointmentDateTime:i})}),a(e)},t=>{a([])})}catch(t){return()=>{}}}async getPendingAppointmentsCount(t,e){try{await this.ensureReady();const{collection:a,query:i,where:s,getCountFromServer:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=this.getAccessibleClinics(t,e),o=this.validateDatabase(),c=i(a(o,"appointments"),s("clinicLocation","in",r),s("status","==","pending"));return(await n(c)).data().count}catch(t){return 0}}async uploadMedicalRecord(t,e,a=null){try{await this.ensureReady();const{collection:i,addDoc:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");let n=0;const r=setInterval(()=>{n+=20,a&&a(Math.min(n,90))},100),o=await this.fileToBase64(e);clearInterval(r),a&&a(95);const c=i(this.validateDatabase(),"medicalRecords"),d={userId:t,filename:e.name,originalName:e.name,size:e.size,type:e.type,base64Data:o,uploadedAt:new Date},l=await s(c,d);return a&&a(100),{id:l.id,...d}}catch(t){throw t}}fileToBase64(t){return new Promise((e,a)=>{const i=new FileReader;i.readAsDataURL(t),i.onload=()=>e(i.result),i.onerror=t=>a(t)})}async getMedicalRecords(t){try{await this.ensureReady();const{collection:e,query:a,where:i,getDocs:s,orderBy:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=this.validateDatabase(),o=a(e(r,"medicalRecords"),i("userId","==",t),n("uploadedAt","desc")),c=await s(o),d=[];return c.forEach(t=>{d.push({id:t.id,...t.data()})}),d}catch(t){throw t}}async deleteMedicalRecord(t){try{await this.ensureReady();const{doc:e,deleteDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=this.validateDatabase();return await a(e(i,"medicalRecords",t)),!0}catch(t){throw t}}async renameMedicalRecord(t,e){try{await this.ensureReady();const{doc:a,updateDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=a(this.validateDatabase(),"medicalRecords",t);return await i(s,{originalName:e,updatedAt:new Date}),!0}catch(t){throw t}}async downloadMedicalRecord(t,e){try{const a=atob(t.split(",")[1]),i=new Array(a.length);for(let t=0;t<a.length;t++)i[t]=a.charCodeAt(t);const s=new Uint8Array(i),n=t.substring(t.indexOf(":")+1,t.indexOf(";")),r=new Blob([s],{type:n}),o=window.URL.createObjectURL(r),c=document.createElement("a");return c.style.display="none",c.href=o,c.download=e,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(o),document.body.removeChild(c),!0}catch(t){throw t}}async getDentalChart(t){await this.ensureReady();const{doc:e,getDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=e(this.validateDatabase(),"dentalCharts",t),s=await a(i);return s.exists()?{id:s.id,...s.data()}:null}validateToothNumber(t){const e=parseInt(t);if(isNaN(e)||e<1||e>32)throw new Error(`Invalid tooth number: ${t}. Must be 1-32.`);return e}validateToothStatus(t){const e=["healthy","monitor","cavity","filled","missing","implant","root-canal","post-op","urgent"];if(!e.includes(t))throw new Error(`Invalid tooth status: ${t}. Must be one of: ${e.join(", ")}`);return t}validateFileUpload(t){if(!t)throw new Error("No file provided");if(t.size>5242880)throw new Error(`File too large: ${(t.size/1024/1024).toFixed(2)}MB. Maximum 5MB allowed.`);if(!["image/jpeg","image/png","image/jpg","application/pdf"].includes(t.type))throw new Error(`Invalid file type: ${t.type}. Only JPEG, PNG, and PDF allowed.`);return!0}async updateToothStatus(t,e,a){await this.ensureReady();const i=this.validateToothNumber(e),s=this.validateToothStatus(a.status),{doc:n,updateDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=n(this.validateDatabase(),"dentalCharts",t);return await r(o,{[`teeth.${i}.status`]:s,[`teeth.${i}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()}),!0}async addToothTreatment(t,e,a){await this.ensureReady();const i=this.validateToothNumber(e),{doc:s,getDoc:n,updateDoc:r,arrayUnion:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=s(this.validateDatabase(),"dentalCharts",t),d=await n(c);if(!d.exists())throw new Error("Dental chart not found");const l={id:`treatment-${Date.now()}`,date:(new Date).toISOString(),createdBy:this.auth.currentUser?.uid||"unknown",...a},p=d.data();return p.teeth||(p.teeth={}),p.teeth[i]||(p.teeth[i]={status:"healthy",treatments:[]}),p.teeth[i].treatments||(p.teeth[i].treatments=[]),p.teeth[i].treatments.push(l),await r(c,{[`teeth.${i}.treatments`]:p.teeth[i].treatments,[`teeth.${i}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()}),l}async uploadToothAttachment(t,e,a){await this.ensureReady();const i=this.validateToothNumber(e);this.validateFileUpload(a);if(a.size<51200){const t=await this.fileToBase64(a);return{type:"base64",filename:a.name,mimeType:a.type,fileSize:a.size,base64Data:t}}{const{ref:e,uploadBytes:s,getDownloadURL:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js"),r=this.storage,o=`dentalCharts/${t}/tooth_${i}/${Date.now()}_${a.name}`,c=e(r,o),d=await s(c,a),l=await n(d.ref);return{type:"storage",filename:a.name,mimeType:a.type,fileSize:a.size,storagePath:o,downloadURL:l}}}async deleteToothTreatment(t,e,a){await this.ensureReady();const i=this.validateToothNumber(e),{doc:s,getDoc:n,updateDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=s(this.validateDatabase(),"dentalCharts",t),c=await n(o);if(c.exists()){const t=c.data(),e=t.teeth?.[i];if(e?.treatments){const t=e.treatments.filter(t=>t.id!==a);await r(o,{[`teeth.${i}.treatments`]:t,[`teeth.${i}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()})}}return!0}async initializeDentalChart(t,e){await this.ensureReady();const{doc:a,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=a(this.validateDatabase(),"dentalCharts",t),n={};for(let t=1;t<=32;t++)n[t.toString()]={status:"healthy",treatments:[],lastUpdated:(new Date).toISOString()};return await i(s,{userId:t,patientName:e,lastUpdated:(new Date).toISOString(),teeth:n}),!0}}let firebaseDataService=null;if("undefined"!=typeof window){const t=()=>{window.firebase&&window.firebase.db?(firebaseDataService=new FirebaseDataService,window.firebaseDataService=firebaseDataService):setTimeout(t,100)};t()}"undefined"!=typeof module&&module.exports?module.exports=FirebaseDataService:"undefined"!=typeof window&&(window.FirebaseDataService=FirebaseDataService);