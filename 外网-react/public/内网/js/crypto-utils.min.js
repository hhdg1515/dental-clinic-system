export async function generateEncryptionKey(){return await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}export async function exportKey(e){const t=await crypto.subtle.exportKey("raw",e),r=new Uint8Array(t);return btoa(String.fromCharCode.apply(null,r))}export async function importKey(e){const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0));return await crypto.subtle.importKey("raw",t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}export async function encryptFile(e,t){const r=crypto.getRandomValues(new Uint8Array(12)),n=await e.arrayBuffer();return{encrypted:await crypto.subtle.encrypt({name:"AES-GCM",iv:r},t,n),iv:r}}export async function decryptFile(e,t,r){return await crypto.subtle.decrypt({name:"AES-GCM",iv:t},r,e)}export function arrayBufferToBase64(e){const t=new Uint8Array(e);let r="";for(let e=0;e<t.byteLength;e++)r+=String.fromCharCode(t[e]);return btoa(r)}export function base64ToArrayBuffer(e){const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r.buffer}export async function derivePatientKey(e,t){return await importKey(e)}export async function encryptMedicalRecord(e,t,r){const{encrypted:n,iv:a}=await encryptFile(e,r);return{encryptedData:arrayBufferToBase64(n),iv:arrayBufferToBase64(a),metadata:{originalName:e.name,originalSize:e.size,mimeType:e.type,encryptedAt:(new Date).toISOString(),algorithm:"AES-256-GCM",patientId:t}}}export async function decryptMedicalRecord(e,t,r,n){const a=base64ToArrayBuffer(e),o=new Uint8Array(base64ToArrayBuffer(t)),i=await decryptFile(a,o,r);return new Blob([i],{type:n.mimeType||"application/octet-stream"})}export async function initializeEncryption(){let e=localStorage.getItem("medical_records_encryption_key");if(!e){const t=await generateEncryptionKey();return e=await exportKey(t),localStorage.setItem("medical_records_encryption_key",e),{key:t,keyBase64:e}}return{key:await importKey(e),keyBase64:e}}export function isEncryptionInitialized(){return null!==localStorage.getItem("medical_records_encryption_key")}