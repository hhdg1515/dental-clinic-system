class GlobalDataManager{constructor(){this.storageKey="dental_clinic_data",this.useFirebase=!0,this.firebaseService=null,this.init()}init(){const t=this.loadFromStorage();if(t){const e=t.metadata?.version;"1.2.0"!==e?(this.data=this.getDefaultData(),this.data.metadata.version="1.2.0",this.saveToStorage()):this.data=t}else this.data=this.getDefaultData(),this.saveToStorage();this.initFirebaseService()}initFirebaseService(){const t=()=>{window.firebaseDataService?this.firebaseService=window.firebaseDataService:setTimeout(t,200)};t()}getDefaultData(){return{patientProfiles:{},appointments:{},pendingConfirmations:[],cancelledAppointments:{},patients:{},clinicInfo:{locations:["Arcadia","Irvine","South Pasadena","Rowland Heights","Eastvale"],services:["General","Implant","Extraction","Preventive","Cosmetic","Restorations","Root Canals","Orthodontics","Periodontics"],timeSlots:["09:00-10:00","10:00-11:00","11:00-12:00","12:00-13:00","13:00-14:00","14:00-15:00","15:00-16:00","16:00-17:00"]},userConfig:{currentUser:"boss",users:{boss:{name:"Sunnie",role:"boss",accessibleLocations:["arcadia","irvine","south-pasadena","rowland-heights","eastvale"],currentViewLocation:"arcadia"},admin_south_pasadena:{name:"Lisa",role:"admin",assignedLocation:"south-pasadena",accessibleLocations:["south-pasadena"]},admin_rowland_heights:{name:"Lily",role:"admin",assignedLocation:"rowland-heights",accessibleLocations:["rowland-heights"]},admin_arcadia:{name:"Lucy",role:"admin",assignedLocation:"arcadia",accessibleLocations:["arcadia"]},admin_irvine:{name:"Jane",role:"admin",assignedLocation:"irvine",accessibleLocations:["irvine"]},admin_eastvale:{name:"Emma",role:"admin",assignedLocation:"eastvale",accessibleLocations:["eastvale"]}}},metadata:{version:"1.2.0",lastUpdated:(new Date).toISOString(),nextAppointmentId:100}}}loadFromStorage(){try{const t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):null}catch(t){return null}}saveToStorage(){try{this.data.metadata.lastUpdated=(new Date).toISOString(),localStorage.setItem(this.storageKey,JSON.stringify(this.data))}catch(t){}}generateId(t="app"){const e=`${t}_${this.data.metadata.nextAppointmentId++}`;return this.saveToStorage(),e}async getAppointmentsForDate(t){if(!this.useFirebase||!this.firebaseService)return this.getAppointmentsForDateLocal(t);try{if(window.cacheManager){let e=window.cacheManager.getDateCache(t);if(e&&"function"==typeof e.then&&(e=await e),e)return e}const e=this.getCurrentUser(),a=e.role,n=this.getUserClinics(e),i=await this.firebaseService.getAppointmentsForDate(t,a,n);return window.cacheManager&&i&&window.cacheManager.setDateCache(t,i),i}catch(e){return this.getAppointmentsForDateLocal(t)}}async getAppointmentsForMonth(t,e){const a=new Date(t,e-1,1),n=new Date(t,e,0),i=a.toISOString().split("T")[0],s=n.toISOString().split("T")[0];if(!this.useFirebase||!this.firebaseService)return this.getAppointmentsForMonthLocal(t,e);try{const t=this.getCurrentUser(),e=t.role,a=this.getUserClinics(t);return await this.firebaseService.getAppointmentsForDateRange(i,s,e,a)}catch(a){return this.getAppointmentsForMonthLocal(t,e)}}getAppointmentsForMonthLocal(t,e){const a={},n=(this.getCurrentUser(),new Date(t,e,0).getDate());for(let i=1;i<=n;i++){const n=`${t}-${e.toString().padStart(2,"0")}-${i.toString().padStart(2,"0")}`,s=this.getAppointmentsForDateLocal(n);s.length>0&&(a[n]=s)}return a}getAppointmentsForDateLocal(t){const e=this.data.appointments[t]||[],a=this.getCurrentUser(),n=e.filter(t=>"pending"!==t.status&&"cancelled"!==t.status&&"declined"!==t.status);if("admin"===a.role){const t=a.assignedLocation.split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ");return n.filter(e=>e.location===t)}return n}async getAllAppointments(t=!0){if(!this.useFirebase||!this.firebaseService)return this.getAllAppointmentsLocal();try{if(window.cacheManager){let t=window.cacheManager.getAllCache();if(t&&"function"==typeof t.then&&(t=await t),t)return t}const e=this.getCurrentUser(),a=e.role,n=this.getUserClinics(e),i=await this.firebaseService.getAllAppointments(a,n,t);return Array.isArray(i)?(window.cacheManager&&window.cacheManager.setAllCache(i),i):this.getAllAppointmentsLocal()}catch(t){return this.getAllAppointmentsLocal()}}getAllAppointmentsLocal(){const t=[],e=this.getCurrentUser();return Object.keys(this.data.appointments).forEach(a=>{let n=this.data.appointments[a];if(Array.isArray(n)){if("admin"===e.role){const t=e.assignedLocation.split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ");n=n.filter(e=>e.location===t)}n.forEach(e=>{t.push({...e,dateKey:a})})}}),t}getUserClinics(t){return"boss"===t.role||"owner"===t.role?["arcadia","irvine","south-pasadena","rowland-heights","eastvale"]:t.assignedLocation?[t.assignedLocation]:[]}async addAppointment(t){if(!this.useFirebase||!this.firebaseService)return this.addAppointmentLocal(t);try{const e=this.getCurrentUser(),a=e.role,n=this.getUserClinics(e),i=await this.firebaseService.addAppointment(t,a,n);return window.cacheManager&&window.cacheManager.onAppointmentCreated(t.date),i}catch(e){return this.addAppointmentLocal(t)}}addAppointmentLocal(t){try{const e={id:this.generateId("app"),patientName:t.patientName,service:t.service,time:t.time,status:"scheduled",location:t.location,phone:t.phone||"",email:t.email||`${t.patientName.toLowerCase().replace(/\s+/g,".")}@email.com`,notes:t.notes||"",createdAt:(new Date).toISOString()},a=t.date;return this.data.appointments[a]||(this.data.appointments[a]=[]),this.data.appointments[a].push(e),this.saveToStorage(),e}catch(t){throw t}}async updateAppointmentStatus(t,e,a={}){if(!this.useFirebase||!this.firebaseService)return this.updateAppointmentStatusLocal(t,e,a);try{const n=this.getCurrentUser(),i=n.role,s=this.getUserClinics(n),r=await this.firebaseService.findAppointmentById(t,i,s),o=r?.dateKey||r?.date,c=await this.firebaseService.updateAppointmentStatus(t,e,a,i,s);return window.cacheManager&&o&&window.cacheManager.onAppointmentUpdated(o,e),c}catch(n){return this.updateAppointmentStatusLocal(t,e,a)}}async updateAppointment(t,e){if(!this.useFirebase||!this.firebaseService)return this.updateAppointmentLocal(t,e);try{const a=this.getCurrentUser(),n=a.role,i=this.getUserClinics(a),s=await this.firebaseService.findAppointmentById(t,n,i),r=s?.dateKey||s?.date||e?.date,o=await this.firebaseService.updateAppointment(t,e,n,i);return window.cacheManager&&r&&window.cacheManager.onAppointmentUpdated(r,e.status||s?.status),o}catch(a){return this.updateAppointmentLocal(t,e)}}updateAppointmentLocal(t,e){try{let a=!1;if(Object.keys(this.data.appointments).forEach(n=>{const i=this.data.appointments[n].findIndex(e=>e.id===t);-1!==i&&(this.data.appointments[n][i]={...this.data.appointments[n][i],...e,lastUpdated:(new Date).toISOString()},a=!0)}),!a&&this.data.pendingConfirmations){const n=this.data.pendingConfirmations.findIndex(e=>e.id===t);-1!==n&&(this.data.pendingConfirmations[n]={...this.data.pendingConfirmations[n],...e,lastUpdated:(new Date).toISOString()},a=!0)}if(a)return this.saveData(),!0;throw new Error("Appointment not found")}catch(t){throw t}}updateAppointmentStatusLocal(t,e,a={}){try{let n=!1;return Object.keys(this.data.appointments).forEach(i=>{const s=this.data.appointments[i],r=s.findIndex(e=>e.id===t);if(-1!==r){if("cancelled"===e){const t={...s[r]};t.status="cancelled",t.cancelledAt=(new Date).toISOString(),t.cancelReason=a.reason||"Unknown",t.cancelNotes=a.notes||"",this.data.cancelledAppointments[i]||(this.data.cancelledAppointments[i]=[]),this.data.cancelledAppointments[i].push(t),s.splice(r,1)}else s[r].status=e,s[r].lastUpdated=(new Date).toISOString();n=!0}}),!!n&&(this.saveToStorage(),!0)}catch(t){return!1}}getCurrentUser(){try{const t=localStorage.getItem("currentUser");if(t){return JSON.parse(t)}}catch(t){}if(!this.data||!this.data.userConfig||!this.data.userConfig.users)return{name:"Sunny",role:"boss",currentViewLocation:"arcadia",assignedLocation:"arcadia"};const t=this.data.userConfig.currentUser,e=this.data.userConfig.users[t];return e||this.data.userConfig.users.boss}switchUser(t){this.data.userConfig.currentUser=t,this.saveToStorage()}switchLocation(t){const e=this.getCurrentUser();"boss"===e.role&&(e.currentViewLocation=t,this.saveToStorage())}async deleteAppointment(t){if(!this.useFirebase||!this.firebaseService)return this.deleteAppointmentLocal(t);try{const e=this.getCurrentUser(),a=e.role,n=this.getUserClinics(e);return await this.firebaseService.deleteAppointment(t,a,n)}catch(e){return this.deleteAppointmentLocal(t)}}deleteAppointmentLocal(t){try{let e=!1;return Object.keys(this.data.appointments).forEach(a=>{const n=this.data.appointments[a],i=n.findIndex(e=>e.id===t);-1!==i&&(n.splice(i,1),e=!0)}),!!e&&(this.saveToStorage(),!0)}catch(t){return!1}}async getPendingConfirmations(){if(!this.useFirebase||!this.firebaseService)return this.data.pendingConfirmations||[];try{const t=this.getCurrentUser(),e=t.role,a=this.getUserClinics(t),n=await this.firebaseService.getAllAppointments(e,a);return n.filter(t=>"pending"===t.status).map(t=>this.convertAppointmentToConfirmation(t))}catch(t){return this.data.pendingConfirmations||[]}}convertAppointmentToConfirmation(t){let e;e=t.appointmentDateTime&&t.appointmentDateTime.seconds?new Date(1e3*t.appointmentDateTime.seconds):t.appointmentDateTime?new Date(t.appointmentDateTime):new Date;const a=e.toLocaleDateString("en-US",{year:"numeric",month:"2-digit",day:"2-digit"}),n=t.appointmentTime||e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});let i=t.location||t.clinicLocation||t.clinicName||"Unknown";return i&&"string"==typeof i&&(i=i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()),{id:t.id,patientName:t.patientName,dateTime:`${a} ${n}`,service:t.service||t.serviceType||t.serviceName||"General",location:i,phone:t.phone||t.patientPhone||"",email:t.email||t.patientEmail||"",notes:t.notes||t.description||"",createdAt:t.createdAt||(new Date).toISOString()}}addPendingConfirmation(t){try{const e={id:this.generateId("pending"),...t,createdAt:(new Date).toISOString()};return this.data.pendingConfirmations.push(e),this.saveToStorage(),e}catch(t){throw t}}async removePendingConfirmation(t){if(!this.useFirebase||!this.firebaseService)return this.removePendingConfirmationLocal(t);try{return await this.firebaseService.removePendingConfirmation(t)}catch(e){return this.removePendingConfirmationLocal(t)}}removePendingConfirmationLocal(t){try{const e=this.data.pendingConfirmations.findIndex(e=>e.id===t);return-1!==e&&(this.data.pendingConfirmations.splice(e,1),this.saveToStorage(),!0)}catch(t){return!1}}async getCancelledAppointments(){if(!this.useFirebase||!this.firebaseService)return this.getCancelledAppointmentsLocal();try{if(window.cacheManager){const t=window.cacheManager.getCancelledCache();if(t)return t}const t=this.getCurrentUser(),e=t.role,a=this.getUserClinics(t),n=await this.firebaseService.getCancelledAppointments(e,a);return window.cacheManager&&n&&window.cacheManager.setCancelledCache(n),n}catch(t){return this.getCancelledAppointmentsLocal()}}getCancelledAppointmentsLocal(){const t=[];return Object.keys(this.data.cancelledAppointments).forEach(e=>{this.data.cancelledAppointments[e].forEach(a=>{t.push({...a,dateKey:e})})}),t}getPatients(){const t=new Map;return this.getAllAppointments().forEach(e=>{const a=e.patientName.toLowerCase();t.has(a)||t.set(a,{id:e.patientName.toLowerCase().replace(/\s+/g,"_"),name:e.patientName,phone:e.phone,email:e.email,appointments:[]}),t.get(a).appointments.push(e)}),this.getCancelledAppointments().forEach(e=>{const a=e.patientName.toLowerCase();t.has(a)||t.set(a,{id:e.patientName.toLowerCase().replace(/\s+/g,"_"),name:e.patientName,phone:e.phone,email:e.email,appointments:[]}),t.get(a).appointments.push(e)}),Array.from(t.values())}getClinicInfo(){return this.data.clinicInfo}clearAllData(){localStorage.removeItem(this.storageKey),this.init()}forceReset(){localStorage.removeItem(this.storageKey),this.data=this.getDefaultData(),this.saveToStorage()}exportData(){return JSON.stringify(this.data,null,2)}importData(t){try{const e=JSON.parse(t);return this.data=e,this.saveToStorage(),!0}catch(t){return!1}}getStatistics(){const t=this.getAllAppointments(),e=(new Date).toISOString().split("T")[0];return{totalAppointments:t.length,todayAppointments:this.getAppointmentsForDate(e).length,pendingConfirmations:this.data.pendingConfirmations.length,cancelledAppointments:this.getCancelledAppointments().length,totalPatients:this.getPatients().length,statusBreakdown:this.getStatusBreakdown(),locationBreakdown:this.getLocationBreakdown()}}getStatusBreakdown(){const t={};return this.getAllAppointments().forEach(e=>{t[e.status]=(t[e.status]||0)+1}),t}getLocationBreakdown(){const t={};return this.getAllAppointments().forEach(e=>{t[e.location]=(t[e.location]||0)+1}),t}}const dataManager=new GlobalDataManager;"undefined"!=typeof module&&module.exports?module.exports=GlobalDataManager:window.dataManager=dataManager;