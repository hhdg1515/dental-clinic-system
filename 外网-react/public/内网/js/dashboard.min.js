function escapeHtml(e){if(null==e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}let currentFirebaseUser=null,userRole=null,userClinics=[],userClaimsCache=null;async function getCurrentUser(){try{const e=["currentUser","user","userData","authUser"];for(const t of e){const e=localStorage.getItem(t);if(e){const t=JSON.parse(e);if(t&&(t.role||t.email))return currentFirebaseUser=t,t}}return null}catch(e){return null}}async function getUserRole(){const e=await getCurrentUser();if(!e)return null;try{return e.role?(userRole=e.role,userClinics=e.clinics||e.accessibleLocations||[],userRole):e.email&&(e.email.includes("admin")||e.email.includes("boss")||e.email.includes("owner"))?(userRole="admin",userRole):null}catch(e){return null}}async function redirectIfNotAdmin(){const e=await getCurrentUser(),t=await getUserRole();return e?!(!t||"admin"!==t&&"boss"!==t&&"owner"!==t)||(showAuthError("Access denied. Admin privileges required for internal dashboard."),!1):(showAuthError("Please login first through the external website to access the internal dashboard."),!1)}async function initializeUserPermissions(){try{const e=await window.AuthUtils.getCurrentUserClaims();if(!e)return userRole=null,void(userClinics=[]);userClaimsCache=e,userRole=e.claims.role||null,userClinics="owner"===userRole||"boss"===userRole?["arcadia","irvine","south-pasadena","rowland-heights","eastvale"]:"admin"===userRole&&e.claims.clinics?e.claims.clinics:[],!userRole&&e.user.email&&e.user.email.endsWith("@firstavedental.com")&&(userRole="owner",userClinics=["arcadia","irvine","south-pasadena","rowland-heights","eastvale"])}catch(e){userRole=null,userClinics=[]}}function isOwner(){if("boss"===userRole||"owner"===userRole)return!0;if(userClaimsCache&&userClaimsCache.claims){const e=userClaimsCache.claims.role;return"boss"===e||"owner"===e}return!1}function getAccessibleClinics(){if(userClinics&&userClinics.length>0)return userClinics;if(userClaimsCache&&userClaimsCache.claims){const e=userClaimsCache.claims.role;if("owner"===e||"boss"===e)return["arcadia","irvine","south-pasadena","rowland-heights","eastvale"];if("admin"===e&&userClaimsCache.claims.clinics)return userClaimsCache.claims.clinics}return[]}function hasClinicAccess(e){return getAccessibleClinics().includes(e)}function filterDataByRole(e,t="appointments"){if(!e||!Array.isArray(e))return e;if(isOwner())return e;const n=getAccessibleClinics();return e.filter(e=>{if(!e.location)return!1;const t=e.location.toLowerCase().replace(/\s+/g,"-");return n.includes(t)})}function setupAuthStateListener(){}async function updateUIBasedOnRole(){updateLocationSelectorPermissions(),updateUserDisplay(),updateDashboardStats(),await refreshDashboardData()}function updateLocationSelectorPermissions(){const e=document.querySelector(".location-selector-container"),t=document.getElementById("locationSelector");if(t)if(isOwner()){e&&(e.style.display="flex");const n=[{value:"arcadia",name:"Arcadia"},{value:"irvine",name:"Irvine"},{value:"south-pasadena",name:"South Pasadena"},{value:"rowland-heights",name:"Rowland Heights"},{value:"eastvale",name:"Eastvale"}];t.innerHTML="",n.forEach(e=>{const n=document.createElement("option");n.value=e.value,n.textContent=e.name,t.appendChild(n)})}else e&&(e.style.display="none")}function updateUserDisplay(){const e=document.querySelector(".user-name"),t=document.querySelector(".user-role");if(currentFirebaseUser&&(e&&(e.textContent=currentFirebaseUser.displayName||currentFirebaseUser.email.split("@")[0]),t)){const e="boss"===userRole||"owner"===userRole?"Owner":"Admin";t.textContent=e}}function testFirebaseConnection(){const e=()=>!!(window.firebase&&window.firebase.app&&window.firebase.auth&&window.firebase.db);if(e())return;let t=0;const n=setInterval(()=>{t++,(e()||t>=50)&&clearInterval(n)},100)}function getLocalDateString(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function getStartOfWeek(e){const t=new Date(e),n=t.getDay(),a=t.getDate()-n+(0===n?-6:1);return t.setDate(a),t}function safeGetCurrentUser(){try{const e=["currentUser","user","userData","authUser"];for(const t of e){const e=localStorage.getItem(t);if(e){const t=JSON.parse(e);if(t&&(t.role||t.email))return t}}if(window.dataManager&&dataManager.getCurrentUser)return dataManager.getCurrentUser()}catch(e){}return{name:"Sunny",role:"boss",currentViewLocation:"arcadia",assignedLocation:"arcadia"}}function safeGetCurrentLocation(){if(currentFirebaseUser&&userRole){if(isOwner()){const e=document.getElementById("locationSelector");return e&&e.value?e.value:"arcadia"}{const e=getAccessibleClinics();return e.length>0?e[0]:"arcadia"}}const e=safeGetCurrentUser();return"boss"===e.role?e.currentViewLocation||"arcadia":e.assignedLocation||"arcadia"}async function safeGetAppointmentsForDate(e){try{if(window.dataManager&&dataManager.getAppointmentsForDate){let t=await dataManager.getAppointmentsForDate(e)||[];return t=filterDataByRole(t,"appointments"),t}}catch(e){}return[]}function safeGetAppointmentsForDateSync(e){try{if(window.dataManager&&dataManager.getAppointmentsForDateLocal){let t=dataManager.getAppointmentsForDateLocal(e)||[];return t=filterDataByRole(t,"appointments"),t}}catch(e){}return[]}async function safeGetPendingConfirmations(){try{if(window.dataManager&&dataManager.getPendingConfirmations){let e=await dataManager.getPendingConfirmations()||[];return e=filterDataByRole(e,"confirmations"),e}}catch(e){}return[]}function safeGetPendingConfirmationsSync(){try{if(window.dataManager&&window.dataManager.data){let e=dataManager.data.pendingConfirmations||[];return e=filterDataByRole(e,"confirmations"),e}}catch(e){}return[]}async function initializeAuthSystem(){setupAuthStateListener(),await performInitialAuthCheck()}function waitForDataManager(){return new Promise(e=>{const t=()=>{window.dataManager&&window.dataManager.firebaseService?e():setTimeout(t,100)};t()})}async function performInitialAuthCheck(){try{await redirectIfNotAdmin()&&(await initializeUserPermissions(),await waitForDataManager(),initializeDashboard(),initializeModal(),initializeLocationSelector(),await updateUIBasedOnRole(),await refreshDashboardData(),renderDashboardCalendar())}catch(e){showAuthError("Authentication check failed")}}function showAuthError(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #fee2e2;\n        color: #991b1b;\n        padding: 20px;\n        border-radius: 8px;\n        border: 1px solid #fecaca;\n        z-index: 9999;\n        font-family: Inter, sans-serif;\n        max-width: 400px;\n        text-align: center;\n    ";const n=e.includes("login");t.innerHTML=`\n        <h3 style="margin: 0 0 10px 0;">Authentication ${n?"Required":"Error"}</h3>\n        <p style="margin: 0;">${e}</p>\n        <button onclick="this.parentElement.remove()" style="\n            background: #6b7280;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 4px;\n            margin: 10px 5px 0 5px;\n            cursor: pointer;\n        ">Close</button>\n    `,document.body.appendChild(t)}function initializeDashboard(){updateTodayDate(),renderDashboardCalendar(),initializeServiceChartSelector();const e=document.getElementById("service");e&&window.ServiceMapping&&window.ServiceMapping.populateInternalServiceDropdown(e),"function"==typeof setMinDateToToday&&setMinDateToToday("appointmentDate"),"function"==typeof initializePhoneFormatting&&initializePhoneFormatting("phoneNumber"),"function"==typeof initializePatientNameValidation&&initializePatientNameValidation("patientName")}function initializeUserSwitcher(){const e=document.getElementById("userSwitcher"),t=document.getElementById("userSwitchSelect");DEV_MODE?t&&(t.value=currentDevUser.id,t.addEventListener("change",function(){handleUserSwitch(this.value)})):e&&(e.style.display="none")}async function handleUserSwitch(e){DEV_MODE&&DEV_USERS[e]&&(currentDevUser=DEV_USERS[e],await refreshDashboardData())}function initializeServiceChartSelector(){const e=document.getElementById("chartPeriodSelector");e&&(e.addEventListener("change",function(){renderServiceChart()}),e.value="weekly")}function initializeLocationSelector(){const e=document.getElementById("locationSelector"),t=safeGetCurrentUser();if(!e||"boss"!==t.role)return;const n=[{value:"arcadia",name:"Arcadia"},{value:"irvine",name:"Irvine"},{value:"south-pasadena",name:"South Pasadena"},{value:"rowland-heights",name:"Rowland Heights"},{value:"eastvale",name:"Eastvale"}];e.innerHTML="",n.forEach(t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.name,e.appendChild(n)}),t.currentViewLocation&&(e.value=t.currentViewLocation),e.addEventListener("change",async function(){const e=this.value;try{if(window.dataManager&&dataManager.switchLocation){if(dataManager.switchLocation(e),"function"==typeof showSuccessMessage){const t=n.find(t=>t.value===e)?.name||e;showSuccessMessage(`Switched to ${t} location`)}await refreshDashboardData()}}catch(e){"function"==typeof showErrorMessage&&showErrorMessage("Failed to switch location")}})}function updateTodayDate(){const e=document.getElementById("todayDate");if(e){const t=(new Date).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"});e.textContent=t}}async function refreshDashboardData(){await renderStatusCards(),await renderAnalysisCards(),await renderTodaysAppointments(),await renderServiceChart(),await renderTrendChart(),await renderPendingConfirmations();try{const e=(await safeGetPendingConfirmations()).length;"function"==typeof updateNotificationBadge&&updateNotificationBadge(e>0)}catch(e){}}async function renderStatusCards(){const e=getCurrentDate(),t=safeGetCurrentLocation(),n=(await safeGetAppointmentsForDate(e)).filter(e=>"all"===t||e.location.toLowerCase().replace(/\s+/g,"-")===t),a={completed:0,inProgress:0,scheduled:0,noShow:0};n.forEach(e=>{switch(e.status){case"completed":a.completed++;break;case"arrived":a.inProgress++;break;case"scheduled":a.scheduled++;break;case"no-show":a.noShow++}});const o={completedCount:document.getElementById("completedCount"),inProgressCount:document.getElementById("inProgressCount"),scheduledCount:document.getElementById("scheduledCount"),noShowCount:document.getElementById("noShowCount")};o.completedCount&&(o.completedCount.textContent=a.completed),o.inProgressCount&&(o.inProgressCount.textContent=a.inProgress),o.scheduledCount&&(o.scheduledCount.textContent=a.scheduled),o.noShowCount&&(o.noShowCount.textContent=a.noShow)}async function renderAnalysisCards(){const e={allAppointmentsCount:document.getElementById("allAppointmentsCount"),allAppointmentsChange:document.getElementById("allAppointmentsChange"),newPatientsCount:document.getElementById("newPatientsCount"),newPatientsChange:document.getElementById("newPatientsChange"),attendanceRate:document.getElementById("attendanceRate"),attendanceProgress:document.getElementById("attendanceProgress"),attendanceLabel:document.getElementById("attendanceLabel"),premiumMembersCount:document.getElementById("premiumMembersCount"),premiumMembersChange:document.getElementById("premiumMembersChange")},t=safeGetCurrentLocation();let n=[];try{n=await dataManager.getAllAppointments()||[],n=filterDataByRole(n,"appointments")}catch(e){n=[]}const a=n.filter(e=>"all"===t||e.location.toLowerCase().replace(/\s+/g,"-")===t),o=(getCurrentDate(),new Date),i=o.getMonth(),r=o.getFullYear(),s=0===i?11:i-1,l=0===i?r-1:r,c=a.filter(e=>{const t=new Date(e.dateKey);return t.getMonth()===i&&t.getFullYear()===r}),d=a.filter(e=>{const t=new Date(e.dateKey);return t.getMonth()===s&&t.getFullYear()===l}),u=c.length,m=c.length-d.length,g=new Set,h=new Set,p=new Set;a.forEach(e=>{e.phone&&g.add(e.phone)}),c.forEach(e=>{e.phone&&h.add(e.phone)}),d.forEach(e=>{e.phone&&p.add(e.phone)});g.size;const f=h.size,C=f-p.size,w=getStartOfWeek(o),y=new Date(w);y.setDate(w.getDate()+6);const v=[];for(let e=new Date(w);e<=y;e.setDate(e.getDate()+1)){const t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,n=await safeGetAppointmentsForDate(t);v.push(...n)}const D=v.filter(e=>"all"===t||e.location.toLowerCase().replace(/\s+/g,"-")===t),b=D.filter(e=>"completed"===e.status||"arrived"===e.status).length,S=D.length,E=S>0?Math.round(b/S*100):0;if(e.allAppointmentsCount&&(e.allAppointmentsCount.textContent=u),e.allAppointmentsChange){const t=m>=0?`+${m}`:m;e.allAppointmentsChange.textContent=`${t} in this month`,e.allAppointmentsChange.className="change-indicator "+(m>=0?"positive":"negative")}if(e.newPatientsCount&&(e.newPatientsCount.textContent=f),e.newPatientsChange){const t=C>=0?`+${C}`:C;e.newPatientsChange.textContent=`${t} in this month`,e.newPatientsChange.className="change-indicator "+(C>=0?"positive":"negative")}e.attendanceRate&&(e.attendanceRate.textContent=`${E}%`),e.attendanceProgress&&(e.attendanceProgress.style.width=`${E}%`),e.attendanceLabel&&(e.attendanceLabel.textContent=`This Week ${b}/${S}`),e.premiumMembersCount&&(e.premiumMembersCount.textContent="0"),e.premiumMembersChange&&(e.premiumMembersChange.textContent="0 in this month",e.premiumMembersChange.className="change-indicator neutral")}async function renderTodaysAppointments(){const e=document.getElementById("todaysAppointmentsList");if(!e)return;const t=getCurrentDate(),n=safeGetCurrentLocation(),a=(await safeGetAppointmentsForDate(t)).filter(e=>"all"===n||e.location.toLowerCase().replace(/\s+/g,"-")===n).sort((e,t)=>e.time.localeCompare(t.time));e.innerHTML="";const o=a.slice(0,6);for(let t=0;t<6;t++){const n=document.createElement("tr");if(t<o.length){const e=o[t],a=formatTime(e.time),i=getStatusDisplayName(e.status);n.innerHTML=`\n            <td>${escapeHtml(e.patientName)}</td>\n            <td>${escapeHtml(a)}</td>\n            <td>${escapeHtml(e.service)}</td>\n            <td><span class="status-badge ${e.status}">${escapeHtml(i)}</span></td>\n        `}else n.innerHTML='\n            <td style="color: #d1d5db;">--</td>\n            <td style="color: #d1d5db;">--</td>\n            <td style="color: #d1d5db;">--</td>\n            <td style="color: #d1d5db;">--</td>\n        ';e.appendChild(n)}}async function renderPendingConfirmations(){const e=document.getElementById("pendingConfirmationsList"),t=document.getElementById("pendingConfirmationCount");if(e&&t){e.innerHTML='<div style="padding: 20px; text-align: center; color: #6b7280;">Loading pending confirmations...</div>',t.textContent="...";try{const n=await safeGetPendingConfirmations();if(t.textContent=n.length,e.innerHTML="",0===n.length)return void(e.innerHTML='<div style="padding: 20px; text-align: center; color: #6b7280; font-style: italic;">No pending confirmations</div>');n.slice(0,3).forEach(t=>{const n=document.createElement("div");n.className="pending-item",n.innerHTML=`\n                <div class="pending-info">\n                    <div class="pending-patient-name">${escapeHtml(t.patientName)}</div>\n                    <div class="pending-details">\n                        ${escapeHtml(t.dateTime)}<br>\n                        ${escapeHtml(t.service)} • ${escapeHtml(t.location)}\n                    </div>\n                </div>\n                <div class="pending-actions">\n                    <button class="btn-icon" data-confirmation-id="${escapeHtml(t.id)}" data-action="confirm" title="Confirm">✓</button>\n                    <button class="btn-icon" data-confirmation-id="${escapeHtml(t.id)}" data-action="decline" title="Decline">✗</button>\n                </div>\n            `;n.querySelectorAll(".btn-icon").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-action"),t=this.getAttribute("data-confirmation-id");"confirm"===e?handleConfirmAction(t):"decline"===e&&handleDeclineAction(t)})}),e.appendChild(n)})}catch(n){e.innerHTML='<div style="padding: 20px; text-align: center; color: #dc3545;">Error loading pending confirmations</div>',t.textContent="0"}}}async function renderServiceChart(){const e=document.getElementById("serviceChart"),t=document.getElementById("chartLegend");if(!e||!t)return;const n=e.getContext("2d"),a=await getServiceTypeData();if(n.clearRect(0,0,e.width,e.height),updateChartLegend(t,a),0===a.length){const t=e.width/2,a=e.height/2,o=80;return n.strokeStyle="#e5e7eb",n.lineWidth=2,n.beginPath(),n.arc(t,a,o,0,2*Math.PI),n.stroke(),n.setLineDash([5,5]),n.strokeStyle="#d1d5db",n.beginPath(),n.arc(t,a,o-20,0,2*Math.PI),n.stroke(),n.setLineDash([]),n.fillStyle="#9ca3af",n.font="14px Inter",n.textAlign="center",void n.fillText("No appointments",t,a)}drawPieChart(n,a,e.width/2,e.height/2,80)}async function getServiceTypeData(){const e=safeGetCurrentLocation(),t=document.getElementById("chartPeriodSelector"),n=t?t.value:"weekly";let a=[];if("weekly"===n){const e=getStartOfWeek(new Date),t=new Date(e);t.setDate(e.getDate()+6);for(let n=new Date(e);n<=t;n.setDate(n.getDate()+1)){const e=n.toISOString().split("T")[0],t=await safeGetAppointmentsForDate(e);a.push(...t)}}else if("monthly"===n){const e=new Date,t=e.getMonth(),n=e.getFullYear();let o=[];try{o=await dataManager.getAllAppointments()||[],Array.isArray(o)||(o=[]),o=filterDataByRole(o,"appointments"),Array.isArray(o)||(o=[])}catch(e){o=[]}a=o.filter(e=>{const a=new Date(e.dateKey),i=a.getMonth()===t&&a.getFullYear()===n;return!i&&o.length,i})}const o=a.filter(t=>"all"===e||t.location.toLowerCase().replace(/\s+/g,"-")===e),i={};o.forEach(e=>{const t=mapServiceName(e.service);i[t]=(i[t]||0)+1});const r=["#5B7FD8","#52C4A0","#8B9DC3","#DBA362","#A78BCA","#7ECBC9","#B8C5A6","#E8A87C","#C4A5C7"],s=Object.values(i).reduce((e,t)=>e+t,0),l={General:"#5B7FD8",Implant:"#52C4A0",Extraction:"#8B9DC3",Preventive:"#DBA362",Cosmetic:"#A78BCA",Orthodontics:"#7ECBC9","Root Canals":"#B8C5A6",Restorations:"#E8A87C",Periodontics:"#C4A5C7"};return Object.entries(i).map(([e,t],n)=>({label:e,value:t,color:l[e]||r[n%r.length],percentage:s>0?Math.round(t/s*100):0}))}function drawPieChart(e,t,n,a,o){const i=t.reduce((e,t)=>e+t.value,0);let r=-Math.PI/2;t.forEach(t=>{const s=t.value/i*2*Math.PI;if(e.fillStyle=t.color,e.beginPath(),e.moveTo(n,a),e.arc(n,a,o,r,r+s),e.closePath(),e.fill(),t.percentage>0){const i=r+s/2;let l,c;if(100===t.percentage)l=n,c=a;else{const e=.65*o;l=n+Math.cos(i)*e,c=a+Math.sin(i)*e}e.save(),e.fillStyle="white",e.font="bold 14px Inter",e.textAlign="center",e.textBaseline="middle",e.fillText(`${t.percentage}%`,l,c),e.restore()}r+=s})}function updateChartLegend(e,t){e.innerHTML="";[{label:"General",color:"#5B7FD8"},{label:"Implant",color:"#52C4A0"},{label:"Extraction",color:"#8B9DC3"},{label:"Preventive",color:"#DBA362"},{label:"Cosmetic",color:"#A78BCA"},{label:"Orthodontics",color:"#7ECBC9"},{label:"Root Canals",color:"#B8C5A6"},{label:"Restorations",color:"#E8A87C"},{label:"Periodontics",color:"#C4A5C7"}].forEach(t=>{const n=document.createElement("div");n.className="legend-item",n.innerHTML=`\n            <div class="legend-color" style="background-color: ${escapeHtml(t.color)}"></div>\n            <span>${escapeHtml(t.label)}</span>\n        `,e.appendChild(n)})}function initializeModal(){const e=document.getElementById("quickAddBtn"),t=document.getElementById("quickAddModal");if(!e||!t)return;const n=e.cloneNode(!0);e.parentNode.replaceChild(n,e),n.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),applyQuickAddLocationPermissions(),t.classList.add("show"),document.body.style.overflow="hidden"});const a=document.getElementById("modalClose"),o=document.getElementById("modalCancel");function i(){t.classList.remove("show"),document.body.style.overflow="auto";const e=document.getElementById("quickAddForm");e&&e.reset()}a&&a.addEventListener("click",i),o&&o.addEventListener("click",i),t.addEventListener("click",function(e){e.target===t&&i()});const r=document.getElementById("quickAddForm");r&&r.addEventListener("submit",function(e){e.preventDefault(),handleQuickAddAppointment(),i()})}function applyQuickAddLocationPermissions(){const e=dataManager.getCurrentUser(),t=document.getElementById("location");if(!t)return;const n=dataManager.getUserClinics(e);t.innerHTML='<option value="">Select Location</option>';const a={arcadia:"Arcadia",irvine:"Irvine","south-pasadena":"South Pasadena","rowland-heights":"Rowland Heights",eastvale:"Eastvale"};n.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=a[e]||e,t.appendChild(n)}),"admin"===e.role?(t.value=e.assignedLocation,t.disabled=!0,t.style.backgroundColor="#f3f4f6",t.style.cursor="not-allowed"):(t.disabled=!1,t.style.backgroundColor="white",t.style.cursor="pointer")}async function handleQuickAddAppointment(){try{const e={patientName:document.getElementById("patientName")?.value,date:document.getElementById("appointmentDate")?.value,time:document.getElementById("appointmentTime")?.value?.split("-")[0],service:document.getElementById("service")?.value,location:document.getElementById("location")?.value,phone:document.getElementById("phoneNumber")?.value};if(!(e.patientName&&e.date&&e.time&&e.service&&e.location))return void("function"==typeof showErrorMessage?showErrorMessage("Please fill in all required fields"):alert("Please fill in all required fields"));if(window.dataManager&&dataManager.addAppointment)try{await dataManager.addAppointment(e),"function"==typeof showSuccessMessage?showSuccessMessage("Appointment added successfully!"):alert("Appointment added successfully!"),await refreshDashboardData()}catch(e){"function"==typeof showErrorMessage?showErrorMessage("Failed to add appointment"):alert("Failed to add appointment")}}catch(e){"function"==typeof showErrorMessage?showErrorMessage("Failed to add appointment. Please try again."):alert("Failed to add appointment. Please try again.")}}function getStatusDisplayName(e){return{scheduled:"Scheduled",arrived:"Arrived",completed:"Completed","no-show":"No Show",cancelled:"Cancelled",held:"Held"}[e]||e}async function getLast30DaysCompletedData(){const e=safeGetCurrentLocation(),t=[];for(let n=29;n>=0;n--){const a=new Date;a.setDate(a.getDate()-n);const o=a.toISOString().split("T")[0],i=(await safeGetAppointmentsForDate(o)).filter(t=>"all"===e||t.location.toLowerCase().replace(/\s+/g,"-")===e).filter(e=>"completed"===e.status).length;t.push({date:o,dateLabel:a.getMonth()+1+"/"+a.getDate(),completed:i})}return t}async function renderTrendChart(){const e=document.getElementById("trendChart");if(!e)return;const t=document.querySelector(".trend-chart-container");e.style.width="100%",e.style.height="auto";const n=window.getComputedStyle(t),a=parseFloat(n.paddingLeft)+parseFloat(n.paddingRight),o=t.clientWidth-a,i=Math.min(o,800);e.width=i,e.height=296;const r=e.getContext("2d"),s=await getLast30DaysCompletedData();if(r.clearRect(0,0,e.width,e.height),0===s.length)return r.fillStyle="#6b7280",r.font="14px Inter",r.textAlign="center",void r.fillText("No data available for the last 30 days.",e.width/2,e.height/2);const l=50,c=e.width-100,d=e.height-100,u=Math.max(...s.map(e=>e.completed),1);r.strokeStyle="#e5e7eb",r.lineWidth=1,r.beginPath(),r.moveTo(l,l),r.lineTo(l,e.height-l),r.lineTo(e.width-l,e.height-l),r.stroke(),r.font="12px Inter",r.fillStyle="#6b7280",r.textAlign="right";for(let t=0;t<=4;t++){const n=Math.round(u/4*t),a=e.height-l-t/4*d;r.fillText(n.toString(),40,a+3)}r.font="12px Inter",r.fillStyle="#6b7280",r.textAlign="center";const m=Math.ceil(s.length/5);s.forEach((t,n)=>{if(n%m===0||n===s.length-1){const a=l+n/(s.length-1)*c;r.beginPath(),r.moveTo(a,e.height-l),r.lineTo(a,e.height-l+5),r.stroke(),r.fillText(t.dateLabel,a,e.height-l+25)}}),r.strokeStyle="#3b82f6",r.lineWidth=2,r.beginPath();const g=s.map((t,n)=>({x:l+n/(s.length-1)*c,y:e.height-l-t.completed/u*d}));if(g.length>1){r.moveTo(g[0].x,g[0].y);for(let e=0;e<g.length-1;e++){const t=g[e],n=g[e+1],a=(t.x+n.x)/2,o=t.y,i=(t.x+n.x)/2,s=n.y;r.bezierCurveTo(a,o,i,s,n.x,n.y)}}r.stroke()}function renderDashboardCalendar(){const e=document.getElementById("calendarDates"),t=document.getElementById("calendarMonthYear");if(!e||!t)return;const n=new Date,a=n.getMonth(),o=n.getFullYear();t.textContent=`${["January","February","March","April","May","June","July","August","September","October","November","December"][a]} ${o}`;const i=new Date(o,a,1),r=(new Date(o,a+1,0),new Date(i));r.setDate(r.getDate()-i.getDay()),e.innerHTML="";for(let t=0;t<42;t++){const o=new Date(r);o.setDate(r.getDate()+t);const i=document.createElement("div");i.className="calendar-date",i.textContent=o.getDate(),o.getMonth()!==a&&i.classList.add("other-month"),o.toDateString()===n.toDateString()&&i.classList.add("today"),e.appendChild(i)}}function mapServiceName(e){return{Cleaning:"Preventive",Examination:"Preventive","Root Canal":"Root Canals",Filling:"Restorations",Orthodontics:"Orthodontics","Teeth Whitening":"Cosmetic",Periodontal:"Periodontics",Restorative:"Restorations",Extraction:"Extraction",Implant:"Implant"}[e]||e}document.addEventListener("DOMContentLoaded",function(){testFirebaseConnection(),initializeAuthSystem()}),window.handleConfirmAction=async function(e){if(confirm("Please confirm if you want to CONFIRM this appointment?"))try{window.dataManager&&dataManager.removePendingConfirmation&&(await dataManager.removePendingConfirmation(e),"function"==typeof showSuccessMessage&&showSuccessMessage("Appointment confirmed!"),await refreshDashboardData())}catch(e){}},window.handleDeclineAction=async function(e){if(confirm("Please confirm if you want to DECLINE this appointment?"))try{window.dataManager&&dataManager.removePendingConfirmation&&(dataManager.removePendingConfirmation(e),"function"==typeof showSuccessMessage&&showSuccessMessage("Appointment declined!"),await refreshDashboardData())}catch(e){}};let pollingInterval=null,lastPendingCount=0;async function pollPendingAppointments(){try{if(!window.firebaseDataService)return;const e=await getUserRole(),t=getAccessibleClinics();if(!e||0===t.length)return;const n=await window.firebaseDataService.getPendingAppointmentsCount(e,t);updateNotificationBell(n>0);const a=document.getElementById("pendingConfirmationCount");a&&(a.textContent=n),lastPendingCount=n}catch(e){}}async function initializePollingSystem(){try{if(!window.firebaseDataService)return void setTimeout(initializePollingSystem,500);await pollPendingAppointments(),pollingInterval=setInterval(pollPendingAppointments,18e5)}catch(e){}}function updateNotificationBell(e){const t=document.getElementById("notificationBell");t&&(e?t.classList.add("has-notifications"):t.classList.remove("has-notifications"))}function handleNotificationBellClick(){window.location.href="patients.html"}function cleanupPollingSystem(){pollingInterval&&(clearInterval(pollingInterval),pollingInterval=null)}async function updateDashboardStats(){try{if(!window.firebaseDataService)return;const e=await getUserRole(),t=getAccessibleClinics();if(!e||0===t.length)return;const n=await window.dataManager.getAllAppointments();if(!Array.isArray(n))return;updateStatsDisplayWithComparison(calculateAppointmentStatsWithComparison(n))}catch(e){}}function calculateAppointmentStatsWithComparison(e){const t=new Date,n=t.getMonth(),a=t.getFullYear(),o=0===n?11:n-1,i=0===n?a-1:a,r=e.filter(e=>{if(!e.dateKey)return!1;const t=new Date(e.dateKey);return t.getMonth()===n&&t.getFullYear()===a}),s=e.filter(e=>{if(!e.dateKey)return!1;const t=new Date(e.dateKey);return t.getMonth()===o&&t.getFullYear()===i}),l=r.length,c={completed:0,inProgress:0,scheduled:0,noShow:0,total:l,appointmentChange:l-s.length,newPatients:0,newPatientsChange:0,vips:0,pending:0};r.forEach(e=>{const t=e.status?.toLowerCase();switch(t){case"completed":c.completed++;break;case"in-progress":case"arrived":c.inProgress++;break;case"scheduled":case"confirmed":c.scheduled++;break;case"no-show":c.noShow++;break;case"pending":c.pending++}});const d=new Set,u=new Set;r.forEach(e=>{e.phone&&d.add(e.phone)}),s.forEach(e=>{e.phone&&u.add(e.phone)}),c.newPatients=d.size;const m=u.size;return c.newPatientsChange=c.newPatients-m,c.vips=Math.floor(.1*c.newPatients),c}function calculateAppointmentStats(e){return calculateAppointmentStatsWithComparison(e)}function updateStatsDisplayWithComparison(e){const t=document.getElementById("completedCount"),n=document.getElementById("inProgressCount"),a=document.getElementById("scheduledCount"),o=document.getElementById("noShowCount");t&&(t.textContent=e.completed),n&&(n.textContent=e.inProgress),a&&(a.textContent=e.scheduled),o&&(o.textContent=e.noShow);const i=document.getElementById("allAppointmentsCount"),r=document.getElementById("allAppointmentsChange");if(i&&(i.textContent=e.total),r){const t=e.appointmentChange>=0?`+${e.appointmentChange}`:e.appointmentChange;r.textContent=`${t} vs last month`,r.className="change-indicator "+(e.appointmentChange>=0?"positive":"negative")}const s=document.getElementById("newPatientsCount"),l=document.getElementById("newPatientsChange");if(s&&(s.textContent=e.newPatients),l){const t=e.newPatientsChange>=0?`+${e.newPatientsChange}`:e.newPatientsChange;l.textContent=`${t} vs last month`,l.className="change-indicator "+(e.newPatientsChange>=0?"positive":"negative")}const c=document.getElementById("premiumMembersCount");c&&(c.textContent=e.vips);const d=document.getElementById("pendingConfirmationCount");d&&e.pending>0&&(d.textContent=e.pending)}function updateStatsDisplay(e){updateStatsDisplayWithComparison(e)}document.addEventListener("DOMContentLoaded",function(){setTimeout(initializePollingSystem,1e3);const e=document.getElementById("notificationBell");e&&e.addEventListener("click",handleNotificationBellClick)}),window.addEventListener("beforeunload",cleanupPollingSystem);