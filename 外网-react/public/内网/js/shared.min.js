function initializeNavigation(){document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",function(e){const t=this.getAttribute("href");if(this.classList.contains("logout"))return e.preventDefault(),void handleLogout();t&&t.startsWith("#")&&e.preventDefault()})})}function initializeNotificationBell(){const e=document.getElementById("notificationBell");e&&(e.addEventListener("click",function(e){e.preventDefault(),window.location.href="patients.html#pending"}),e.style.cursor="pointer")}async function handleLogout(e){if(e&&e.preventDefault(),confirm("Are you sure you want to logout?"))try{if(window.firebase&&window.firebase.auth){const{signOut:e}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js");await e(window.firebase.auth)}["currentUser","user","userData","authUser"].forEach(e=>{localStorage.removeItem(e)}),sessionStorage.removeItem("internal_auth_checked"),showSuccessMessage("Logged out successfully. Redirecting..."),setTimeout(()=>{window.location.href="../外网/landingpage.html"},1e3)}catch(e){alert("Logout failed. Please try again.")}}function initializeKeyboardShortcuts(){document.addEventListener("keydown",function(e){if("Escape"===e.key){document.querySelectorAll(".modal-overlay.show").forEach(e=>{e.classList.remove("show"),document.body.style.overflow="auto";e.querySelectorAll(".modify-form, .hold-form").forEach(e=>{e.style.display="none"});e.querySelectorAll(".btn-action").forEach(e=>{e.style.display="flex"})})}if((e.ctrlKey||e.metaKey)&&"n"===e.key){const t=document.getElementById("quickAddBtn")||document.getElementById("newAppointmentBtn")||document.querySelector(".new-appointment-btn");t&&(e.preventDefault(),t.click())}})}function showSuccessMessage(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: #10b981;\n        color: white;\n        padding: 12px 20px;\n        border-radius: 8px;\n        font-weight: 500;\n        z-index: 1001;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        transition: all 0.3s ease;\n    ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout(()=>{t.parentNode&&t.remove()},300)},3e3)}function formatPhoneNumber(e){const t=e.value.replace(/\D/g,""),n=t.replace(/(\d{3})(\d{3})(\d{4})/,"($1) $2-$3");t.length<=10&&(e.value=n)}function initializePatientNameValidation(e){const t=document.getElementById(e);t&&(t.addEventListener("input",function(){this.value=this.value.replace(/[^A-Za-z\s]/g,"")}),t.addEventListener("keypress",function(e){const t=String.fromCharCode(e.which);/[A-Za-z\s]/.test(t)||e.preventDefault()}))}function initializePhoneFormatting(e){const t=document.getElementById(e);t&&t.addEventListener("input",function(){formatPhoneNumber(this)})}function closeModal(e){const t=document.getElementById(e);t&&(t.classList.remove("show"),document.body.style.overflow="auto")}function openModal(e){const t=document.getElementById(e);t&&(t.classList.add("show"),document.body.style.overflow="hidden")}function capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...o)},t)}}function formatTime(e){const[t,n]=e.split(":").map(Number),o=t>=12?"PM":"AM",i=t>12?t-12:0===t?12:t,a=n.toString().padStart(2,"0");return`${i.toString().padStart(2,"0")}:${a} ${o}`}function getCurrentDate(){return(new Date).toISOString().split("T")[0]}function setMinDateToToday(e){const t=document.getElementById(e);t&&(t.min=getCurrentDate())}function validatePatientName(e){return/^[A-Za-z\s]+$/.test(e)&&e.trim().length>0}function validatePhoneNumber(e){return 10===e.replace(/\D/g,"").length}function validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}document.addEventListener("DOMContentLoaded",function(){initializeNavigation(),initializeNotificationBell(),initializeKeyboardShortcuts(),initializeHistoryIconNavigation(),initializeGlobalSearch()}),window.handleLogout=handleLogout;const serviceDisplayMap={general:"General",implant:"Implant",extraction:"Extraction",preventive:"Preventive",cosmetic:"Cosmetic",orthodontics:"Orthodontics","root-canals":"Root Canals",restorations:"Restorations",periodontics:"Periodontics"};function getServiceDisplayName(e){return serviceDisplayMap[e]||e}const locationDisplayMap={arcadia:"Arcadia",irvine:"Irvine","south-pasadena":"South Pasadena","rowland-heights":"Rowland Heights",eastvale:"Eastvale"};function getLocationDisplayName(e){return locationDisplayMap[e]||e}const timeSlotOptions={"09:00-10:00":"09:00 AM - 10:00 AM","10:00-11:00":"10:00 AM - 11:00 AM","11:00-12:00":"11:00 AM - 12:00 PM","12:00-13:00":"12:00 PM - 01:00 PM","13:00-14:00":"01:00 PM - 02:00 PM","14:00-15:00":"02:00 PM - 03:00 PM","15:00-16:00":"03:00 PM - 04:00 PM","16:00-17:00":"04:00 PM - 05:00 PM"};function getTimeSlotDisplayName(e){return timeSlotOptions[e]||e}function extractTimeFromSlot(e){return e.split("-")[0]}const appointmentStatusConfig={scheduled:{class:"scheduled",color:"#6b7280",bgColor:"#f3f4f6",label:"Scheduled"},arrived:{class:"arrived",color:"#1e40af",bgColor:"#dbeafe",label:"Arrived"},completed:{class:"completed",color:"white",bgColor:"#1e40af",label:"Completed"},"no-show":{class:"no-show",color:"#dc2626",bgColor:"#fecaca",label:"No-Show"},cancelled:{class:"cancelled",color:"white",bgColor:"#dc2626",label:"Cancelled"},held:{class:"held",color:"white",bgColor:"#a855f7",label:"Held"}};function getStatusConfig(e){return appointmentStatusConfig[e]||appointmentStatusConfig.scheduled}function formatDateForDisplay(e){return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}function formatDateTimeForDisplay(e,t){return`${formatDateForDisplay(e)} ${formatTime(t)}`}function saveToSessionStorage(e,t){try{sessionStorage.setItem(e,JSON.stringify(t))}catch(e){}}function getFromSessionStorage(e,t=null){try{const n=sessionStorage.getItem(e);return n?JSON.parse(n):t}catch(e){return t}}function removeFromSessionStorage(e){try{sessionStorage.removeItem(e)}catch(e){}}function generateUniqueId(){return Date.now()+Math.random().toString(36).substr(2,9)}function showErrorMessage(e){const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: #dc2626;\n        color: white;\n        padding: 12px 20px;\n        border-radius: 8px;\n        font-weight: 500;\n        z-index: 1001;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        transition: all 0.3s ease;\n    ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout(()=>{t.parentNode&&t.remove()},300)},4e3)}function updateNotificationBadge(e){document.querySelectorAll(".notification-badge").forEach(t=>{e?t.classList.add("show"):t.classList.remove("show")})}function initializeMobileMenu(){const e=document.getElementById("mobileMenuBtn"),t=document.querySelector(".sidebar");e&&t&&(e.addEventListener("click",()=>{t.classList.toggle("open")}),document.addEventListener("click",n=>{t.contains(n.target)||e.contains(n.target)||t.classList.remove("open")}))}function initializeHistoryIconNavigation(){const e=document.getElementById("historyIcon");e&&e.addEventListener("click",()=>{window.location.href="appointments.html#history"})}function initializeStickyHeader(){const e=document.querySelector(".top-header");if(!e)return;let t=!1;function n(){(window.pageYOffset||document.documentElement.scrollTop)>50?e.classList.add("scrolled"):e.classList.remove("scrolled"),t=!1}window.addEventListener("scroll",function(){t||(requestAnimationFrame(n),t=!0)},{passive:!0})}function initializeSidebarToggle(){const e=document.querySelector(".sidebar"),t=document.getElementById("sidebarToggle"),n=t?.querySelector("i");if(!e||!t)return;"true"===localStorage.getItem("sidebarCollapsed")?(e.classList.add("collapsed"),document.body.classList.add("sidebar-collapsed"),n&&(n.className="fas fa-chevron-right")):n&&(n.className="fas fa-chevron-left"),t.addEventListener("click",()=>{e.classList.contains("collapsed")?(e.classList.remove("collapsed"),document.body.classList.remove("sidebar-collapsed"),n.className="fas fa-chevron-left",localStorage.setItem("sidebarCollapsed","false")):(e.classList.add("collapsed"),document.body.classList.add("sidebar-collapsed"),n.className="fas fa-chevron-right",localStorage.setItem("sidebarCollapsed","true"))})}function initializeGlobalSearch(){const e=document.querySelector(".global-search-container"),t=document.getElementById("globalSearchInput");if(!e||!t)return;let n=e.querySelector(".global-search-results");n||(n=document.createElement("div"),n.className="global-search-results",e.appendChild(n)),n.addEventListener("click",function(e){}),n.addEventListener("mouseenter",function(e){}),n.addEventListener("mouseleave",function(e){});let o=null,i=[],a=!1,s=!1,r=0;async function l(){if(!a)try{if(r>=20)return;if(!window.dataManager||"function"!=typeof window.dataManager.getAllAppointments)return r++,void setTimeout(l,500);a=!0;window.dataManager.getCurrentUser();const e=await window.dataManager.getAllAppointments();if(e&&e.length,!e||0===e.length)return a=!1,void(i=[]);const n=new Map;e.forEach(e=>{if(e.patientName&&e.phone){const t=e.phone;n.has(t)||n.set(t,{patientName:e.patientName,phone:e.phone,email:e.email||"",userId:e.userId||null,fullData:e})}}),i=Array.from(n.values()),i.length,a=!1,t&&t.value.trim().length>=2&&c(t.value)}catch(e){a=!1}}function c(e){if(!e||e.length<2)return void u();if(s||(s=!0,l()),0===i.length&&a)return n.innerHTML='<div class="search-loading">Loading patients...</div>',void d();if(0===i.length&&!a&&s)return n.innerHTML='<div class="search-no-results">No patients found in database</div>',void d();const t=e.toLowerCase().trim();!function(e){if(0===e.length)n.innerHTML='<div class="search-no-results">No patients found</div>';else{n.innerHTML=e.map(e=>`\n                <div class="search-result-item" data-phone="${e.phone}">\n                    <span class="search-result-name">${e.patientName}</span>\n                    <span class="search-result-phone">${function(e){const t=e.replace(/\D/g,"");if(10===t.length)return`(${t.slice(0,3)}) ${t.slice(3,6)}-${t.slice(6)}`;return e}(e.phone)}</span>\n                </div>\n            `).join("");n.querySelectorAll(".search-result-item").forEach((e,t)=>{e.addEventListener("click",function(e){const t=this.querySelector(".search-result-name").textContent;u(),m(t)})})}d()}(i.filter(e=>{const n=e.patientName.toLowerCase(),o=e.phone.replace(/\D/g,"");return n.includes(t)||o.includes(t)}))}function d(){n.classList.add("show")}function u(){n.classList.remove("show")}function m(e){window.location.href=`appointments.html?search=${encodeURIComponent(e)}#history`}t.addEventListener("input",function(){clearTimeout(o);const e=this.value.trim();e.length<2?u():o=setTimeout(()=>{c(e)},300)}),document.addEventListener("click",function(t){t.target.closest(".search-result-item")||e.contains(t.target)||u()}),t.addEventListener("keydown",function(e){if("Escape"===e.key)u(),this.blur();else if("Enter"===e.key){e.preventDefault();const t=this.value.trim();t.length>=2&&(u(),m(t))}}),window.addEventListener&&window.addEventListener("firebase-data-updated",function(){s=!0,r=0,a=!1,l()})}document.addEventListener("DOMContentLoaded",initializeMobileMenu),document.addEventListener("DOMContentLoaded",function(){initializeStickyHeader()}),document.addEventListener("DOMContentLoaded",function(){initializeStickyHeader(),initializeSidebarToggle()}),window.initializeGlobalSearch=initializeGlobalSearch;