import{escapeHtml}from"./security-utils.js";let currentView="week",currentDate=new Date,currentAppointmentData=null,historyCurrentPage=1,historyItemsPerPage=8,historyFilteredData=[],historyAllData=[],appointmentRealtimeListener=null;function waitForFirebaseService(){return new Promise((e,t)=>{let n=0;const a=setInterval(()=>{n++,window.dataManager&&window.dataManager.firebaseService&&window.dataManager.useFirebase?(clearInterval(a),e()):n>=50&&(clearInterval(a),t(new Error("Firebase service initialization timeout")))},100)})}async function initializeRealtimeListeners(){}function cleanupRealtimeListeners(){appointmentRealtimeListener&&"function"==typeof appointmentRealtimeListener&&(appointmentRealtimeListener(),appointmentRealtimeListener=null)}function initializeServiceDropdowns(){if(window.ServiceMapping){const e=document.getElementById("editService");e&&window.ServiceMapping.populateInternalServiceDropdown(e);const t=document.getElementById("appointmentService");t&&window.ServiceMapping.populateInternalServiceDropdown(t)}}function canEditAppointment(e,t){if(!e||!t)return{canEdit:!1,reason:"Invalid appointment or user data",restrictedFields:[]};const n=new Date(e.dateKey),a=((new Date).getTime()-n.getTime())/36e5,i="completed"===(e.status||"scheduled"),o=a>48;return"boss"===t.role?i&&o?{canEdit:!0,reason:"Boss override - audit trail required",requiresAudit:!0,restrictedFields:[]}:{canEdit:!0,reason:"Boss has full edit permissions",restrictedFields:[]}:"admin"===t.role?i&&o?{canEdit:!1,reason:"Cannot edit completed appointments from more than 48 hours ago. Contact management if changes are needed.",restrictedFields:["service","date","time","location"]}:i&&a<=48?{canEdit:!0,reason:"Limited edit permissions for recent completed appointments",restrictedFields:["service"],warnings:["Service changes are restricted for completed appointments"]}:{canEdit:!0,reason:"Full edit permissions for non-completed appointments",restrictedFields:[]}:{canEdit:!1,reason:"Insufficient permissions",restrictedFields:[]}}function applyEditFieldRestrictions(e){const t=e.restrictedFields||[],n=e.warnings||[],a={service:"editService",date:"editDate",time:"editTime",location:"editLocation",notes:"editNotes"};if(Object.values(a).forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!1,t.style.backgroundColor="",t.style.opacity="",t.removeAttribute("title"))}),t.forEach(e=>{const t=a[e],n=document.getElementById(t);n&&(n.disabled=!0,n.style.backgroundColor="#f3f4f6",n.style.opacity="0.7",n.setAttribute("title","This field cannot be modified due to business rules"))}),n.length>0){const e=document.getElementById("editWarnings");e&&(e.innerHTML=n.map(e=>`<div class="edit-warning">${e}</div>`).join(""),e.style.display="block")}}function logAppointmentAudit(e,t,n){const a={timestamp:(new Date).toISOString(),appointmentId:e.id||e.appointmentId,patientName:e.patientName,originalDate:e.dateKey,modifiedBy:n.username||n.email,userRole:n.role,changes:t,reason:"Historical appointment modification",businessJustification:"Boss override for completed historical record"},i=JSON.parse(localStorage.getItem("appointment_audit_log")||"[]");i.push(a),localStorage.setItem("appointment_audit_log",JSON.stringify(i))}function ensureNotificationBellNormalState(){const e=document.getElementById("notificationBell");e&&e.classList.remove("active")}function truncatePatientName(e){if(!e||"string"!=typeof e)return"Unknown";const t=e.trim();return t.length<=14?t:t.substring(0,11)+"..."}function formatDateWithLeadingZeros(e){if(!(e instanceof Date)||isNaN(e.getTime()))return"Invalid Date";return`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}/${e.getFullYear()}`}function formatTimeWithLeadingZeros(e){const t=/^(\d{1,2}):(\d{2})$/.exec(e);if(!t)return"Invalid Time";return`${String(t[1]).padStart(2,"0")}:${String(t[2]).padStart(2,"0")}`}function formatHistoryDateTime(e,t){return`${formatDateWithLeadingZeros(e)}, ${formatTimeWithLeadingZeros(t)}`}function formatPhoneToDisplay(e){if(!e)return"";const t=e.replace(/\D/g,"");return 10===t.length?`${t.slice(0,3)}-${t.slice(3,6)}-${t.slice(6)}`:e}function initializeHistoryPagination(){const e=document.getElementById("prevPageBtn"),t=document.getElementById("nextPageBtn");e&&e.addEventListener("click",()=>{historyCurrentPage>1&&(historyCurrentPage--,renderHistoryView(!1),updateHistoryPaginationControls())}),t&&t.addEventListener("click",()=>{const e=Math.ceil(historyFilteredData.length/historyItemsPerPage);historyCurrentPage<e&&(historyCurrentPage++,renderHistoryView(!1),updateHistoryPaginationControls())})}function updateHistoryPaginationControls(){const e=document.getElementById("prevPageBtn"),t=document.getElementById("nextPageBtn"),n=Math.ceil(historyFilteredData.length/historyItemsPerPage);if(e&&(e.disabled=1===historyCurrentPage),t){const e=historyCurrentPage>=n||0===n;t.disabled=e}}async function refreshAllViews(){await renderWeekView(),await renderDayView(),await renderMonthView(),updateCurrentDateDisplay(),await renderHistoryView(!0)}async function refreshCurrentViewOnly(){switch(currentView){case"week":await renderWeekView();break;case"day":await renderDayViewOptimized();break;case"month":await generateMonthCalendar();break;case"history":await renderHistoryView(!0);break;default:return void await refreshAllViews()}updateCurrentDateDisplay()}async function renderDayViewOptimized(){performance.now();const e=document.getElementById("dayAppointmentsArea");if(!e)return;const t=await getAppointmentsForDateOptimized(currentDate),n=e.querySelector(".live-time-indicator");e.innerHTML="",n&&e.appendChild(n);const a={};t.forEach(e=>{const t=e.time;a[t]||(a[t]=[]),a[t].push(e)}),Object.keys(a).forEach(t=>{const n=a[t],i=getTimePosition(t);if(1===n.length){const t=n[0],a=document.createElement("div"),o=t.status||"scheduled";a.className=`day-appointment-card ${o}`,a.style.top=`${i}px`,a.style.height="56px",a.onclick=()=>openProcessModal(a,t);const s=document.createElement("div");s.className="patient-name",s.textContent=t.patientName;const r=document.createElement("div");r.className="service-type",r.textContent=t.service,a.appendChild(s),a.appendChild(r),e.appendChild(a)}else{const t=document.createElement("div");t.className="concurrent-appointments-container",t.style.top=`${i}px`,t.style.height="56px";const a=4,o=n.slice(0,a),s=n.slice(a);if(o.forEach(e=>{const n=document.createElement("div"),a=e.status||"scheduled";n.className=`day-appointment-card ${a}`,n.onclick=()=>openProcessModal(n,e);const i=document.createElement("div");i.className="patient-name",i.textContent=e.patientName;const o=document.createElement("div");o.className="service-type",o.textContent=e.service,n.appendChild(i),n.appendChild(o),t.appendChild(n)}),s.length>0){const e=document.createElement("div");e.className="more-appointments-btn",e.textContent=`+${s.length} more`,e.onclick=e=>{e.stopPropagation(),showMoreAppointmentsPopup(s,e.target)},t.appendChild(e)}e.appendChild(t)}});performance.now()}document.addEventListener("DOMContentLoaded",function(){initializeServiceDropdowns(),initializeViewToggle(),initializeHistoryIcon(),initializeNewAppointmentModal(),initializeProcessModal(),initializeEditModal(),initializeCancellationModal(),initializeAppointmentDetailsModal(),initializeLiveTimeIndicator(),initializeHistoryPagination(),updateDayDate(),generateMonthCalendar(),setupFormValidation(),ensureNotificationBellNormalState(),waitForFirebaseService().then(async()=>{try{await refreshAllViews(),await initializeRealtimeListeners(),updateNotificationBadge(dataManager.getPendingConfirmations().length>0)}catch(e){}}).catch(async e=>{await refreshAllViews()});window.location.href;const e=new URLSearchParams(window.location.search).get("search"),t="#history"===window.location.hash;if("#open-account"===window.location.hash)setTimeout(()=>{const e=sessionStorage.getItem("openPatientAccount");if(e)try{showPatientAccountModal(JSON.parse(e)),sessionStorage.removeItem("openPatientAccount")}catch(e){}window.history.replaceState(null,null,window.location.pathname)},800);else if(t||e){e&&sessionStorage.setItem("pendingSearch",e);const t=()=>{const e=sessionStorage.getItem("pendingSearch");if(e){const t=document.getElementById("globalSearchInput");t&&(t.value=e,applyHistoryFilter(!0),renderHistoryView(!1),sessionStorage.removeItem("pendingSearch"))}window.removeEventListener("historyDataLoaded",t)};window.addEventListener("historyDataLoaded",t),setTimeout(()=>{const e=document.getElementById("historyIcon");e&&e.click(),window.history.replaceState(null,null,window.location.pathname)},300)}}),window.addEventListener("beforeunload",cleanupRealtimeListeners),document.addEventListener("visibilitychange",function(){document.hidden&&cleanupRealtimeListeners()});let prefetchInProgress=new Set;const PREFETCH_RANGE_DAYS=3;async function getAppointmentsForDateOptimized(e){performance.now();const t=formatDateToKey(e);try{const n=await dataManager.getAppointmentsForDate(t);performance.now();return prefetchAdjacentDates(e),n||[]}catch(e){return[]}}async function prefetchAdjacentDates(e){const t=[];for(let n=1;n<=3;n++){const a=new Date(e);a.setDate(e.getDate()-n);const i=formatDateToKey(a);window.cacheManager&&window.cacheManager.getDateCache(i)||prefetchInProgress.has(i)||(prefetchInProgress.add(i),t.push(prefetchSingleDate(i)))}for(let n=1;n<=3;n++){const a=new Date(e);a.setDate(e.getDate()+n);const i=formatDateToKey(a);window.cacheManager&&window.cacheManager.getDateCache(i)||prefetchInProgress.has(i)||(prefetchInProgress.add(i),t.push(prefetchSingleDate(i)))}t.length>0&&Promise.all(t).then(()=>{}).catch(e=>{})}async function prefetchSingleDate(e){try{await dataManager.getAppointmentsForDate(e)}catch(e){}finally{prefetchInProgress.delete(e)}}function formatDateToKey(e,t=!1){if(!(e instanceof Date)||isNaN(e.getTime()))return"";return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}async function getAppointmentsForDate(e){const t=formatDateToKey(e);return await dataManager.getAppointmentsForDate(t)}function getAppointmentsForDateSync(e){const t=formatDateToKey(e);if(dataManager.data&&dataManager.data.appointments&&dataManager.data.appointments[t]){return dataManager.getAppointmentsForDateLocal(t)}return[]}async function getAppointmentCountForDate(e){return(await getAppointmentsForDateOptimized(e)).length}async function getAllAppointmentsForDate(e){try{const t=formatDateToKey(e),n=await dataManager.getAppointmentsForDate(t)||[],a=(await dataManager.getCancelledAppointments()||[]).filter(e=>e.dateKey===t);return[...n,...a]}catch(e){return[]}}async function renderHistoryView(e=!1){const t=document.getElementById("historyTableBody");if(!t)return;if(0===historyAllData.length||e)try{const e=(await dataManager.getAllAppointments()||[]).filter(e=>"pending"!==e.status&&"declined"!==e.status),t=await dataManager.getCancelledAppointments()||[],n=[...e,...t];n.forEach(e=>{e.dateObj=new Date(e.dateKey)});const a=new Map;n.forEach(e=>{const t=e.userId||e.patientName;e.userId,a.has(t)||a.set(t,[]),a.get(t).push(e)}),a.forEach((e,t)=>{e[0].userId});const i=Array.from(a.entries()).map(([e,t])=>{const n=[...t].sort((e,t)=>e.dateKey.localeCompare(t.dateKey)),a=[...t].sort((e,t)=>t.dateKey.localeCompare(e.dateKey)),i=a[0],o=n[0];(new Date).setHours(0,0,0,0);const s=(new Date).toISOString().split("T")[0],r=t.some(e=>e.dateKey>=s)?"active":"inactive",c=e=>{const t=["phone","phoneNumber","tel","mobile","contactNumber","patientPhone","userPhone","clientPhone"];for(const n of t)if(e[n]&&e[n].trim())return e[n].trim();return""};let d="";for(const e of a){const t=c(e);if(t){d=t;break}}if(!d)for(const e of t){const t=c(e);if(t){d=t;break}}t.map(e=>{const t={phone:e.phone,phoneNumber:e.phoneNumber,tel:e.tel,mobile:e.mobile,contactNumber:e.contactNumber,patientPhone:e.patientPhone,userPhone:e.userPhone,clientPhone:e.clientPhone},n=Object.entries(t).filter(([e,t])=>t&&t.trim()).map(([e,t])=>`${e}:"${t}"`).join(",");return`${e.dateKey}: [${n||"no phone fields"}]`}).join(", ");return{...i,phone:d,appointmentCount:t.length,firstVisitDate:o.dateKey,firstVisitDateObj:o.dateObj,accountStatus:r,isPatientRecord:!0,allAppointments:t,patientIdentifier:e,groupedByUserId:!!i.userId,userId:i.userId}});i.sort((e,t)=>t.dateObj-e.dateObj),historyAllData=i,applyHistoryFilter(!0),window.dispatchEvent(new Event("historyDataLoaded"))}catch(e){historyAllData=[],applyHistoryFilter(!0),window.dispatchEvent(new Event("historyDataLoaded"))}else applyHistoryFilter(!1);t.innerHTML="";const n=(historyCurrentPage-1)*historyItemsPerPage,a=n+historyItemsPerPage;historyFilteredData.slice(n,a).forEach(e=>{const n=document.createElement("tr");n.onclick=()=>showPatientAccountModal(e);const a=document.createElement("td");a.className="patient-name",a.textContent=e.patientName;const i=document.createElement("td");i.className="phone",i.textContent=formatPhoneToDisplay(e.phone);const o=document.createElement("td");o.className="first-visit";const[s,r,c]=e.firstVisitDate.split("-");o.textContent=`${r}/${c}/${s}`;const d=document.createElement("td");d.className="total-visits",d.textContent=e.appointmentCount;const l=document.createElement("td"),p=document.createElement("span");p.className=`status-badge ${e.accountStatus}`,p.textContent=capitalizeFirst(e.accountStatus),l.appendChild(p),n.appendChild(a),n.appendChild(i),n.appendChild(o),n.appendChild(d),n.appendChild(l),t.appendChild(n)}),updateHistoryPaginationControls()}function applyHistoryFilter(e=!0){const t=document.getElementById("globalSearchInput"),n=t?t.value.toLowerCase().trim():"";historyFilteredData=""===n?[...historyAllData]:historyAllData.filter(e=>{const t=e.patientName.toLowerCase(),a=e.phone.replace(/\D/g,"").toLowerCase();return t.includes(n)||a.includes(n)}),e&&(historyCurrentPage=1)}function showAppointmentDetails(e,t=null){let n,a,i,o,s,r,c="";if(t){if(n=t.patientName,a=formatHistoryDateTime(t.dateObj,t.time),i=t.service,o=t.location,s=capitalizeFirst(t.status.replace("-"," ")),r=formatPhoneToDisplay(t.phone),"cancelled"===t.status){const e=t.cancelReason||"Not specified",n=t.cancelNotes||"";c=`\n                <div class="detail-row">\n                    <span class="detail-label">Cancel Reason:</span>\n                    <span class="detail-value">${e}</span>\n                </div>\n                ${n?`\n                <div class="detail-row">\n                    <span class="detail-label">Cancel Notes:</span>\n                    <span class="detail-value">${n}</span>\n                </div>\n                `:""}\n                <div class="detail-row">\n                    <span class="detail-label">Cancelled At:</span>\n                    <span class="detail-value">${t.cancelledAt?new Date(t.cancelledAt).toLocaleString():"Unknown"}</span>\n                </div>\n            `}}else n=e.querySelector(".patient-name")?.textContent||"Unknown",a=e.querySelector(".time")?.textContent||"Unknown",i=e.querySelector(".service")?.textContent||"Unknown",o="Unknown",s=e.querySelector(".status-badge")?.textContent||"Unknown",r=e.querySelector(".tel")?.textContent||"";const d=document.getElementById("appointmentDetailsContent");d&&(d.innerHTML=`\n            <h4>${escapeHtml(n)}</h4>\n            <div class="detail-row">\n                <span class="detail-label">Date & Time:</span>\n                <span class="detail-value">${escapeHtml(a)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Service:</span>\n                <span class="detail-value">${escapeHtml(i)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Location:</span>\n                <span class="detail-value">${escapeHtml(o)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Phone:</span>\n                <span class="detail-value">${escapeHtml(r)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Status:</span>\n                <span class="detail-value">${escapeHtml(s)}</span>\n            </div>\n            ${c}\n        `),openModal("appointmentDetailsModal")}async function renderWeekView(){const e=document.querySelectorAll(".week-day"),t=getStartOfWeek(currentDate),n=new Set;for(let a=0;a<e.length;a++){const e=new Date(t);e.setDate(t.getDate()+a);(await getAppointmentsForDateOptimized(e)).forEach(e=>{n.add(e.time)})}["09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"].forEach(e=>{n.add(e)});const a=Array.from(n).sort();for(let n=0;n<e.length;n++){const i=e[n],o=new Date(t);o.setDate(t.getDate()+n);const s=i.querySelector(".day-appointments"),r=await getAppointmentsForDateOptimized(o);s.innerHTML="";const c={};r.forEach(e=>{const t=e.time;c[t]||(c[t]=[]),c[t].push(e)}),a.forEach(e=>{const t=document.createElement("div");t.className="week-time-slot-container",t.setAttribute("data-time",e);const n=c[e]||[];if(n.length,0===n.length);else if(1===n.length){const e=createWeekAppointmentCard(n[0]);t.appendChild(e)}else if(2===n.length)n.forEach(e=>{const n=createWeekAppointmentCard(e);t.appendChild(n)});else if(n.length>=3){const a=createWeekAppointmentCard(n[0]);t.appendChild(a);const i=n.length-1,s=document.createElement("div");s.className="week-more-indicator",s.textContent=`+${i} more`,s.onclick=t=>{t.stopPropagation(),showWeekMoreAppointments(n.slice(1),o,e)},t.appendChild(s)}s.appendChild(t)});const d=i.querySelector(".day-number");if(d){d.textContent=o.getDate();const e=new Date,t=i.querySelector(".day-header");o.toDateString()===e.toDateString()?t.classList.add("today"):t.classList.remove("today")}}updateWeekRangeDisplay()}function createWeekAppointmentCard(e){const t=document.createElement("div"),n=e.status||"scheduled";t.className=`week-appointment ${n}`,t.onclick=()=>openProcessModal(t,e);const a=document.createElement("div");return a.className="week-patient",a.textContent=truncatePatientName(e.patientName),a.title=e.patientName,t.appendChild(a),t}function showWeekMoreAppointments(e,t,n){const a=document.querySelector(".week-more-popup");a&&a.remove();const i=document.createElement("div");i.className="week-more-popup";const o=document.createElement("div");o.className="popup-header";const s=t.toLocaleDateString("en-US",{month:"short",day:"numeric"}),r=formatTime(n);o.textContent=`${s} at ${r} (+${e.length})`,i.appendChild(o);const c=document.createElement("div");c.className="popup-appointments-list",e.forEach(e=>{const t=document.createElement("div");t.className=`popup-appointment-item ${e.status}`,t.onclick=()=>{i.remove(),openProcessModal(t,e)};const n=document.createElement("div");n.className="popup-left-content";const a=document.createElement("div");a.className="popup-patient-name",a.textContent=e.patientName;const o=document.createElement("div");o.className="popup-service",o.textContent=e.service,n.appendChild(a),n.appendChild(o);const s=document.createElement("div"),r=e.status||"scheduled";s.className=`popup-status ${r}`,s.textContent=capitalizeFirst(r),t.appendChild(n),t.appendChild(s),c.appendChild(t)}),i.appendChild(c),document.body.appendChild(i),i.style.position="fixed",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.zIndex="1000";const d=e=>{i.contains(e.target)||(i.remove(),document.removeEventListener("click",d))};setTimeout(()=>{document.addEventListener("click",d)},100)}async function renderDayView(){const e=document.getElementById("dayAppointmentsArea");if(!e)return;const t=await getAppointmentsForDateOptimized(currentDate),n=e.querySelector(".live-time-indicator");e.innerHTML="",n&&e.appendChild(n);const a={};t.forEach(e=>{const t=e.time;a[t]||(a[t]=[]),a[t].push(e)}),Object.keys(a).forEach(t=>{const n=a[t],i=getTimePosition(t);if(1===n.length){const t=n[0],a=document.createElement("div"),o=t.status||"scheduled";a.className=`day-appointment-card ${o}`,a.style.top=`${i}px`,a.style.height="56px",a.onclick=()=>openProcessModal(a,t);const s=document.createElement("div");s.className="patient-name",s.textContent=t.patientName;const r=document.createElement("div");r.className="service-type",r.textContent=t.service,a.appendChild(s),a.appendChild(r),e.appendChild(a)}else{const t=document.createElement("div");t.className="concurrent-appointments-container",t.style.top=`${i}px`,t.style.height="56px";const a=4,o=n.slice(0,a),s=n.slice(a);if(o.forEach(e=>{const n=document.createElement("div"),a=e.status||"scheduled";n.className=`day-appointment-card ${a}`,n.onclick=()=>openProcessModal(n,e);const i=document.createElement("div");i.className="patient-name",i.textContent=e.patientName;const o=document.createElement("div");o.className="service-type",o.textContent=e.service,n.appendChild(i),n.appendChild(o),t.appendChild(n)}),s.length>0){const e=document.createElement("div");e.className="more-appointments-btn",e.textContent=`+${s.length} more`,e.onclick=e=>{e.stopPropagation(),showMoreAppointmentsPopup(s,e.target)},t.appendChild(e)}e.appendChild(t)}})}async function renderMonthView(){await generateMonthCalendar()}function getTimePosition(e){const t=/^(\d{1,2}):(\d{2})$/.exec(e);if(!t)return 0;const n=parseInt(t[1],10),a=parseInt(t[2],10);if(n<0||n>23||a<0||a>59)return 0;if(n<9)return 0;return 80*(n-9)+a/60*80+12}function getStartOfWeek(e){if(!(e instanceof Date)||isNaN(e.getTime()))return new Date;const t=new Date(e),n=t.getDay(),a=t.getDate()-n+(0===n?-6:1);return t.setDate(a),t}function updateWeekRangeDisplay(){const e=document.getElementById("weekRange");if(!e)return;const t=getStartOfWeek(currentDate),n=new Date(t);n.setDate(n.getDate()+6);const a={month:"long",day:"numeric",year:"numeric"};e.textContent=`${t.toLocaleDateString("en-US",a)} - ${n.toLocaleDateString("en-US",a)}`}function initializeViewToggle(){const e=document.querySelectorAll(".view-btn"),t=document.querySelectorAll(".view-content"),n=document.getElementById("mainViewToggle");e.forEach(a=>{a.addEventListener("click",function(){const a=this.dataset.view;if(!["week","day","month"].includes(a))return;e.forEach(e=>e.classList.remove("active")),this.classList.add("active"),t.forEach(e=>e.classList.remove("active"));const i=document.getElementById(a+"-view");i&&i.classList.add("active");const o=document.getElementById("history-view"),s=document.getElementById("historyIcon");o&&o.classList.contains("active")&&(o.classList.remove("active"),s.classList.remove("active")),n&&(n.style.display="flex"),currentView=a,"day"===a?(renderDayViewOptimized(),updateLiveTimeIndicator()):"week"===a?renderWeekView():"month"===a&&generateMonthCalendar(),updateCurrentDateDisplay()})})}function initializeHistoryIcon(){const e=document.getElementById("historyIcon"),t=document.getElementById("closeHistoryBtn"),n=document.getElementById("history-view"),a=document.querySelector(".view-toggle-container");e&&e.addEventListener("click",()=>{document.querySelectorAll(".view-content").forEach(e=>{e.classList.remove("active")}),n.classList.add("active"),e.classList.add("active"),currentView="history",a&&(a.style.display="none"),document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active"));const t=document.querySelector(".page-title h1");t&&(t.textContent="Accounts"),historyCurrentPage=1,renderHistoryView(!0)}),t&&t.addEventListener("click",()=>{n.classList.remove("active"),e.classList.remove("active"),document.getElementById("week-view").classList.add("active"),currentView="week",a&&(a.style.display="flex");const t=document.querySelector(".page-title h1");t&&(t.textContent="Calendar"),document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active")),document.querySelector('[data-view="week"]').classList.add("active");const i=document.querySelector(".view-toggle-container");i&&(i.style.display="none",setTimeout(()=>{i.style.display="grid"},10))})}function triggerAppointmentsSearch(e){"history"===getCurrentView()&&(applyHistoryFilter(!0),renderHistoryView(!1))}function initializeProcessModal(){const e=document.getElementById("processModal"),t=document.getElementById("processModalClose"),n=document.getElementById("arrivedBtn"),a=document.getElementById("noShowBtn"),i=document.getElementById("editBtn"),o=document.getElementById("holdBtn"),s=document.getElementById("completedBtn"),r=document.getElementById("cancelBtn");function c(e=!0){closeModal("processModal"),e&&(currentAppointmentData=null)}t&&t.addEventListener("click",()=>c(!0)),e?.addEventListener("click",function(t){t.target===e&&c(!0)}),n?.addEventListener("click",()=>{updateAppointmentStatus("arrived")}),a?.addEventListener("click",()=>{updateAppointmentStatus("no-show")}),s?.addEventListener("click",()=>{updateAppointmentStatus("completed")}),o?.addEventListener("click",()=>{updateAppointmentStatus("held")}),i?.addEventListener("click",async()=>{if(c(!1),currentAppointmentData){{const e=await findAppointmentById(currentAppointmentData.appointmentId);if(!e)return void alert("Error: Appointment data not found. Please try again.");{if(document.getElementById("editDate").value=e.dateKey||e.date||"",e.time&&"string"==typeof e.time){const t=`${e.time}-${getEndTime(e.time)}`;document.getElementById("editTime").value=t}else{const t=e.appointmentTime||e.timeSlot||"";if(t){const e=`${t}-${getEndTime(t)}`;document.getElementById("editTime").value=e}else document.getElementById("editTime").value=""}const t=e.service||e.serviceName||e.serviceType||"";document.getElementById("editService").value=getServiceValue(t),document.getElementById("editNotes").value=e.notes||"";const n=dataManager.getCurrentUser(),a=document.getElementById("editLocation"),i=e.location||e.clinicLocation||e.clinicName||"";a.value=getLocationValue(i);const o=canEditAppointment(e,n);if(!o.canEdit)return void alert(`Edit Restricted: ${o.reason}`);applyEditFieldRestrictions(o),"admin"===n.role?(a.disabled=!0,a.style.backgroundColor="#f3f4f6"):"boss"===n.role&&(a.disabled=!1,a.style.backgroundColor="white"),currentAppointmentData.editPermissions=o}}openModal("editModal")}else alert("Error: No appointment selected. Please try again.")}),r?.addEventListener("click",()=>{c(!1),openModal("cancellationModal")})}function openProcessModal(e,t=null){let n,a,i,o;t?(n=t.patientName,a=t.service,i=t.status,o=t.id):(e.querySelector(".patient-name")?(n=e.querySelector(".patient-name").textContent,a=e.querySelector(".service-type")?.textContent||e.querySelector(".service")?.textContent||""):e.querySelector(".week-patient")?(n=e.querySelector(".week-patient").textContent,a=e.querySelector(".week-service")?.textContent||"Service not available"):(n=e.querySelector(".patient-name")?.textContent||"Unknown Patient",a=e.querySelector(".service")?.textContent||"Unknown Service"),i=getStatusFromCard(e),o=null),currentAppointmentData={patientName:n,service:a,status:i,element:e,appointmentId:o,phone:t?.phone||"",rawAppointment:t||null},"undefined"!=typeof window&&(window.__currentAppointmentData=currentAppointmentData);const s=document.getElementById("appointmentSummary");if(s){let e="Phone not available";t&&t.phone&&(e=t.phone),s.innerHTML=`\n            <h4>${escapeHtml(n)}</h4>\n            <div class="detail-row">\n                <span class="detail-label">Phone:</span>\n                <span class="detail-value">${escapeHtml(e)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Service:</span>\n                <span class="detail-value">${escapeHtml(a)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Status:</span>\n                <span class="detail-value">${escapeHtml(capitalizeFirst(i.replace("-"," ")))}</span>\n            </div>\n        `}updateButtonSelection(i),openModal("processModal")}function initializeEditModal(){const e=document.getElementById("editModal"),t=document.getElementById("editModalClose"),n=document.getElementById("editCancel"),a=document.getElementById("editForm");function i(){closeModal("editModal"),a&&a.reset(),currentAppointmentData=null}t&&t.addEventListener("click",i),n&&n.addEventListener("click",i),e?.addEventListener("click",function(t){t.target===e&&i()}),a&&a.addEventListener("submit",async function(e){if(e.preventDefault(),!currentAppointmentData||!currentAppointmentData.appointmentId)return void showErrorMessage("No appointment data found");const t=document.getElementById("editDate")?.value,n=document.getElementById("editTime")?.value,a=document.getElementById("editService")?.value,o=document.getElementById("editLocation")?.value,s=document.getElementById("editNotes")?.value||"";if(!(t&&n&&a&&o))return void showErrorMessage("Please fill in all required fields");const r=dataManager.getCurrentUser(),c=document.getElementById("editLocation");"admin"===r.role?(c.value=r.assignedLocation,c.disabled=!0,c.style.backgroundColor="#f3f4f6"):"boss"===r.role&&(c.disabled=!1,c.style.backgroundColor="white");const d=extractTimeFromSlot(n);try{await dataManager.deleteAppointment(currentAppointmentData.appointmentId);const e={patientName:currentAppointmentData.patientName,date:t,time:d,service:getServiceDisplayName(a),location:getLocationDisplayName(o),phone:currentAppointmentData.phone||"",notes:s};try{const n=currentAppointmentData.editPermissions;if(n&&n.requiresAudit){const e=await findAppointmentById(currentAppointmentData.appointmentId),n={date:{from:e.dateKey,to:t},time:{from:e.time,to:d},service:{from:e.service,to:getServiceDisplayName(a)},location:{from:e.location,to:getLocationDisplayName(o)},notes:{from:e.notes,to:s}};Object.keys(n).forEach(e=>{n[e].from===n[e].to&&delete n[e]}),Object.keys(n).length>0&&logAppointmentAudit(e,n,r)}await dataManager.addAppointment(e),showSuccessMessage("Appointment updated successfully!"),i()}catch(e){showErrorMessage("Failed to update appointment")}await refreshCurrentViewOnly()}catch(e){showErrorMessage("Failed to update appointment")}})}async function findAppointmentById(e){return(await dataManager.getAllAppointments()).find(t=>t.id===e)}function getEndTime(e){if(!e||"string"!=typeof e)return"";if(!/^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/.test(e))return e;try{const t=e.split(":");if(2!==t.length)return e;const[n,a]=t.map(Number);if(isNaN(n)||isNaN(a)||n<0||n>23||a<0||a>59)return e;const i=n+1;return`${String(i>23?i-24:i).padStart(2,"0")}:${String(a).padStart(2,"0")}`}catch(t){return e}}function getServiceValue(e){if(!e||"string"!=typeof e)return"general";return{General:"general",Implant:"implant",Extraction:"extraction",Preventive:"preventive",Cosmetic:"cosmetic",Orthodontics:"orthodontics","Root Canals":"root-canals",Restorations:"restorations",Periodontics:"periodontics"}[e]||e.toLowerCase()}function getLocationValue(e){if(!e||"string"!=typeof e)return"arcadia";return{Arcadia:"arcadia",Irvine:"irvine","South Pasadena":"south-pasadena","Rowland Heights":"rowland-heights",Eastvale:"eastvale"}[e]||e.toLowerCase()}function initializeCancellationModal(){const e=document.getElementById("cancellationModal"),t=document.getElementById("cancellationModalClose"),n=document.getElementById("cancelBack"),a=document.getElementById("confirmCancellation");function i(){closeModal("cancellationModal"),document.querySelectorAll('input[name="cancelReason"]').forEach(e=>{e.checked=!1});const e=document.getElementById("cancelNotes");e&&(e.value=""),currentAppointmentData=null}t&&t.addEventListener("click",i),n&&n.addEventListener("click",i),e?.addEventListener("click",function(t){t.target===e&&i()}),a&&a.addEventListener("click",function(){const e=document.querySelector('input[name="cancelReason"]:checked')?.value,t=document.getElementById("cancelNotes")?.value||"";e&&["patient-cancelled","clinic-cancelled"].includes(e)?(updateAppointmentStatus("cancelled",{reason:"patient-cancelled"===e?"Patient Cancelled":"Clinic Cancelled",notes:t}),i()):alert("Please select a valid cancellation reason.")})}function initializeAppointmentDetailsModal(){const e=document.getElementById("appointmentDetailsModal"),t=document.getElementById("appointmentDetailsClose"),n=document.getElementById("appointmentDetailsOk");function a(){closeModal("appointmentDetailsModal")}t&&t.addEventListener("click",a),n&&n.addEventListener("click",a),e?.addEventListener("click",function(t){t.target===e&&a()})}function initializeNewAppointmentModal(){const e=document.getElementById("newAppointmentBtn"),t=document.getElementById("newAppointmentModal"),n=document.getElementById("newAppointmentClose"),a=document.getElementById("newAppointmentCancel"),i=document.getElementById("newAppointmentForm");function o(){closeModal("newAppointmentModal");const e=document.getElementById("newAppointmentForm"),t=document.getElementById("appointmentPatientName");e&&e.reset(),t&&(t.readOnly=!1,t.style.backgroundColor="white")}e&&e.addEventListener("click",()=>{openNewAppointmentModal()}),n&&n.addEventListener("click",o),a&&a.addEventListener("click",o),t&&t.addEventListener("click",function(e){e.target===t&&o()}),i&&i.addEventListener("submit",function(e){e.preventDefault(),handleNewAppointmentSubmission(),o()})}function openNewAppointmentModal(e=null){const t=document.getElementById("appointmentDate"),n=(new Date).toISOString().split("T")[0];t&&(t.min=n,t.value=e?e.toISOString().split("T")[0]:n),applyLocationPermissionsToNewAppointmentModal(),openModal("newAppointmentModal")}async function handleNewAppointmentSubmission(){try{const e={patientName:document.getElementById("appointmentPatientName")?.value||"",date:document.getElementById("appointmentDate")?.value||"",time:extractTimeFromSlot(document.getElementById("appointmentTime")?.value||""),service:getServiceDisplayName(document.getElementById("appointmentService")?.value||""),location:getLocationDisplayName(document.getElementById("appointmentLocation")?.value||""),phone:document.getElementById("appointmentPhone")?.value||"",notes:document.getElementById("appointmentNotes")?.value||""};if(!(e.patientName&&e.date&&e.time&&e.service&&e.location))return void showErrorMessage("Please fill in all required fields");try{await dataManager.addAppointment(e),showSuccessMessage("New appointment created successfully!")}catch(e){showErrorMessage("Failed to add appointment")}await refreshCurrentViewOnly()}catch(e){showErrorMessage("Failed to create appointment. Please check all fields and try again.")}}function setupFormValidation(){document.querySelectorAll("#appointmentPatientName").forEach(e=>{e&&(e.addEventListener("input",function(e){try{this.value=this.value.replace(/[^A-Za-z\s'\-\.]/g,"").substring(0,50)}catch(e){}}),e.addEventListener("change",function(e){try{this.value&&!validatePatientName(this.value)&&(this.value=this.value.replace(/[^A-Za-z\s'\-\.]/g,"").substring(0,50))}catch(e){}}))});document.querySelectorAll("#appointmentPhone").forEach(e=>{e&&e.addEventListener("input",function(){try{formatPhoneNumber(this)}catch(e){}})})}function initializeLiveTimeIndicator(){updateLiveTimeIndicator(),setInterval(updateLiveTimeIndicator,6e4)}function updateLiveTimeIndicator(){const e=document.getElementById("liveTimeIndicator");if(!e||"day"!==currentView)return;const t=new Date,n=t.getHours(),a=t.getMinutes();if(n<9||n>=16)return void(e.style.display="none");const i=(60*(n-9)+a)/420*100;e.style.top=i+"%",e.style.display="block"}function updateDayDate(){const e=document.getElementById("dayDate");if(e){const t={year:"numeric",month:"long",day:"numeric"};e.textContent=currentDate.toLocaleDateString("en-US",t)}}function updateCurrentDateDisplay(){const e=document.getElementById("currentDateDisplay");if(!e)return;let t="";if("week"===currentView){const e=getStartOfWeek(currentDate),n=new Date(e);n.setDate(n.getDate()+6),t=`${e.toLocaleDateString("en-US",{month:"long",day:"numeric"})} - ${n.toLocaleDateString("en-US",{month:"long",day:"numeric"})}`}else"day"===currentView?t=currentDate.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"month"===currentView&&(t=currentDate.toLocaleDateString("en-US",{month:"long",year:"numeric"}));e.textContent=t}async function generateMonthCalendar(){const e=document.getElementById("monthDates");if(!e)return;const t=currentDate.getFullYear(),n=currentDate.getMonth();e.innerHTML="";const a=new Date(t,n,1),i=new Date(t,n+1,0).getDate(),o=a.getDay(),s=0===o?6:o-1,r=new Date(t,n,0),c=r.getDate(),d=r.getFullYear(),l=r.getMonth(),p=await dataManager.getAppointmentsForMonth(t,n+1);for(let t=s-1;t>=0;t--){const n=c-t,a=new Date(d,l,n,12,0,0),i=createMonthDateElementOptimized(n,!0,!1,a,p[formatDateToKey(a)]||[]);e.appendChild(i)}const m=new Date;for(let a=1;a<=i;a++){const i=new Date(t,n,a,12,0,0),o=createMonthDateElementOptimized(a,!1,i.toDateString()===m.toDateString(),i,p[formatDateToKey(i)]||[]);e.appendChild(o)}const u=42-e.children.length,g=11===n?t+1:t,h=11===n?0:n+1;for(let t=1;t<=u;t++){const n=new Date(g,h,t,12,0,0),a=createMonthDateElementOptimized(t,!0,!1,n,p[formatDateToKey(n)]||[]);e.appendChild(a)}let y,f;if(pruneTrailingOtherMonthRows(e),t===m.getFullYear()&&n===m.getMonth()){y=new Date(m.getFullYear(),m.getMonth(),m.getDate(),12,0,0),f=p[formatDateToKey(y)]||[];const t=e.querySelector(".month-date.today");t&&t.classList.add("selected")}else{y=new Date(t,n,1,12,0,0),f=p[formatDateToKey(y)]||[];const a=e.querySelector(".month-date:not(.other-month)");a&&a.classList.add("selected")}y&&updateMonthSidebar(y,f)}function pruneTrailingOtherMonthRows(e){const t=Array.from(e.children);if(t.length%7!=0)return;let n=t.length/7;for(;n>0;){const a=7*(n-1),i=t.slice(a,a+7);if(!i.every(e=>e.classList.contains("other-month")))break;i.forEach(t=>e.removeChild(t)),t.splice(a,7),n--}}window.getCacheStats=()=>window.cacheManager?window.cacheManager.getStats():{error:"CacheManager not available"},window.printCacheStats=()=>{window.cacheManager&&window.cacheManager.printStats()};let currentMonthSidebarDate=null;function createMonthDateElementOptimized(e,t=!1,n=!1,a=null,i=[]){const o=document.createElement("div");o.className="month-date",t&&o.classList.add("other-month"),n&&o.classList.add("today");const s=i.length,r=document.createElement("div");if(r.className="date-number",r.textContent=e.toString(),o.appendChild(r),!t){const e=document.createElement("div");e.className="add-appointment-icon",e.innerHTML='<i class="fas fa-plus"></i>',o.appendChild(e)}if(s>0){const e=document.createElement("div");e.className="appointment-count",e.textContent=s.toString(),o.appendChild(e)}return a&&(o.addEventListener("click",e=>{if(!t&&e.target.closest(".add-appointment-icon"))return e.stopPropagation(),void openNewAppointmentModal(a);document.querySelectorAll(".month-date.selected").forEach(e=>e.classList.remove("selected")),o.classList.add("selected"),updateMonthSidebar(a,i)}),o.addEventListener("dblclick",e=>{!t&&e.target.closest(".add-appointment-icon")||switchToDayView(a)})),o}function updateMonthSidebar(e,t){const n=document.getElementById("monthSidebarDate"),a=document.getElementById("monthSidebarCount"),i=document.getElementById("monthSidebarEmpty"),o=document.getElementById("monthSidebarList");if(!(n&&a&&i&&o))return;currentMonthSidebarDate=e;n.textContent=e.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"});const s=t.length;if(0===s)return a.textContent="",i.style.display="block",void(o.innerHTML="");a.textContent=1===s?"1 appointment":`${s} appointments`,i.style.display="none";const r=[...t].sort((e,t)=>{const n=(e.time||"00:00").padStart(5,"0"),a=(t.time||"00:00").padStart(5,"0");return n.localeCompare(a)});o.innerHTML="",r.forEach(e=>{const t=document.createElement("div"),n=(e.status||"scheduled").toLowerCase();t.className=`month-sidebar-card status-${n}`;const a=e.time?e.time:"Time TBC",i=e.service||"Dental visit",s=e.location||"";t.innerHTML=`\n            <div class="month-sidebar-card-header">\n                <div class="month-sidebar-time">${a}</div>\n                <div class="month-sidebar-status">${n}</div>\n            </div>\n            <div class="month-sidebar-title">${e.patientName||"Unnamed patient"}</div>\n            <div class="month-sidebar-subtitle">${i}${s?" Â· "+s:""}</div>\n        `,o.appendChild(t)})}async function createMonthDateElement(e,t=!1,n=!1,a=null){const i=document.createElement("div");i.className="month-date",t&&i.classList.add("other-month"),n&&i.classList.add("today");const o=(a?await getAppointmentsForDateOptimized(a):[]).length,s=document.createElement("div");if(s.className="date-number",s.textContent=e.toString(),i.appendChild(s),!t){const e=document.createElement("div");e.className="add-appointment-icon",e.innerHTML='<i class="fas fa-plus"></i>',i.appendChild(e)}if(o>0){const e=document.createElement("div");e.className="appointment-count",e.textContent=o.toString(),i.appendChild(e)}return a&&i.addEventListener("click",e=>{if(!t&&e.target.closest(".add-appointment-icon"))return e.stopPropagation(),void openNewAppointmentModal(a);switchToDayView(a)}),i}function switchToDayView(e){if(!(e instanceof Date)||isNaN(e.getTime()))return;const t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),12,0,0);currentDate=t;const n=document.getElementById("dayDate");if(n){const e={year:"numeric",month:"long",day:"numeric"},a=t.toLocaleDateString("en-US",e);n.textContent=a}document.querySelectorAll(".view-content").forEach(e=>e.classList.remove("active")),document.getElementById("day-view").classList.add("active"),document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active")),document.querySelector('[data-view="day"]').classList.add("active"),currentView="day",renderDayView(),updateLiveTimeIndicator()}async function updateAppointmentStatus(e,t={}){if(currentAppointmentData)try{const n=currentAppointmentData?.rawAppointment||null;if(!await dataManager.updateAppointmentStatus(currentAppointmentData.appointmentId,e,t,n))return void showErrorMessage("Appointment not found in database");let a="";switch(e){case"arrived":a="Patient marked as arrived";break;case"completed":a="Appointment marked as completed";break;case"no-show":a="Appointment marked as no-show";break;case"cancelled":a="Appointment cancelled and removed from schedule";break;case"held":a="Appointment put on hold"}currentAppointmentData&&(currentAppointmentData.status=e,updateProcessModalDisplay(currentAppointmentData));currentAppointmentData.date;showSuccessMessage(a),closeModal("processModal"),currentAppointmentData=null,await refreshCurrentViewOnly()}catch(e){showErrorMessage("Failed to update appointment status")}else showErrorMessage("Error: No appointment data found. Please try again.")}function updateProcessModalDisplay(e){const t=document.getElementById("appointmentSummary");t&&e&&(t.innerHTML=`\n            <h4>Appointment Details</h4>\n            <div class="detail-row">\n                <span class="detail-label">Patient:</span>\n                <span class="detail-value">${escapeHtml(e.patientName)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Service:</span>\n                <span class="detail-value">${escapeHtml(e.service)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Status:</span>\n                <span class="detail-value">${escapeHtml(capitalizeFirst(e.status.replace("-"," ")))}</span>\n            </div>\n        `),updateButtonSelection(e.status)}function updateButtonSelection(e){document.querySelectorAll(".btn-action").forEach(e=>{e.classList.remove("selected")});let t=null;switch(e){case"arrived":t="arrivedBtn";break;case"completed":t="completedBtn";break;case"no-show":t="noShowBtn";break;case"cancelled":t="cancelBtn";break;case"held":t="holdBtn"}if(t){const e=document.getElementById(t);e&&e.classList.add("selected")}}function getStatusFromCard(e){const t=["scheduled","arrived","completed","no-show","cancelled","held"];for(let n of t)if(e.classList.contains(n))return n;return"scheduled"}function showMoreAppointmentsPopup(e,t){const n=document.querySelector(".more-appointments-popup");n&&n.remove();const a=document.createElement("div");a.className="more-appointments-popup";const i=document.createElement("div");i.className="popup-header",i.textContent=`Additional Appointments (${e.length})`,a.appendChild(i);const o=document.createElement("div");o.className="popup-appointments-list",e.forEach(e=>{const t=document.createElement("div");t.className=`popup-appointment-item ${e.status}`,t.onclick=()=>{a.remove(),openProcessModal(t,e)};const n=document.createElement("div");n.className="popup-left-content";const i=document.createElement("div");i.className="popup-patient-name",i.textContent=e.patientName;const s=document.createElement("div");s.className="popup-service",s.textContent=e.service,n.appendChild(i),n.appendChild(s);const r=document.createElement("div"),c=e.status||"scheduled";r.className=`popup-status ${c}`,r.textContent=capitalizeFirst(c),t.appendChild(n),t.appendChild(r),o.appendChild(t)}),a.appendChild(o),a.style.visibility="hidden",a.style.position="fixed",document.body.appendChild(a);const s=t.getBoundingClientRect(),r=a.getBoundingClientRect(),c=window.innerWidth,d=window.innerHeight;let l=s.left,p=s.bottom+5;l+r.width>c-10&&(l=s.right-r.width),l<10&&(l=10),p+r.height>d-10&&(p=s.top-r.height-5),p<10&&(p=10),a.style.left=`${l}px`,a.style.top=`${p}px`,a.style.visibility="visible",a.style.zIndex="1000";const m=e=>{a.contains(e.target)||e.target===t||(a.remove(),document.removeEventListener("click",m))};setTimeout(()=>{document.addEventListener("click",m)},100)}function validatePatientName(e){if("string"!=typeof e)return!1;const t=e.trim();if(!t||0===t.length)return!1;return/^[A-Za-z\s'\-\.]{1,50}$/.test(t)}function fixAppointmentTimeOptions(){setTimeout(()=>{const e=document.getElementById("appointmentTime");if(e&&8===e.options.length){const t=new Option("04:00 PM - 05:00 PM","16:00-17:00");e.add(t)}},200)}document.getElementById("prevWeek")?.addEventListener("click",async()=>{"week"===currentView?(currentDate.setDate(currentDate.getDate()-7),await refreshCurrentViewOnly()):"day"===currentView?(currentDate.setDate(currentDate.getDate()-1),await refreshCurrentViewOnly()):"month"===currentView?(currentDate.setMonth(currentDate.getMonth()-1),await refreshCurrentViewOnly()):(await refreshAllViews(),updateCurrentDateDisplay())}),document.getElementById("nextWeek")?.addEventListener("click",async()=>{"week"===currentView?(currentDate.setDate(currentDate.getDate()+7),await refreshCurrentViewOnly()):"day"===currentView?(currentDate.setDate(currentDate.getDate()+1),await refreshCurrentViewOnly()):"month"===currentView?(currentDate.setMonth(currentDate.getMonth()+1),await refreshCurrentViewOnly()):(await refreshAllViews(),updateCurrentDateDisplay())}),document.addEventListener("click",function(e){e.target&&("newAppointmentBtn"===e.target.id||e.target.textContent?.includes("New Appointment")||e.target.closest("#newAppointmentBtn"))&&fixAppointmentTimeOptions()}),document.addEventListener("DOMContentLoaded",fixAppointmentTimeOptions);let currentAccountPatient=null;async function showPatientAccountModal(e){currentAccountPatient=e,document.getElementById("accountPatientName").textContent=e.patientName;const t=document.getElementById("patientStatusToggle");await checkHasUpcomingAppointments(e)?(t.classList.add("active"),t.classList.remove("inactive"),t.querySelector(".status-text").textContent="Active"):(t.classList.add("inactive"),t.classList.remove("active"),t.querySelector(".status-text").textContent="Inactive"),loadAccountHistory(e),loadAccountRecords(e),loadDentalChart(e),loadNextTreatments(e),openModal("patientAccountModal"),setTimeout(()=>{initializePatientInfoEdit();document.getElementById("patientInfoDisplay")?loadPatientInfoDisplay(e):setTimeout(()=>{loadPatientInfoDisplay(e)},300)},200)}async function checkHasUpcomingAppointments(e){const t=await dataManager.getAllAppointments()||[],n=(new Date).toISOString().split("T")[0];return t.some(t=>!!(e.userId&&t.userId?t.userId===e.userId:t.patientName===e.patientName)&&t.dateKey>=n)}async function loadAccountHistory(e){try{const t=document.getElementById("accountHistoryList"),n=await dataManager.getAllAppointments()||[],a=await dataManager.getCancelledAppointments()||[],i=[...n,...a].filter(t=>e.userId&&t.userId?t.userId===e.userId:t.patientName===e.patientName).sort((e,t)=>t.dateKey.localeCompare(e.dateKey));t.innerHTML="",i.forEach(e=>{const n=document.createElement("div");n.className="account-history-item";const[a,i,o]=e.dateKey.split("-"),s=`${["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(i)-1]} ${parseInt(o)}, ${a}`,r=formatTime(e.time);n.innerHTML=`\n            <div class="account-history-header">\n                <span class="account-history-date">${escapeHtml(s)} - ${escapeHtml(r)}</span>\n                <span class="status-badge ${e.status}">${escapeHtml(capitalizeFirst(e.status))}</span>\n            </div>\n            <div class="account-history-details">\n                <div><strong>Service:</strong> ${escapeHtml(e.serviceType||e.service||"Unknown Service")}</div>\n                <div><strong>Location:</strong> ${escapeHtml(e.location)}</div>\n                <div><strong>Duration:</strong> 60 minutes</div>\n            </div>\n            ${e.notes?`<div class="account-history-notes"><strong>Notes:</strong> ${escapeHtml(e.notes)}</div>`:""}\n        `,t.appendChild(n)})}catch(e){const t=document.getElementById("accountHistoryList");t&&(t.innerHTML='<div class="error-message">Failed to load appointment history</div>')}}async function loadAccountRecords(e){const t=document.getElementById("accountRecordsList");if(!e)return void(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">No patient selected</div>');if(!window.firebaseDataService)return void(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">Firebase service not available</div>');const n=e.userId||`patient_${e.patientName.toLowerCase().replace(/[^a-z0-9]/g,"_")}`;try{t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">Loading medical records...</div>';const e=await window.firebaseDataService.getMedicalRecords(n);if(t.innerHTML="",0===e.length)return void(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">No medical records found</div>');e.forEach(e=>{const n=document.createElement("div");n.className="record-item";let a="fas fa-file";e.type.includes("pdf")?a="fas fa-file-pdf":e.type.includes("image")?a="fas fa-file-image":(e.type.includes("word")||e.type.includes("document"))&&(a="fas fa-file-word");const i=(e.uploadedAt.toDate?e.uploadedAt.toDate():new Date(e.uploadedAt)).toLocaleDateString();n.innerHTML=`\n                <div class="record-info">\n                    <i class="${a} record-icon"></i>\n                    <div class="record-details">\n                        <div class="record-name">${escapeHtml(e.originalName)}</div>\n                        <div class="record-date">Uploaded: ${escapeHtml(i)}</div>\n                    </div>\n                </div>\n                <div class="record-actions">\n                    <button class="record-action" data-record-id="${escapeHtml(e.id)}" data-record-name="${escapeHtml(e.originalName)}" data-action="download" title="Download">\n                        <i class="fas fa-download"></i>\n                    </button>\n                    <button class="record-action" data-record-id="${escapeHtml(e.id)}" data-record-name="${escapeHtml(e.originalName)}" data-action="rename" title="Rename">\n                        <i class="fas fa-edit"></i>\n                    </button>\n                    <button class="record-action" data-record-id="${escapeHtml(e.id)}" data-record-name="${escapeHtml(e.originalName)}" data-action="delete" title="Delete">\n                        <i class="fas fa-trash"></i>\n                    </button>\n                </div>\n            `;n.querySelectorAll(".record-action").forEach(t=>{t.addEventListener("click",function(){const t=this.getAttribute("data-action"),n=this.getAttribute("data-record-id"),a=this.getAttribute("data-record-name");"download"===t?downloadRecord(n,e.base64Data,a):"rename"===t?renameRecord(n,a):"delete"===t&&deleteRecord(n,a)})}),t.appendChild(n)})}catch(e){t.innerHTML='<div style="text-align: center; color: #e74c3c; padding: 40px;">Failed to load medical records</div>'}}function renameRecord(e,t){const n=prompt("Enter new filename:",t);n&&n!==t&&window.firebaseDataService&&window.firebaseDataService.renameMedicalRecord(e,n).then(()=>{currentAccountPatient&&loadAccountRecords(currentAccountPatient)}).catch(e=>{alert("Failed to rename file. Please try again.")})}async function loadNextTreatments(e){const t=document.getElementById("accountTreatmentList"),n=(new Date,(await dataManager.getAllAppointments()).filter(t=>{let n=!1;if(n=e.userId&&t.userId?t.userId===e.userId:t.patientName===e.patientName,!n)return!1;const a=(new Date).toISOString().split("T")[0];return t.dateKey>=a}).sort((e,t)=>e.dateKey.localeCompare(t.dateKey)));t.innerHTML="",n.forEach(e=>{const n=document.createElement("div");n.className="treatment-card",n.onclick=()=>showAppointmentDetails(null,e);const[a,i,o]=e.dateKey.split("-"),s=`${["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(i)-1]} ${parseInt(o)}, ${a}`,r=formatTime(e.time);n.innerHTML=`\n            <div class="treatment-header">\n                <div class="treatment-info">\n                    <h4>${escapeHtml(e.serviceType||e.service||"Unknown Service")} - ${escapeHtml(e.location)}</h4>\n                    <div class="treatment-date">${escapeHtml(s)} at ${escapeHtml(r)}</div>\n                </div>\n                <span class="status-badge ${e.status}">${escapeHtml(capitalizeFirst(e.status))}</span>\n            </div>\n            ${e.notes?`<div class="treatment-desc">${escapeHtml(e.notes)}</div>`:""}\n        `,t.appendChild(n)}),0===n.length&&(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">No upcoming treatments scheduled</div>')}function downloadRecord(e,t,n){window.firebaseDataService&&window.firebaseDataService.downloadMedicalRecord(t,n).then(()=>{}).catch(e=>{alert("Failed to download file. Please try again.")})}function deleteRecord(e,t){confirm(`Delete ${t}?`)&&window.firebaseDataService&&window.firebaseDataService.deleteMedicalRecord(e).then(()=>{currentAccountPatient&&loadAccountRecords(currentAccountPatient)}).catch(e=>{alert("Failed to delete file. Please try again.")})}async function handleFileUpload(e){const t=e.target.files;if(!t||0===t.length)return;if(!currentAccountPatient)return void alert("No patient selected");const n=currentAccountPatient.userId||`patient_${currentAccountPatient.patientName.toLowerCase().replace(/[^a-z0-9]/g,"_")}`,a=[];for(let e of t){if(!validateFile(e))continue;const t=await processFile(e);a.push(uploadFile(n,t))}try{await Promise.all(a),currentAccountPatient&&loadAccountRecords(currentAccountPatient),e.target.value=""}catch(e){alert("Some files failed to upload. Please try again.")}}function validateFile(e){return e.size>512e3?(alert(`File "${e.name}" is too large. Maximum size is 500KB for Base64 storage.`),!1):!!["application/pdf","image/jpeg","image/jpg","image/png","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(e.type)||(alert(`File "${e.name}" has unsupported format. Allowed: PDF, JPG, PNG, DOC, DOCX`),!1)}async function processFile(e){return e.type.startsWith("image/")?new Promise(t=>{const n=document.createElement("canvas"),a=n.getContext("2d"),i=new Image;i.onload=function(){let o=.6;e.size>307200?o=.5:e.size<102400&&(o=.7);let{width:s,height:r}=i;if(s>800||r>600){const e=Math.min(800/s,600/r);s*=e,r*=e}n.width=s,n.height=r,a.drawImage(i,0,0,s,r),n.toBlob(n=>{const a=new File([n],e.name,{type:e.type,lastModified:Date.now()});t(a)},e.type,o)},i.src=URL.createObjectURL(e)}):e}async function uploadFile(e,t){return new Promise((n,a)=>{if(!window.firebaseDataService)return void a(new Error("Firebase service not available"));const i=createProgressElement(t.name);window.firebaseDataService.uploadMedicalRecord(e,t,e=>{updateProgressElement(i,e)}).then(e=>{removeProgressElement(i),n(e)}).catch(e=>{removeProgressElement(i),a(e)})})}function createProgressElement(e){const t=document.getElementById("accountRecordsList");if(!t)return null;const n=document.createElement("div");return n.className="upload-progress",n.innerHTML=`\n        <div class="progress-info">\n            <span class="progress-filename">${e}</span>\n            <span class="progress-percentage">0%</span>\n        </div>\n        <div class="progress-bar">\n            <div class="progress-fill" style="width: 0%"></div>\n        </div>\n    `,t.insertBefore(n,t.firstChild),n}function updateProgressElement(e,t){if(!e)return;const n=Math.round(t),a=e.querySelector(".progress-percentage"),i=e.querySelector(".progress-fill");a&&(a.textContent=`${n}%`),i&&(i.style.width=`${n}%`)}function removeProgressElement(e){e&&e.parentNode&&setTimeout(()=>{try{e.parentNode&&e.parentNode.removeChild(e)}catch(e){}},1e3)}function initializePatientInfoEdit(){const e=document.getElementById("editPatientInfoBtn"),t=document.getElementById("cancelEdit"),n=document.getElementById("saveEdit");e&&e.addEventListener("click",function(e){e.stopPropagation(),toggleEditMode(!0)}),t&&t.addEventListener("click",function(){toggleEditMode(!1)}),n&&n.addEventListener("click",function(){savePatientInfo()})}function toggleEditMode(e){const t=document.getElementById("patientInfoDisplay"),n=document.getElementById("patientInfoEdit"),a=document.getElementById("notesDisplay"),i=document.getElementById("notesEdit"),o=document.getElementById("editActions");if(e){if(t.style.display="none",n.style.display="flex",n.style.flexDirection="column",a.style.display="none",i.style.display="block",o.style.display="flex",currentAccountPatient){document.getElementById("editPhone").value=currentAccountPatient.phone||"",document.getElementById("editEmail").value=currentAccountPatient.email||"";let e={};dataManager.data.patientProfiles&&dataManager.data.patientProfiles[currentAccountPatient.patientName]&&(e=dataManager.data.patientProfiles[currentAccountPatient.patientName].detailedInfo),document.getElementById("editAddress").value=e.address||"",document.getElementById("editEmergency").value=e.emergency||"",document.getElementById("editDateOfBirth").value=e.dateOfBirth||"",document.getElementById("editAge").value=e.age||"",document.getElementById("editGender").value=e.gender||"",document.getElementById("editFirstVisit").value=e.firstVisit||"",document.getElementById("editAllergies").value=e.allergies||"",document.getElementById("editMedications").value=e.medications||"",document.getElementById("editConditions").value=e.conditions||"",document.getElementById("notesEdit").value=e.medicalNotes||""}}else t.style.display="flex",n.style.display="none",a.style.display="block",i.style.display="none",o.style.display="none"}function savePatientInfo(){const e=document.getElementById("editPhone").value,t=document.getElementById("editEmail").value,n=document.getElementById("editAddress").value,a=document.getElementById("editEmergency").value,i=document.getElementById("editDateOfBirth").value,o=document.getElementById("editAge").value,s=document.getElementById("editGender").value,r=document.getElementById("editFirstVisit").value,c=document.getElementById("editAllergies").value,d=document.getElementById("editMedications").value,l=document.getElementById("editConditions").value,p=document.getElementById("notesEdit").value;if(currentAccountPatient&&(currentAccountPatient.phone=e,currentAccountPatient.email=t,Object.keys(dataManager.data.appointments).forEach(n=>{dataManager.data.appointments[n].forEach(n=>{n.patientName===currentAccountPatient.patientName&&(n.phone=e,n.email=t)})}),Object.keys(dataManager.data.cancelledAppointments||{}).forEach(n=>{dataManager.data.cancelledAppointments[n].forEach(n=>{n.patientName===currentAccountPatient.patientName&&(n.phone=e,n.email=t)})}),dataManager.data.patientProfiles||(dataManager.data.patientProfiles={}),dataManager.data.patientProfiles[currentAccountPatient.patientName]={detailedInfo:{address:n,emergency:a,dateOfBirth:i,age:o,gender:s,firstVisit:r,allergies:c,medications:d,conditions:l,medicalNotes:p},lastUpdated:(new Date).toISOString()},dataManager.saveToStorage()),showSuccessMessage("Patient information updated successfully!"),currentAccountPatient){let n={};dataManager.data.patientProfiles&&dataManager.data.patientProfiles[currentAccountPatient.patientName]&&(n=dataManager.data.patientProfiles[currentAccountPatient.patientName].detailedInfo),updatePatientInfoDisplay(e,t,n.address||"",n.emergency||"",n.dateOfBirth||"",n.age||"",n.gender||"",n.firstVisit||"",n.allergies||"",n.medications||"",n.conditions||"",n.medicalNotes||"")}toggleEditMode(!1),renderHistoryView(!0),closeModal("patientAccountModal"),currentAccountPatient=null,"history"===currentView&&renderHistoryView(!0)}function updatePatientInfoDisplay(e,t,n,a,i,o,s,r,c,d,l,p){document.getElementById("patientInfoDisplay").innerHTML=`\n        <div class="info-row"><span>Phone:</span> <span>${e||""}</span></div>\n        <div class="info-row"><span>Email:</span> <span>${t||""}</span></div>\n        <div class="info-row"><span>Address:</span> <span>${n||""}</span></div>\n        <div class="info-row"><span>Emergency Contact:</span> <span>${a||""}</span></div>\n        <div class="info-row"><span>Date of Birth:</span> <span>${formatDateForDisplay(i)||""}</span></div>\n        <div class="info-row"><span>Age:</span> <span>${o||""} years old</span></div>\n        <div class="info-row"><span>Gender:</span> <span>${s||""}</span></div>\n        <div class="info-row"><span>First Visit:</span> <span>${formatDateForDisplay(r)||""}</span></div>\n        <div class="info-row"><span>Allergies:</span> <span>${c||""}</span></div>\n        <div class="info-row"><span>Medications:</span> <span>${d||""}</span></div>\n        <div class="info-row"><span>Medical Conditions:</span> <span>${l||""}</span></div>\n    `;const m=document.getElementById("notesDisplay");m&&(m.textContent=p||"No notes available")}function loadPatientInfoDisplay(e){const t=document.getElementById("patientInfoDisplay");if(!t)return;let n={};dataManager.data.patientProfiles&&dataManager.data.patientProfiles[e.patientName]&&(n=dataManager.data.patientProfiles[e.patientName].detailedInfo),t.innerHTML=`\n        <div class="info-row"><span>Phone:</span> <span>${e.phone||""}</span></div>\n        <div class="info-row"><span>Email:</span> <span>${e.email||""}</span></div>\n        <div class="info-row"><span>Address:</span> <span>${n.address||""}</span></div>\n        <div class="info-row"><span>Emergency Contact:</span> <span>${n.emergency||""}</span></div>\n        <div class="info-row"><span>Date of Birth:</span> <span>${n.dateOfBirth||""}</span></div>\n        <div class="info-row"><span>Age:</span> <span>${n.age?n.age+" years old":""}</span></div>\n        <div class="info-row"><span>Gender:</span> <span>${n.gender||""}</span></div>\n        <div class="info-row"><span>First Visit:</span> <span>${n.firstVisit||(e.firstVisitDate?(()=>{const[t,n,a]=e.firstVisitDate.split("-");return`${n}/${a}/${t}`})():"")}</span></div>\n        <div class="info-row"><span>Allergies:</span> <span>${n.allergies||""}</span></div>\n        <div class="info-row"><span>Medications:</span> <span>${n.medications||""}</span></div>\n        <div class="info-row"><span>Medical Conditions:</span> <span>${n.conditions||""}</span></div>\n    `}function openNewAppointmentModalWithPatient(e){const t=document.getElementById("appointmentDate"),n=document.getElementById("appointmentPatientName"),a=document.getElementById("appointmentPhone"),i=(new Date).toISOString().split("T")[0];t&&(t.min=i,t.value=i),e&&n&&(n.value=e.patientName,n.readOnly=!0,n.style.backgroundColor="#f9fafb"),e&&a&&(a.value=e.phone||""),applyLocationPermissionsToNewAppointmentModal(),openModal("newAppointmentModal")}function applyLocationPermissionsToNewAppointmentModal(){const e=dataManager.getCurrentUser(),t=document.getElementById("appointmentLocation");if(!t)return;const n=dataManager.getUserClinics(e);t.innerHTML='<option value="">Select Location</option>';const a={arcadia:"Arcadia",irvine:"Irvine","south-pasadena":"South Pasadena","rowland-heights":"Rowland Heights",eastvale:"Eastvale"};n.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=a[e]||e,t.appendChild(n)}),"admin"===e.role?(t.value=e.assignedLocation,t.disabled=!0,t.style.backgroundColor="#f3f4f6",t.style.cursor="not-allowed"):(t.disabled=!1,t.style.backgroundColor="white",t.style.cursor="pointer")}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".account-tab-item").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".account-tab-item").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".account-tab-content").forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.getAttribute("data-tab");document.getElementById(t).classList.add("active")})}),document.getElementById("accountModalClose")?.addEventListener("click",()=>{closeModal("patientAccountModal"),currentAccountPatient=null}),document.getElementById("accountScheduleBtn")?.addEventListener("click",()=>{closeModal("patientAccountModal"),openNewAppointmentModalWithPatient(currentAccountPatient)}),document.getElementById("patientStatusToggle")?.addEventListener("click",function(){this.classList.contains("active")?(this.classList.remove("active"),this.classList.add("inactive"),this.querySelector(".status-text").textContent="Inactive"):(this.classList.remove("inactive"),this.classList.add("active"),this.querySelector(".status-text").textContent="Active")});const e=document.getElementById("accountFileInput");e&&e.addEventListener("change",handleFileUpload)}),document.getElementById("accountModalClose")?.addEventListener("click",()=>{closeModal("patientAccountModal"),renderHistoryView(!0),currentAccountPatient=null});let currentDentalChart=null;async function loadDentalChart(e){try{const t=e.userId||`patient_${e.patientName.toLowerCase().replace(/[^a-z0-9]/g,"_")}`;let n=window.cacheManager.getDentalChartCache(t);n||(n=await window.firebaseDataService.getDentalChart(t),n||(await window.firebaseDataService.initializeDentalChart(t,e.patientName),n=await window.firebaseDataService.getDentalChart(t)),n&&window.cacheManager.setDentalChartCache(t,n));document.getElementById("dentalChartContainer")&&n&&(currentDentalChart=new DentalChart("dentalChartContainer",{mode:"edit",teethData:n.teeth||{},onToothSelect:(e,n)=>{showToothDetails(t,e,n)}}))}catch(e){}}function showToothDetails(e,t,n){const a=document.getElementById("toothDetailsPanel"),i=document.getElementById("selectedToothTitle"),o=document.getElementById("toothStatusSelect"),s=document.getElementById("treatmentsList");i.textContent=`Tooth ${t}`,o.value=n.status||"healthy",s.innerHTML="",n.treatments&&n.treatments.length>0?n.treatments.forEach((n,a)=>{const i=document.createElement("div");i.className="treatment-item",i.innerHTML=`\n                <div class="treatment-date">${new Date(n.date).toLocaleDateString()}</div>\n                <div class="treatment-type">${n.type||"Note"}</div>\n                <div class="treatment-notes">${n.notes||""}</div>\n                <button class="btn-small btn-danger" onclick="deleteToothTreatment('${e}', ${t}, '${n.id}')">Delete</button>\n            `,s.appendChild(i)}):s.innerHTML='<p class="treatment-placeholder">No treatment records yet</p>',window.currentToothData={userId:e,toothNum:t},a.style.display="block"}function closeToothDetails(){const e=document.getElementById("toothDetailsPanel"),t=document.getElementById("selectedToothTitle"),n=document.getElementById("treatmentsList"),a=document.getElementById("toothStatusSelect");e.style.display="none",window.currentToothData=null,t&&(t.textContent="Select a tooth"),a&&(a.value="healthy"),n&&(n.innerHTML='<p class="treatment-placeholder">Select a tooth to view history</p>')}async function updateToothStatus(){if(!window.currentToothData)return;const{userId:e,toothNum:t}=window.currentToothData,n=document.getElementById("toothStatusSelect").value;try{if(await window.firebaseDataService.updateToothStatus(e,t,{status:n}),window.cacheManager.onDentalChartUpdated(e),currentDentalChart){const e=currentDentalChart.getToothData(t);e&&(e.status=n,currentDentalChart.updateToothData(t,e))}showNotification("â Tooth status updated successfully")}catch(e){showNotification("â Failed to update tooth status")}}async function addTreatmentRecord(){if(!window.currentToothData)return;const{userId:e,toothNum:t}=window.currentToothData,n=document.getElementById("treatmentNotes").value.trim();if(n)try{const a={type:"note",notes:n};await window.firebaseDataService.addToothTreatment(e,t,a),window.cacheManager.onDentalChartUpdated(e),await loadDentalChart({userId:e}),document.getElementById("treatmentNotes").value="",showNotification("â Treatment record added successfully")}catch(e){showNotification("â Failed to add treatment record")}else showNotification("â ï¸ Please enter treatment notes")}async function saveToothUpdates(){if(!window.currentToothData)return;await updateToothStatus();document.getElementById("treatmentNotes").value.trim()&&await addTreatmentRecord()}async function deleteToothTreatment(e,t,n){if(confirm("Are you sure you want to delete this treatment record?"))try{await window.firebaseDataService.deleteToothTreatment(e,t,n),window.cacheManager.onDentalChartUpdated(e);const a=await window.firebaseDataService.getDentalChart(e);if(a){const n=a.teeth[t.toString()];showToothDetails(e,t,n)}showNotification("â Treatment record deleted")}catch(e){showNotification("â Failed to delete treatment record")}}