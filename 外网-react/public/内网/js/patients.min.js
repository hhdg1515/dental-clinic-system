import{escapeHtml}from"./security-utils.js";let currentProcessingRow=null,currentPatientData=null,pendingCurrentPage=1,confirmedCurrentPage=1;const patientsItemsPerPage=8;let pendingFilteredData=[],confirmedFilteredData=[],pendingAllData=[],confirmedAllData=[],appointmentRealtimeListener=null;function waitForFirebaseService(){return new Promise((e,t)=>{let n=0;const a=setInterval(()=>{n++,window.dataManager&&window.dataManager.firebaseService&&window.dataManager.useFirebase?(clearInterval(a),e()):n>=50&&(clearInterval(a),t(new Error("Firebase service initialization timeout")))},100)})}async function initializeRealtimeListeners(){}function cleanupRealtimeListeners(){appointmentRealtimeListener&&"function"==typeof appointmentRealtimeListener&&(appointmentRealtimeListener(),appointmentRealtimeListener=null)}function activateNotificationBell(){const e=document.getElementById("notificationBell");e&&(e.classList.add("active"),e.onclick=function(e){e.preventDefault();const t=document.querySelector('[data-tab="pending"]');t&&!t.classList.contains("active")&&t.click()})}function handleUrlHashNavigation(){if("#pending"===window.location.hash){const e=document.querySelector('[data-tab="pending"]'),t=document.querySelector('[data-tab="confirmed"]'),n=document.getElementById("pending-tab"),a=document.getElementById("confirmed-tab");e&&n&&(t&&t.classList.remove("active"),a&&a.classList.remove("active"),e.classList.add("active"),n.classList.add("active")),window.history.replaceState(null,null,window.location.pathname)}}function initializePagination(){initializePendingPagination(),initializeConfirmedPagination()}function initializePendingPagination(){const e=document.getElementById("pendingPrevBtn"),t=document.getElementById("pendingNextBtn");e&&e.addEventListener("click",()=>{pendingCurrentPage>1&&(pendingCurrentPage--,renderPendingAppointments(!1),updatePendingPaginationControls())}),t&&t.addEventListener("click",()=>{const e=Math.ceil(pendingFilteredData.length/8);pendingCurrentPage<e&&(pendingCurrentPage++,renderPendingAppointments(!1),updatePendingPaginationControls())})}function initializeConfirmedPagination(){const e=document.getElementById("confirmedPrevBtn"),t=document.getElementById("confirmedNextBtn");e&&e.addEventListener("click",()=>{confirmedCurrentPage>1&&(confirmedCurrentPage--,renderConfirmedAppointments(!1),updateConfirmedPaginationControls())}),t&&t.addEventListener("click",()=>{const e=Math.ceil(confirmedFilteredData.length/8);confirmedCurrentPage<e&&(confirmedCurrentPage++,renderConfirmedAppointments(!1),updateConfirmedPaginationControls())})}function updatePendingPaginationControls(){const e=document.getElementById("pendingPrevBtn"),t=document.getElementById("pendingNextBtn"),n=Math.ceil(pendingFilteredData.length/8);if(e&&(e.disabled=1===pendingCurrentPage),t){const e=pendingCurrentPage>=n||0===n;t.disabled=e}}function updateConfirmedPaginationControls(){const e=document.getElementById("confirmedPrevBtn"),t=document.getElementById("confirmedNextBtn"),n=Math.ceil(confirmedFilteredData.length/8);if(e&&(e.disabled=1===confirmedCurrentPage),t){const e=confirmedCurrentPage>=n||0===n;t.disabled=e}}function applyPendingFilter(e=!0){const t=document.getElementById("globalSearchInput"),n=t?t.value.toLowerCase().trim():"";Array.isArray(pendingAllData)||(pendingAllData=[]),pendingFilteredData=""===n?[...pendingAllData]:pendingAllData.filter(e=>{if(!e||!e.patientName)return!1;const t=e.patientName.toLowerCase(),a=(e.phone||"").replace(/\D/g,"").toLowerCase();return t.includes(n)||a.includes(n)}),e&&(pendingCurrentPage=1)}function applyConfirmedFilter(e=!0){const t=document.getElementById("globalSearchInput"),n=t?t.value.toLowerCase().trim():"";Array.isArray(confirmedAllData)||(confirmedAllData=[]),confirmedFilteredData=""===n?[...confirmedAllData]:confirmedAllData.filter(e=>{if(!e||!e.patientName)return!1;const t=e.patientName.toLowerCase(),a=(e.phone||"").replace(/\D/g,"").toLowerCase();return t.includes(n)||a.includes(n)}),e&&(confirmedCurrentPage=1)}async function refreshPatientsData(){await renderPendingAppointments(!0),await renderConfirmedAppointments(!0)}async function renderPendingAppointments(e=!1){const t=document.getElementById("pendingTableBody");if(!t)return;if(!Array.isArray(pendingAllData)||0===pendingAllData.length||e)try{const e=await dataManager.getPendingConfirmations();pendingAllData=Array.isArray(e)?e:[],applyPendingFilter(!0)}catch(e){pendingAllData=[],applyPendingFilter(!0)}else applyPendingFilter(!1);t.innerHTML="";const n=8*(pendingCurrentPage-1),a=n+8;pendingFilteredData.slice(n,a).forEach(e=>{const n=createPatientTableRow(e,"pending");t.appendChild(n)}),updatePendingPaginationControls()}async function renderConfirmedAppointments(e=!1){const t=document.getElementById("confirmedTableBody");if(!t)return;if(!Array.isArray(confirmedAllData)||0===confirmedAllData.length||e)try{const e=await dataManager.getAllAppointments();if(!Array.isArray(e))return confirmedAllData=[],void applyConfirmedFilter(!0);const t=e.filter(e=>"cancelled"!==e.status&&"pending"!==e.status&&"declined"!==e.status);t.sort((e,t)=>{const n=t.dateKey.localeCompare(e.dateKey);return 0!==n?n:t.time.localeCompare(e.time)}),confirmedAllData=t,applyConfirmedFilter(!0)}catch(e){confirmedAllData=[],applyConfirmedFilter(!0)}else applyConfirmedFilter(!1);t.innerHTML="";const n=8*(confirmedCurrentPage-1),a=n+8;confirmedFilteredData.slice(n,a).forEach(e=>{const n=createPatientTableRow(e,"confirmed");t.appendChild(n)}),updateConfirmedPaginationControls()}function createPatientTableRow(e,t){const n=document.createElement("tr");let a;if(n.dataset.patientId=e.id,n.dataset.patientType=t,"pending"===t)a=e.dateTime;else{const[t,n,i]=e.dateKey.split("-");a=`${`${n}/${i}/${t}`} ${formatTime(e.time)}`}n.innerHTML=`\n        <td class="patient-name">${escapeHtml(e.patientName)}</td>\n        <td class="appointment-date">${escapeHtml(a)}</td>\n        <td>${escapeHtml(e.phone||"(XXX) XXX-XXXX")}</td>\n        <td><span class="treatment-type">${escapeHtml(e.service||e.serviceType||e.serviceName||e.treatment||"Not specified")}</span></td>\n        <td class="location-cell">${escapeHtml(e.location)}</td>\n        <td id="actions-${escapeHtml(e.id)}"></td>\n    `;const i=n.querySelector(`#actions-${e.id}`);if("pending"===t){const t=document.createElement("div");t.className="pending-actions";const n=document.createElement("button");n.className="btn-icon btn-confirm",n.setAttribute("data-tooltip","Confirm"),n.textContent="✓",n.onclick=async t=>{t.stopPropagation(),await handleConfirmAction(e)};const a=document.createElement("button");a.className="btn-icon btn-decline",a.setAttribute("data-tooltip","Decline"),a.textContent="✗",a.onclick=async t=>{t.stopPropagation(),await handleDeclineAction(e)},t.appendChild(n),t.appendChild(a),i.appendChild(t)}else{const e=document.createElement("i");e.className="fas fa-ellipsis-v action-icon",e.onclick=async t=>{t.stopPropagation(),await showProcessModal(e)},i.appendChild(e)}return n.addEventListener("click",async function(n){n.target.classList.contains("action-icon")||n.target.classList.contains("btn-icon")||await showPatientDetailsModal(e,t)}),n}async function handleConfirmAction(e){if(confirm(`Are you sure you want to confirm the appointment for ${e.patientName}?`))try{if(!await dataManager.updateAppointmentStatus(e.id,"confirmed",{confirmedAt:(new Date).toISOString(),confirmedBy:dataManager.getCurrentUser()?.name||"Admin"}))throw new Error("Update returned false");showSuccessMessage("Appointment confirmed successfully!"),refreshPatientsData()}catch(e){showErrorMessage(`Failed to confirm appointment: ${e.message}`)}}async function handleDeclineAction(e){if(confirm(`Are you sure you want to decline the appointment request for ${e.patientName}?`))try{await dataManager.updateAppointmentStatus(e.id,"declined",{declinedAt:(new Date).toISOString(),declinedBy:dataManager.getCurrentUser()?.name||"Admin"}),showSuccessMessage("Appointment request declined."),refreshPatientsData()}catch(e){showErrorMessage("Failed to decline appointment. Please try again.")}}async function showPatientDetailsModal(e,t="unknown"){document.getElementById("patientDetailsTitle").textContent=e.patientName,document.getElementById("patientName").textContent=e.patientName,document.getElementById("patientPhone").textContent=e.phone||"(XXX) XXX-XXXX",document.getElementById("patientEmail").textContent=e.email||`${e.patientName.toLowerCase().replace(/\s+/g,".")}@email.com`,document.getElementById("patientLocation").textContent=e.location;const n=document.getElementById("patientService");if(n){const t=e.service||e.serviceType||e.serviceName||e.treatment||"";t&&window.ServiceMapping?n.textContent=window.ServiceMapping.getServiceDisplayName(t):n.textContent=t||"Not specified"}document.getElementById("selfDescriptionText").textContent=e.notes||"No additional notes provided.",e.userId?await loadAppointmentHistory(e.userId,!0):await loadAppointmentHistory(e.patientName,!1),window.currentPatientForEdit={...e,_editingId:e.id,_editingType:t},updateModalActionButtons(t),openModal("patientDetailsModal")}function updateModalActionButtons(e){const t=document.getElementById("reviewedBtn");t&&("pending"===e?(t.textContent="Reviewed",t.title="Mark as reviewed and close",t.className="btn-secondary"):"confirmed"===e?(t.textContent="Schedule Follow-up",t.title="Schedule a follow-up appointment",t.className="btn-primary"):(t.textContent="Close",t.title="Close patient details",t.className="btn-secondary"))}async function loadAppointmentHistory(e,t=!1){const n=document.getElementById("appointmentHistory");if(!n)return;n.innerHTML="";const a=[...await dataManager.getAllAppointments(),...await dataManager.getCancelledAppointments()].filter(n=>t&&n.userId?n.userId===e:n.patientName===e).sort((e,t)=>{const n=new Date(e.dateKey+"T"+e.time);return new Date(t.dateKey+"T"+t.time)-n});0!==a.length?a.forEach(e=>{const t=createAppointmentHistoryCard(e);n.appendChild(t)}):n.innerHTML="<p>No appointment history found.</p>"}function createAppointmentHistoryCard(e){const t=document.createElement("div");t.className="appointment-card";const[n,a,i]=e.dateKey.split("-"),o=`${["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(a)-1]} ${parseInt(i)}, ${n}`,d=formatTime(e.time),c=`status-${e.status}`,l=capitalizeFirst(e.status.replace("-"," "));return t.innerHTML=`\n        <div class="appointment-card-header">\n            <div class="appointment-date-time">${escapeHtml(o)}</div>\n            <div class="appointment-status ${c}">${escapeHtml(l)}</div>\n        </div>\n        <div class="appointment-details">\n            <div class="detail-item">\n                <span class="detail-label">Service:</span>\n                <span class="detail-value">${escapeHtml(e.service||e.serviceType||e.serviceName||e.treatment||"Not specified")}</span>\n            </div>\n            <div class="detail-item">\n                <span class="detail-label">Location:</span>\n                <span class="detail-value">${escapeHtml(e.location)}</span>\n            </div>\n            <div class="detail-item">\n                <span class="detail-label">Time:</span>\n                <span class="detail-value">${escapeHtml(d)}</span>\n            </div>\n        </div>\n    `,t}async function showProcessModal(e){refreshPatientsData();const t=e.closest("tr"),n=t.dataset.patientId;let a;if("pending"===t.dataset.patientType){a=(await dataManager.getPendingConfirmations()).find(e=>e.id===n)}else{if(a=(await dataManager.getAllAppointments()).find(e=>e.id===n),!a){a=(await dataManager.getCancelledAppointments()).find(e=>e.id===n)}}if(!a)return void showErrorMessage("Patient data not found");setCurrentProcessData(t,a);const i=document.getElementById("appointmentSummary"),o=a.phone||"Phone not available";i.innerHTML=`\n        <h4>${escapeHtml(a.patientName)}</h4>\n        <div class="detail-row">\n            <span class="detail-label">Phone:</span>\n            <span class="detail-value">${escapeHtml(o)}</span>\n        </div>\n        <div class="detail-row">\n            <span class="detail-label">Service:</span>\n            <span class="detail-value">${escapeHtml(a.service||a.serviceType||a.serviceName||a.treatment||"Not specified")}</span>\n        </div>\n        <div class="detail-row">\n            <span class="detail-label">Status:</span>\n            <span class="detail-value">${escapeHtml(capitalizeFirst(a.status.replace("-"," ")))}</span>\n        </div>\n    `,updateButtonSelection(a.status),openModal("processModal")}function formatAppointmentDateTime(e){return`${new Date(e.dateKey).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"})} ${formatTime(e.time)}`}function setCurrentProcessData(e,t){currentProcessingRow=e,currentPatientData=t}function initializeTabs(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content");e.forEach(n=>{n.addEventListener("click",function(){const n=this.dataset.tab;e.forEach(e=>e.classList.remove("active")),this.classList.add("active"),t.forEach(e=>{e.classList.remove("active"),e.id===n+"-tab"&&e.classList.add("active")});const a=document.getElementById("patientSearchInput");a&&a.value&&a.dispatchEvent(new Event("input"))})})}function triggerPatientsSearch(e){const t=document.getElementById("patientSearchInput");t&&(t.value=e),applyPendingFilter(!0),applyConfirmedFilter(!0),renderPendingAppointments(!1),renderConfirmedAppointments(!1)}function initializeTopNewAppointmentButton(){const e=document.getElementById("topNewAppointmentBtn");e&&e.addEventListener("click",function(){showGenericNewAppointmentModal()})}function applyLocationPermissionsToPatientsModal(){const e=dataManager.getCurrentUser(),t=document.getElementById("newAppointmentLocation");if(!t)return;const n=dataManager.getUserClinics(e);t.innerHTML='<option value="">Select Location</option>';const a={arcadia:"Arcadia",irvine:"Irvine","south-pasadena":"South Pasadena","rowland-heights":"Rowland Heights",eastvale:"Eastvale"};if(n.forEach(e=>{const n=document.createElement("option");n.value=a[e],n.textContent=a[e],t.appendChild(n)}),"admin"===e.role){const n=a[e.assignedLocation];t.value=n,t.disabled=!0,t.style.backgroundColor="#f3f4f6",t.style.cursor="not-allowed"}else t.disabled=!1,t.style.backgroundColor="white",t.style.cursor="pointer"}function showGenericNewAppointmentModal(){document.getElementById("newAppointmentForm").reset();const e=document.getElementById("newPatientName"),t=document.getElementById("newPatientPhone"),n=document.getElementById("newPatientEmail");e.readOnly=!1,t.readOnly=!1,n.readOnly=!1,e.style.backgroundColor="white",t.style.backgroundColor="white",n.style.backgroundColor="white",e.placeholder="Enter patient name",t.placeholder="(XXX) XXX-XXXX",n.placeholder="Enter email address",setMinDateToToday("newAppointmentDate");document.getElementById("newAppointmentDate").value=getCurrentDate(),applyLocationPermissionsToPatientsModal(),openModal("newAppointmentModal")}function initializeModals(){const e=document.getElementById("patientDetailsModal");document.getElementById("patientDetailsClose").addEventListener("click",function(){closeModal("patientDetailsModal")}),e.addEventListener("click",function(t){t.target===e&&closeModal("patientDetailsModal")}),document.getElementById("editBasicInfoBtn").addEventListener("click",function(){showEditBasicInfoModal()}),document.getElementById("reviewedBtn").addEventListener("click",function(){const e=window.currentPatientForEdit;e&&e._editingType;closeModal("patientDetailsModal")}),initializeEditBasicInfoModal(),initializeNewAppointmentModal()}function initializeEditBasicInfoModal(){const e=document.getElementById("editBasicInfoModal"),t=document.getElementById("editBasicInfoClose"),n=document.getElementById("editBasicInfoCancel"),a=document.getElementById("editBasicInfoForm");function i(){closeModal("editBasicInfoModal"),a&&a.reset()}t.addEventListener("click",i),n.addEventListener("click",i),e.addEventListener("click",function(t){t.target===e&&i()}),a.addEventListener("submit",async function(e){e.preventDefault();const t={name:document.getElementById("editPatientName").value,phone:document.getElementById("editPatientPhone").value,email:document.getElementById("editPatientEmail").value,service:window.ServiceMapping?window.ServiceMapping.getServiceDisplayName(document.getElementById("editPatientService").value):document.getElementById("editPatientService").value};try{const e=window.currentPatientForEdit;if(!e||!e._editingId)throw new Error("No patient data found for editing");await dataManager.updateAppointment(e._editingId,t),updatePatientDetailsDisplay(t),refreshPatientsData(),showSuccessMessage("Patient information updated successfully!"),i()}catch(e){showErrorMessage("Failed to update patient information. Please try again.")}}),initializePhoneFormatting("editPatientPhone"),initializePatientNameValidation("editPatientName")}function initializeNewAppointmentModal(){const e=document.getElementById("newAppointmentModal"),t=document.getElementById("newAppointmentClose"),n=document.getElementById("newAppointmentCancel"),a=document.getElementById("newAppointmentForm");function i(){closeModal("newAppointmentModal"),a&&a.reset()}t.addEventListener("click",i),n.addEventListener("click",i),e.addEventListener("click",function(t){t.target===e&&i()}),a.addEventListener("submit",function(e){e.preventDefault();const t={patientName:document.getElementById("newPatientName").value,phone:document.getElementById("newPatientPhone").value,email:document.getElementById("newPatientEmail").value,date:document.getElementById("newAppointmentDate").value,time:extractTimeFromSlot(document.getElementById("newAppointmentTime").value),service:getServiceDisplayName(document.getElementById("newAppointmentService").value),location:document.getElementById("newAppointmentLocation").value,notes:document.getElementById("newAppointmentNotes").value};try{dataManager.addAppointment(t);showSuccessMessage("New appointment created successfully!"),i(),refreshPatientsData()}catch(e){showErrorMessage("Failed to create appointment. Please try again.")}}),setMinDateToToday("newAppointmentDate"),initializePatientNameValidation("newPatientName"),initializePhoneFormatting("newPatientPhone")}function showEditBasicInfoModal(){const e=getCurrentPatientData();document.getElementById("editPatientName").value=e.name,document.getElementById("editPatientPhone").value=e.phone,document.getElementById("editPatientEmail").value=e.email;const t=document.getElementById("editPatientService");t&&window.ServiceMapping&&(window.ServiceMapping.populateInternalServiceDropdown(t),e.service&&(t.value=e.service.toLowerCase().replace(/\s+/g,"-"))),openModal("editBasicInfoModal")}function showNewAppointmentModal(){const e=getCurrentPatientData(),t=document.getElementById("newPatientName"),n=document.getElementById("newPatientPhone"),a=document.getElementById("newPatientEmail");t.value=e.name,n.value=e.phone,a.value=e.email,t.readOnly=!0,n.readOnly=!0,a.readOnly=!0,t.style.backgroundColor="#f9fafb",n.style.backgroundColor="#f9fafb",a.style.backgroundColor="#f9fafb",setMinDateToToday("newAppointmentDate");document.getElementById("newAppointmentDate").value=getCurrentDate(),applyLocationPermissionsToPatientsModal(),openModal("newAppointmentModal")}function getCurrentPatientData(){return{name:document.getElementById("patientName").textContent,phone:document.getElementById("patientPhone").textContent,email:document.getElementById("patientEmail").textContent,location:document.getElementById("patientLocation").textContent,service:document.getElementById("patientService")?document.getElementById("patientService").textContent:""}}function updatePatientDetailsDisplay(e){document.getElementById("patientName").textContent=e.name,document.getElementById("patientPhone").textContent=e.phone,document.getElementById("patientEmail").textContent=e.email,document.getElementById("patientLocation")&&(document.getElementById("patientLocation").textContent=e.location||""),document.getElementById("patientService")&&(document.getElementById("patientService").textContent=e.service||""),document.getElementById("patientDetailsTitle").textContent=`Patient Profile: ${e.name}`}function initializeProcessModal(){const e=document.getElementById("processModal"),t=document.getElementById("processModalClose"),n=document.getElementById("arrivedBtn"),a=document.getElementById("noShowBtn"),i=document.getElementById("modifyDetailsBtn"),o=document.getElementById("holdBtn"),d=document.getElementById("completedBtn"),c=document.getElementById("cancelBtn"),l=document.getElementById("modifyForm"),r=document.getElementById("holdForm");function s(){closeModal("processModal"),l&&(l.style.display="none"),r&&(r.style.display="none"),m(),currentProcessingRow=null,currentPatientData=null}function m(){document.querySelectorAll(".btn-action").forEach(e=>{e.style.display="flex"})}t.addEventListener("click",s),e.addEventListener("click",function(t){t.target===e&&s()}),n.addEventListener("click",async function(){await handleProcessAction("arrived")}),a.addEventListener("click",async function(){await handleProcessAction("no-show")}),i.addEventListener("click",function(){l.style.display="block",document.querySelectorAll(".btn-action").forEach(e=>e.style.display="none"),setMinDateToToday("modifyDate");const e=document.getElementById("modifyDate");e&&(e.value=getCurrentDate())}),o.addEventListener("click",function(){r.style.display="block",document.querySelectorAll(".btn-action").forEach(e=>e.style.display="none")}),d.addEventListener("click",async function(){await handleProcessAction("completed")}),c.addEventListener("click",async function(){await handleProcessAction("cancelled")}),document.getElementById("cancelModify").addEventListener("click",function(){l.style.display="none",m()}),document.getElementById("cancelHold").addEventListener("click",function(){r.style.display="none",m()}),document.getElementById("saveHold").addEventListener("click",async function(){await handleProcessAction("held")}),document.getElementById("modifyAppointmentForm").addEventListener("submit",function(e){e.preventDefault(),showSuccessMessage("Appointment modified successfully!"),s(),refreshPatientsData()})}async function handleProcessAction(e){if(currentPatientData)try{if(currentPatientData.id&&currentPatientData.id.startsWith("pending_")){if("arrived"===e||"completed"===e){const t={patientName:currentPatientData.patientName,date:(new Date).toISOString().split("T")[0],time:"10:00",service:currentPatientData.service,location:currentPatientData.location,phone:currentPatientData.phone,email:currentPatientData.email},n=await dataManager.addAppointment(t);"scheduled"!==e&&await dataManager.updateAppointmentStatus(n.id,e)}await dataManager.removePendingConfirmation(currentPatientData.id)}else currentPatientData.id&&await dataManager.updateAppointmentStatus(currentPatientData.id,e);let t="";switch(e){case"arrived":t="Patient marked as arrived";break;case"completed":t="Appointment completed successfully";break;case"no-show":t="Appointment marked as no-show";break;case"cancelled":t="Appointment cancelled";break;case"held":t="Appointment put on hold"}showSuccessMessage(t),currentProcessingRow&&currentProcessingRow.remove(),closeModal("processModal"),currentProcessingRow=null,currentPatientData=null,refreshPatientsData()}catch(e){showErrorMessage("Failed to process appointment")}else showErrorMessage("No patient data found")}function setupFormValidation(){["newPatientName","editPatientName"].forEach(e=>{initializePatientNameValidation(e)});["newPatientPhone","editPatientPhone"].forEach(e=>{initializePhoneFormatting(e)})}function updateButtonSelection(e){document.querySelectorAll(".btn-action").forEach(e=>{e.classList.remove("selected")});let t=null;switch(e){case"arrived":t="arrivedBtn";break;case"completed":t="completedBtn";break;case"no-show":t="noShowBtn";break;case"cancelled":t="cancelBtn";break;case"held":t="holdBtn"}if(t){const e=document.getElementById(t);e&&e.classList.add("selected")}}document.addEventListener("DOMContentLoaded",function(){initializeTabs(),initializeModals(),initializeProcessModal(),initializePagination(),initializeTopNewAppointmentButton(),initializeHistoryIconNavigation(),setupFormValidation(),activateNotificationBell(),handleUrlHashNavigation(),waitForFirebaseService().then(async()=>{try{await refreshPatientsData(),await initializeRealtimeListeners()}catch(e){}}).catch(e=>{refreshPatientsData()})}),window.addEventListener("beforeunload",cleanupRealtimeListeners),document.addEventListener("visibilitychange",function(){document.hidden&&cleanupRealtimeListeners()});