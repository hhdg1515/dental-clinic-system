<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-item {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Firebase è¿æ¥è¯Šæ–­å·¥å…·</h1>

    <div id="results"></div>

    <div class="test-item info">
        <h3>æ‰‹åŠ¨æµ‹è¯•ç™»å½•</h3>
        <input type="email" id="testEmail" placeholder="æµ‹è¯•é‚®ç®±" value="test@firstavedental.com">
        <input type="password" id="testPassword" placeholder="æµ‹è¯•å¯†ç " value="test123">
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const results = document.getElementById('results');

        function addResult(title, message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-item ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${message}</pre>`;
            results.appendChild(div);
        }

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCCJbTwnqQo4CcUM-jDSaTC-hdpMcBTX4c",
            authDomain: "dental-clinic-demo-ce94b.firebaseapp.com",
            projectId: "dental-clinic-demo-ce94b",
            storageBucket: "dental-clinic-demo-ce94b.firebasestorage.app"
        };

        addResult('ğŸ“‹ Firebase é…ç½®', JSON.stringify(firebaseConfig, null, 2), 'info');

        // æµ‹è¯•1: åˆå§‹åŒ– Firebase
        try {
            const app = initializeApp(firebaseConfig);
            addResult('âœ… æµ‹è¯•1: Firebase åˆå§‹åŒ–', 'æˆåŠŸåˆå§‹åŒ– Firebase', 'success');

            const auth = getAuth(app);
            const db = getFirestore(app);

            addResult('âœ… æµ‹è¯•2: Firebase æœåŠ¡',
                `Auth: ${auth ? 'âœ…' : 'âŒ'}\nFirestore: ${db ? 'âœ…' : 'âŒ'}`,
                'success');

            // æš´éœ²åˆ°å…¨å±€ä¾›æµ‹è¯•ä½¿ç”¨
            window.firebaseApp = app;
            window.firebaseAuth = auth;
            window.firebaseDb = db;

            // æµ‹è¯•3: ç½‘ç»œè¿æ¥
            testNetworkConnection();

            // æµ‹è¯•4: Firebase Auth ç«¯ç‚¹
            testFirebaseEndpoints();

        } catch (error) {
            addResult('âŒ æµ‹è¯•1: Firebase åˆå§‹åŒ–å¤±è´¥',
                `é”™è¯¯: ${error.message}\n\nå †æ ˆ:\n${error.stack}`,
                'error');
        }

        // æµ‹è¯•ç½‘ç»œè¿æ¥
        async function testNetworkConnection() {
            const endpoints = [
                'https://identitytoolkit.googleapis.com',
                'https://firestore.googleapis.com',
                'https://www.gstatic.com',
                'https://dental-clinic-demo-ce94b.firebaseapp.com'
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, { method: 'HEAD', mode: 'no-cors' });
                    addResult(`âœ… æµ‹è¯•3: ç½‘ç»œè¿æ¥ - ${endpoint}`,
                        `è¿æ¥æˆåŠŸï¼ˆno-corsæ¨¡å¼ï¼‰`,
                        'success');
                } catch (error) {
                    addResult(`âŒ æµ‹è¯•3: ç½‘ç»œè¿æ¥ - ${endpoint}`,
                        `è¿æ¥å¤±è´¥: ${error.message}`,
                        'error');
                }
            }
        }

        // æµ‹è¯• Firebase Auth ç«¯ç‚¹
        async function testFirebaseEndpoints() {
            const apiKey = firebaseConfig.apiKey;

            // æµ‹è¯•è·å–é¡¹ç›®é…ç½®
            try {
                const response = await fetch(
                    `https://identitytoolkit.googleapis.com/v1/projects?key=${apiKey}`
                );

                if (response.ok) {
                    addResult('âœ… æµ‹è¯•4: Firebase Auth API',
                        `API ç«¯ç‚¹å¯è®¿é—®\nHTTP ${response.status} ${response.statusText}`,
                        'success');
                } else {
                    const text = await response.text();
                    addResult('âš ï¸ æµ‹è¯•4: Firebase Auth API',
                        `HTTP ${response.status} ${response.statusText}\n\nå“åº”:\n${text}`,
                        'error');
                }
            } catch (error) {
                addResult('âŒ æµ‹è¯•4: Firebase Auth API',
                    `æ— æ³•è®¿é—® Firebase Auth API\n\né”™è¯¯: ${error.message}\n\nè¿™å¯èƒ½æ˜¯:\n- é˜²ç«å¢™é˜»æ­¢\n- VPN/ä»£ç†é—®é¢˜\n- DNSè§£æé—®é¢˜\n- ç½‘ç»œè¿æ¥é—®é¢˜`,
                    'error');
            }
        }

        // æµ‹è¯•ç™»å½•åŠŸèƒ½
        window.testLogin = async function() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            addResult('ğŸ” å¼€å§‹æµ‹è¯•ç™»å½•', `é‚®ç®±: ${email}`, 'info');

            try {
                const userCredential = await signInWithEmailAndPassword(
                    window.firebaseAuth,
                    email,
                    password
                );

                addResult('âœ… ç™»å½•æˆåŠŸï¼',
                    `ç”¨æˆ·: ${userCredential.user.email}\nUID: ${userCredential.user.uid}`,
                    'success');
            } catch (error) {
                addResult('âŒ ç™»å½•å¤±è´¥',
                    `é”™è¯¯ä»£ç : ${error.code}\né”™è¯¯æ¶ˆæ¯: ${error.message}\n\nå®Œæ•´é”™è¯¯:\n${JSON.stringify(error, null, 2)}`,
                    'error');

                // è¯¦ç»†è¯Šæ–­
                if (error.code === 'auth/network-request-failed') {
                    addResult('ğŸ” network-request-failed è¯Šæ–­',
                        `è¿™ä¸ªé”™è¯¯é€šå¸¸ç”±ä»¥ä¸‹åŸå› å¼•èµ·:\n\n` +
                        `1. ç½‘ç»œè¿æ¥é—®é¢˜\n` +
                        `   - æ£€æŸ¥ä½ çš„äº’è”ç½‘è¿æ¥\n` +
                        `   - å°è¯•è®¿é—® https://firebase.google.com çœ‹æ˜¯å¦èƒ½æ‰“å¼€\n\n` +
                        `2. é˜²ç«å¢™/ä»£ç†é˜»æ­¢\n` +
                        `   - å…¬å¸/å­¦æ ¡ç½‘ç»œå¯èƒ½é˜»æ­¢äº† Firebase æœåŠ¡\n` +
                        `   - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†VPN\n` +
                        `   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®\n\n` +
                        `3. DNSè§£æé—®é¢˜\n` +
                        `   - å°è¯•åˆ‡æ¢DNS (å¦‚ 8.8.8.8)\n` +
                        `   - æ¸…é™¤DNSç¼“å­˜: ipconfig /flushdns\n\n` +
                        `4. æµè§ˆå™¨é—®é¢˜\n` +
                        `   - å°è¯•å…¶ä»–æµè§ˆå™¨\n` +
                        `   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n` +
                        `   - ç¦ç”¨æµè§ˆå™¨æ‰©å±•ï¼ˆç‰¹åˆ«æ˜¯å¹¿å‘Šæ‹¦æˆªå™¨ï¼‰\n\n` +
                        `5. CORSé—®é¢˜\n` +
                        `   - æ£€æŸ¥æµè§ˆå™¨Consoleæ˜¯å¦æœ‰CORSé”™è¯¯`,
                        'error');
                }
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåçš„é¢å¤–æµ‹è¯•
        window.addEventListener('load', () => {
            addResult('ğŸ“Š æµè§ˆå™¨ä¿¡æ¯',
                `User Agent: ${navigator.userAgent}\n` +
                `åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}\n` +
                `è¯­è¨€: ${navigator.language}`,
                'info');
        });
    </script>
</body>
</html>
