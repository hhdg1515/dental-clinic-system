class FirebaseDataService{constructor(){this.db=null,this.auth=null,this.storage=null,this.isInitialized=!1,this.clinicLocations=["arcadia","irvine","south-pasadena","rowland-heights","eastvale"],this.init()}async init(){try{await this.waitForFirebase(),this.db=window.firebase.db,this.auth=window.firebase.auth,this.storage=window.firebase.storage,this.isInitialized=!0,console.log("âœ… FirebaseDataService initialized with Storage")}catch(e){console.error("âŒ FirebaseDataService initialization failed:",e),this.isInitialized=!1}}waitForFirebase(){return new Promise((e,t)=>{let a=0;const i=()=>{window.firebase&&window.firebase.db&&window.firebase.auth&&window.firebase.storage?e():a>=100?t(new Error("Firebase services not available")):(a++,setTimeout(i,100))};i()})}async ensureReady(){this.isInitialized||await this.init();let e=0;for(;(!this.isInitialized||!window.firebase?.db)&&e<10;)console.log(`Waiting for Firebase initialization (attempt ${e+1}/10)...`),await new Promise(e=>setTimeout(e,300)),this.isInitialized||await this.init(),e++;if(!this.isInitialized||!window.firebase?.db)throw console.warn("Firebase services not available after multiple retry attempts, operations will fail gracefully"),new Error("Firebase services not available after multiple retry attempts")}validateDatabase(){const e=window.firebase?.db;if(!e)throw new Error("Firebase database not available - window.firebase.db is null or undefined");if("object"!=typeof e||!e.app)throw console.error("Invalid Firebase database object:",e),new Error("Firebase database object is invalid - missing app property");return e}getAccessibleClinics(e,t){return"boss"===e||"owner"===e?this.clinicLocations:t||[]}normalizeStatus(e){if(!e)return"scheduled";return{confirmed:"scheduled",scheduled:"scheduled",completed:"completed",cancelled:"cancelled",pending:"pending",declined:"declined",arrived:"arrived","no-show":"no-show"}[e.toLowerCase()]||"scheduled"}capitalizeClinicName(e){if(!e)return"";return{arcadia:"Arcadia",irvine:"Irvine","south-pasadena":"South Pasadena","rowland-heights":"Rowland Heights",eastvale:"Eastvale"}[e]||e}async getAppointmentsForDate(e,t=null,a=[],i=!1){try{let n;await this.ensureReady();try{n=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty appointments array for date:",e.message),[]}const{collection:o,getDocs:s,query:r,where:c,orderBy:l,Timestamp:d}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),p=this.getAccessibleClinics(t,a),m=o(n,"appointments");console.log(`ðŸ” Querying appointments for date: ${e}`);const w=r(m,c("appointmentDate","==",e)),u=await s(w),h=[];let g=0,f=0,b=0,y=0;const D=new Set(p.map(e=>e.toLowerCase()));return u.forEach(t=>{g++;const a=t.data();if(!D.has((a.clinicLocation||"").toLowerCase()))return void f++;if(!i&&("cancelled"===a.status||"declined"===a.status))return void b++;let n="",o=e;if(a.appointmentTime)n=a.appointmentTime;else if(a.appointmentDateTime){const e=a.appointmentDateTime.toDate();n=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}if(a.appointmentDate)o=a.appointmentDate;else if(a.appointmentDateTime){const e=a.appointmentDateTime.toDate();o=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}if(o===e){const e=this.normalizeStatus(a.status),i=a.service||a.serviceType||a.serviceName||"General Consultation";let s=a.location;!s&&a.clinicLocation&&(s=this.capitalizeClinicName(a.clinicLocation)),s||(s="Unknown");let r=a.clinicLocation;!r&&a.location&&(r=a.location.toLowerCase().replace(/\s+/g,"-")),h.push({id:t.id,...a,time:n,dateKey:o,date:o,location:s,clinicLocation:r,status:e,service:i})}}),console.log(`ðŸ“Š Query Summary for ${e}:`,{totalDocuments:g,filteredByClinic:f,filteredByStatus:b,filteredByDate:y,finalResults:h.length}),h}catch(e){return console.error("Error getting appointments for date:",e),[]}}async getAppointmentsForDateRange(e,t,a=null,i=[]){try{let n;await this.ensureReady();try{n=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty appointments for date range:",e.message),{}}console.log(`Calendar: Getting appointments for date range: ${e} to ${t}`);const{collection:o,getDocs:s,query:r,where:c}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),l=this.getAccessibleClinics(a,i),d=r(o(n,"appointments"),c("appointmentDate",">=",e),c("appointmentDate","<=",t)),p=await s(d),m={},w=new Set(l.map(e=>e.toLowerCase()));return p.forEach(a=>{const i=a.data();if(!w.has((i.clinicLocation||"").toLowerCase()))return;if("pending"===i.status||"cancelled"===i.status||"declined"===i.status)return;let n="",o="";if(i.appointmentTime)n=i.appointmentTime;else if(i.appointmentDateTime){const e=i.appointmentDateTime.toDate();n=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}if(i.appointmentDate)o=i.appointmentDate;else if(i.appointmentDateTime){const e=i.appointmentDateTime.toDate();o=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}if(o>=e&&o<=t){m[o]||(m[o]=[]);const e=this.normalizeStatus(i.status),t=i.service||i.serviceType||i.serviceName||"General Consultation";let s=i.location;!s&&i.clinicLocation&&(s=this.capitalizeClinicName(i.clinicLocation)),s||(s="Unknown");let r=i.clinicLocation;!r&&i.location&&(r=i.location.toLowerCase().replace(/\s+/g,"-")),m[o].push({id:a.id,...i,time:n,dateKey:o,date:o,location:s,clinicLocation:r,status:e,service:t})}}),console.log(`Calendar: Found appointments for ${Object.keys(m).length} days in range`),m}catch(e){return console.error("Error getting appointments for date range:",e),{}}}async getAllAppointments(e=null,t=[],a=!0){try{let i;await this.ensureReady();try{i=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty appointments array:",e.message),[]}const{collection:n,getDocs:o,query:s,where:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=this.getAccessibleClinics(e,t),l=new Date,d=new Date(l.getFullYear(),l.getMonth()-3,l.getDate()),p=new Date(l.getFullYear()+1,l.getMonth(),l.getDate()),m=d.toISOString().split("T")[0],w=p.toISOString().split("T")[0];console.log(`ðŸ“… getAllAppointments: Querying range ${m} to ${w} (includeAllStatuses: ${a})`);const u=s(n(i,"appointments"),r("appointmentDate",">=",m),r("appointmentDate","<=",w)),h=await o(u),g=[],f=new Set(c.map(e=>e.toLowerCase()));return h.forEach(e=>{const t=e.data();if(!f.has((t.clinicLocation||"").toLowerCase()))return;if(!a&&("cancelled"===t.status||"declined"===t.status))return;let i="",n="";if(t.appointmentTime)i=t.appointmentTime;else if(t.appointmentDateTime){const e=t.appointmentDateTime.toDate();i=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}if(t.appointmentDate)n=t.appointmentDate;else if(t.appointmentDateTime){const e=t.appointmentDateTime.toDate();n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}const o=this.normalizeStatus(t.status),s=t.service||t.serviceType||t.serviceName||"General Consultation";let r=t.location;!r&&t.clinicLocation&&(r=this.capitalizeClinicName(t.clinicLocation)),r||(r="Unknown");let c=t.clinicLocation;!c&&t.location&&(c=t.location.toLowerCase().replace(/\s+/g,"-")),g.push({id:e.id,...t,time:i,dateKey:n,location:r,clinicLocation:c,status:o,service:s})}),console.log(`ðŸ“Š getAllAppointments Summary: Retrieved ${g.length} total appointments`),g}catch(e){return console.error("Error getting all appointments:",e),[]}}async createAppointmentTimestamp(e,t){try{const{Timestamp:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),[i,n,o]=e.split("-").map(Number),[s,r]=t.split(":").map(Number),c=new Date(i,n-1,o,s,r,0,0);return a.fromDate(c)}catch(e){console.error("Error creating appointment timestamp:",e);const{Timestamp:t}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");return t.fromDate(new Date)}}async addAppointment(e,t=null,a=[]){try{await this.ensureReady();const{collection:i,addDoc:n,doc:o,setDoc:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=this.getClinicIdFromLocation(e.location),c=this.getAccessibleClinics(t,a);if(!c.includes(r))throw console.error(`Access denied: User clinics [${c.join(", ")}] does not include "${r}"`),new Error(`Access denied: You don't have permission to create appointments for ${r}`);const l=await this.createAppointmentTimestamp(e.date,e.time),d={patientName:e.patientName,service:e.service,appointmentTime:e.time,appointmentDate:e.date,appointmentDateTime:l,status:"scheduled",clinicLocation:r,phone:e.phone||"",email:e.email||`${e.patientName.toLowerCase().replace(/\s+/g,".")}@email.com`,notes:e.notes||"",dateKey:e.date,createdAt:(new Date).toISOString(),clinicId:r},p=i(this.validateDatabase(),"appointments");return{id:(await n(p,d)).id,...d}}catch(e){throw console.error("Error adding appointment:",e),e}}async updateAppointmentStatus(e,t,a={},i=null,n=[]){try{console.log("ðŸ”„ updateAppointmentStatus called with:",{appointmentId:e,newStatus:t,userRole:i,userClinics:n,additionalData:a}),await this.ensureReady();const{doc:o,updateDoc:s,deleteDoc:r,collection:c,addDoc:l}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");console.log("ðŸ”„ Firebase updateAppointmentStatus - Appointment ID:",e,"New status:",t);const d=await this.findAppointmentById(e,i,n);if(console.log("ðŸ”„ Found appointment:",d),d&&d.appointmentDateTime){const e=d.appointmentDateTime.toDate(),t=e.toISOString().split("T")[0];console.log("Appointment date:",e),console.log("Appointment dateKey:",t)}if(!d)throw console.error("Appointment not found with ID:",e),new Error("Appointment not found");const p=d.clinicLocation,m=(d.dateKey||(d.appointmentDateTime?d.appointmentDateTime.toDate().toISOString().split("T")[0]:(new Date).toISOString().split("T")[0]),this.getAccessibleClinics(i,n)),w=(p||"").toLowerCase().replace(/\s+/g,"-");if(!m.includes(w))throw console.error(`Access denied: User clinics [${m.join(", ")}] does not include "${w}"`),new Error(`Access denied to clinic: ${w}`);if("cancelled"===t){const t={...d,status:"cancelled",cancelledAt:(new Date).toISOString(),cancelReason:a.reason||"Unknown",cancelNotes:a.notes||""},i=this.validateDatabase(),n=c(i,"cancelledAppointments");await l(n,t),await r(o(i,"appointments",e))}else{const i={status:t,...a,lastUpdated:(new Date).toISOString()},n=this.validateDatabase();await s(o(n,"appointments",e),i)}return!0}catch(e){throw console.error("Error updating appointment status:",e),e}}async updateAppointment(e,t,a=null,i=[]){try{await this.ensureReady();const{doc:n,updateDoc:o,getDoc:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=await this.findAppointmentById(e,a,i);if(!r)throw new Error("Appointment not found");const c=this.getAccessibleClinics(a,i),l=(r.clinicLocation||"").toLowerCase().replace(/\s+/g,"-");if(!c.includes(l))throw console.error(`Update denied: User clinics [${c.join(", ")}] does not include "${l}"`),new Error(`No permission to update appointments for ${l}`);const d=this.validateDatabase(),p={...t,lastUpdated:(new Date).toISOString()};return t.name&&(p.patientName=t.name,delete p.name),await o(n(d,"appointments",e),p),!0}catch(e){throw console.error("Error updating appointment:",e),e}}async deleteAppointment(e,t=null,a=[]){try{await this.ensureReady();const{doc:i,deleteDoc:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=await this.findAppointmentById(e,t,a);if(!o)throw new Error("Appointment not found");const s=o.clinicLocation,r=this.getAccessibleClinics(t,a),c=(s||"").toLowerCase().replace(/\s+/g,"-");if(!r.includes(c))throw console.error(`Delete denied: User clinics [${r.join(", ")}] does not include "${c}"`),new Error(`Access denied to delete appointments for ${c}`);const l=this.validateDatabase();return await n(i(l,"appointments",e)),!0}catch(e){throw console.error("Error deleting appointment:",e),e}}async findAppointmentById(e,t=null,a=[]){try{console.log("ðŸ” findAppointmentById called with:",{appointmentId:e,userRole:t,userClinics:a}),await this.ensureReady();const{doc:i,getDoc:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=this.getAccessibleClinics(t,a);console.log("ðŸ” Accessible clinics:",o);const s=i(this.validateDatabase(),"appointments",e),r=await n(s);if(console.log("ðŸ” Appointment exists in DB:",r.exists()),r.exists()){const e=r.data();console.log("ðŸ” Appointment data:",{id:r.id,patientName:e.patientName,clinicLocation:e.clinicLocation,location:e.location,status:e.status});const t=(e.clinicLocation||"").toLowerCase().replace(/\s+/g,"-");if(console.log("ðŸ” Normalized clinic location:",t),o.includes(t))return console.log("âœ… Permission granted - returning appointment"),{id:r.id,...e};throw console.error(`âŒ Find denied: User clinics [${o.join(", ")}] does not include "${t}"`),new Error("No permission to access this appointment")}return console.warn("âš ï¸ Appointment not found in database with ID:",e),null}catch(e){return console.error("âŒ Error finding appointment by ID:",e),null}}async getPendingConfirmations(e=null,t=[]){try{await this.ensureReady();const{collection:a,getDocs:i,query:n,orderBy:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=this.validateDatabase(),r=n(a(s,"pendingConfirmations"),o("createdAt","desc")),c=await i(r),l=[];return c.forEach(a=>{const i=a.data(),n=this.getClinicIdFromLocation(i.location);this.getAccessibleClinics(e,t).includes(n)&&l.push({id:a.id,...i})}),l}catch(e){return console.error("Error getting pending confirmations:",e),[]}}async addPendingConfirmation(e){try{await this.ensureReady();const{collection:t,addDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i={...e,createdAt:(new Date).toISOString()},n=t(this.validateDatabase(),"pendingConfirmations");return{id:(await a(n,i)).id,...i}}catch(e){throw console.error("Error adding pending confirmation:",e),e}}async removePendingConfirmation(e){try{await this.ensureReady();const{doc:t,deleteDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=this.validateDatabase();return await a(t(i,"pendingConfirmations",e)),!0}catch(e){throw console.error("Error removing pending confirmation:",e),e}}async getCancelledAppointments(e=null,t=[]){try{let a;await this.ensureReady();try{a=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty cancelled appointments array:",e.message),[]}const{collection:i,getDocs:n,query:o,orderBy:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=[],c=this.getAccessibleClinics(e,t);for(const e of c){const t=o(i(a,"cancelledAppointments",e,"appointments"),s("cancelledAt","desc"));(await n(t)).forEach(e=>{r.push({id:e.id,...e.data()})})}return r}catch(e){return console.error("Error getting cancelled appointments:",e),[]}}async getPatientProfile(e){try{await this.ensureReady();const{doc:t,getDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=e.toLowerCase().replace(/\s+/g,"_"),n=t(this.validateDatabase(),"patientProfiles",i),o=await a(n);return o.exists()?o.data():null}catch(e){return console.error("Error getting patient profile:",e),null}}async setPatientProfile(e,t){try{await this.ensureReady();const{doc:a,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=e.toLowerCase().replace(/\s+/g,"_"),o=a(this.validateDatabase(),"patientProfiles",n),s={patientName:e,detailedInfo:t,lastUpdated:(new Date).toISOString()};return await i(o,s,{merge:!0}),s}catch(e){throw console.error("Error setting patient profile:",e),e}}getClinicIdFromLocation(e){return e?e.toLowerCase().replace(/\s+/g,"-"):"arcadia"}getLocationFromClinicId(e){return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}generateAppointmentId(){return"app_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}async subscribeToNewAppointments(e,t,a){try{await this.ensureReady();const{collection:i,query:n,where:o,orderBy:s,onSnapshot:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=this.getAccessibleClinics(e,t),l=this.validateDatabase(),d=n(i(l,"appointments"),o("clinicLocation","in",c),o("status","==","pending"),s("appointmentDateTime","asc"));return r(d,e=>{const t=[];e.forEach(e=>{const a=e.data(),i=a.appointmentDateTime?a.appointmentDateTime.toDate():new Date;t.push({id:e.id,...a,time:i.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),dateKey:i.toISOString().split("T")[0],location:a.clinicLocation,appointmentDateTime:i})}),a(t)},e=>{console.error("Error listening to new appointments:",e),a([])})}catch(e){return console.error("Error setting up new appointments listener:",e),()=>{}}}async getPendingAppointmentsCount(e,t){try{await this.ensureReady();const{collection:a,query:i,where:n,getCountFromServer:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=this.getAccessibleClinics(e,t),r=this.validateDatabase(),c=i(a(r,"appointments"),n("clinicLocation","in",s),n("status","==","pending"));return(await o(c)).data().count}catch(e){return console.error("Error getting pending appointments count:",e),0}}async uploadMedicalRecord(e,t,a=null){try{await this.ensureReady();const{collection:i,addDoc:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");console.log("ðŸ” Upload Debug - Auth current user:",this.auth.currentUser),console.log("ðŸ” Upload Debug - Auth state:",this.auth.currentUser?"Authenticated":"Not authenticated");let o=0;const s=setInterval(()=>{o+=20,a&&a(Math.min(o,90))},100),r=await this.fileToBase64(t);clearInterval(s),a&&a(95);const c=i(this.validateDatabase(),"medicalRecords"),l={userId:e,filename:t.name,originalName:t.name,size:t.size,type:t.type,base64Data:r,uploadedAt:new Date},d=await n(c,l);return a&&a(100),{id:d.id,...l}}catch(e){throw console.error("Error uploading medical record:",e),e}}fileToBase64(e){return new Promise((t,a)=>{const i=new FileReader;i.readAsDataURL(e),i.onload=()=>t(i.result),i.onerror=e=>a(e)})}async getMedicalRecords(e){try{await this.ensureReady();const{collection:t,query:a,where:i,getDocs:n,orderBy:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=this.validateDatabase(),r=a(t(s,"medicalRecords"),i("userId","==",e),o("uploadedAt","desc")),c=await n(r),l=[];return c.forEach(e=>{l.push({id:e.id,...e.data()})}),l}catch(e){throw console.error("Error getting medical records:",e),e}}async deleteMedicalRecord(e){try{await this.ensureReady();const{doc:t,deleteDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=this.validateDatabase();return await a(t(i,"medicalRecords",e)),console.log("Medical record deleted successfully"),!0}catch(e){throw console.error("Error deleting medical record:",e),e}}async renameMedicalRecord(e,t){try{await this.ensureReady();const{doc:a,updateDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=a(this.validateDatabase(),"medicalRecords",e);return await i(n,{originalName:t,updatedAt:new Date}),console.log("Medical record renamed successfully"),!0}catch(e){throw console.error("Error renaming medical record:",e),e}}async downloadMedicalRecord(e,t){try{const a=atob(e.split(",")[1]),i=new Array(a.length);for(let e=0;e<a.length;e++)i[e]=a.charCodeAt(e);const n=new Uint8Array(i),o=e.substring(e.indexOf(":")+1,e.indexOf(";")),s=new Blob([n],{type:o}),r=window.URL.createObjectURL(s),c=document.createElement("a");return c.style.display="none",c.href=r,c.download=t,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(r),document.body.removeChild(c),!0}catch(e){throw console.error("Error downloading medical record:",e),e}}async getDentalChart(e){await this.ensureReady();const{doc:t,getDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=t(this.validateDatabase(),"dentalCharts",e),n=await a(i);return n.exists()?{id:n.id,...n.data()}:null}async updateToothStatus(e,t,a){await this.ensureReady();const{doc:i,updateDoc:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=i(this.validateDatabase(),"dentalCharts",e);return await n(o,{[`teeth.${t}.status`]:a.status,[`teeth.${t}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()}),!0}async addToothTreatment(e,t,a){await this.ensureReady();const{doc:i,getDoc:n,updateDoc:o,arrayUnion:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=i(this.validateDatabase(),"dentalCharts",e),c=await n(r);if(!c.exists())throw new Error("Dental chart not found");const l={id:`treatment-${Date.now()}`,date:(new Date).toISOString(),createdBy:this.auth.currentUser?.uid||"unknown",...a},d=c.data();return d.teeth||(d.teeth={}),d.teeth[t]||(d.teeth[t]={status:"healthy",treatments:[]}),d.teeth[t].treatments||(d.teeth[t].treatments=[]),d.teeth[t].treatments.push(l),await o(r,{[`teeth.${t}.treatments`]:d.teeth[t].treatments,[`teeth.${t}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()}),l}async uploadToothAttachment(e,t,a){await this.ensureReady();if(a.size<51200){const e=await this.fileToBase64(a);return{type:"base64",filename:a.name,mimeType:a.type,fileSize:a.size,base64Data:e}}{const{ref:i,uploadBytes:n,getDownloadURL:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js"),s=this.storage,r=`dentalCharts/${e}/tooth_${t}/${Date.now()}_${a.name}`,c=i(s,r),l=await n(c,a),d=await o(l.ref);return{type:"storage",filename:a.name,mimeType:a.type,fileSize:a.size,storagePath:r,downloadURL:d}}}async deleteToothTreatment(e,t,a){await this.ensureReady();const{doc:i,getDoc:n,updateDoc:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=i(this.validateDatabase(),"dentalCharts",e),r=await n(s);if(r.exists()){const e=r.data(),i=e.teeth?.[t];if(i?.treatments){const e=i.treatments.filter(e=>e.id!==a);await o(s,{[`teeth.${t}.treatments`]:e,[`teeth.${t}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()})}}return!0}async initializeDentalChart(e,t){await this.ensureReady();const{doc:a,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=a(this.validateDatabase(),"dentalCharts",e),o={};for(let e=1;e<=32;e++)o[e.toString()]={status:"healthy",treatments:[],lastUpdated:(new Date).toISOString()};return await i(n,{userId:e,patientName:t,lastUpdated:(new Date).toISOString(),teeth:o}),!0}}let firebaseDataService=null;if("undefined"!=typeof window){const e=()=>{window.firebase&&window.firebase.db?(firebaseDataService=new FirebaseDataService,window.firebaseDataService=firebaseDataService,console.log("âœ… FirebaseDataService instance created")):setTimeout(e,100)};e()}"undefined"!=typeof module&&module.exports?module.exports=FirebaseDataService:"undefined"!=typeof window&&(window.FirebaseDataService=FirebaseDataService);