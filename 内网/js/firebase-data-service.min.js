if(void 0===patientName)var patientName=null;function recordDebugLog(e,t){try{if("undefined"==typeof window)return;window.__intranetDebugLog||(window.__intranetDebugLog=[]),window.__intranetDebugLog.push({ts:(new Date).toISOString(),label:e,payload:t})}catch(e){}}"undefined"==typeof window||window.__intranetDebugLog||(window.__intranetDebugLog=[]);class FirebaseDataService{constructor(){this.db=null,this.auth=null,this.storage=null,this.isInitialized=!1,this.clinicLocations=["arcadia","irvine","south-pasadena","rowland-heights","eastvale"],this.init()}async init(){try{await this.waitForFirebase(),this.db=window.firebase.db,this.auth=window.firebase.auth,this.storage=window.firebase.storage,this.isInitialized=!0,console.log("âœ… FirebaseDataService initialized with Storage")}catch(e){console.error("âŒ FirebaseDataService initialization failed:",e),this.isInitialized=!1}}waitForFirebase(){return new Promise((e,t)=>{let a=0;const i=()=>{window.firebase&&window.firebase.db&&window.firebase.auth&&window.firebase.storage?e():a>=100?t(new Error("Firebase services not available")):(a++,setTimeout(i,100))};i()})}async ensureReady(){this.isInitialized||await this.init();let e=0;for(;(!this.isInitialized||!window.firebase?.db)&&e<10;)console.log(`Waiting for Firebase initialization (attempt ${e+1}/10)...`),await new Promise(e=>setTimeout(e,300)),this.isInitialized||await this.init(),e++;if(!this.isInitialized||!window.firebase?.db)throw console.warn("Firebase services not available after multiple retry attempts, operations will fail gracefully"),new Error("Firebase services not available after multiple retry attempts")}validateDatabase(){const e=window.firebase?.db;if(!e)throw new Error("Firebase database not available - window.firebase.db is null or undefined");if("object"!=typeof e||!e.app)throw console.error("Invalid Firebase database object:",e),new Error("Firebase database object is invalid - missing app property");return e}getAccessibleClinics(e,t){const a=("boss"===e||"owner"===e?this.clinicLocations:t||[]).map(e=>this.normalizeClinicId(e)).filter(Boolean);return Array.from(new Set(a))}normalizeStatus(e){if(!e)return"scheduled";return{confirmed:"scheduled",scheduled:"scheduled",completed:"completed",cancelled:"cancelled",pending:"pending",declined:"declined",arrived:"arrived","no-show":"no-show"}[e.toLowerCase()]||"scheduled"}normalizeClinicId(e){if(!e)return null;"string"!=typeof e&&(e=String(e));const t=e.trim().toLowerCase();return t?t.includes("arcadia")?"arcadia":t.includes("rowland")?"rowland-heights":t.includes("pasadena")?"south-pasadena":t.includes("irvine")?"irvine":t.includes("eastvale")?"eastvale":t.replace(/[^a-z0-9\s-]/g,"").replace(/[\s_]+/g,"-"):null}resolveClinicInfo(e){const t=e?.clinicLocation??e?.clinicId??e?.location??e?.clinic??e?.clinicName??"",a=this.normalizeClinicId(t);return{key:a,label:a?this.getLocationFromClinicId(a):t||""}}async getAppointmentsForDate(e,t=null,a=[],i=!1){try{let n;await this.ensureReady();try{n=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty appointments array for date:",e.message),[]}const{collection:o,getDocs:r,query:s,where:c,orderBy:l,Timestamp:d}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),p=this.getAccessibleClinics(t,a),m=o(n,"appointments");console.log(`ðŸ” Querying appointments for date: ${e}`);const w=s(m,c("appointmentDate","==",e)),u=await r(w),h=[];let g=0,f=0,b=0,y=0;const D=new Set(p);return u.forEach(t=>{g++;const a=t.data(),n=this.resolveClinicInfo(a);if(!n.key)return void f++;if(!D.has(n.key))return void f++;if(!i&&("cancelled"===a.status||"declined"===a.status))return void b++;let o="",r=e;if(a.appointmentTime)o=a.appointmentTime;else if(a.appointmentDateTime){const e=a.appointmentDateTime.toDate();o=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}if(a.appointmentDate)r=a.appointmentDate;else if(a.appointmentDateTime){const e=a.appointmentDateTime.toDate();r=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}if(r===e){const e=this.normalizeStatus(a.status),i=a.service||a.serviceType||a.serviceName||"General Consultation",s=a.id||a.appointmentId||null;h.push({...a,legacyId:s,id:t.id,clinicLocation:n.key,clinicId:n.key,location:n.label||a.location||a.clinicLocation||"",time:o,dateKey:r,date:r,status:e,service:i})}}),console.log(`ðŸ“Š Query Summary for ${e}:`,{totalDocuments:g,filteredByClinic:f,filteredByStatus:b,filteredByDate:y,finalResults:h.length}),h}catch(e){return console.error("Error getting appointments for date:",e),[]}}async getAppointmentsForDateRange(e,t,a=null,i=[]){try{let n;await this.ensureReady();try{n=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty appointments for date range:",e.message),{}}console.log(`Calendar: Getting appointments for date range: ${e} to ${t}`);const{collection:o,getDocs:r,query:s,where:c}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),l=this.getAccessibleClinics(a,i),d=s(o(n,"appointments"),c("appointmentDate",">=",e),c("appointmentDate","<=",t)),p=await r(d),m={},w=new Set(l);return p.forEach(a=>{const i=a.data(),n=this.resolveClinicInfo(i);if(!n.key||!w.has(n.key))return;if("pending"===i.status||"cancelled"===i.status||"declined"===i.status)return;let o="",r="";if(i.appointmentTime)o=i.appointmentTime;else if(i.appointmentDateTime){const e=i.appointmentDateTime.toDate();o=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}if(i.appointmentDate)r=i.appointmentDate;else if(i.appointmentDateTime){const e=i.appointmentDateTime.toDate();r=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}if(r>=e&&r<=t){m[r]||(m[r]=[]);const e=this.normalizeStatus(i.status),t=i.service||i.serviceType||i.serviceName||"General Consultation",s=i.id||i.appointmentId||null;m[r].push({...i,legacyId:s,id:a.id,clinicLocation:n.key,clinicId:n.key,time:o,dateKey:r,date:r,location:n.label||i.location||i.clinicLocation||"",status:e,service:t})}}),console.log(`Calendar: Found appointments for ${Object.keys(m).length} days in range`),m}catch(e){return console.error("Error getting appointments for date range:",e),{}}}async getAllAppointments(e=null,t=[],a=!0){try{let i;await this.ensureReady();try{i=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty appointments array:",e.message),[]}const{collection:n,getDocs:o,query:r,where:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=this.getAccessibleClinics(e,t),l=new Date,d=new Date(l.getFullYear(),l.getMonth()-3,l.getDate()),p=new Date(l.getFullYear()+1,l.getMonth(),l.getDate()),m=d.toISOString().split("T")[0],w=p.toISOString().split("T")[0];console.log(`ðŸ“… getAllAppointments: Querying range ${m} to ${w} (includeAllStatuses: ${a})`);const u=r(n(i,"appointments"),s("appointmentDate",">=",m),s("appointmentDate","<=",w)),h=await o(u),g=[],f=new Set(c);return h.forEach(e=>{const t=e.data(),i=this.resolveClinicInfo(t);if(!i.key||!f.has(i.key))return;if(!a&&("cancelled"===t.status||"declined"===t.status))return;let n="",o="";if(t.appointmentTime)n=t.appointmentTime;else if(t.appointmentDateTime){const e=t.appointmentDateTime.toDate();n=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}if(t.appointmentDate)o=t.appointmentDate;else if(t.appointmentDateTime){const e=t.appointmentDateTime.toDate();o=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}const r=this.normalizeStatus(t.status),s=t.service||t.serviceType||t.serviceName||"General Consultation",c=t.id||t.appointmentId||null;g.push({...t,legacyId:c,id:e.id,clinicLocation:i.key,clinicId:i.key,time:n,dateKey:o,location:i.label||t.location||t.clinicLocation||"",status:r,service:s})}),console.log(`ðŸ“Š getAllAppointments Summary: Retrieved ${g.length} total appointments`),g}catch(e){return console.error("Error getting all appointments:",e),[]}}async createAppointmentTimestamp(e,t){try{const{Timestamp:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),[i,n,o]=e.split("-").map(Number),[r,s]=t.split(":").map(Number),c=new Date(i,n-1,o,r,s,0,0);return a.fromDate(c)}catch(e){console.error("Error creating appointment timestamp:",e);const{Timestamp:t}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");return t.fromDate(new Date)}}async addAppointment(e,t=null,a=[]){try{console.log("ðŸ”µ [addAppointment] START - Received data:",e),console.log("ðŸ”µ [addAppointment] User role:",t,"User clinics:",a),await this.ensureReady();const{collection:i,addDoc:n,doc:o,setDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=this.getClinicIdFromLocation(e.location);console.log("ðŸ”µ [addAppointment] Normalized clinic ID:",s);const c=this.getAccessibleClinics(t,a);if(console.log("ðŸ”µ [addAppointment] Accessible clinics:",c),!c.includes(s))throw console.error(`âŒ Access denied: User clinics [${c.join(", ")}] does not include "${s}"`),new Error(`Access denied: You don't have permission to create appointments for ${s}`);console.log("âœ… [addAppointment] Permission check passed");const l=await this.createAppointmentTimestamp(e.date,e.time);console.log("ðŸ”µ [addAppointment] Created timestamp:",l);const d={patientName:e.patientName,service:e.service,appointmentTime:e.time,appointmentDate:e.date,appointmentDateTime:l,status:"scheduled",clinicLocation:s,phone:e.phone||"",email:e.email||`${e.patientName.toLowerCase().replace(/\s+/g,".")}@email.com`,notes:e.notes||"",dateKey:e.date,createdAt:(new Date).toISOString(),clinicId:s};console.log("ðŸ”µ [addAppointment] Prepared appointment object:",d);const p=i(this.validateDatabase(),"appointments");console.log("ðŸ”µ [addAppointment] About to call addDoc to Firebase...");const m=await n(p,d);return console.log("âœ… [addAppointment] SUCCESS - Document created with ID:",m.id),console.log("âœ… [addAppointment] Full document path:",m.path),{id:m.id,...d}}catch(e){throw console.error("âŒ [addAppointment] ERROR:",e),console.error("âŒ [addAppointment] Error details:",{message:e.message,code:e.code,stack:e.stack}),e}}async updateAppointmentStatus(e,t,a={},i=null,n=[],o=null){try{await this.ensureReady();const{doc:r,updateDoc:s,deleteDoc:c,collection:l,addDoc:d}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");recordDebugLog("firebase.updateAppointmentStatus.start",{appointmentId:e,newStatus:t,additionalData:a,userRole:i,userClinics:n,appointmentContext:o});const p=await this.findAppointmentById(e,i,n,o);if(recordDebugLog("firebase.updateAppointmentStatus.found",p),p&&p.appointmentDateTime){const e=p.appointmentDateTime.toDate(),t=e.toISOString().split("T")[0];console.log("Appointment date:",e),console.log("Appointment dateKey:",t)}if(!p)throw console.error("Appointment not found with ID:",e),new Error("Appointment not found");const m=p.clinicLocation||p.location,w=(p.dateKey||(p.appointmentDateTime?p.appointmentDateTime.toDate().toISOString().split("T")[0]:(new Date).toISOString().split("T")[0]),this.getAccessibleClinics(i,n)),u=this.normalizeClinicId(m);if(!u||!w.includes(u))throw console.error(`Access denied: User clinics [${w.join(", ")}] does not include "${u}"`),new Error(`Access denied to clinic: ${u}`);if("cancelled"===t){const t={...p,status:"cancelled",cancelledAt:(new Date).toISOString(),cancelReason:a.reason||"Unknown",cancelNotes:a.notes||""},i=this.validateDatabase(),n=l(i,"cancelledAppointments");await d(n,t),await c(r(i,"appointments",e))}else{const i={status:t,...a,lastUpdated:(new Date).toISOString()},n=this.validateDatabase();await s(r(n,"appointments",e),i)}return!0}catch(e){throw console.error("Error updating appointment status:",e),e}}async updateAppointment(e,t,a=null,i=[]){try{await this.ensureReady();const{doc:n,updateDoc:o,getDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=await this.findAppointmentById(e,a,i);if(!s)throw new Error("Appointment not found");const c=this.getAccessibleClinics(a,i),l=this.normalizeClinicId(s.clinicLocation||s.location);if(!l||!c.includes(l))throw console.error(`Update denied: User clinics [${c.join(", ")}] does not include "${l}"`),new Error(`No permission to update appointments for ${l}`);const d=this.validateDatabase(),p={...t,lastUpdated:(new Date).toISOString()};return t.name&&(p.patientName=t.name,delete p.name),await o(n(d,"appointments",e),p),!0}catch(e){throw console.error("Error updating appointment:",e),e}}async deleteAppointment(e,t=null,a=[]){try{await this.ensureReady();const{doc:i,deleteDoc:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),o=await this.findAppointmentById(e,t,a);if(!o)throw new Error("Appointment not found");const r=o.clinicLocation||o.location,s=this.getAccessibleClinics(t,a),c=this.normalizeClinicId(r);if(!c||!s.includes(c))throw console.error(`Delete denied: User clinics [${s.join(", ")}] does not include "${c}"`),new Error(`Access denied to delete appointments for ${c}`);const l=this.validateDatabase();return await n(i(l,"appointments",e)),!0}catch(e){throw console.error("Error deleting appointment:",e),e}}async findAppointmentById(e,t=null,a=[],i=null){try{await this.ensureReady();const{doc:n,getDoc:o,collection:r,getDocs:s,query:c,where:l,limit:d}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),p=this.getAccessibleClinics(t,a),m=this.validateDatabase(),w=async(e,t="primary")=>{if(!e)return null;recordDebugLog("firebase.findAppointmentById.tryId",{label:t,docId:e});const a=n(m,"appointments",e),i=await o(a);if(!i.exists())return null;const r=i.data(),s=this.normalizeClinicId(r.clinicLocation||r.location);if(!s||!p.includes(s))throw console.error(`Find denied: User clinics [${p.join(", ")}] does not include "${s}"`),new Error("No permission to access this appointment");return{id:i.id,...r}};let u=await w(e,"primary");if(u)return u;const h=i?.legacyId||i?.appointmentId||null;if(!u&&h&&h!==e)try{if(u=await w(h,"legacy"),u)return u}catch(e){console.warn("Legacy ID lookup failed:",e)}return recordDebugLog("firebase.findAppointmentById.failed",{appointmentId:e,appointmentContext:i}),null}catch(e){return console.error("Error finding appointment by ID:",e),null}}async getPendingConfirmations(e=null,t=[]){try{await this.ensureReady();const{collection:a,getDocs:i,query:n,orderBy:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=this.validateDatabase(),s=n(a(r,"pendingConfirmations"),o("createdAt","desc")),c=await i(s),l=[];return c.forEach(a=>{const i=a.data(),n=this.getClinicIdFromLocation(i.location);this.getAccessibleClinics(e,t).includes(n)&&l.push({...i,legacyId:i.id||i.appointmentId||null,id:a.id})}),l}catch(e){return console.error("Error getting pending confirmations:",e),[]}}async addPendingConfirmation(e){try{await this.ensureReady();const{collection:t,addDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i={...e,createdAt:(new Date).toISOString()},n=t(this.validateDatabase(),"pendingConfirmations");return{id:(await a(n,i)).id,...i}}catch(e){throw console.error("Error adding pending confirmation:",e),e}}async removePendingConfirmation(e){try{await this.ensureReady();const{doc:t,deleteDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=this.validateDatabase();return await a(t(i,"pendingConfirmations",e)),!0}catch(e){throw console.error("Error removing pending confirmation:",e),e}}async getCancelledAppointments(e=null,t=[]){try{let a;await this.ensureReady();try{a=this.validateDatabase()}catch(e){return console.warn("Firebase database not ready, returning empty cancelled appointments array:",e.message),[]}const{collection:i,getDocs:n,query:o,orderBy:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=[],c=this.getAccessibleClinics(e,t);for(const e of c){const t=o(i(a,"cancelledAppointments",e,"appointments"),r("cancelledAt","desc"));(await n(t)).forEach(e=>{const t=e.data();s.push({...t,legacyId:t.id||t.appointmentId||null,id:e.id})})}return s}catch(e){return console.error("Error getting cancelled appointments:",e),[]}}async getPatientProfile(e){try{await this.ensureReady();const{doc:t,getDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=e.toLowerCase().replace(/\s+/g,"_"),n=t(this.validateDatabase(),"patientProfiles",i),o=await a(n);return o.exists()?o.data():null}catch(e){return console.error("Error getting patient profile:",e),null}}async setPatientProfile(e,t){try{await this.ensureReady();const{doc:a,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=e.toLowerCase().replace(/\s+/g,"_"),o=a(this.validateDatabase(),"patientProfiles",n),r={patientName:e,detailedInfo:t,lastUpdated:(new Date).toISOString()};return await i(o,r,{merge:!0}),r}catch(e){throw console.error("Error setting patient profile:",e),e}}getClinicIdFromLocation(e){return this.normalizeClinicId(e)||"arcadia"}getLocationFromClinicId(e){return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}generateAppointmentId(){return"app_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}async subscribeToNewAppointments(e,t,a){try{await this.ensureReady();const{collection:i,query:n,where:o,orderBy:r,onSnapshot:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=this.getAccessibleClinics(e,t),l=this.validateDatabase(),d=n(i(l,"appointments"),o("clinicLocation","in",c),o("status","==","pending"),r("appointmentDateTime","asc"));return s(d,e=>{const t=[];e.forEach(e=>{const a=e.data(),i=a.appointmentDateTime?a.appointmentDateTime.toDate():new Date,n=this.resolveClinicInfo(a);t.push({...a,legacyId:a.id||a.appointmentId||null,id:e.id,clinicLocation:n.key,clinicId:n.key,time:i.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),dateKey:i.toISOString().split("T")[0],location:n.label||a.location||a.clinicLocation||"",appointmentDateTime:i})}),a(t)},e=>{console.error("Error listening to new appointments:",e),a([])})}catch(e){return console.error("Error setting up new appointments listener:",e),()=>{}}}async getPendingAppointmentsCount(e,t){try{await this.ensureReady();const{collection:a,query:i,where:n,getCountFromServer:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=this.getAccessibleClinics(e,t),s=this.validateDatabase(),c=i(a(s,"appointments"),n("clinicLocation","in",r),n("status","==","pending"));return(await o(c)).data().count}catch(e){return console.error("Error getting pending appointments count:",e),0}}async uploadMedicalRecord(e,t,a=null){try{await this.ensureReady();const{collection:i,addDoc:n}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");console.log("ðŸ” Upload Debug - Auth current user:",this.auth.currentUser),console.log("ðŸ” Upload Debug - Auth state:",this.auth.currentUser?"Authenticated":"Not authenticated");let o=0;const r=setInterval(()=>{o+=20,a&&a(Math.min(o,90))},100),s=await this.fileToBase64(t);clearInterval(r),a&&a(95);const c=i(this.validateDatabase(),"medicalRecords"),l={userId:e,filename:t.name,originalName:t.name,size:t.size,type:t.type,base64Data:s,uploadedAt:new Date},d=await n(c,l);return a&&a(100),{id:d.id,...l}}catch(e){throw console.error("Error uploading medical record:",e),e}}fileToBase64(e){return new Promise((t,a)=>{const i=new FileReader;i.readAsDataURL(e),i.onload=()=>t(i.result),i.onerror=e=>a(e)})}async getMedicalRecords(e){try{await this.ensureReady();const{collection:t,query:a,where:i,getDocs:n,orderBy:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),r=this.validateDatabase(),s=a(t(r,"medicalRecords"),i("userId","==",e),o("uploadedAt","desc")),c=await n(s),l=[];return c.forEach(e=>{const t=e.data();l.push({...t,legacyId:t.id||null,id:e.id})}),l}catch(e){throw console.error("Error getting medical records:",e),e}}async deleteMedicalRecord(e){try{await this.ensureReady();const{doc:t,deleteDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=this.validateDatabase();return await a(t(i,"medicalRecords",e)),console.log("Medical record deleted successfully"),!0}catch(e){throw console.error("Error deleting medical record:",e),e}}async renameMedicalRecord(e,t){try{await this.ensureReady();const{doc:a,updateDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=a(this.validateDatabase(),"medicalRecords",e);return await i(n,{originalName:t,updatedAt:new Date}),console.log("Medical record renamed successfully"),!0}catch(e){throw console.error("Error renaming medical record:",e),e}}async downloadMedicalRecord(e,t){try{const a=atob(e.split(",")[1]),i=new Array(a.length);for(let e=0;e<a.length;e++)i[e]=a.charCodeAt(e);const n=new Uint8Array(i),o=e.substring(e.indexOf(":")+1,e.indexOf(";")),r=new Blob([n],{type:o}),s=window.URL.createObjectURL(r),c=document.createElement("a");return c.style.display="none",c.href=s,c.download=t,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(s),document.body.removeChild(c),!0}catch(e){throw console.error("Error downloading medical record:",e),e}}async getDentalChart(e){await this.ensureReady();const{doc:t,getDoc:a}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),i=t(this.validateDatabase(),"dentalCharts",e),n=await a(i);return n.exists()?{id:n.id,...n.data()}:null}validateToothNumber(e){const t=parseInt(e);if(isNaN(t)||t<1||t>32)throw new Error(`Invalid tooth number: ${e}. Must be 1-32.`);return t}validateToothStatus(e){const t=["healthy","monitor","cavity","filled","missing","implant","root-canal","post-op","urgent"];if(!t.includes(e))throw new Error(`Invalid tooth status: ${e}. Must be one of: ${t.join(", ")}`);return e}validateFileUpload(e){if(!e)throw new Error("No file provided");if(e.size>5242880)throw new Error(`File too large: ${(e.size/1024/1024).toFixed(2)}MB. Maximum 5MB allowed.`);if(!["image/jpeg","image/png","image/jpg","application/pdf"].includes(e.type))throw new Error(`Invalid file type: ${e.type}. Only JPEG, PNG, and PDF allowed.`);return!0}async updateToothStatus(e,t,a){await this.ensureReady();const i=this.validateToothNumber(t),n=this.validateToothStatus(a.status),{doc:o,updateDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=o(this.validateDatabase(),"dentalCharts",e);return await r(s,{[`teeth.${i}.status`]:n,[`teeth.${i}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()}),!0}async addToothTreatment(e,t,a){await this.ensureReady();const i=this.validateToothNumber(t),{doc:n,getDoc:o,updateDoc:r,arrayUnion:s}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),c=n(this.validateDatabase(),"dentalCharts",e),l=await o(c);if(!l.exists())throw new Error("Dental chart not found");const d={id:`treatment-${Date.now()}`,date:(new Date).toISOString(),createdBy:this.auth.currentUser?.uid||"unknown",...a},p=l.data();return p.teeth||(p.teeth={}),p.teeth[i]||(p.teeth[i]={status:"healthy",treatments:[]}),p.teeth[i].treatments||(p.teeth[i].treatments=[]),p.teeth[i].treatments.push(d),await r(c,{[`teeth.${i}.treatments`]:p.teeth[i].treatments,[`teeth.${i}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()}),d}async uploadToothAttachment(e,t,a){await this.ensureReady();const i=this.validateToothNumber(t);this.validateFileUpload(a);if(a.size<51200){const e=await this.fileToBase64(a);return{type:"base64",filename:a.name,mimeType:a.type,fileSize:a.size,base64Data:e}}{const{ref:t,uploadBytes:n,getDownloadURL:o}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js"),r=this.storage,s=`dentalCharts/${e}/tooth_${i}/${Date.now()}_${a.name}`,c=t(r,s),l=await n(c,a),d=await o(l.ref);return{type:"storage",filename:a.name,mimeType:a.type,fileSize:a.size,storagePath:s,downloadURL:d}}}async deleteToothTreatment(e,t,a){await this.ensureReady();const i=this.validateToothNumber(t),{doc:n,getDoc:o,updateDoc:r}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),s=n(this.validateDatabase(),"dentalCharts",e),c=await o(s);if(c.exists()){const e=c.data(),t=e.teeth?.[i];if(t?.treatments){const e=t.treatments.filter(e=>e.id!==a);await r(s,{[`teeth.${i}.treatments`]:e,[`teeth.${i}.lastUpdated`]:(new Date).toISOString(),lastUpdated:(new Date).toISOString()})}}return!0}async initializeDentalChart(e,t){await this.ensureReady();const{doc:a,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"),n=a(this.validateDatabase(),"dentalCharts",e),o={};for(let e=1;e<=32;e++)o[e.toString()]={status:"healthy",treatments:[],lastUpdated:(new Date).toISOString()};return await i(n,{userId:e,patientName:t,lastUpdated:(new Date).toISOString(),teeth:o}),!0}}let firebaseDataService=null;if("undefined"!=typeof window){const e=()=>{window.firebase&&window.firebase.db?(firebaseDataService=new FirebaseDataService,window.firebaseDataService=firebaseDataService,console.log("âœ… FirebaseDataService instance created")):setTimeout(e,100)};e()}"undefined"!=typeof module&&module.exports?module.exports=FirebaseDataService:"undefined"!=typeof window&&(window.FirebaseDataService=FirebaseDataService);