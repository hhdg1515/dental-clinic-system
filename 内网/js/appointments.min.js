function escapeHtml(e){if(null==e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}let currentView="week",currentDate=new Date,currentAppointmentData=null,historyCurrentPage=1,historyItemsPerPage=8,historyFilteredData=[],historyAllData=[],appointmentRealtimeListener=null;function waitForFirebaseService(){return new Promise((e,t)=>{let n=0;const a=setInterval(()=>{n++,window.dataManager&&window.dataManager.firebaseService&&window.dataManager.useFirebase?(clearInterval(a),console.log("âœ… Firebase service ready after",100*n,"ms"),e()):n>=50&&(clearInterval(a),t(new Error("Firebase service initialization timeout")))},100)})}async function initializeRealtimeListeners(){console.log("â„¹ï¸ Real-time listeners disabled. Use F5 to refresh appointments.")}function cleanupRealtimeListeners(){appointmentRealtimeListener&&"function"==typeof appointmentRealtimeListener&&(appointmentRealtimeListener(),appointmentRealtimeListener=null,console.log("ðŸ§¹ Appointments page real-time listeners cleaned up"))}function initializeServiceDropdowns(){if(window.ServiceMapping){const e=document.getElementById("editService");e&&window.ServiceMapping.populateInternalServiceDropdown(e);const t=document.getElementById("appointmentService");t&&window.ServiceMapping.populateInternalServiceDropdown(t)}}function canEditAppointment(e,t){if(!e||!t)return{canEdit:!1,reason:"Invalid appointment or user data",restrictedFields:[]};const n=new Date(e.dateKey),a=((new Date).getTime()-n.getTime())/36e5,o="completed"===(e.status||"scheduled"),i=a>48;return"boss"===t.role?o&&i?{canEdit:!0,reason:"Boss override - audit trail required",requiresAudit:!0,restrictedFields:[]}:{canEdit:!0,reason:"Boss has full edit permissions",restrictedFields:[]}:"admin"===t.role?o&&i?{canEdit:!1,reason:"Cannot edit completed appointments from more than 48 hours ago. Contact management if changes are needed.",restrictedFields:["service","date","time","location"]}:o&&a<=48?{canEdit:!0,reason:"Limited edit permissions for recent completed appointments",restrictedFields:["service"],warnings:["Service changes are restricted for completed appointments"]}:{canEdit:!0,reason:"Full edit permissions for non-completed appointments",restrictedFields:[]}:{canEdit:!1,reason:"Insufficient permissions",restrictedFields:[]}}function applyEditFieldRestrictions(e){const t=e.restrictedFields||[],n=e.warnings||[],a={service:"editService",date:"editDate",time:"editTime",location:"editLocation",notes:"editNotes"};if(Object.values(a).forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!1,t.style.backgroundColor="",t.style.opacity="",t.removeAttribute("title"))}),t.forEach(e=>{const t=a[e],n=document.getElementById(t);n&&(n.disabled=!0,n.style.backgroundColor="#f3f4f6",n.style.opacity="0.7",n.setAttribute("title","This field cannot be modified due to business rules"))}),n.length>0){const e=document.getElementById("editWarnings");e&&(e.innerHTML=n.map(e=>`<div class="edit-warning">${e}</div>`).join(""),e.style.display="block")}}function logAppointmentAudit(e,t,n){const a={timestamp:(new Date).toISOString(),appointmentId:e.id||e.appointmentId,patientName:e.patientName,originalDate:e.dateKey,modifiedBy:n.username||n.email,userRole:n.role,changes:t,reason:"Historical appointment modification",businessJustification:"Boss override for completed historical record"};console.log("ðŸ”’ AUDIT TRAIL - Protected Appointment Modified:",a);const o=JSON.parse(localStorage.getItem("appointment_audit_log")||"[]");o.push(a),localStorage.setItem("appointment_audit_log",JSON.stringify(o))}function ensureNotificationBellNormalState(){const e=document.getElementById("notificationBell");e&&e.classList.remove("active")}function truncatePatientName(e){if(!e||"string"!=typeof e)return"Unknown";const t=e.trim();return t.length<=14?t:t.substring(0,11)+"..."}function formatDateWithLeadingZeros(e){if(!(e instanceof Date)||isNaN(e.getTime()))return"Invalid Date";return`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}/${e.getFullYear()}`}function formatTimeWithLeadingZeros(e){const t=/^(\d{1,2}):(\d{2})$/.exec(e);if(!t)return"Invalid Time";return`${String(t[1]).padStart(2,"0")}:${String(t[2]).padStart(2,"0")}`}function formatHistoryDateTime(e,t){return`${formatDateWithLeadingZeros(e)}, ${formatTimeWithLeadingZeros(t)}`}function formatPhoneToDisplay(e){if(!e)return"";const t=e.replace(/\D/g,"");return 10===t.length?`${t.slice(0,3)}-${t.slice(3,6)}-${t.slice(6)}`:e}function initializeHistoryPagination(){const e=document.getElementById("prevPageBtn"),t=document.getElementById("nextPageBtn");e&&e.addEventListener("click",()=>{historyCurrentPage>1&&(historyCurrentPage--,renderHistoryView(!1),updateHistoryPaginationControls())}),t&&t.addEventListener("click",()=>{const e=Math.ceil(historyFilteredData.length/historyItemsPerPage);historyCurrentPage<e&&(historyCurrentPage++,renderHistoryView(!1),updateHistoryPaginationControls())})}function updateHistoryPaginationControls(){const e=document.getElementById("prevPageBtn"),t=document.getElementById("nextPageBtn"),n=Math.ceil(historyFilteredData.length/historyItemsPerPage);if(e&&(e.disabled=1===historyCurrentPage),t){const e=historyCurrentPage>=n||0===n;t.disabled=e}}async function refreshAllViews(){console.log("Calendar: Refreshing all views with current date:",currentDate),await renderWeekView(),await renderDayView(),await renderMonthView(),updateCurrentDateDisplay(),await renderHistoryView(!0),console.log("Calendar: All views refreshed")}async function refreshCurrentViewOnly(){switch(console.log(`Calendar: Refreshing ${currentView} view only`),currentView){case"week":await renderWeekView();break;case"day":await renderDayViewOptimized();break;case"month":await generateMonthCalendar();break;case"history":await renderHistoryView(!0);break;default:return console.warn("Unknown view type:",currentView),void await refreshAllViews()}updateCurrentDateDisplay(),console.log(`Calendar: ${currentView} view refreshed`)}async function renderDayViewOptimized(){console.log("Calendar: Fast day view rendering started");const e=performance.now(),t=document.getElementById("dayAppointmentsArea");if(!t)return;const n=await getAppointmentsForDateOptimized(currentDate),a=t.querySelector(".live-time-indicator");t.innerHTML="",a&&t.appendChild(a);const o={};n.forEach(e=>{const t=e.time;o[t]||(o[t]=[]),o[t].push(e)}),Object.keys(o).forEach(e=>{const n=o[e],a=getTimePosition(e);if(1===n.length){const e=n[0],o=document.createElement("div"),i=e.status||"scheduled";o.className=`day-appointment-card ${i}`,o.style.top=`${a}px`,o.style.height="56px",o.onclick=()=>openProcessModal(o,e);const s=document.createElement("div");s.className="patient-name",s.textContent=e.patientName;const r=document.createElement("div");r.className="service-type",r.textContent=e.service,o.appendChild(s),o.appendChild(r),t.appendChild(o)}else{const e=document.createElement("div");e.className="concurrent-appointments-container",e.style.top=`${a}px`,e.style.height="56px";const o=4,i=n.slice(0,o),s=n.slice(o);if(i.forEach(t=>{const n=document.createElement("div"),a=t.status||"scheduled";n.className=`day-appointment-card ${a}`,n.onclick=()=>openProcessModal(n,t);const o=document.createElement("div");o.className="patient-name",o.textContent=t.patientName;const i=document.createElement("div");i.className="service-type",i.textContent=t.service,n.appendChild(o),n.appendChild(i),e.appendChild(n)}),s.length>0){const t=document.createElement("div");t.className="more-appointments-btn",t.textContent=`+${s.length} more`,t.onclick=e=>{e.stopPropagation(),showMoreAppointmentsPopup(s,e.target)},e.appendChild(t)}t.appendChild(e)}});const i=performance.now();console.log(`Calendar: Fast day view rendering completed in ${(i-e).toFixed(2)}ms`)}document.addEventListener("DOMContentLoaded",function(){initializeServiceDropdowns(),initializeViewToggle(),initializeHistoryIcon(),initializeNewAppointmentModal(),initializeProcessModal(),initializeEditModal(),initializeCancellationModal(),initializeAppointmentDetailsModal(),initializeLiveTimeIndicator(),initializeHistoryPagination(),updateDayDate(),generateMonthCalendar(),setupFormValidation(),ensureNotificationBellNormalState(),waitForFirebaseService().then(async()=>{console.log("âœ… Firebase service ready, loading calendar data...");try{await refreshAllViews(),await initializeRealtimeListeners(),updateNotificationBadge(dataManager.getPendingConfirmations().length>0)}catch(e){console.error("Error initializing appointments page:",e)}}).catch(async e=>{console.error("Firebase service failed to initialize:",e),await refreshAllViews()});const e=window.location.href;console.log("ðŸ” Appointments: Full URL on load:",e);const t=new URLSearchParams(window.location.search),n=t.get("search"),a=t.get("date"),o=t.get("view"),i="#history"===window.location.hash,s="#open-account"===window.location.hash;if(console.log("ðŸ” Appointments: URL params:",{search:n,date:a,view:o,hasHistoryHash:i,hasOpenAccountHash:s,fullSearch:window.location.search,fullHash:window.location.hash}),s)setTimeout(()=>{const e=sessionStorage.getItem("openPatientAccount");if(e)try{showPatientAccountModal(JSON.parse(e)),sessionStorage.removeItem("openPatientAccount")}catch(e){console.error("Failed to open patient account:",e)}window.history.replaceState(null,null,window.location.pathname)},800);else if(i||n){console.log("ðŸ” Appointments: Detected navigation with search/history hash"),console.log("ðŸ” Search param:",n),console.log("ðŸ” Has history hash:",i),n&&(sessionStorage.setItem("pendingSearch",n),console.log("ðŸ” Stored search parameter for later:",n));const e=()=>{console.log("ðŸ” History data loaded event received");const t=sessionStorage.getItem("pendingSearch");if(t){console.log("ðŸ” Processing stored search parameter:",t);const e=document.getElementById("globalSearchInput");e&&(e.value=t,console.log("ðŸ” Set search input value to:",t),console.log("ðŸ” Triggering applyHistoryFilter and renderHistoryView..."),applyHistoryFilter(!0),renderHistoryView(!1),console.log("âœ… Search triggered successfully"),sessionStorage.removeItem("pendingSearch"))}window.removeEventListener("historyDataLoaded",e)};window.addEventListener("historyDataLoaded",e),setTimeout(()=>{const e=document.getElementById("historyIcon");e&&(console.log("ðŸ” Clicking history icon to switch view..."),e.click()),window.history.replaceState(null,null,window.location.pathname)},300)}else a&&"day"===o&&(console.log("ðŸ“… Appointments: Navigating to day view with date:",a),waitForFirebaseService().then(async()=>{const[e,t,n]=a.split("-").map(Number),o=new Date(e,t-1,n,12,0,0);console.log("ðŸ“… Parsed date:",o.toLocaleDateString()),currentDate=o,setTimeout(()=>{const e=document.querySelector('.view-toggle-btn[data-view="day"]');e&&(console.log("ðŸ“… Switching to day view..."),e.click(),updateDayDate(),refreshDayView()),window.history.replaceState(null,null,window.location.pathname)},500)}).catch(e=>{console.error("Failed to navigate to day view:",e)}))}),window.addEventListener("beforeunload",cleanupRealtimeListeners),document.addEventListener("visibilitychange",function(){document.hidden&&cleanupRealtimeListeners()});let prefetchInProgress=new Set;const PREFETCH_RANGE_DAYS=3;async function getAppointmentsForDateOptimized(e){const t=performance.now(),n=formatDateToKey(e);try{const a=await dataManager.getAppointmentsForDate(n),o=performance.now();return console.log(`Calendar: Data fetch for ${n} in ${(o-t).toFixed(2)}ms, found ${(a||[]).length} appointments`),prefetchAdjacentDates(e),a||[]}catch(e){return console.error("Error in optimized day data fetch:",e),[]}}async function prefetchAdjacentDates(e){console.log("Calendar: Starting background prefetch for adjacent dates");const t=[];for(let n=1;n<=3;n++){const a=new Date(e);a.setDate(e.getDate()-n);const o=formatDateToKey(a);window.cacheManager&&window.cacheManager.getDateCache(o)||prefetchInProgress.has(o)||(prefetchInProgress.add(o),t.push(prefetchSingleDate(o)))}for(let n=1;n<=3;n++){const a=new Date(e);a.setDate(e.getDate()+n);const o=formatDateToKey(a);window.cacheManager&&window.cacheManager.getDateCache(o)||prefetchInProgress.has(o)||(prefetchInProgress.add(o),t.push(prefetchSingleDate(o)))}t.length>0&&Promise.all(t).then(()=>{console.log(`Calendar: Background prefetch completed for ${t.length} dates`)}).catch(e=>{console.warn("Calendar: Some background prefetch operations failed:",e)})}async function prefetchSingleDate(e){try{console.log(`Calendar: Background prefetching ${e}`);const t=await dataManager.getAppointmentsForDate(e);console.log(`Calendar: Background prefetch completed for ${e}: ${(t||[]).length} appointments`)}catch(t){console.warn(`Calendar: Background prefetch failed for ${e}:`,t)}finally{prefetchInProgress.delete(e)}}function formatDateToKey(e,t=!1){if(!(e instanceof Date)||isNaN(e.getTime()))return console.warn("âš ï¸ Invalid date passed to formatDateToKey:",e),"";const n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),i=`${n}-${a}-${o}`;return t&&console.log("ðŸ“… formatDateToKey:",{inputDate:e.toString(),year:n,month:a,day:o,outputKey:i,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}),i}async function getAppointmentsForDate(e){const t=formatDateToKey(e);console.log("Calendar: Getting appointments for date:",t);const n=await dataManager.getAppointmentsForDate(t);return console.log("Calendar: Found appointments:",n),n}function getAppointmentsForDateSync(e){const t=formatDateToKey(e);if(console.log("Calendar SYNC: Getting appointments for date:",t),dataManager.data&&dataManager.data.appointments&&dataManager.data.appointments[t]){const e=dataManager.getAppointmentsForDateLocal(t);return console.log("Calendar SYNC: Found appointments:",e),e}return console.log("Calendar SYNC: No appointments found for date:",t),[]}async function getAppointmentCountForDate(e){return(await getAppointmentsForDateOptimized(e)).length}async function getAllAppointmentsForDate(e){try{const t=formatDateToKey(e),n=await dataManager.getAppointmentsForDate(t)||[],a=(await dataManager.getCancelledAppointments()||[]).filter(e=>e.dateKey===t);return[...n,...a]}catch(e){return console.error("Error getting appointments for date:",e),[]}}async function renderHistoryView(e=!1){const t=document.getElementById("historyTableBody");if(!t)return;if(0===historyAllData.length||e)try{const e=(await dataManager.getAllAppointments()||[]).filter(e=>"pending"!==e.status&&"declined"!==e.status),t=await dataManager.getCancelledAppointments()||[],n=[...e,...t];n.forEach(e=>{e.dateObj=new Date(e.dateKey)});const a=new Map;console.log("ðŸ“‹ Account Management: Processing",n.length,"appointments for consolidation"),n.forEach(e=>{const t=e.userId||e.patientName;e.userId&&console.log(`ðŸ‘¤ Found appointment with userId: ${e.userId} for patient: ${e.patientName}`),a.has(t)||a.set(t,[]),a.get(t).push(e)}),console.log(`ðŸ“Š Account Management: Consolidated into ${a.size} unique patient accounts`),a.forEach((e,t)=>{const n=e[0].userId;console.log(`${n?"ðŸ”—":"ðŸ“"} Patient "${t}": ${e.length} appointments ${n?"(grouped by userId)":"(grouped by name)"}`)});const o=Array.from(a.entries()).map(([e,t])=>{const n=[...t].sort((e,t)=>e.dateKey.localeCompare(t.dateKey)),a=[...t].sort((e,t)=>t.dateKey.localeCompare(e.dateKey)),o=a[0],i=n[0];console.log("ðŸ—“ï¸ First Visit Debug:",{patientIdentifier:e,allAppointmentDates:t.map(e=>e.dateKey),sortedDates:n.map(e=>e.dateKey),firstAppointmentDate:i.dateKey,mostRecentDate:o.dateKey});(new Date).setHours(0,0,0,0);const s=(new Date).toISOString().split("T")[0],r=t.some(e=>e.dateKey>=s),c=r?"active":"inactive",l=e=>{const t=["phone","phoneNumber","tel","mobile","contactNumber","patientPhone","userPhone","clientPhone"];for(const n of t)if(e[n]&&e[n].trim())return e[n].trim();return""};let d="";for(const e of a){const t=l(e);if(t){d=t;break}}if(!d)for(const e of t){const t=l(e);if(t){d=t;break}}const p=t.map(e=>{const t={phone:e.phone,phoneNumber:e.phoneNumber,tel:e.tel,mobile:e.mobile,contactNumber:e.contactNumber,patientPhone:e.patientPhone,userPhone:e.userPhone,clientPhone:e.clientPhone},n=Object.entries(t).filter(([e,t])=>t&&t.trim()).map(([e,t])=>`${e}:"${t}"`).join(",");return`${e.dateKey}: [${n||"no phone fields"}]`}).join(", ");return console.log(`ðŸ“ž Patient "${o.patientName}" phone data: [${p}] â†’ Selected: "${d}"`),console.log("ðŸ” Raw appointment object for debugging:",t[0]),console.log(`ðŸ“Š Patient "${o.patientName}": ${c} (${t.length} appointments, future: ${r})`),{...o,phone:d,appointmentCount:t.length,firstVisitDate:i.dateKey,firstVisitDateObj:i.dateObj,accountStatus:c,isPatientRecord:!0,allAppointments:t,patientIdentifier:e,groupedByUserId:!!o.userId,userId:o.userId}});o.sort((e,t)=>t.dateObj-e.dateObj),historyAllData=o,applyHistoryFilter(!0),console.log("ðŸ”¥ Dispatching historyDataLoaded event"),window.dispatchEvent(new Event("historyDataLoaded"))}catch(e){console.error("Error loading appointment history data:",e),historyAllData=[],applyHistoryFilter(!0),window.dispatchEvent(new Event("historyDataLoaded"))}else applyHistoryFilter(!1);t.innerHTML="";const n=(historyCurrentPage-1)*historyItemsPerPage,a=n+historyItemsPerPage;historyFilteredData.slice(n,a).forEach(e=>{const n=document.createElement("tr");n.onclick=()=>showPatientAccountModal(e);const a=document.createElement("td");a.className="patient-name",a.textContent=e.patientName;const o=document.createElement("td");o.className="phone",o.textContent=formatPhoneToDisplay(e.phone);const i=document.createElement("td");i.className="first-visit";const[s,r,c]=e.firstVisitDate.split("-");i.textContent=`${r}/${c}/${s}`;const l=document.createElement("td");l.className="total-visits",l.textContent=e.appointmentCount;const d=document.createElement("td"),p=document.createElement("span");p.className=`status-badge ${e.accountStatus}`,p.textContent=capitalizeFirst(e.accountStatus),d.appendChild(p),n.appendChild(a),n.appendChild(o),n.appendChild(i),n.appendChild(l),n.appendChild(d),t.appendChild(n)}),updateHistoryPaginationControls()}function applyHistoryFilter(e=!0){const t=document.getElementById("globalSearchInput"),n=t?t.value.toLowerCase().trim():"";historyFilteredData=""===n?[...historyAllData]:historyAllData.filter(e=>{const t=e.patientName.toLowerCase(),a=e.phone.replace(/\D/g,"").toLowerCase();return t.includes(n)||a.includes(n)}),e&&(historyCurrentPage=1)}function showAppointmentDetails(e,t=null){let n,a,o,i,s,r,c="";if(t){if(n=t.patientName,a=formatHistoryDateTime(t.dateObj,t.time),o=t.service,i=t.location,s=capitalizeFirst(t.status.replace("-"," ")),r=formatPhoneToDisplay(t.phone),"cancelled"===t.status){const e=t.cancelReason||"Not specified",n=t.cancelNotes||"";c=`\n                <div class="detail-row">\n                    <span class="detail-label">Cancel Reason:</span>\n                    <span class="detail-value">${e}</span>\n                </div>\n                ${n?`\n                <div class="detail-row">\n                    <span class="detail-label">Cancel Notes:</span>\n                    <span class="detail-value">${n}</span>\n                </div>\n                `:""}\n                <div class="detail-row">\n                    <span class="detail-label">Cancelled At:</span>\n                    <span class="detail-value">${t.cancelledAt?new Date(t.cancelledAt).toLocaleString():"Unknown"}</span>\n                </div>\n            `}}else n=e.querySelector(".patient-name")?.textContent||"Unknown",a=e.querySelector(".time")?.textContent||"Unknown",o=e.querySelector(".service")?.textContent||"Unknown",i="Unknown",s=e.querySelector(".status-badge")?.textContent||"Unknown",r=e.querySelector(".tel")?.textContent||"";const l=document.getElementById("appointmentDetailsContent");l&&(l.innerHTML=`\n            <h4>${escapeHtml(n)}</h4>\n            <div class="detail-row">\n                <span class="detail-label">Date & Time:</span>\n                <span class="detail-value">${escapeHtml(a)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Service:</span>\n                <span class="detail-value">${escapeHtml(o)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Location:</span>\n                <span class="detail-value">${escapeHtml(i)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Phone:</span>\n                <span class="detail-value">${escapeHtml(r)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Status:</span>\n                <span class="detail-value">${escapeHtml(s)}</span>\n            </div>\n            ${c}\n        `),openModal("appointmentDetailsModal")}async function renderWeekView(){const e=document.querySelectorAll(".week-day"),t=getStartOfWeek(currentDate),n=new Set;for(let a=0;a<e.length;a++){const e=new Date(t);e.setDate(t.getDate()+a);(await getAppointmentsForDateOptimized(e)).forEach(e=>{n.add(e.time)})}["09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"].forEach(e=>{n.add(e)});const a=Array.from(n).sort();for(let n=0;n<e.length;n++){const o=e[n],i=new Date(t);i.setDate(t.getDate()+n);const s=o.querySelector(".day-appointments"),r=await getAppointmentsForDateOptimized(i);s.innerHTML="";const c={};r.forEach(e=>{const t=e.time;c[t]||(c[t]=[]),c[t].push(e)}),a.forEach(e=>{const t=document.createElement("div");t.className="week-time-slot-container",t.setAttribute("data-time",e);const n=c[e]||[];if(n.length,0===n.length);else if(1===n.length){const e=createWeekAppointmentCard(n[0]);t.appendChild(e)}else if(2===n.length)n.forEach(e=>{const n=createWeekAppointmentCard(e);t.appendChild(n)});else if(n.length>=3){const a=createWeekAppointmentCard(n[0]);t.appendChild(a);const o=n.length-1,s=document.createElement("div");s.className="week-more-indicator",s.textContent=`+${o} more`,s.onclick=t=>{t.stopPropagation(),showWeekMoreAppointments(n.slice(1),i,e)},t.appendChild(s)}s.appendChild(t)});const l=o.querySelector(".day-number");if(l){l.textContent=i.getDate();const e=new Date,t=o.querySelector(".day-header");i.toDateString()===e.toDateString()?t.classList.add("today"):t.classList.remove("today")}}updateWeekRangeDisplay()}function createWeekAppointmentCard(e){const t=document.createElement("div"),n=e.status||"scheduled";t.className=`week-appointment ${n}`,t.onclick=()=>openProcessModal(t,e);const a=document.createElement("div");return a.className="week-patient",a.textContent=truncatePatientName(e.patientName),a.title=e.patientName,t.appendChild(a),t}function showWeekMoreAppointments(e,t,n){const a=document.querySelector(".week-more-popup");a&&a.remove();const o=document.createElement("div");o.className="week-more-popup";const i=document.createElement("div");i.className="popup-header";const s=t.toLocaleDateString("en-US",{month:"short",day:"numeric"}),r=formatTime(n);i.textContent=`${s} at ${r} (+${e.length})`,o.appendChild(i);const c=document.createElement("div");c.className="popup-appointments-list",e.forEach(e=>{const t=document.createElement("div");t.className=`popup-appointment-item ${e.status}`,t.onclick=()=>{o.remove(),openProcessModal(t,e)};const n=document.createElement("div");n.className="popup-left-content";const a=document.createElement("div");a.className="popup-patient-name",a.textContent=e.patientName;const i=document.createElement("div");i.className="popup-service",i.textContent=e.service,n.appendChild(a),n.appendChild(i);const s=document.createElement("div"),r=e.status||"scheduled";s.className=`popup-status ${r}`,s.textContent=capitalizeFirst(r),t.appendChild(n),t.appendChild(s),c.appendChild(t)}),o.appendChild(c),document.body.appendChild(o),o.style.position="fixed",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.zIndex="1000";const l=e=>{o.contains(e.target)||(o.remove(),document.removeEventListener("click",l))};setTimeout(()=>{document.addEventListener("click",l)},100)}async function renderDayView(){const e=document.getElementById("dayAppointmentsArea");if(!e)return;const t=await getAppointmentsForDateOptimized(currentDate),n=e.querySelector(".live-time-indicator");e.innerHTML="",n&&e.appendChild(n);const a={};t.forEach(e=>{const t=e.time;a[t]||(a[t]=[]),a[t].push(e)}),Object.keys(a).forEach(t=>{const n=a[t],o=getTimePosition(t);if(1===n.length){const t=n[0],a=document.createElement("div"),i=t.status||"scheduled";a.className=`day-appointment-card ${i}`,a.style.top=`${o}px`,a.style.height="56px",a.onclick=()=>openProcessModal(a,t);const s=document.createElement("div");s.className="patient-name",s.textContent=t.patientName;const r=document.createElement("div");r.className="service-type",r.textContent=t.service,a.appendChild(s),a.appendChild(r),e.appendChild(a)}else{const t=document.createElement("div");t.className="concurrent-appointments-container",t.style.top=`${o}px`,t.style.height="56px";const a=4,i=n.slice(0,a),s=n.slice(a);if(i.forEach(e=>{const n=document.createElement("div"),a=e.status||"scheduled";n.className=`day-appointment-card ${a}`,n.onclick=()=>openProcessModal(n,e);const o=document.createElement("div");o.className="patient-name",o.textContent=e.patientName;const i=document.createElement("div");i.className="service-type",i.textContent=e.service,n.appendChild(o),n.appendChild(i),t.appendChild(n)}),s.length>0){const e=document.createElement("div");e.className="more-appointments-btn",e.textContent=`+${s.length} more`,e.onclick=e=>{e.stopPropagation(),showMoreAppointmentsPopup(s,e.target)},t.appendChild(e)}e.appendChild(t)}})}async function renderMonthView(){await generateMonthCalendar()}function createMonthDateElement(e,t=!1,n=!1){const a=document.createElement("div");return a.className="month-date",t&&a.classList.add("other-month"),n&&a.classList.add("today"),a.textContent=e.toString(),a}function getTimePosition(e){const t=/^(\d{1,2}):(\d{2})$/.exec(e);if(!t)return 0;const n=parseInt(t[1],10),a=parseInt(t[2],10);if(n<0||n>23||a<0||a>59)return 0;if(n<9)return 0;return 80*(n-9)+a/60*80+12}function getStartOfWeek(e){if(!(e instanceof Date)||isNaN(e.getTime()))return new Date;const t=new Date(e),n=t.getDay(),a=t.getDate()-n+(0===n?-6:1);return t.setDate(a),t}function updateWeekRangeDisplay(){const e=document.getElementById("weekRange");if(!e)return;const t=getStartOfWeek(currentDate),n=new Date(t);n.setDate(n.getDate()+6);const a={month:"long",day:"numeric",year:"numeric"};e.textContent=`${t.toLocaleDateString("en-US",a)} - ${n.toLocaleDateString("en-US",a)}`}function initializeViewToggle(){const e=document.querySelectorAll(".view-btn"),t=document.querySelectorAll(".view-content"),n=document.getElementById("mainViewToggle");e.forEach(a=>{a.addEventListener("click",function(){const a=this.dataset.view;if(!["week","day","month"].includes(a))return;e.forEach(e=>e.classList.remove("active")),this.classList.add("active"),t.forEach(e=>e.classList.remove("active"));const o=document.getElementById(a+"-view");o&&o.classList.add("active");const i=document.getElementById("history-view"),s=document.getElementById("historyIcon");i&&i.classList.contains("active")&&(i.classList.remove("active"),s.classList.remove("active")),n&&(n.style.display="flex"),currentView=a,"day"===a?(renderDayViewOptimized(),updateLiveTimeIndicator()):"week"===a?renderWeekView():"month"===a&&generateMonthCalendar(),updateCurrentDateDisplay()})})}function initializeHistoryIcon(){const e=document.getElementById("historyIcon"),t=document.getElementById("closeHistoryBtn"),n=document.getElementById("history-view"),a=document.querySelector(".view-toggle-container");e&&e.addEventListener("click",()=>{document.querySelectorAll(".view-content").forEach(e=>{e.classList.remove("active")}),n.classList.add("active"),e.classList.add("active"),currentView="history",a&&(a.style.display="none"),document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active"));const t=document.querySelector(".page-title h1");t&&(t.textContent="Accounts"),historyCurrentPage=1,renderHistoryView(!0)}),t&&t.addEventListener("click",()=>{n.classList.remove("active"),e.classList.remove("active"),document.getElementById("week-view").classList.add("active"),currentView="week",a&&(a.style.display="flex");const t=document.querySelector(".page-title h1");t&&(t.textContent="Calendar"),document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active")),document.querySelector('[data-view="week"]').classList.add("active");const o=document.querySelector(".view-toggle-container");o&&(o.style.display="none",setTimeout(()=>{o.style.display="grid"},10))})}function triggerAppointmentsSearch(e){"history"===getCurrentView()&&(applyHistoryFilter(!0),renderHistoryView(!1))}function initializeProcessModal(){const e=document.getElementById("processModal"),t=document.getElementById("processModalClose"),n=document.getElementById("arrivedBtn"),a=document.getElementById("noShowBtn"),o=document.getElementById("editBtn"),i=document.getElementById("holdBtn"),s=document.getElementById("completedBtn"),r=document.getElementById("cancelBtn");function c(e=!0){closeModal("processModal"),e&&(currentAppointmentData=null)}t&&t.addEventListener("click",()=>c(!0)),e?.addEventListener("click",function(t){t.target===e&&c(!0)}),n?.addEventListener("click",()=>{updateAppointmentStatus("arrived")}),a?.addEventListener("click",()=>{updateAppointmentStatus("no-show")}),s?.addEventListener("click",()=>{updateAppointmentStatus("completed")}),i?.addEventListener("click",()=>{updateAppointmentStatus("held")}),o?.addEventListener("click",async()=>{if(c(!1),!currentAppointmentData)return console.error("Edit: No current appointment data available"),void alert("Error: No appointment selected. Please try again.");{const e=await findAppointmentById(currentAppointmentData.appointmentId);if(!e)return console.error("Edit: Appointment not found for ID:",currentAppointmentData.appointmentId),void alert("Error: Appointment data not found. Please try again.");{if(console.log("Edit: Found appointment data:",e),document.getElementById("editDate").value=e.dateKey||e.date||"",e.time&&"string"==typeof e.time){const t=`${e.time}-${getEndTime(e.time)}`;document.getElementById("editTime").value=t}else{console.warn("Edit: Missing or invalid time data:",e.time);const t=e.appointmentTime||e.timeSlot||"";if(t){const e=`${t}-${getEndTime(t)}`;document.getElementById("editTime").value=e}else document.getElementById("editTime").value="",console.warn("Edit: No valid time field found in appointment data")}const t=e.service||e.serviceName||e.serviceType||"";document.getElementById("editService").value=getServiceValue(t),document.getElementById("editNotes").value=e.notes||"";const n=dataManager.getCurrentUser(),a=document.getElementById("editLocation"),o=e.location||e.clinicLocation||e.clinicName||"";a.value=getLocationValue(o);const i=canEditAppointment(e,n);if(!i.canEdit)return void alert(`Edit Restricted: ${i.reason}`);applyEditFieldRestrictions(i),"admin"===n.role?(a.disabled=!0,a.style.backgroundColor="#f3f4f6"):"boss"===n.role&&(a.disabled=!1,a.style.backgroundColor="white"),currentAppointmentData.editPermissions=i}}openModal("editModal")}),r?.addEventListener("click",()=>{c(!1),openModal("cancellationModal")})}function openProcessModal(e,t=null){let n,a,o,i;t?(n=t.patientName,a=t.service,o=t.status,i=t.id):(e.querySelector(".patient-name")?(n=e.querySelector(".patient-name").textContent,a=e.querySelector(".service-type")?.textContent||e.querySelector(".service")?.textContent||""):e.querySelector(".week-patient")?(n=e.querySelector(".week-patient").textContent,a=e.querySelector(".week-service")?.textContent||"Service not available"):(n=e.querySelector(".patient-name")?.textContent||"Unknown Patient",a=e.querySelector(".service")?.textContent||"Unknown Service"),o=getStatusFromCard(e),i=null),currentAppointmentData={patientName:n,service:a,status:o,element:e,appointmentId:i,phone:t?.phone||""};const s=document.getElementById("appointmentSummary");if(s){let e="Phone not available";t&&t.phone&&(e=t.phone),s.innerHTML=`\n            <h4>${escapeHtml(n)}</h4>\n            <div class="detail-row">\n                <span class="detail-label">Phone:</span>\n                <span class="detail-value">${escapeHtml(e)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Service:</span>\n                <span class="detail-value">${escapeHtml(a)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Status:</span>\n                <span class="detail-value">${escapeHtml(capitalizeFirst(o.replace("-"," ")))}</span>\n            </div>\n        `}updateButtonSelection(o),openModal("processModal")}function initializeEditModal(){const e=document.getElementById("editModal"),t=document.getElementById("editModalClose"),n=document.getElementById("editCancel"),a=document.getElementById("editForm");function o(){closeModal("editModal"),a&&a.reset(),currentAppointmentData=null}t&&t.addEventListener("click",o),n&&n.addEventListener("click",o),e?.addEventListener("click",function(t){t.target===e&&o()}),a&&a.addEventListener("submit",async function(e){if(e.preventDefault(),!currentAppointmentData||!currentAppointmentData.appointmentId)return void showErrorMessage("No appointment data found");const t=document.getElementById("editDate")?.value,n=document.getElementById("editTime")?.value,a=document.getElementById("editService")?.value,i=document.getElementById("editLocation")?.value,s=document.getElementById("editNotes")?.value||"";if(!(t&&n&&a&&i))return void showErrorMessage("Please fill in all required fields");const r=dataManager.getCurrentUser(),c=document.getElementById("editLocation");"admin"===r.role?(c.value=r.assignedLocation,c.disabled=!0,c.style.backgroundColor="#f3f4f6"):"boss"===r.role&&(c.disabled=!1,c.style.backgroundColor="white");const l=extractTimeFromSlot(n);try{await dataManager.deleteAppointment(currentAppointmentData.appointmentId);const e={patientName:currentAppointmentData.patientName,date:t,time:l,service:getServiceDisplayName(a),location:getLocationDisplayName(i),phone:currentAppointmentData.phone||"",notes:s};try{const n=currentAppointmentData.editPermissions;if(n&&n.requiresAudit){const e=await findAppointmentById(currentAppointmentData.appointmentId),n={date:{from:e.dateKey,to:t},time:{from:e.time,to:l},service:{from:e.service,to:getServiceDisplayName(a)},location:{from:e.location,to:getLocationDisplayName(i)},notes:{from:e.notes,to:s}};Object.keys(n).forEach(e=>{n[e].from===n[e].to&&delete n[e]}),Object.keys(n).length>0&&logAppointmentAudit(e,n,r)}await dataManager.addAppointment(e),showSuccessMessage("Appointment updated successfully!"),o()}catch(e){console.error("Error updating appointment:",e),showErrorMessage("Failed to update appointment")}await refreshCurrentViewOnly()}catch(e){showErrorMessage("Failed to update appointment")}})}async function findAppointmentById(e){return(await dataManager.getAllAppointments()).find(t=>t.id===e)}function getEndTime(e){if(!e||"string"!=typeof e)return console.warn("getEndTime: Invalid startTime:",e),"";if(!/^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/.test(e))return console.warn("getEndTime: Invalid time format:",e),e;try{const t=e.split(":");if(2!==t.length)return console.warn("getEndTime: Unexpected time format:",e),e;const[n,a]=t.map(Number);if(isNaN(n)||isNaN(a)||n<0||n>23||a<0||a>59)return console.warn("getEndTime: Invalid hour/minute values:",n,a),e;const o=n+1;return`${String(o>23?o-24:o).padStart(2,"0")}:${String(a).padStart(2,"0")}`}catch(t){return console.error("getEndTime: Error processing time:",t),e}}function getServiceValue(e){if(!e||"string"!=typeof e)return console.warn("getServiceValue: Invalid serviceName:",e),"general";return{General:"general",Implant:"implant",Extraction:"extraction",Preventive:"preventive",Cosmetic:"cosmetic",Orthodontics:"orthodontics","Root Canals":"root-canals",Restorations:"restorations",Periodontics:"periodontics"}[e]||e.toLowerCase()}function getLocationValue(e){if(!e||"string"!=typeof e)return console.warn("getLocationValue: Invalid locationName:",e),"arcadia";return{Arcadia:"arcadia",Irvine:"irvine","South Pasadena":"south-pasadena","Rowland Heights":"rowland-heights",Eastvale:"eastvale"}[e]||e.toLowerCase()}function initializeCancellationModal(){const e=document.getElementById("cancellationModal"),t=document.getElementById("cancellationModalClose"),n=document.getElementById("cancelBack"),a=document.getElementById("confirmCancellation");function o(){closeModal("cancellationModal"),document.querySelectorAll('input[name="cancelReason"]').forEach(e=>{e.checked=!1});const e=document.getElementById("cancelNotes");e&&(e.value=""),currentAppointmentData=null}t&&t.addEventListener("click",o),n&&n.addEventListener("click",o),e?.addEventListener("click",function(t){t.target===e&&o()}),a&&a.addEventListener("click",function(){const e=document.querySelector('input[name="cancelReason"]:checked')?.value,t=document.getElementById("cancelNotes")?.value||"";e&&["patient-cancelled","clinic-cancelled"].includes(e)?(updateAppointmentStatus("cancelled",{reason:"patient-cancelled"===e?"Patient Cancelled":"Clinic Cancelled",notes:t}),o()):alert("Please select a valid cancellation reason.")})}function initializeAppointmentDetailsModal(){const e=document.getElementById("appointmentDetailsModal"),t=document.getElementById("appointmentDetailsClose"),n=document.getElementById("appointmentDetailsOk");function a(){closeModal("appointmentDetailsModal")}t&&t.addEventListener("click",a),n&&n.addEventListener("click",a),e?.addEventListener("click",function(t){t.target===e&&a()})}function initializeNewAppointmentModal(){const e=document.getElementById("newAppointmentBtn"),t=document.getElementById("newAppointmentModal"),n=document.getElementById("newAppointmentClose"),a=document.getElementById("newAppointmentCancel"),o=document.getElementById("newAppointmentForm");function i(){closeModal("newAppointmentModal");const e=document.getElementById("newAppointmentForm"),t=document.getElementById("appointmentPatientName");e&&e.reset(),t&&(t.readOnly=!1,t.style.backgroundColor="white")}e&&e.addEventListener("click",()=>{openNewAppointmentModal()}),n&&n.addEventListener("click",i),a&&a.addEventListener("click",i),t&&t.addEventListener("click",function(e){e.target===t&&i()}),o&&o.addEventListener("submit",function(e){e.preventDefault(),handleNewAppointmentSubmission(),i()})}function openNewAppointmentModal(e=null){console.log("ðŸ”µ openNewAppointmentModal called");const t=document.getElementById("appointmentDate"),n=(new Date).toISOString().split("T")[0];t&&(t.min=n,t.value=e?e.toISOString().split("T")[0]:n),applyLocationPermissionsToNewAppointmentModal(),console.log("âœ… Location permissions applied. Opening modal..."),openModal("newAppointmentModal")}async function handleNewAppointmentSubmission(){try{const e={patientName:document.getElementById("appointmentPatientName")?.value||"",date:document.getElementById("appointmentDate")?.value||"",time:extractTimeFromSlot(document.getElementById("appointmentTime")?.value||""),service:getServiceDisplayName(document.getElementById("appointmentService")?.value||""),location:getLocationDisplayName(document.getElementById("appointmentLocation")?.value||""),phone:document.getElementById("appointmentPhone")?.value||"",notes:document.getElementById("appointmentNotes")?.value||""};if(!(e.patientName&&e.date&&e.time&&e.service&&e.location))return void showErrorMessage("Please fill in all required fields");try{await dataManager.addAppointment(e),showSuccessMessage("New appointment created successfully!")}catch(e){console.error("Error adding appointment:",e),showErrorMessage("Failed to add appointment")}await refreshCurrentViewOnly()}catch(e){showErrorMessage("Failed to create appointment. Please check all fields and try again.")}}function setupFormValidation(){document.querySelectorAll("#appointmentPatientName").forEach(e=>{e&&(e.addEventListener("input",function(e){try{this.value=this.value.replace(/[^A-Za-z\s'\-\.]/g,"").substring(0,50)}catch(e){}}),e.addEventListener("change",function(e){try{this.value&&!validatePatientName(this.value)&&(this.value=this.value.replace(/[^A-Za-z\s'\-\.]/g,"").substring(0,50))}catch(e){}}))});document.querySelectorAll("#appointmentPhone").forEach(e=>{e&&e.addEventListener("input",function(){try{formatPhoneNumber(this)}catch(e){}})})}function initializeLiveTimeIndicator(){updateLiveTimeIndicator(),setInterval(updateLiveTimeIndicator,6e4)}function updateLiveTimeIndicator(){const e=document.getElementById("liveTimeIndicator");if(!e||"day"!==currentView)return;const t=new Date,n=t.getHours(),a=t.getMinutes();if(n<9||n>=16)return void(e.style.display="none");const o=(60*(n-9)+a)/420*100;e.style.top=o+"%",e.style.display="block"}function updateDayDate(){const e=document.getElementById("dayDate");if(e){const t={year:"numeric",month:"long",day:"numeric"};e.textContent=currentDate.toLocaleDateString("en-US",t)}}function updateCurrentDateDisplay(){const e=document.getElementById("currentDateDisplay");if(!e)return;let t="";if("week"===currentView){const e=getStartOfWeek(currentDate),n=new Date(e);n.setDate(n.getDate()+6),t=`${e.toLocaleDateString("en-US",{month:"long",day:"numeric"})} - ${n.toLocaleDateString("en-US",{month:"long",day:"numeric"})}`}else"day"===currentView?t=currentDate.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"month"===currentView&&(t=currentDate.toLocaleDateString("en-US",{month:"long",year:"numeric"}));e.textContent=t}async function generateMonthCalendar(){const e=document.getElementById("monthDates");if(!e)return;const t=currentDate.getFullYear(),n=currentDate.getMonth();console.log("Calendar: Starting optimized month calendar generation"),e.innerHTML="";const a=new Date(t,n,1),o=new Date(t,n+1,0).getDate(),i=a.getDay(),s=0===i?6:i-1,r=new Date(t,n,0),c=r.getDate(),l=r.getFullYear(),d=r.getMonth();console.log(`Calendar: Fetching appointments for month ${t}-${(n+1).toString().padStart(2,"0")}`);const p=await dataManager.getAppointmentsForMonth(t,n+1);console.log("Calendar: Batch query completed, appointments found for",Object.keys(p).length,"days");for(let t=s-1;t>=0;t--){const n=c-t,a=new Date(l,d,n,12,0,0),o=formatDateToKey(a),i=p[o]||[];console.log(`ðŸ“… Month calendar - Previous month date ${o}: ${i.length} appointments`);const s=createMonthDateElementOptimized(n,!0,!1,a,i);e.appendChild(s)}const m=new Date;for(let a=1;a<=o;a++){const o=new Date(t,n,a,12,0,0),i=o.toDateString()===m.toDateString(),s=formatDateToKey(o),r=p[s]||[];console.log(`ðŸ“… Month calendar - Current month date ${s}: ${r.length} appointments`);const c=createMonthDateElementOptimized(a,!1,i,o,r);e.appendChild(c)}const u=42-e.children.length,g=11===n?t+1:t,y=11===n?0:n+1;for(let t=1;t<=u;t++){const n=new Date(g,y,t,12,0,0),a=formatDateToKey(n),o=p[a]||[];console.log(`ðŸ“… Month calendar - Next month date ${a}: ${o.length} appointments`);const i=createMonthDateElementOptimized(t,!0,!1,n,o);e.appendChild(i)}console.log("Calendar: Optimized month calendar generation completed");updateMonthSidebar(new Date(m.getFullYear(),m.getMonth(),m.getDate(),12,0,0))}function createMonthDateElementOptimized(e,t=!1,n=!1,a=null,o=[]){const i=document.createElement("div");i.className="month-date",t&&i.classList.add("other-month"),n&&i.classList.add("today");const s=o.length,r=document.createElement("div");if(r.className="date-number",r.textContent=e.toString(),i.appendChild(r),!t){const e=document.createElement("div");e.className="add-appointment-icon",e.innerHTML='<i class="fas fa-plus"></i>',i.appendChild(e)}if(s>0){const e=document.createElement("div");e.className="appointment-count",e.textContent=s.toString(),i.appendChild(e)}return a&&(i.addEventListener("click",e=>{if(!t&&e.target.closest(".add-appointment-icon"))return e.stopPropagation(),void openNewAppointmentModal(a);updateMonthSidebar(a)}),i.addEventListener("dblclick",e=>{e.preventDefault(),switchToDayView(a)})),i}async function createMonthDateElement(e,t=!1,n=!1,a=null){const o=document.createElement("div");o.className="month-date",t&&o.classList.add("other-month"),n&&o.classList.add("today");const i=(a?await getAppointmentsForDateOptimized(a):[]).length,s=document.createElement("div");if(s.className="date-number",s.textContent=e.toString(),o.appendChild(s),!t){const e=document.createElement("div");e.className="add-appointment-icon",e.innerHTML='<i class="fas fa-plus"></i>',o.appendChild(e)}if(i>0){const e=document.createElement("div");e.className="appointment-count",e.textContent=i.toString(),o.appendChild(e)}return a&&(o.addEventListener("click",e=>{if(!t&&e.target.closest(".add-appointment-icon"))return e.stopPropagation(),void openNewAppointmentModal(a);updateMonthSidebar(a)}),o.addEventListener("dblclick",e=>{e.preventDefault(),switchToDayView(a)})),o}async function updateMonthSidebar(e){const t=document.getElementById("monthSidebarDate"),n=document.getElementById("monthSidebarCount"),a=document.getElementById("monthSidebarList"),o=document.getElementById("monthSidebarEmpty");if(!t||!a||!o)return void console.error("Month sidebar elements not found");const i=e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});t.textContent=i;const s=await getAppointmentsForDateOptimized(e);n&&(n.textContent=`${s.length} appointment${1!==s.length?"s":""}`),a.innerHTML="",0===s.length?(o.style.display="block",a.style.display="none"):(o.style.display="none",a.style.display="block",s.sort((e,t)=>e.time.localeCompare(t.time)),s.forEach(e=>{const t=document.createElement("div"),n=e.status||"scheduled";t.className=`month-sidebar-card status-${n}`;const o=getStatusDisplayText(e.status);t.innerHTML=`\n                <div class="month-sidebar-card-header">\n                    <span class="month-sidebar-time">${escapeHtml(formatTime(e.time))}</span>\n                    <span class="month-sidebar-status">${escapeHtml(o)}</span>\n                </div>\n                <div class="month-sidebar-title">${escapeHtml(e.patientName)}</div>\n                <div class="month-sidebar-subtitle">${escapeHtml(e.service)}</div>\n            `,t.addEventListener("click",()=>{openAppointmentDetails(e)}),t.style.cursor="pointer",t.style.transition="transform 0.2s, box-shadow 0.2s",t.addEventListener("mouseenter",()=>{t.style.transform="translateY(-2px)",t.style.boxShadow="0 16px 40px rgba(15, 23, 42, 0.12)"}),t.addEventListener("mouseleave",()=>{t.style.transform="translateY(0)",t.style.boxShadow="0 12px 30px rgba(15, 23, 42, 0.08)"}),a.appendChild(t)}))}function getStatusDisplayText(e){return{scheduled:"Scheduled",confirmed:"Confirmed",arrived:"Arrived",completed:"Completed","no-show":"No Show",cancelled:"Cancelled",held:"Held",pending:"Pending"}[e]||e}function openAppointmentDetails(e){"scheduled"===e.status||"confirmed"===e.status||"arrived"===e.status?(currentProcessingAppointment=e,showProcessModal(e)):showAppointmentDetailsModal(e)}function switchToDayView(e){if(!(e instanceof Date)||isNaN(e.getTime()))return;const t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),12,0,0);currentDate=t;const n=document.getElementById("dayDate");if(n){const e={year:"numeric",month:"long",day:"numeric"},a=t.toLocaleDateString("en-US",e);n.textContent=a}document.querySelectorAll(".view-content").forEach(e=>e.classList.remove("active")),document.getElementById("day-view").classList.add("active"),document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active")),document.querySelector('[data-view="day"]').classList.add("active"),currentView="day",renderDayView(),updateLiveTimeIndicator()}async function updateAppointmentStatus(e,t={}){if(currentAppointmentData)try{if(!await dataManager.updateAppointmentStatus(currentAppointmentData.appointmentId,e,t))return void showErrorMessage("Appointment not found in database");let n="";switch(e){case"arrived":n="Patient marked as arrived";break;case"completed":n="Appointment marked as completed";break;case"no-show":n="Appointment marked as no-show";break;case"cancelled":n="Appointment cancelled and removed from schedule";break;case"held":n="Appointment put on hold"}currentAppointmentData&&(currentAppointmentData.status=e,updateProcessModalDisplay(currentAppointmentData));currentAppointmentData.date;showSuccessMessage(n),closeModal("processModal"),currentAppointmentData=null,console.log("Calendar: Refreshing view after status update"),await refreshCurrentViewOnly(),console.log("Calendar: View refresh completed")}catch(e){showErrorMessage("Failed to update appointment status")}else showErrorMessage("Error: No appointment data found. Please try again.")}function updateProcessModalDisplay(e){const t=document.getElementById("appointmentSummary");t&&e&&(t.innerHTML=`\n            <h4>Appointment Details</h4>\n            <div class="detail-row">\n                <span class="detail-label">Patient:</span>\n                <span class="detail-value">${escapeHtml(e.patientName)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Service:</span>\n                <span class="detail-value">${escapeHtml(e.service)}</span>\n            </div>\n            <div class="detail-row">\n                <span class="detail-label">Status:</span>\n                <span class="detail-value">${escapeHtml(capitalizeFirst(e.status.replace("-"," ")))}</span>\n            </div>\n        `),updateButtonSelection(e.status)}function updateButtonSelection(e){document.querySelectorAll(".btn-action").forEach(e=>{e.classList.remove("selected")});let t=null;switch(e){case"arrived":t="arrivedBtn";break;case"completed":t="completedBtn";break;case"no-show":t="noShowBtn";break;case"cancelled":t="cancelBtn";break;case"held":t="holdBtn"}if(t){const e=document.getElementById(t);e&&e.classList.add("selected")}}function getStatusFromCard(e){const t=["scheduled","arrived","completed","no-show","cancelled","held"];for(let n of t)if(e.classList.contains(n))return n;return"scheduled"}function showMoreAppointmentsPopup(e,t){const n=document.querySelector(".more-appointments-popup");n&&n.remove();const a=document.createElement("div");a.className="more-appointments-popup";const o=document.createElement("div");o.className="popup-header",o.textContent=`Additional Appointments (${e.length})`,a.appendChild(o);const i=document.createElement("div");i.className="popup-appointments-list",e.forEach(e=>{const t=document.createElement("div");t.className=`popup-appointment-item ${e.status}`,t.onclick=()=>{a.remove(),openProcessModal(t,e)};const n=document.createElement("div");n.className="popup-left-content";const o=document.createElement("div");o.className="popup-patient-name",o.textContent=e.patientName;const s=document.createElement("div");s.className="popup-service",s.textContent=e.service,n.appendChild(o),n.appendChild(s);const r=document.createElement("div"),c=e.status||"scheduled";r.className=`popup-status ${c}`,r.textContent=capitalizeFirst(c),t.appendChild(n),t.appendChild(r),i.appendChild(t)}),a.appendChild(i),a.style.visibility="hidden",a.style.position="fixed",document.body.appendChild(a);const s=t.getBoundingClientRect(),r=a.getBoundingClientRect(),c=window.innerWidth,l=window.innerHeight;let d=s.left,p=s.bottom+5;d+r.width>c-10&&(d=s.right-r.width),d<10&&(d=10),p+r.height>l-10&&(p=s.top-r.height-5),p<10&&(p=10),a.style.left=`${d}px`,a.style.top=`${p}px`,a.style.visibility="visible",a.style.zIndex="1000";const m=e=>{a.contains(e.target)||e.target===t||(a.remove(),document.removeEventListener("click",m))};setTimeout(()=>{document.addEventListener("click",m)},100)}function validatePatientName(e){if("string"!=typeof e)return!1;const t=e.trim();if(!t||0===t.length)return!1;return/^[A-Za-z\s'\-\.]{1,50}$/.test(t)}function fixAppointmentTimeOptions(){setTimeout(()=>{const e=document.getElementById("appointmentTime");if(e&&8===e.options.length){const t=new Option("04:00 PM - 05:00 PM","16:00-17:00");e.add(t)}},200)}window.getCacheStats=()=>window.cacheManager?window.cacheManager.getStats():{error:"CacheManager not available"},window.printCacheStats=()=>{window.cacheManager?window.cacheManager.printStats():console.warn("CacheManager not available")},document.getElementById("prevWeek")?.addEventListener("click",async()=>{console.log(`Calendar: Previous navigation in ${currentView} view`),"week"===currentView?(currentDate.setDate(currentDate.getDate()-7),await refreshCurrentViewOnly()):"day"===currentView?(currentDate.setDate(currentDate.getDate()-1),await refreshCurrentViewOnly()):"month"===currentView?(currentDate.setMonth(currentDate.getMonth()-1),await refreshCurrentViewOnly()):(await refreshAllViews(),updateCurrentDateDisplay())}),document.getElementById("nextWeek")?.addEventListener("click",async()=>{console.log(`Calendar: Next navigation in ${currentView} view`),"week"===currentView?(currentDate.setDate(currentDate.getDate()+7),await refreshCurrentViewOnly()):"day"===currentView?(currentDate.setDate(currentDate.getDate()+1),await refreshCurrentViewOnly()):"month"===currentView?(currentDate.setMonth(currentDate.getMonth()+1),await refreshCurrentViewOnly()):(await refreshAllViews(),updateCurrentDateDisplay())}),document.addEventListener("click",function(e){e.target&&("newAppointmentBtn"===e.target.id||e.target.textContent?.includes("New Appointment")||e.target.closest("#newAppointmentBtn"))&&fixAppointmentTimeOptions()}),document.addEventListener("DOMContentLoaded",fixAppointmentTimeOptions);let currentAccountPatient=null;function showPatientAccountModal(e){currentAccountPatient=e,console.log("ðŸ” showPatientAccountModal - patientData:",e),console.log("ðŸ” patientData.userId:",e.userId),console.log("ðŸ” patientData keys:",Object.keys(e)),document.getElementById("accountPatientName").textContent=e.patientName;const t=document.getElementById("patientStatusToggle");checkHasUpcomingAppointments(e.patientName)?(t.classList.add("active"),t.classList.remove("inactive"),t.querySelector(".status-text").textContent="Active"):(t.classList.add("inactive"),t.classList.remove("active"),t.querySelector(".status-text").textContent="Inactive"),loadAccountHistory(e),loadAccountRecords(e),loadNextTreatments(e),openModal("patientAccountModal"),setTimeout(()=>{initializePatientInfoEdit();document.getElementById("patientInfoDisplay")?loadPatientInfoDisplay(e):setTimeout(()=>{loadPatientInfoDisplay(e)},300)},200)}async function checkHasUpcomingAppointments(e){const t=new Date;return(await dataManager.getAllAppointments()).some(n=>{if(n.patientName!==e)return!1;return new Date(n.dateKey)>=t})}async function loadAccountHistory(e){try{const t=document.getElementById("accountHistoryList"),n=await dataManager.getAllAppointments()||[],a=await dataManager.getCancelledAppointments()||[];console.log("ðŸ” loadAccountHistory - patientData:",e),console.log("ðŸ” loadAccountHistory - userId:",e.userId),console.log("ðŸ” loadAccountHistory - patientName:",e.patientName);const o=[...n,...a].filter(t=>e.userId&&t.userId?t.userId===e.userId:t.patientName===e.patientName).sort((e,t)=>t.dateKey.localeCompare(e.dateKey));t.innerHTML="",o.forEach(e=>{const n=document.createElement("div");n.className="account-history-item",console.log("ðŸ“… Account Management History - RAW data:",{dateKey:e.dateKey,appointmentDateTime:e.appointmentDateTime,rawAppointment:e});const[a,o,i]=e.dateKey.split("-"),s=`${["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(o)-1]} ${parseInt(i)}, ${a}`;console.log("ðŸ“… Account Management FIXED string parsing:",{dateKey:e.dateKey,year:a,month:o,day:i,formattedDate:s,comparison:"This should now show correct dates"});const r=formatTime(e.time);n.innerHTML=`\n            <div class="account-history-header">\n                <span class="account-history-date">${escapeHtml(s)} - ${escapeHtml(r)}</span>\n                <span class="status-badge ${e.status}">${escapeHtml(capitalizeFirst(e.status))}</span>\n            </div>\n            <div class="account-history-details">\n                <div><strong>Service:</strong> ${escapeHtml(e.serviceType||e.service||"Unknown Service")}</div>\n                <div><strong>Location:</strong> ${escapeHtml(e.location)}</div>\n                <div><strong>Duration:</strong> 60 minutes</div>\n            </div>\n            ${e.notes?`<div class="account-history-notes"><strong>Notes:</strong> ${escapeHtml(e.notes)}</div>`:""}\n        `,t.appendChild(n)})}catch(e){console.error("Error loading account history:",e);const t=document.getElementById("accountHistoryList");t&&(t.innerHTML='<div class="error-message">Failed to load appointment history</div>')}}async function loadAccountRecords(e){const t=document.getElementById("accountRecordsList");if(!e)return void(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">No patient selected</div>');if(!window.firebaseDataService)return void(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">Firebase service not available</div>');const n=e.userId||`patient_${e.patientName.toLowerCase().replace(/[^a-z0-9]/g,"_")}`;console.log("ðŸ“¥ Loading records for patient:",e.patientName,"using ID:",n);try{t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">Loading medical records...</div>';const e=await window.firebaseDataService.getMedicalRecords(n);if(t.innerHTML="",0===e.length)return void(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">No medical records found</div>');e.forEach(e=>{const n=document.createElement("div");n.className="record-item";let a="fas fa-file";e.type.includes("pdf")?a="fas fa-file-pdf":e.type.includes("image")?a="fas fa-file-image":(e.type.includes("word")||e.type.includes("document"))&&(a="fas fa-file-word");const o=(e.uploadedAt.toDate?e.uploadedAt.toDate():new Date(e.uploadedAt)).toLocaleDateString();n.innerHTML=`\n                <div class="record-info">\n                    <i class="${a} record-icon"></i>\n                    <div class="record-details">\n                        <div class="record-name">${escapeHtml(e.originalName)}</div>\n                        <div class="record-date">Uploaded: ${escapeHtml(o)}</div>\n                    </div>\n                </div>\n                <div class="record-actions">\n                    <button class="record-action" data-record-id="${escapeHtml(e.id)}" data-record-name="${escapeHtml(e.originalName)}" data-action="download" title="Download">\n                        <i class="fas fa-download"></i>\n                    </button>\n                    <button class="record-action" data-record-id="${escapeHtml(e.id)}" data-record-name="${escapeHtml(e.originalName)}" data-action="rename" title="Rename">\n                        <i class="fas fa-edit"></i>\n                    </button>\n                    <button class="record-action" data-record-id="${escapeHtml(e.id)}" data-record-name="${escapeHtml(e.originalName)}" data-action="delete" title="Delete">\n                        <i class="fas fa-trash"></i>\n                    </button>\n                </div>\n            `;n.querySelectorAll(".record-action").forEach(t=>{t.addEventListener("click",function(){const t=this.getAttribute("data-action"),n=this.getAttribute("data-record-id"),a=this.getAttribute("data-record-name");"download"===t?downloadRecord(n,e.base64Data,a):"rename"===t?renameRecord(n,a):"delete"===t&&deleteRecord(n,a)})}),t.appendChild(n)})}catch(e){console.error("Error loading medical records:",e),t.innerHTML='<div style="text-align: center; color: #e74c3c; padding: 40px;">Failed to load medical records</div>'}}function renameRecord(e,t){const n=prompt("Enter new filename:",t);n&&n!==t&&window.firebaseDataService&&window.firebaseDataService.renameMedicalRecord(e,n).then(()=>{console.log("File renamed successfully"),currentAccountPatient&&loadAccountRecords(currentAccountPatient)}).catch(e=>{console.error("Rename failed:",e),alert("Failed to rename file. Please try again.")})}async function loadNextTreatments(e){const t=document.getElementById("accountTreatmentList"),n=(new Date,await dataManager.getAllAppointments());console.log("ðŸ” loadNextTreatments - patientData:",e),console.log("ðŸ” loadNextTreatments - userId:",e.userId),console.log("ðŸ” loadNextTreatments - patientName:",e.patientName);const a=n.filter(t=>{let n=!1;if(n=e.userId&&t.userId?t.userId===e.userId:t.patientName===e.patientName,!n)return!1;const a=(new Date).toISOString().split("T")[0];return t.dateKey>=a}).sort((e,t)=>e.dateKey.localeCompare(t.dateKey));t.innerHTML="",a.forEach(e=>{const n=document.createElement("div");n.className="treatment-card",n.onclick=()=>showAppointmentDetails(null,e),console.log("ðŸ”® Next Treatment - RAW data:",{dateKey:e.dateKey,appointmentDateTime:e.appointmentDateTime,rawAppointment:e});const[a,o,i]=e.dateKey.split("-"),s=`${["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(o)-1]} ${parseInt(i)}, ${a}`;console.log("ðŸ”® Next Treatment FIXED string parsing:",{dateKey:e.dateKey,year:a,month:o,day:i,formattedDate:s,comparison:"This should now show correct dates"});const r=formatTime(e.time);n.innerHTML=`\n            <div class="treatment-header">\n                <div class="treatment-info">\n                    <h4>${escapeHtml(e.serviceType||e.service||"Unknown Service")} - ${escapeHtml(e.location)}</h4>\n                    <div class="treatment-date">${escapeHtml(s)} at ${escapeHtml(r)}</div>\n                </div>\n                <span class="status-badge ${e.status}">${escapeHtml(capitalizeFirst(e.status))}</span>\n            </div>\n            ${e.notes?`<div class="treatment-desc">${escapeHtml(e.notes)}</div>`:""}\n        `,t.appendChild(n)}),0===a.length&&(t.innerHTML='<div style="text-align: center; color: #64748b; padding: 40px;">No upcoming treatments scheduled</div>')}function downloadRecord(e,t,n){window.firebaseDataService&&window.firebaseDataService.downloadMedicalRecord(t,n).then(()=>{console.log("File downloaded successfully")}).catch(e=>{console.error("Download failed:",e),alert("Failed to download file. Please try again.")})}function deleteRecord(e,t){confirm(`Delete ${t}?`)&&window.firebaseDataService&&window.firebaseDataService.deleteMedicalRecord(e).then(()=>{console.log("File deleted successfully"),currentAccountPatient&&loadAccountRecords(currentAccountPatient)}).catch(e=>{console.error("Delete failed:",e),alert("Failed to delete file. Please try again.")})}async function handleFileUpload(e){const t=e.target.files;if(!t||0===t.length)return;if(!currentAccountPatient)return void alert("No patient selected");const n=currentAccountPatient.userId||`patient_${currentAccountPatient.patientName.toLowerCase().replace(/[^a-z0-9]/g,"_")}`;console.log("ðŸ“¤ File upload for patient:",currentAccountPatient.patientName,"using ID:",n);const a=[];for(let e of t){if(!validateFile(e))continue;const t=await processFile(e);a.push(uploadFile(n,t))}try{await Promise.all(a),console.log("All files uploaded successfully"),currentAccountPatient&&loadAccountRecords(currentAccountPatient),e.target.value=""}catch(e){console.error("Upload failed:",e),alert("Some files failed to upload. Please try again.")}}function validateFile(e){return e.size>512e3?(alert(`File "${e.name}" is too large. Maximum size is 500KB for Base64 storage.`),!1):!!["application/pdf","image/jpeg","image/jpg","image/png","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(e.type)||(alert(`File "${e.name}" has unsupported format. Allowed: PDF, JPG, PNG, DOC, DOCX`),!1)}async function processFile(e){return e.type.startsWith("image/")?new Promise(t=>{const n=document.createElement("canvas"),a=n.getContext("2d"),o=new Image;o.onload=function(){let i=.6;e.size>307200?i=.5:e.size<102400&&(i=.7);let{width:s,height:r}=o;if(s>800||r>600){const e=Math.min(800/s,600/r);s*=e,r*=e}n.width=s,n.height=r,a.drawImage(o,0,0,s,r),n.toBlob(n=>{const a=new File([n],e.name,{type:e.type,lastModified:Date.now()});t(a)},e.type,i)},o.src=URL.createObjectURL(e)}):e}async function uploadFile(e,t){return new Promise((n,a)=>{if(!window.firebaseDataService)return void a(new Error("Firebase service not available"));const o=createProgressElement(t.name);window.firebaseDataService.uploadMedicalRecord(e,t,e=>{updateProgressElement(o,e)}).then(e=>{console.log("Upload successful:",e),removeProgressElement(o),n(e)}).catch(e=>{console.error("Upload failed:",e),removeProgressElement(o),a(e)})})}function createProgressElement(e){const t=document.getElementById("accountRecordsList");if(!t)return null;const n=document.createElement("div");return n.className="upload-progress",n.innerHTML=`\n        <div class="progress-info">\n            <span class="progress-filename">${e}</span>\n            <span class="progress-percentage">0%</span>\n        </div>\n        <div class="progress-bar">\n            <div class="progress-fill" style="width: 0%"></div>\n        </div>\n    `,t.insertBefore(n,t.firstChild),n}function updateProgressElement(e,t){if(!e)return;const n=Math.round(t),a=e.querySelector(".progress-percentage"),o=e.querySelector(".progress-fill");a&&(a.textContent=`${n}%`),o&&(o.style.width=`${n}%`)}function removeProgressElement(e){e&&e.parentNode&&setTimeout(()=>{try{e.parentNode&&e.parentNode.removeChild(e)}catch(e){console.log("Progress element already removed")}},1e3)}function initializePatientInfoEdit(){const e=document.getElementById("editPatientInfoBtn"),t=document.getElementById("cancelEdit"),n=document.getElementById("saveEdit");e&&e.addEventListener("click",function(e){e.stopPropagation(),toggleEditMode(!0)}),t&&t.addEventListener("click",function(){toggleEditMode(!1)}),n&&n.addEventListener("click",function(){savePatientInfo()})}function toggleEditMode(e){const t=document.getElementById("patientInfoDisplay"),n=document.getElementById("patientInfoEdit"),a=document.getElementById("notesDisplay"),o=document.getElementById("notesEdit"),i=document.getElementById("editActions");if(console.log("DOM elements found:",{displayDiv:!!t,editDiv:!!n,notesDisplay:!!a,notesEdit:!!o,editActions:!!i}),e){if(t.style.display="none",n.style.display="flex",n.style.flexDirection="column",a.style.display="none",o.style.display="block",i.style.display="flex",currentAccountPatient){document.getElementById("editPhone").value=currentAccountPatient.phone||"",document.getElementById("editEmail").value=currentAccountPatient.email||"";let e={};dataManager.data.patientProfiles&&dataManager.data.patientProfiles[currentAccountPatient.patientName]&&(e=dataManager.data.patientProfiles[currentAccountPatient.patientName].detailedInfo),document.getElementById("editAddress").value=e.address||"",document.getElementById("editEmergency").value=e.emergency||"",document.getElementById("editDateOfBirth").value=e.dateOfBirth||"",document.getElementById("editAge").value=e.age||"",document.getElementById("editGender").value=e.gender||"",document.getElementById("editFirstVisit").value=e.firstVisit||"",document.getElementById("editAllergies").value=e.allergies||"",document.getElementById("editMedications").value=e.medications||"",document.getElementById("editConditions").value=e.conditions||"",document.getElementById("notesEdit").value=e.medicalNotes||""}}else t.style.display="flex",n.style.display="none",a.style.display="block",o.style.display="none",i.style.display="none"}function savePatientInfo(){const e=document.getElementById("editPhone").value,t=document.getElementById("editEmail").value,n=document.getElementById("editAddress").value,a=document.getElementById("editEmergency").value,o=document.getElementById("editDateOfBirth").value,i=document.getElementById("editAge").value,s=document.getElementById("editGender").value,r=document.getElementById("editFirstVisit").value,c=document.getElementById("editAllergies").value,l=document.getElementById("editMedications").value,d=document.getElementById("editConditions").value,p=document.getElementById("notesEdit").value;if(currentAccountPatient&&(currentAccountPatient.phone=e,currentAccountPatient.email=t,Object.keys(dataManager.data.appointments).forEach(n=>{dataManager.data.appointments[n].forEach(n=>{n.patientName===currentAccountPatient.patientName&&(n.phone=e,n.email=t)})}),Object.keys(dataManager.data.cancelledAppointments||{}).forEach(n=>{dataManager.data.cancelledAppointments[n].forEach(n=>{n.patientName===currentAccountPatient.patientName&&(n.phone=e,n.email=t)})}),dataManager.data.patientProfiles||(dataManager.data.patientProfiles={}),dataManager.data.patientProfiles[currentAccountPatient.patientName]={detailedInfo:{address:n,emergency:a,dateOfBirth:o,age:i,gender:s,firstVisit:r,allergies:c,medications:l,conditions:d,medicalNotes:p},lastUpdated:(new Date).toISOString()},dataManager.saveToStorage()),showSuccessMessage("Patient information updated successfully!"),currentAccountPatient){let n={};dataManager.data.patientProfiles&&dataManager.data.patientProfiles[currentAccountPatient.patientName]&&(n=dataManager.data.patientProfiles[currentAccountPatient.patientName].detailedInfo),updatePatientInfoDisplay(e,t,n.address||"",n.emergency||"",n.dateOfBirth||"",n.age||"",n.gender||"",n.firstVisit||"",n.allergies||"",n.medications||"",n.conditions||"",n.medicalNotes||"")}toggleEditMode(!1),renderHistoryView(!0),closeModal("patientAccountModal"),currentAccountPatient=null,"history"===currentView&&renderHistoryView(!0)}function updatePatientInfoDisplay(e,t,n,a,o,i,s,r,c,l,d,p){document.getElementById("patientInfoDisplay").innerHTML=`\n        <div class="info-row"><span>Phone:</span> <span>${e||""}</span></div>\n        <div class="info-row"><span>Email:</span> <span>${t||""}</span></div>\n        <div class="info-row"><span>Address:</span> <span>${n||""}</span></div>\n        <div class="info-row"><span>Emergency Contact:</span> <span>${a||""}</span></div>\n        <div class="info-row"><span>Date of Birth:</span> <span>${formatDateForDisplay(o)||""}</span></div>\n        <div class="info-row"><span>Age:</span> <span>${i||""} years old</span></div>\n        <div class="info-row"><span>Gender:</span> <span>${s||""}</span></div>\n        <div class="info-row"><span>First Visit:</span> <span>${formatDateForDisplay(r)||""}</span></div>\n        <div class="info-row"><span>Allergies:</span> <span>${c||""}</span></div>\n        <div class="info-row"><span>Medications:</span> <span>${l||""}</span></div>\n        <div class="info-row"><span>Medical Conditions:</span> <span>${d||""}</span></div>\n    `;const m=document.getElementById("notesDisplay");m&&(m.textContent=p||"No notes available")}function loadPatientInfoDisplay(e){const t=document.getElementById("patientInfoDisplay");if(!t)return;let n={};dataManager.data.patientProfiles&&dataManager.data.patientProfiles[e.patientName]&&(n=dataManager.data.patientProfiles[e.patientName].detailedInfo),t.innerHTML=`\n        <div class="info-row"><span>Phone:</span> <span>${e.phone||""}</span></div>\n        <div class="info-row"><span>Email:</span> <span>${e.email||""}</span></div>\n        <div class="info-row"><span>Address:</span> <span>${n.address||""}</span></div>\n        <div class="info-row"><span>Emergency Contact:</span> <span>${n.emergency||""}</span></div>\n        <div class="info-row"><span>Date of Birth:</span> <span>${n.dateOfBirth||""}</span></div>\n        <div class="info-row"><span>Age:</span> <span>${n.age?n.age+" years old":""}</span></div>\n        <div class="info-row"><span>Gender:</span> <span>${n.gender||""}</span></div>\n        <div class="info-row"><span>First Visit:</span> <span>${n.firstVisit||(e.firstVisitDate?(()=>{const[t,n,a]=e.firstVisitDate.split("-");return`${n}/${a}/${t}`})():"")}</span></div>\n        <div class="info-row"><span>Allergies:</span> <span>${n.allergies||""}</span></div>\n        <div class="info-row"><span>Medications:</span> <span>${n.medications||""}</span></div>\n        <div class="info-row"><span>Medical Conditions:</span> <span>${n.conditions||""}</span></div>\n    `}function openNewAppointmentModalWithPatient(e){console.log("ðŸ”µ openNewAppointmentModalWithPatient called with patient:",e?.patientName);const t=document.getElementById("appointmentDate"),n=document.getElementById("appointmentPatientName"),a=document.getElementById("appointmentPhone"),o=(new Date).toISOString().split("T")[0];t&&(t.min=o,t.value=o),e&&n&&(n.value=e.patientName,n.readOnly=!0,n.style.backgroundColor="#f9fafb"),e&&a&&(a.value=e.phone||""),applyLocationPermissionsToNewAppointmentModal(),openModal("newAppointmentModal")}function applyLocationPermissionsToNewAppointmentModal(){const e=dataManager.getCurrentUser();console.log("ðŸ‘¤ Applying permissions for user:",e.name,"Role:",e.role);const t=document.getElementById("appointmentLocation");if(!t)return void console.error("Location select element not found");const n=dataManager.getUserClinics(e);console.log("ðŸ¥ User clinics:",n),t.innerHTML='<option value="">Select Location</option>';const a={arcadia:"Arcadia",irvine:"Irvine","south-pasadena":"South Pasadena","rowland-heights":"Rowland Heights",eastvale:"Eastvale"};n.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=a[e]||e,t.appendChild(n)}),"admin"===e.role?(t.value=e.assignedLocation,t.disabled=!0,t.style.backgroundColor="#f3f4f6",t.style.cursor="not-allowed",console.log("ðŸ”’ Admin mode: Location locked to",e.assignedLocation)):(t.disabled=!1,t.style.backgroundColor="white",t.style.cursor="pointer",console.log("ðŸ”“ Boss mode: All locations accessible"))}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".account-tab-item").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".account-tab-item").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".account-tab-content").forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.getAttribute("data-tab");document.getElementById(t).classList.add("active")})}),document.getElementById("accountModalClose")?.addEventListener("click",()=>{closeModal("patientAccountModal"),currentAccountPatient=null}),document.getElementById("accountScheduleBtn")?.addEventListener("click",()=>{closeModal("patientAccountModal"),openNewAppointmentModalWithPatient(currentAccountPatient)}),document.getElementById("patientStatusToggle")?.addEventListener("click",function(){this.classList.contains("active")?(this.classList.remove("active"),this.classList.add("inactive"),this.querySelector(".status-text").textContent="Inactive"):(this.classList.remove("inactive"),this.classList.add("active"),this.querySelector(".status-text").textContent="Active")});const e=document.getElementById("accountFileInput");e&&e.addEventListener("change",handleFileUpload)}),document.getElementById("accountModalClose")?.addEventListener("click",()=>{closeModal("patientAccountModal"),renderHistoryView(!0),currentAccountPatient=null});