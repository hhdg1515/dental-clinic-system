<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients - First Ave Dental</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/glass-effects.css">
    <link rel="stylesheet" href="css/patients.css">
    <link rel="stylesheet" href="css/appointments.css">
    <link rel="stylesheet" href="css/liquid-glass-modal.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- 认证检查由各页面的 JS 文件处理 -->
</head>
<body>
    <div class="admin-container">
        <!-- Left Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <i class="fas fa-tooth"></i>
                    <div class="logo-text">
                        <div class="company-name">FIRST AVE DENTAL</div>
                        <div class="company-subtitle">&ORTHODONTICS</div>
                    </div>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                  <!-- Collapsible toggle button -->
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-indent"></i>
                </div>
                <a href="patients.html" class="nav-item active">
                   <i class="fas fa-tasks"></i>
                    <span>Appointments</span>
                </a>
                <a href="appointments.html" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
                <a href="#logout" class="nav-item logout" onclick="handleLogout(event); return false;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-actions">
                    <div class="page-title">
                        <h1>Appointments</h1>
                    </div>
                    <div class="global-search-container">
                        <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Search appointments, patients...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="history-icon" id="historyIcon">
                        <i class="fas fa-users"></i>
                        <div class="tooltip">Accounts</div>
                    </div>
                    <div class="notification-bell" id="notificationBell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge"></span>
                        <div class="tooltip">Notifications</div>
                    </div>
                    <div class="user-profile">
                        <img class="profile-img" src="./author_lily.jpg" alt="Profile picture of Sunny"/>
                        <div class="user-info">
                            <div class="user-name">Sunny</div>
                            <div class="user-role">Admin</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Patients Content -->
            <div class="patients-content">
                <!-- Page Controls -->
                <div class="page-controls">
                    <div class="tab-navigation">
                        <button class="tab-button active" data-tab="pending">Pending Appointments</button>
                        <button class="tab-button" data-tab="confirmed">Recent Appointments</button>
                    </div>
                    <button class="new-appointment-btn" id="topNewAppointmentBtn">
                        <i class="fas fa-plus"></i>
                        New Appointment
                    </button>
                </div>

                <!-- Pending Appointments Tab -->
                <div class="tab-content active" id="pending-tab">
                    <div class="patients-table-container">
                        <table class="patients-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Date</th>
                                    <th>Phone</th>
                                    <th>Treatment</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTableBody">
                                <!-- Pending appointments will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination for Pending Tab -->
                    <div class="patients-pagination" id="pendingPagination">
                        <button class="pagination-btn" id="pendingPrevBtn" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="pagination-btn" id="pendingNextBtn">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Confirmed Appointments Tab -->
                <div class="tab-content" id="confirmed-tab">
                    <div class="patients-table-container">
                        <table class="patients-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Date</th>
                                    <th>Phone</th>
                                    <th>Treatment</th>
                                    <th>Location</th>
                                    <th>Process</th>
                                </tr>
                            </thead>
                            <tbody id="confirmedTableBody">
                                <!-- Confirmed appointments will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination for Confirmed Tab -->
                    <div class="patients-pagination" id="confirmedPagination">
                        <button class="pagination-btn" id="confirmedPrevBtn" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="pagination-btn" id="confirmedNextBtn">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div class="modal-overlay liquid-glass" id="patientDetailsModal">
        <div class="modal-content liquid-glass">
            <div class="modal-header">
                <h3 id="patientDetailsTitle">Patient Profile</h3>
                <button class="modal-close" id="patientDetailsClose" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Basic Patient Information -->
                <div class="patient-section">
                    <div class="section-title">Basic</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Name</div>
                            <div class="info-value" id="patientName"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Phone</div>
                            <div class="info-value" id="patientPhone"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Email</div>
                            <div class="info-value" id="patientEmail"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Location</div>
                            <div class="info-value" id="patientLocation"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Service</div>
                            <div class="info-value" id="patientService"></div>
                        </div>
                    </div>
                </div>

                <!-- Patient Self-Description -->
                <div class="patient-section">
                    <div class="section-title">Description</div>
                    <div class="self-description">
                        <div class="self-description-label">Patient Description</div>
                        <div class="self-description-text" id="selfDescriptionText">
                            
                        </div>
                    </div>
                </div>

                <!-- Appointment History -->
                <div class="patient-section">
                    <div class="section-title">History</div>
                    <div class="appointment-history" id="appointmentHistory">
                        <!-- Appointment history will be dynamically populated -->
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="modal-actions">
                    <button class="btn-secondary" id="editBasicInfoBtn">Edit Basic Info</button>
                    <button class="btn-secondary" id="reviewedBtn">Reviewed</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Appointment Modal - Updated Layout -->
    <div class="modal-overlay liquid-glass" id="processModal">
        <div class="modal-content liquid-glass">
            <div class="modal-header">
                <h3>Process Appointment</h3>
                <button class="modal-close" id="processModalClose" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="appointment-summary" id="appointmentSummary">
                    <!-- Appointment details will be populated here -->
                </div>
                
                <div class="process-actions">
                    <h4>Select Action:</h4>
                    <div class="action-buttons-grid">
                        <!-- Row 1: Arrival Status -->
                        <div class="action-row">
                            <button class="btn-action btn-arrived-action" id="arrivedBtn">
                                <i class="fas fa-check-circle"></i>
                                <span>arrived</span>
                            </button>
                            <button class="btn-action btn-no-show-action" id="noShowBtn">
                                <i class="fas fa-user-times"></i>
                                <span>no-show</span>
                            </button>
                        </div>
                        
                        <!-- Row 2: Adjustments -->
                        <div class="action-row">
                            <button class="btn-action btn-modify-action" id="modifyDetailsBtn">
                                <i class="fas fa-edit"></i>
                                <span>Edit</span>
                            </button>
                            <button class="btn-action btn-hold-action" id="holdBtn">
                                <i class="fas fa-pause-circle"></i>
                                <span>Hold</span>
                            </button>
                        </div>
                        
                        <!-- Row 3: Final Outcomes -->
                        <div class="action-row">
                            <button class="btn-action btn-completed-action" id="completedBtn">
                                <i class="fas fa-check-double"></i>
                                <span>completed</span>
                            </button>
                            <button class="btn-action btn-cancel-action" id="cancelBtn">
                                <i class="fas fa-times-circle"></i>
                                <span>Cancel</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modify Form (initially hidden) -->
                <div class="modify-form hidden" id="modifyForm">
                    <h4>Modify Appointment Details:</h4>
                    <form id="modifyAppointmentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="modifyDate">Date</label>
                                <input type="date" id="modifyDate" required>
                            </div>
                            <div class="form-group">
                                <label for="modifyTime">Time</label>
                                <select id="modifyTime" required>
                                    <option value="">Select Time Slot</option>
                                    <option value="09:00-10:00">09:00 AM - 10:00 AM</option>
                                    <option value="10:00-11:00">10:00 AM - 11:00 AM</option>
                                    <option value="11:00-12:00">11:00 AM - 12:00 PM</option>
                                    <option value="12:00-13:00">12:00 PM - 01:00 PM</option>
                                    <option value="13:00-14:00">01:00 PM - 02:00 PM</option>
                                    <option value="14:00-15:00">02:00 PM - 03:00 PM</option>
                                    <option value="15:00-16:00">03:00 PM - 04:00 PM</option>
                                    <option value="16:00-17:00">04:00 PM - 05:00 PM</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modifyService">Service</label>
                            <select id="modifyService" required>
                                <option value="">Select Service</option>
                                <option value="general">General</option>
                                <option value="implant">Implant</option>
                                <option value="extraction">Extraction</option>
                                <option value="preventive">Preventive</option>
                                <option value="cosmetic">Cosmetic</option>
                                <option value="orthodontics">Orthodontics</option>
                                <option value="root-canals">Root Canals</option>
                                <option value="restorations">Restorations</option>
                                <option value="periodontics">Periodontics</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="modifyNotes">Notes (Optional)</label>
                            <textarea id="modifyNotes" rows="3" placeholder="Add any notes about the modification..."></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" id="cancelModify">Cancel</button>
                            <button type="submit" class="btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
                
                <!-- Hold Form (initially hidden) -->
                <div class="hold-form hidden" id="holdForm">
                    <h4>Hold Appointment:</h4>
                    <div class="form-group">
                        <label for="holdNotes">Reason for Hold (Optional)</label>
                        <textarea id="holdNotes" rows="2" placeholder="e.g., Customer considering, Awaiting info..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancelHold">Cancel</button>
                        <button type="button" class="btn-primary" id="saveHold">Save Hold</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Basic Info Modal -->
    <div class="modal-overlay liquid-glass" id="editBasicInfoModal">
        <div class="modal-content liquid-glass">
            <div class="modal-header">
                <h3>Edit Basic Information</h3>
                <button class="modal-close" id="editBasicInfoClose" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editBasicInfoForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editPatientName">Name</label>
                            <input type="text" id="editPatientName" pattern="[A-Za-z\s]+" title="Please enter only English letters and spaces" required>
                        </div>
                        <div class="form-group">
                            <label for="editPatientPhone">Phone</label>
                            <input type="tel" id="editPatientPhone" placeholder="(XXX) XXX-XXXX" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPatientEmail">Email</label>
                        <input type="email" id="editPatientEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="editPatientService">Service</label>
                        <select id="editPatientService" required>
                            <option value="">Select Service</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="editBasicInfoCancel">Cancel</button>
                <button type="submit" class="btn-primary" form="editBasicInfoForm">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- New Appointment Modal -->
    <div class="modal-overlay liquid-glass" id="newAppointmentModal">
        <div class="modal-content liquid-glass">
            <div class="modal-header">
                <h3>Create New Appointment</h3>
                <button class="modal-close" id="newAppointmentClose" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newAppointmentForm">
                    <div class="form-group">
                        <label for="newPatientName">Name</label>
                        <input type="text" id="newPatientName" readonly class="readonly-field">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPatientPhone">Phone</label>
                            <input type="tel" id="newPatientPhone" readonly class="readonly-field">
                        </div>
                        <div class="form-group">
                            <label for="newPatientEmail">Email</label>
                            <input type="email" id="newPatientEmail" readonly class="readonly-field">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newAppointmentDate">Date</label>
                            <input type="date" id="newAppointmentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="newAppointmentTime">Time</label>
                            <select id="newAppointmentTime" required>
                                <option value="">Select Time Slot</option>
                                <option value="09:00-10:00">09:00 AM - 10:00 AM</option>
                                <option value="10:00-11:00">10:00 AM - 11:00 AM</option>
                                <option value="11:00-12:00">11:00 AM - 12:00 PM</option>
                                <option value="12:00-13:00">12:00 PM - 01:00 PM</option>
                                <option value="13:00-14:00">01:00 PM - 02:00 PM</option>
                                <option value="14:00-15:00">02:00 PM - 03:00 PM</option>
                                <option value="15:00-16:00">03:00 PM - 04:00 PM</option>
                                <option value="16:00-17:00">04:00 PM - 05:00 PM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newAppointmentService">Service</label>
                            <select id="newAppointmentService" required>
                                <option value="">Select Service</option>
                                <option value="general">General</option>
                                <option value="implant">Implant</option>
                                <option value="extraction">Extraction</option>
                                <option value="preventive">Preventive</option>
                                <option value="cosmetic">Cosmetic</option>
                                <option value="orthodontics">Orthodontics</option>
                                <option value="root-canals">Root Canals</option>
                                <option value="restorations">Restorations</option>
                                <option value="periodontics">Periodontics</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newAppointmentLocation">Location</label>
                            <select id="newAppointmentLocation" required>
                                <option value="">Select Location</option>
                                <option value="Arcadia">Arcadia</option>
                                <option value="Irvine">Irvine</option>
                                <option value="South Pasadena Park">South Pasadena</option>
                                <option value="Rowland Heights">Rowland Heights</option>
                                <option value="Eastvale">Eastvale</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newAppointmentNotes">Notes (Optional)</label>
                        <textarea id="newAppointmentNotes" rows="3" placeholder="Add any special notes for this appointment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="newAppointmentCancel">Cancel</button>
                <button type="submit" class="btn-primary" form="newAppointmentForm">Create Appointment</button>
            </div>
        </div>
    </div>

    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js';

        // Make Firebase functions available globally
        window.firebaseSDK = {
            initializeApp,
            getAuth,
            GoogleAuthProvider,
            getFirestore,
            getStorage
        };
    </script>

    <!-- LocalForage for IndexedDB persistence -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

    <script src="js/service-mapping.js"></script>
    <script src="js/cache-manager.js"></script>
    <script src="js/persistent-cache-manager.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/shared.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script src="js/firebase-data-service.js"></script>
    <script src="js/patients.js"></script>
</body>
</html>